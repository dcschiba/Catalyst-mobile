var WRAP;"undefined"==typeof WRAP&&(WRAP={}),WRAP.DH={name:"WRAP.DataHandling",version:"0.9",conf_path:"./pri/wrap/conf/data",setUser:function(t,e){if(this.user=e,this.customer=t,this._data){var a;for(var r in this._data)(a=this._data[r].reload)&&a()}},addObject:function(t){var e=this;e._data[t]={name:t,base:{},load:[],inspect:[]};var a=this.conf_path+"/"+t+".json";return this._getJSON(a,"configuration",function(a){var r=e._data[t];r.conf=a;var i=a.DataHandler;i&&e.DataHandler[i]?(r.handler=new e.DataHandler[i](r.ref,r.conf,r.base),WRAP.DH._load(r)):e._error("Implementation WRAP.DH.DataHandler."+i+" not found.")}),e._data[t].ref=new this.Reference(t)},removeObject:function(t){delete this._data[t]},query:function(t){return new this.Reference(t)},Reference:function(t,e){if(e)this._string=e._string+"."+t,this._data=e._data;else{this._string=t;var a=t.split(".");a.length&&(this._data=WRAP.DH._data[a[0]])||WRAP.DH._error("Invalid reference. key="+t+" root object not found.")}this._path=(e?e._path:[]).concat(t?t.split("."):[]),this.query=function(t){return new WRAP.DH.Reference(t,this)},this.length=function(){var t=this.value();return Array.isArray(t)?t.length:0},this.value=function(){var t,e=this._data;if(e&&(e.handler&&e.handler.resolve&&e.handler.resolve(this),t=e.base))for(var a=1;a<this._path.length;a++){var r=this._path[a];if(!(t=this._resolve(t,r)))break}return t},this.available=function(){return!(void 0===this.value())},this.load=function(t){this._data.load.push({ref:this,cb:t?t:this._nop}),WRAP.DH._load(this._data)},this.inspect=function(t,e){if(t){var a=this._string+"."+t.toString();this._data.inspect.push({key:a,ref:this,cb:t}),e&&this.available()&&t(this)}else for(var r=0;r<this._data.inspect.length;r++){if(this._data.inspect[r].ref==this)return void this.splice(r,1);r++}},this.filter=function(t){var e=this.value();if(Array.isArray(e)){for(var a=[],r=e.length,i=0;i<r;i++){var n=t(e[i]);void 0!==n&&a.push(n)}return a}},this._resolve=function(t,e){var a,r=e.indexOf("["),i=e.indexOf("]");if(r<0&&i<0)a=t[e];else if(r<0||i<0)WRAP.DH._error('Invalid reference key. "'+e+'"');else{var n=e.substring(0,r);if(a=t[n]){var o=e.indexOf("=");if(o>r){if(Array.isArray(a)){for(var s=e.substring(r+1,o),l=ket.substring(o+1,i),u=a.length,d=0;d<u&&a[d][s]!=l;)d++;a=d<u?a[d]:void 0}}else{var s=e.substring(r+1,i);a=a[s]}}}return a},this._contain=function(t){for(var e=this._path.length,a=0;a<e;a++)if(this._path[a]!=t._path[a])return!1;return!0},this._equal=function(t){var e=this._path.length;if(e!=t._path.length)return!1;for(var a=0;a<e;a++)if(this._path[a]!=t._path[a])return!1;return!0},this._handler=function(){return this._data.handler},this._nop=function(){}},DataHandler:{},_cache:function(t){this.array=[],this.max=t,this.get=function(t){for(var e=0;e<this.array.length;e++)if(this.array[e].key==t){var a=this.array[e];return this.array.splice(e,1),this.array.unshift(a),a}return null},this.set=function(t,e){var a=this.get(t);return a?void(a.data=e):(this.array.unshift({key:t,data:e}),void(this.array.length>=this.max&&this.array.pop()))}},_get:function(t,e,a,r){var i=this,n=new XMLHttpRequest;n&&(n.onreadystatechange=function(){4===n.readyState&&(200===n.status||0===n.status?a(n.responseText):(i._error(e+" load error. ("+n.status+") ["+t+"]"),r?r():a(null)))},n.open("GET",t,!0),n.send(null))},_getJSON:function(t,e,a,r){var i=this;this._get(t,e,function(n){var o=null;try{o=JSON.parse(n)}catch(a){i._error(e+" parse error. ["+t+"]")}o?a(o):r?r():a(null)},r)},_load:function(t){if(t.handler)for(var e;e=t.load.shift();)e.ref.cb=e.cb,t.handler.load(e.ref,function(e,a){if(a){for(var r=0;r<t.inspect.length;r++){var i=t.inspect[r];(a._contain(i.ref)||i.ref._contain(a))&&i.cb(a)}a.cb&&(a.cb(e,a),delete a.cb)}})},_padding:function(t,e){void 0==e&&(e=2);for(var a=""+t;a.length<e;)a="0"+a;return a},_timeString:function(t,e,a,r){var i="";return 1==arguments.length&&(e="",a="T",r=""),(""==e||e)&&(i+=t.getUTCFullYear()+e,i+=this._padding(t.getUTCMonth()+1)+e,i+=this._padding(t.getUTCDate())),a&&(i+=a),(""==r||r)&&(i+=this._padding(t.getUTCHours())+r,i+=this._padding(t.getUTCMinutes())+r,i+=this._padding(t.getUTCSeconds())),i},_time:function(t){t=t.replace(/ +/g," ").replace(/:| |T|\//g,",");for(var e=[0,0,0,0,0,0,-1],a=[4,2,2,2,2,2,-1],r=0,i=0,n=0;n<t.length&&a[r]>0;n++){var o=t.charAt(n);isNaN(o)?","==o&&(r++,i=0):(a[r]==i&&(r++,i=0),e[r]=10*e[r]+parseInt(o),i++)}return new Date(Date.UTC(e[0],e[1]-1,e[2],e[3],e[4],e[5]))},_currentTime:function(){return new Date},_setTime:function(t,e){return new Date(t.getTime()+1e3*e)},_elapsed:function(t,e){return parseInt((e.getTime()-t.getTime())/1e3)},_error:function(t){console.warn(this.name+":"+t)},_data:{},Test:{}},WRAP.DH.DataHandler.Lightning=function(t,e,a){var r=this;r.ref=t,r.update_interval=parseFloat(e.Attributes.UpdateInterval),this.load=function(t,i){WRAP.DH._getJSON(e.Attributes.URL,"Lightning Data",function(e){if(e&&e.updated){if(WRAP.DH.Test.Lightning){var n=WRAP.DH._currentTime();a.data={updatedtime:WRAP.DH._timeString(n),array:[]};for(var o=0;o<WRAP.DH.Test.Lightning;o++){var s=e.body[o];a.data.array.push({lat:60*(25+20*Math.random()),lon:60*(125+20*Math.random()),time:WRAP.DH._timeString(WRAP.DH._setTime(n,60*-Math.random()*60))})}}else{var n=WRAP.DH._time(e.updated);a.data={updatedtime:WRAP.DH._timeString(n),array:[]};for(var o=0;o<e.body.length;o++){var s=e.body[o];a.data.array.push({lat:60*s.lt,lon:60*s.ln,time:WRAP.DH._timeString(WRAP.DH._setTime(n,-s.tm))})}}i("completed",t)}else WRAP.DH._error("Invalid Lightning data format."),i("error",null);r.update_interval>0&&setTimeout(function(){r.ref.load()},1e3*r.update_interval)})},r.update_interval>0&&r.ref.load()},WRAP.DH.DataHandler.LiveCamera=function(t,e,a){var r=36e3,i=10,n=this;n.initial=!0,n.ref=t,n.update_interval=parseFloat(e.Attributes.UpdateInterval),n.auto_update=!1,this.load=function(t,o){var s=t._path.length;if(s<3)console.log("Load LiveCamera Info (autou pdate="+n.auto_update+")"),a.data&&!n.auto_update||WRAP.DH._get(e.Attributes.CameraMaster,"LiveCamera Master",function(r){if(r){a.data||(a.data={});for(var i=r.split("\n"),s=0,l=0;l<i.length;l++){var u=i[l];u.length&&(s++,a.data[u]||(a.data[u]={}),a.data[u].active=!0)}var d=0;for(var f in a.data)if(a.data[f].active){delete a.data[f].active;var h=e.Attributes.CameraServer+"/info/public/camera_master/"+f;WRAP.DH.Test.Camera&&(h="./sample_data/LIVE_CAMERA/test/"+f+"/info.json"),WRAP.DH._getJSON(h,"LiveCamera Info",function(r){if(r){if(a.data[r.AREA]){var i=a.data[r.AREA];i.area_name=r.AREA,i.e_name=r.Shibakoen,i.l_name=r.LNAME,i.company=r.COMPNY,i.jpscsn=r.JPSCSN,i.lat=60*parseFloat(r.LATD),i.lon=60*parseFloat(r.LOND),i.dir=r.DIR!=-1?22.5*r.DIR:void 0,i.gid=r.GID,!n.initial||e.Attributes.InitialLoad?t.query("data").query(r.AREA).load(function(){++d>=s&&(n.initial=!1,o("completed",t))}):++d>=s&&(n.initial=!1,o("completed",t))}}else++d>=s&&(n.initial=!1,o("completed",t))})}else delete a.data[f]}else WRAP.DH._error("LiveCamera Master not found."),o("error",null);n.auto_update&&n.update_interval>0&&setTimeout(function(){n.ref.load()},1e3*n.update_interval)});else if(s>=3){var l=t._path[2],u=WRAP.DH._currentTime(),d=WRAP.DH._setTime(u,-r),f=WRAP.DH._timeString(d,"","",""),h=WRAP.DH._timeString(u,"","",""),c=e.Attributes.CameraServer+"/date/public/"+l+"/"+f+"/"+h+"/";WRAP.DH.Test.Camera&&(c="./sample_data/LIVE_CAMERA/test/"+l+"/files.json"),WRAP.DH._getJSON(c,"LiveCamera File List",function(r){if(r&&r.keys&&a.data[l]){r.keys.sort(function(t,e){return t>e?-1:t<e?1:0});for(var n=a.data[l].image,u=a.data[l].image=[],d=0,f=0;f<r.keys.length;f++){var h=r.keys[f].split("."),c=WRAP.DH._time(h[0]),_=WRAP.DH._timeString(c),p=null,m=!1;if(n)for(var v=0;v<n.length;v++)if(n[v].time==_){m=!0,p=n[v].image;break}if(s>3||0==f||m){var g;if(u.push(g={time:_,image:p}),!m){var A=new Image;g.image=A,A.target=g,A.onload=function(){},A.onerror=function(){A.onerror=null,A.src="img/broken_img.png"};var c=WRAP.DH._time(_),D=WRAP.DH._timeString(c,"","",""),R=e.Attributes.CameraServer+"/img/public/"+l+"/"+D+".jpeg";WRAP.DH.Test.Camera&&(R="./sample_data/LIVE_CAMERA/test/"+l+"/"+D+".jpeg"),A.src=R}}if(++d>=i)break}}o("completed",t)})}},n.update_interval>0&&n.ref.load()},WRAP.DH.DataHandler.RendezvousPoint=function(t,e,a){var r=this;r.ref=t,r.update_interval=parseFloat(e.Attributes.UpdateInterval),this.load=function(t,i){if(WRAP.DH.customer&&WRAP.DH.user){var n=e.Attributes.Directory+"/"+WRAP.DH.customer+"/"+WRAP.DH.user+".json";WRAP.DH._getJSON(n,"RendezvousPoint Data",function(e){if(e&&e.data){a.data=[];for(var n=0;n<e.data.length;n++){var o=e.data[n];a.data.push({update_time:WRAP.DH._timeString(WRAP.DH._time(o.updated_at)),type:o.icon_type,display:o.disp_type&&1==o.disp_type,name:o.name,lat:60*o.lat,lon:60*o.lon,remarks:o.remarks,circle_num:parseInt(o.circle_num),circle_dist:parseFloat(o.circle_dist)})}i("completed",t)}else WRAP.DH._error("Invalid RendezvousPoint data format."),i("error",null);r.update_interval>0&&setTimeout(function(){r.ref.load()},1e3*r.update_interval)})}},this.reload=function(){this.load(r.reference,function(){})},r.update_interval>0&&r.ref.load()},WRAP.DH.DataHandler.TMS=function(t,e,a){function r(t,e,a,r){return t+"/"+e+"/"+r+"/"+a}function i(t,a,r){var i=256,n=0,o=0;if(t>e.Attributes.MaxZoom){i=Math.pow(2,t-e.Attributes.MaxZoom);var s=Math.floor(r/i);n=Math.floor(256*(r-s*i)/i),r=s;var l=Math.floor(a/i);o=Math.floor(256*(a-l*i)/i),a=l,t=e.Attributes.MaxZoom,i=256/i,i<1&&(i=1),o=256-o-i}return{x:r,y:a,z:t,ts:i,tx:n,ty:o}}function n(t,e,a,r){if(256==e)return t;t=t.data;var i=document.createElement("canvas");i.width=i.height=e;for(var n=i.getContext("2d"),o=n.createImageData(e,e),s=o.data,l=0,u=0;u<e;u++)for(var d=4*(256*(u+r)+a),f=0;f<e;f++)s[l++]=t[d++],s[l++]=t[d++],s[l++]=t[d++],s[l++]=t[d++];return o}function o(t,a,r){if(0==t)return!0;var i=WRAP.Geo.getTMSPoint(t,r,a),n=i.latDegree();if(n<=e.Attributes.BoundingBox.miny)return!1;var o=WRAP.Geo.getTMSPoint(t,parseInt(r)+1,parseInt(a)-1),s=o.latDegree();if(s>=e.Attributes.BoundingBox.maxy)return!1;var l=i.lonDegree(),u=o.lonDegree();if(u<l&&(u+=360),e.Attributes.BoundingBox.minx<e.Attributes.BoundingBox.maxx){if(u<=e.Attributes.BoundingBox.minx)return!1;if(l>=e.Attributes.BoundingBox.maxx)return!1}else if(u<=e.Attributes.BoundingBox.minx&&l>=e.Attributes.BoundingBox.maxx)return!1;return!0}var s=12,l=this;l.ref=t,l.update_interval=parseFloat(e.Attributes.UpdateInterval),l.cache=new WRAP.DH._cache(150);var u=document.createElement("canvas");u.width=256,u.height=256;var d=u.getContext("2d");d.fillStyle="rgba(200,200,100,0.4)",d.fillRect(0,0,256,256),this.empty_tile=d.getImageData(0,0,256,256),this.empty_tile.empty=!0,this.load=function(t,r){var i=e.Attributes.Index,n=e.Attributes.Directory+"/index.json";WRAP.DH._getJSON(n,i+" Timelist",function(e){if(e&&e[i]){var n=e[i];if(n.vtlist){a.timelist=[];for(var o=0;o<n.vtlist.length&&o<s;o++){var u=n.vtlist[o];a.timelist.push(WRAP.DH._timeString(WRAP.DH._time(u)))}r("completed",t)}else if(n.timelist){a.timelist=n.timelist;for(var o=0;o<a.timelist.length;o++){var d=WRAP.DH._time(a.timelist[o].basetime);a.timelist[o].basetime=WRAP.DH._timeString(d);var f=a.timelist[o].validtime;if(f){for(f.sort(function(t,e){return t>e?-1:t<e?1:0});f.length>s;)f.splice(0,1);for(var h=0;h<f.length;h++){var c=WRAP.DH._time(f[h]);f[h]=WRAP.DH._timeString(c)}}}r("completed",t)}else WRAP.DH._error(i+" Timelist format not supported."),r("error",null)}else WRAP.DH._error(i+" Timelist format."),r("error",null);l.update_interval>0&&setTimeout(function(){l.ref.load()},1e3*l.update_interval)})},this.getTile=function(t,e,a,s){if(!o(e,a,s))return this.empty_tile;var l=i(e,a,s),u=r(t,l.z,l.y,l.x),d=this.cache.get(u);return d&&d.data?n(d.data,l.ts,l.tx,l.ty):null},this.loadTile=function(t,a,n,o,s){var l=this,u=i(a,n,o),d=r(t,u.z,u.y,u.x),f=this.cache.get(d);if(!f){l.cache.set(d,null);var h=e.Attributes.Directory+"/"+d+".png",c=new Image;c.width=256,c.height=256,c.onload=function(){var e=document.createElement("canvas");e.width=256,e.height=256;var r=e.getContext("2d");if(r.drawImage(c,0,0,256,256),WRAP.DH.Test.TileID){var i=a+"/"+n+"/"+o;r.font="16px Arial",r.beginPath();var u=r.measureText(i);r.fillStyle="rgba(100,100,20,0.8)",t.length<20?r.fillText(t,50,170):r.fillText(t.substr(20,19),50,170),r.fillText(i,128-u.width/2,200),r.closePath(),r.beginPath(),r.strokeStyle="rgba(100,100,20,0.8)",r.rect(3,3,250,250),r.stroke(),r.closePath()}var f=r.getImageData(0,0,256,256);l.cache.set(d,f),s()},c.onerror=function(){var e=document.createElement("canvas");e.width=256,e.height=256;var r=e.getContext("2d");if(WRAP.DH.Test.TileID){var i=a+"/"+n+"/"+o;r.font="16px Arial",r.beginPath();var u=r.measureText(i);r.fillStyle="rgba(200,30,30,0.8)",r.fillText(t,50,170),r.fillText(i,128-u.width/2,200),r.closePath(),r.beginPath(),r.strokeStyle="rgba(200,30,30,0.8)",r.rect(3,3,250,250),r.stroke(),r.closePath()}var f=r.getImageData(0,0,256,256);f.empty=!0,l.cache.set(d,f),s()},c.src=h}},l.update_interval>0&&l.ref.load()},WRAP.DH.DataHandler.CoPilot=function(t,e,a){var r=this;r.ref=t,r.update_interval=parseFloat(e.Attributes.UpdateInterval),this.load=function(t,i){if(WRAP.DH.customer){var n=e.Attributes.Directory+"/"+WRAP.DH.customer+"/"+e.Attributes.PointFile,o=e.Attributes.Directory+"/"+WRAP.DH.customer+"/"+e.Attributes.RouteFile,s=function(t,e){if(t)for(var a=0;a<t.length;a++)if(t[a].copilot_no==e)return t[a];return null},l=function(t,e){if(e){t.past_position=[];for(var a=WRAP.DH._time(t.obs_time),r=0;r<e.length;r++){var i=e[r],n=WRAP.DH._elapsed(WRAP.DH._time(i.obs_time),a);0>n&&n>=-3600&&(i.copilot_no=t.copilot_no,t.past_position.push(i))}}};WRAP.DH._getJSON(n,"Copilot Data",function(e){if(e&&e.point_data){a.data=[];for(var n=0;n<e.point_data.length;n++){var u=e.point_data[n],d=WRAP.DH._timeString(WRAP.DH._time(u.update_time)),f=WRAP.DH._timeString(WRAP.DH._time(u.obs_time)),h=s(u.copilot_no),c={update_time:d,obs_time:f,copilot_no:u.copilot_no,lat:60*u.lat,lon:60*u.lon,hgt:u.hgt,gps_spd:u.gps_spd,heading:u.heading,type:u.type,name:u.name,battery:u.battery,past_position:[]};h&&l(c,h.past_position),a.data.push(c)}WRAP.DH._getJSON(o,"Copilot Route Data",function(e){if(e.all_data)for(var r=0;r<e.all_data.length;r++){var n=e.all_data[r],o=s(a.data,n.copilot_no);if(o){for(var u=[],d=0;d<e.all_data[r].route_data.length;d++){var f=n.route_data[d],h=WRAP.DH._timeString(WRAP.DH._time(f.update_time)),c=WRAP.DH._timeString(WRAP.DH._time(f.obs_time)),_={update_time:h,obs_time:c,lat:60*f.lat,lon:60*f.lon,hgt:f.hgt,gps_spd:f.gps_spd,heading:f.heading,type:f.type,name:f.name,battery:f.battery};u.push(_)}l(o,u)}}i("completed",t)})}else WRAP.DH._error("Invalid Copilot data format."),i("error",null);r.update_interval>0&&setTimeout(function(){r.ref.load()},1e3*r.update_interval)})}},this.reload=function(){this.load(r.reference,function(){})},r.update_interval>0&&r.ref.load()};
//# sourceMappingURL=../build/js/WRAP.DH-1.0.0.0-min.js.map