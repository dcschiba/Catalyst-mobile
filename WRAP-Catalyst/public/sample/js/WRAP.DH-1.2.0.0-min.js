var WRAP;"undefined"==typeof WRAP&&(WRAP={}),WRAP.DH={version:"1.1",conf_path:"./pri/wrap/conf/data",setUser:function(e,t){if(this.user=t,this.customer=e,this._data){var a;for(var i in this._data)(a=this._data[i].reload)&&a()}},addObject:function(e){var t=this;t._data[e]={name:e,base:{},load:[],inspect:[]};var a=this.conf_path+"/"+e+".json";return this._getJSON(a,"configuration",function(a){var i=t._data[e];i.conf=a;var r=a.DataHandler;r&&t.DataHandler[r]?(i.handler=new t.DataHandler[r](i.ref,i.conf,i.base),WRAP.DH._load(i)):t._error("Implementation WRAP.DH.DataHandler."+r+" not found.")}),t._data[e].ref=new this.Reference(e)},removeObject:function(e){delete this._data[e]},query:function(e){return new this.Reference(e)},Reference:function(e,t){if(t)this._string=t._string+"."+e,this._data=t._data;else{this._string=e;var a=e.split(".");a.length&&(this._data=WRAP.DH._data[a[0]])||WRAP.DH._error("Invalid reference. key="+e+" root object not found.")}this._path=(t?t._path:[]).concat(e?e.split("."):[]),this.query=function(e){return new WRAP.DH.Reference(e,this)},this.length=function(){var e=this.value();return Array.isArray(e)?e.length:0},this.value=function(){var e,t=this._data;if(t&&(t.handler&&t.handler.resolve&&t.handler.resolve(this),e=t.base))for(var a=1;a<this._path.length;a++){var i=this._path[a];if(!(e=this._resolve(e,i)))break}return e},this.available=function(){return!(void 0===this.value())},this.load=function(e){this._data.load.push({ref:this,cb:e?e:this._nop}),WRAP.DH._load(this._data)},this.inspect=function(e,t){if(e){var a=this._string+"."+e.toString();this._data.inspect.push({key:a,ref:this,cb:e}),t&&this.available()&&e(this)}else for(var i=0;i<this._data.inspect.length;i++){if(this._data.inspect[i].ref==this)return void this.splice(i,1);i++}},this.filter=function(e){var t=this.value();if(Array.isArray(t)){for(var a=[],i=t.length,r=0;r<i;r++){var n=e(t[r]);void 0!==n&&a.push(n)}return a}},this.validate=function(e){this.validator=e},this.getData=function(e,t){if(t){if(this._data&&this._data.handler){var a=this._data.handler;if(a.getData&&a.loadData){var i=a.getData(e);return i?void t(i):void a.loadData(e,null,function(){var i=a.getData(e);i&&t(i)})}}t(null)}},this._resolve=function(e,t){var a,i=t.indexOf("["),r=t.indexOf("]");if(i<0&&r<0)a=e[t];else if(i<0||r<0)WRAP.DH._error('Invalid reference key. "'+t+'"');else{var n=t.substring(0,i);if(a=e[n]){var o=t.indexOf("=");if(o>i){if(Array.isArray(a)){for(var l=t.substring(i+1,o),s=t.substring(o+1,r),d=a.length,f=0;f<d&&a[f][l]!=s;)f++;a=f<d?a[f]:void 0}}else{var l=t.substring(i+1,r);a=a[l]}}}return a},this._contain=function(e){for(var t=this._path.length,a=0;a<t;a++)if(this._path[a]!=e._path[a])return!1;return!0},this._equal=function(e){var t=this._path.length;if(t!=e._path.length)return!1;for(var a=0;a<t;a++)if(this._path[a]!=e._path[a])return!1;return!0},this._handler=function(){return this._data.handler},this._nop=function(){}},DataHandler:{},_cache:function(e){this.array=[],this.max=e,this.get=function(e){for(var t=0;t<this.array.length;t++)if(this.array[t].key==e){var a=this.array[t];return this.array.splice(t,1),this.array.unshift(a),a}return null},this.set=function(e,t){var a=this.get(e);return a?void(a.data=t):(this.array.unshift({key:e,data:t}),void(this.array.length>=this.max&&this.array.pop()))}},_get:function(e,t,a,i){var r=this,n=new XMLHttpRequest;if(n){n.onreadystatechange=function(){4===n.readyState&&(200===n.status||0===n.status?a(n.responseText):(r._error(t+" load error. ("+n.status+") ["+e+"]"),i?i():a(null)))};var o=e.indexOf("?")>=0?"&":"?";o+="t="+(new Date).getTime(),n.open("GET",e+o,!0),n.send(null)}},_getJSON:function(e,t,a,i){var r=this;this._get(e,t,function(n){var o=null;try{o=JSON.parse(n)}catch(a){r._error(t+" parse error. ["+e+"]")}o?a(o,e):i?i(e):a(null)},i)},_load:function(e){if(e.handler)for(var t;t=e.load.shift();)t.ref.cb=t.cb,e.handler.load(t.ref,function(t,a){if(a){for(var i=0;i<e.inspect.length;i++){var r=e.inspect[i];(a._contain(r.ref)||r.ref._contain(a))&&r.cb(r.ref)}a.cb&&(a.cb(t,a),delete a.cb)}})},_padding:function(e,t){void 0==t&&(t=2);for(var a=""+e;a.length<t;)a="0"+a;return a},_timeString:function(e,t,a,i){var r="";return 1==arguments.length&&(t="",a="T",i=""),(""==t||t)&&(r+=e.getUTCFullYear()+t,r+=this._padding(e.getUTCMonth()+1)+t,r+=this._padding(e.getUTCDate())),a&&(r+=a),(""==i||i)&&(r+=this._padding(e.getUTCHours())+i,r+=this._padding(e.getUTCMinutes())+i,r+=this._padding(e.getUTCSeconds())),r},_time:function(e){e=e.replace(/ +/g," ").replace(/:| |T|\//g,",");for(var t=[0,0,0,0,0,0,-1],a=[4,2,2,2,2,2,-1],i=0,r=0,n=0;n<e.length&&a[i]>0;n++){var o=e.charAt(n);isNaN(o)?","==o&&(i++,r=0):(a[i]==r&&(i++,r=0),t[i]=10*t[i]+parseInt(o),r++)}return new Date(Date.UTC(t[0],t[1]-1,t[2],t[3],t[4],t[5]))},_currentTime:function(){return new Date},_setTime:function(e,t){return new Date(e.getTime()+1e3*t)},_elapsed:function(e,t){return parseInt((t.getTime()-e.getTime())/1e3)},_error:function(e){console.warn((this.name||"Error")+":"+e)},_data:{},Test:{}},WRAP.DH.DataHandler.GeoTiff=function(e,t,a){function i(e,t){this.dataView=new A(e),t=t||{},this.cache=t.cache||!1;var a=this.dataView.getUint16(0,0);if(18761===a)this.littleEndian=!0;else{if(19789!==a)throw new TypeError("Invalid byte order value.");this.littleEndian=!1}var i=this.dataView.getUint16(2,this.littleEndian);if(42===this.dataView.getUint16(2,this.littleEndian))this.bigTiff=!1;else{if(43!==i)throw new TypeError("Invalid magic number.");this.bigTiff=!0;var r=this.dataView.getUint16(4,this.littleEndian);if(8!==r)throw new Error("Unsupported offset byte-size.")}this.fileDirectories=this.parseFileDirectories(this.getOffset(this.bigTiff?8:4))}function r(e,t){var a=[],i=e.element&&Array.isArray(e.element)?e.element.length:0;if(i)for(var r=0;r<i;r++){var n=o.file;for(var l in e){var s=e[l];"element"==l&&(s=e[l][r]);var d="%"+l+"%";n.indexOf(d)>=0&&(n=n.replace(d,s))}if(t)for(var l in t){var d="%"+l+"%";n.indexOf(d)>=0&&(n=n.replace(d,t[l]))}a.push({file:n,index:r})}else{var n=o.file;for(var l in e){var d="%"+l+"%";n.indexOf(d)>=0&&(n=n.replace(d,e[l]))}if(t)for(var l in t){var d="%"+l+"%";n.indexOf(d)>=0&&(n=n.replace(d,t[l]))}a.push({file:n,index:0})}return a}function n(e,t,a){var i="",r=0;for(var n in e){var o=e[n];if(Array.isArray(o)&&o.length)for(var l=o[0],s=0;s<o.length;s++)l+="+"+o[s];r++&&(i+="/"),i+=o}return i+="/"+t,a&&(i+="/"+a),i}var o=this;if(o.name=t.Name,o.ref=e,o.tile_cache=new WRAP.DH._cache(1e3),o.data_cache=new WRAP.DH._cache(200),o.file=t.Attributes.File,o.grid=t.Attributes.DataGrid,o.update_interval=parseFloat(t.Attributes.UpdateInterval),o.boundary={n:o.grid.LatBase,w:o.grid.LonBase,s:o.grid.LatBase-o.grid.LatInterval*o.grid.Height,e:o.grid.LonBase+o.grid.LonInterval*o.grid.Width},o.wrap_round=o.grid.LonInterval*o.grid.Width>=360,o.tiled=o.grid.TileSize,o.tiled){for(var l=0,s=0,d=o.tiled,f=o.tiled;d<o.grid.Height;)d*=2,l++;for(;f<o.grid.Width;)f*=2,s++;o.max_zoom=l>s?l:s}this.load=function(e,i){var r=t.Attributes.TimeList;r&&WRAP.DH._getJSON(r,"Timelist",function(t){t.timelist?(a.timelist=t.timelist,i("completed",e)):t.validtime?(a.validtime=t.validtime,i("completed",e)):(WRAP.DH._error(o.name+" Timelist format."),i("error",null)),o.update_interval>0&&setTimeout(function(){o.ref.load()},1e3*o.update_interval)})};var u,h={315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop",33550:"ModelPixelScale",33922:"ModelTiepoint",34264:"ModelTransformation",34735:"GeoKeyDirectory",34736:"GeoDoubleParams",34737:"GeoAsciiParams"},c={};for(u in h)c[h[u]]=parseInt(u);var g=[c.BitsPerSample,c.ExtraSamples,c.SampleFormat,c.StripByteCounts,c.StripOffsets,c.StripRowCounts,c.TileByteCounts,c.TileOffsets],v={1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE",16:"LONG8",17:"SLONG8",18:"IFD8"},m={};for(u in v)m[v[u]]=parseInt(u);var p={1024:"GTModelTypeGeoKey",1025:"GTRasterTypeGeoKey",1026:"GTCitationGeoKey",2048:"GeographicTypeGeoKey",2049:"GeogCitationGeoKey",2050:"GeogGeodeticDatumGeoKey",2051:"GeogPrimeMeridianGeoKey",2052:"GeogLinearUnitsGeoKey",2053:"GeogLinearUnitSizeGeoKey",2054:"GeogAngularUnitsGeoKey",2055:"GeogAngularUnitSizeGeoKey",2056:"GeogEllipsoidGeoKey",2057:"GeogSemiMajorAxisGeoKey",2058:"GeogSemiMinorAxisGeoKey",2059:"GeogInvFlatteningGeoKey",2060:"GeogAzimuthUnitsGeoKey",2061:"GeogPrimeMeridianLongGeoKey",2062:"GeogTOWGS84GeoKey",3072:"ProjectedCSTypeGeoKey",3073:"PCSCitationGeoKey",3074:"ProjectionGeoKey",3075:"ProjCoordTransGeoKey",3076:"ProjLinearUnitsGeoKey",3077:"ProjLinearUnitSizeGeoKey",3078:"ProjStdParallel1GeoKey",3079:"ProjStdParallel2GeoKey",3080:"ProjNatOriginLongGeoKey",3081:"ProjNatOriginLatGeoKey",3082:"ProjFalseEastingGeoKey",3083:"ProjFalseNorthingGeoKey",3084:"ProjFalseOriginLongGeoKey",3085:"ProjFalseOriginLatGeoKey",3086:"ProjFalseOriginEastingGeoKey",3087:"ProjFalseOriginNorthingGeoKey",3088:"ProjCenterLongGeoKey",3089:"ProjCenterLatGeoKey",3090:"ProjCenterEastingGeoKey",3091:"ProjCenterNorthingGeoKey",3092:"ProjScaleAtNatOriginGeoKey",3093:"ProjScaleAtCenterGeoKey",3094:"ProjAzimuthAngleGeoKey",3095:"ProjStraightVertPoleLongGeoKey",3096:"ProjRectifiedGridAngleGeoKey",4096:"VerticalCSTypeGeoKey",4097:"VerticalCitationGeoKey",4098:"VerticalDatumGeoKey",4099:"VerticalUnitsGeoKey"},_=function(){function e(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,a,i){return a&&e(t.prototype,a),i&&e(t,i),t}}(),A=function(){function e(e){this._dataView=new DataView(e)}return _(e,[{key:"getUint64",value:function(e,t){var a=this.getUint32(e,t),i=this.getUint32(e+4,t);return t?a<<32|i:i<<32|a}},{key:"getInt64",value:function(e,t){var a,i;return t?(a=this.getInt32(e,t),i=this.getUint32(e+4,t),a<<32|i):(a=this.getUint32(e,t),i=this.getInt32(e+4,t),i<<32|a)}},{key:"getUint8",value:function(e,t){return this._dataView.getUint8(e,t)}},{key:"getInt8",value:function(e,t){return this._dataView.getInt8(e,t)}},{key:"getUint16",value:function(e,t){return this._dataView.getUint16(e,t)}},{key:"getInt16",value:function(e,t){return this._dataView.getInt16(e,t)}},{key:"getUint32",value:function(e,t){return this._dataView.getUint32(e,t)}},{key:"getInt32",value:function(e,t){return this._dataView.getInt32(e,t)}},{key:"getFloat32",value:function(e,t){return this._dataView.getFloat32(e,t)}},{key:"getFloat64",value:function(e,t){return this._dataView.getFloat64(e,t)}},{key:"buffer",get:function(){return this._dataView.buffer}}]),e}();i.prototype={getOffset:function(e){return this.bigTiff?this.dataView.getUint64(e,this.littleEndian):this.dataView.getUint32(e,this.littleEndian)},getFieldTypeLength:function(e){switch(e){case m.BYTE:case m.ASCII:case m.SBYTE:case m.UNDEFINED:return 1;case m.SHORT:case m.SSHORT:return 2;case m.LONG:case m.SLONG:case m.FLOAT:return 4;case m.RATIONAL:case m.SRATIONAL:case m.DOUBLE:case m.LONG8:case m.SLONG8:case m.IFD8:return 8;default:throw new RangeError("Invalid field type: "+e)}},getValues:function(e,t,a){var i,r=null,n=null,o=this.getFieldTypeLength(e);switch(e){case m.BYTE:case m.ASCII:case m.UNDEFINED:r=new Uint8Array(t),n=this.dataView.getUint8;break;case m.SBYTE:r=new Int8Array(t),n=this.dataView.getInt8;break;case m.SHORT:r=new Uint16Array(t),n=this.dataView.getUint16;break;case m.SSHORT:r=new Int16Array(t),n=this.dataView.getInt16;break;case m.LONG:r=new Uint32Array(t),n=this.dataView.getUint32;break;case m.SLONG:r=new Int32Array(t),n=this.dataView.getInt32;break;case m.LONG8:case m.IFD8:r=new Array(t),n=this.dataView.getUint64;break;case m.SLONG8:r=new Array(t),n=this.dataView.getInt64;break;case m.RATIONAL:r=new Uint32Array(2*t),n=this.dataView.getUint32;break;case m.SRATIONAL:r=new Int32Array(2*t),n=this.dataView.getInt32;break;case m.FLOAT:r=new Float32Array(t),n=this.dataView.getFloat32;break;case m.DOUBLE:r=new Float64Array(t),n=this.dataView.getFloat64;break;default:throw new RangeError("Invalid field type: "+e)}if(e!==m.RATIONAL&&e!==m.SRATIONAL)for(i=0;i<t;++i)r[i]=n.call(this.dataView,a+i*o,this.littleEndian);else for(i=0;i<t;i+=2)r[i]=n.call(this.dataView,a+i*o,this.littleEndian),r[i+1]=n.call(this.dataView,a+(i*o+4),this.littleEndian);return e===m.ASCII?String.fromCharCode.apply(null,r):r},getFieldValues:function(e,t,a,i){var r,n=this.getFieldTypeLength(t);if(n*a<=(this.bigTiff?8:4))r=this.getValues(t,a,i);else{var o=this.getOffset(i);r=this.getValues(t,a,o)}return 1===a&&g.indexOf(e)===-1&&t!==m.RATIONAL&&t!==m.SRATIONAL?r[0]:r},parseGeoKeyDirectory:function(e){var t=e.GeoKeyDirectory;if(!t)return null;for(var a={},i=4;i<4*t[3];i+=4){var r=p[t[i]],n=t[i+1]?h[t[i+1]]:null,o=t[i+2],l=t[i+3],s=null;if(n){if(s=e[n],"undefined"==typeof s||null===s)throw new Error("Could not get value of geoKey '"+r+"'.");"string"==typeof s?s=s.substring(l,l+o-1):s.subarray&&(s=s.subarray(l,l+o-1))}else s=l;a[r]=s}return a},parseFileDirectories:function(e){for(var t=e,a=[];0!==t;){for(var i=this.bigTiff?this.dataView.getUint64(t,this.littleEndian):this.dataView.getUint16(t,this.littleEndian),r={},n=e+(this.bigTiff?8:2),o=0;o<i;n+=this.bigTiff?20:12,++o){var l=this.dataView.getUint16(n,this.littleEndian),s=this.dataView.getUint16(n+2,this.littleEndian),d=this.bigTiff?this.dataView.getUint64(n+4,this.littleEndian):this.dataView.getUint32(n+4,this.littleEndian);r[h[l]]=this.getFieldValues(l,s,d,n+(this.bigTiff?12:8))}a.push([r,this.parseGeoKeyDirectory(r)]),t=this.getOffset(n)}return a}};var y=function(e,t,a,r){var n=new XMLHttpRequest;n.open("GET",e),n.setRequestHeader("X-Requested-With","XMLHttpRequest"),n.responseType="arraybuffer",n.onload=function(){var o=3;if(!Module)return console.log("WRAP.ASM Module not found."),void r(e,[]);Module.printErr=function(e){e=null},Module.tmpFileID?Module.tmpFileID+=1:Module.tmpFileID=1;var l=String(Module.tmpFileID)+".tiff";Module.FS.createDataFile("/",l,new Uint8Array(n.response),!0,!1);var s=Module.ccall("TIFFOpen","number",["string","string"],[l,"r"]);if(!s)return console.log("Tiff load error. "+l),void r(e,[]);var d,f=new i(this.response),u=f.fileDirectories&&f.fileDirectories[0]&&f.fileDirectories[0][0],h=u.ImageWidth,c=u.ImageLength,g=u.SampleFormat&&u.SampleFormat[0],v=Module.ccall("_TIFFmalloc","number",["number"],[h*c*4]);if(d=g==o?Module.ccall("TIFFReadEncodedStrip","number",["number","number","number","number"],[s,0,v,h*c*4]):Module.ccall("TIFFReadRGBAImageOriented","number",["number","number","number","number","number","number"],[s,h,c,v,1,0]),0===d)return console.log("GeoTiff Data Parse Error"),void r([]);var u;u=g==o?Module.HEAPF32.subarray(v/4,v+h*c):Module.HEAPU8.subarray(v,v+h*c*4);var m=[],p=h*c;if(g==o)if(isNaN(t)||isNaN(a))if(isNaN(t))if(isNaN(a))for(var _=0;_<p;_++)m[_]=u[_];else for(var _=0;_<p;_++){var A=u[_];A<=a&&(m[_]=A)}else for(var _=0;_<p;_++){var A=u[_];t<=A&&(m[_]=A)}else for(var _=0;_<p;_++){var A=u[_];t<=A&&A<=a&&(m[_]=A)}Module.ccall("_TIFFfree","number",["number"],[v]),Module.ccall("TIFFClose","number",["number"],[s]),r(e,m)},n.onerror=function(){var t=[];r(e,t)},n.send()};this.getGrid=function(){return o.grid},this.getTile=function(e,t,a){var i=this.tile_cache.get(n(e,t,a));return i&&i.data?i.data:null},this.loadTile=function(e,t,a,i,l,s,d,f,u){function h(){for(var e=!0,t=0;t<g.length;t++)if(!g[t].data||!g[t].data.data){var r=o.data_cache.get(g[t].file);if(r&&r.data&&r.data.data){g[t].data=r.data;continue}e=!1;break}if(e){if(a.indexOf("value")>=0){var n=40,l=a.split(" ");l.length>1&&parseInt(l[1])&&(n=parseInt(l[1]));for(var s=f.north/60+.1,h=f.south/60,v=f.west/60-.1,m=f.east/60,p={data:[]},t=0;t<g.length;t++){for(var _=g[t],A=_.data.data,y=Math.pow(2,i),b=256/(360/y),w=1,D=_.lonInterval;w<256&&!(D*b>=n);)D*=2,w*=2;var T;for(T=_.latInterval>0?Math.round((_.n-90)/_.latInterval):Math.round((_.n+90)/_.latInterval);T>0;)T-=w;for(;T<0;)T+=w;for(var I=Math.round(-_.w/_.lonInterval);I>0;)I-=w;for(;I<0;)I+=w;for(V=T;V<_.active_height;V+=w){var P=_.n-_.latInterval*V;if(!(P>s||h>=P))for(k=I;k<_.active_width;k+=w){var x=_.w+_.lonInterval*k;if(x<-180?x+=360:x>=180&&(x-=360),!(x<v||m<=x)){var S=V*_.width+k,R=A[S];if(_.element>1){for(var O=null,G=0;G<p.data.length;G++){var L=p.data[G];if(L.lat==P&&L.lon==x){O=L,L.value[_.index]=R;break}}O||(O={lat:P,lon:x,value:[],x:k,y:V,step:w},O.value[_.index]=R,p.data.push(O))}else p.data.push({lat:P,lon:x,value:R,x:k,y:V,step:w})}}}}return o.tile_cache.set(c,p),void u()}if(a.indexOf("highest")>=0){var n=40,l=a.split(" ");l.length>1&&parseInt(l[1])&&(n=parseInt(l[1]));for(var s=f.north/60+.1,h=f.south/60,v=f.west/60-.1,m=f.east/60,p={data:[]},t=0;t<g.length;t++){for(var _=g[t],A=_.data.data,y=Math.pow(2,i),b=256/(360/y),w=1,D=_.lonInterval;w<256&&!(D*b>=n);)D*=2,w*=2;for(V=0;V<_.height;V+=w){var P=_.n-_.latInterval*(V+w/2);if(!(P>s||h>=P))for(k=0;k<_.width;k+=w){var x=_.w+_.lonInterval*(k+w/2);if(x<-180?x+=360:x>=180&&(x-=360),!(x<v||m<=x)){for(var R=void 0,H=0;H<w;H++)for(var M=0;M<w;M++){var S=(V+H)*_.width+(k+M),N=A[S];(void 0===R||R<N)&&(R=N)}if(_.element>1){for(var O=null,G=0;G<p.data.length;G++){var L=p.data[G];if(L.lat==P&&L.lon==x){O=L,L.value[_.index]=R;break}}O||(O={lat:P,lon:x,value:[],x:k,y:V,step:w},O.value[_.index]=R,p.data.push(O))}else p.data.push({lat:P,lon:x,value:R,x:k,y:V,step:w})}}}}return o.tile_cache.set(c,p),void u()}var W=65536,p={width:256,height:256};if(g.length&&g[0].element>1){p.data=[];for(var t=0;t<g[0].element;t++)p.data[t]=new Array(W)}else p.data=new Array(W);var C=0;if("interpolate"==a)for(var F=0;F<W;F++)for(var P=d[C++],x=d[C++],t=0;t<g.length;t++){var _=g[t],U=_.element<=1?p.data:p.data[_.index],A=_.data.data,E=(_.n-P)/_.latInterval,V=Math.floor(E);if(0<=V&&V<_.height){var K=(x>=_.w?x-_.w:x-(_.w-360))/_.lonInterval,k=Math.floor(K);if(0<=k&&k<_.width){var S=V*_.width+k,R=A[S],z=1;if(k==_.width-1&&(z=o.wrap_round?1-_.width:0),V+1<_.height){var j=R,B=A[S+z],J=A[S+_.width],Y=A[S+_.width+z],q=E-V,X=K-k;R=j*(1-q)*(1-X)+B*(1-q)*X+J*q*(1-X)+Y*X*q}U[F]=R}}}else for(var F=0;F<W;F++)for(var P=d[C++],x=d[C++],t=0;t<g.length;t++){var _=g[t],U=_.element<=1?p.data:p.data[_.index],A=_.data.data,V=Math.round((_.n-P)/_.latInterval);if(0<=V&&V<_.height){var K=(x>=_.w?x-_.w:x-(_.w-360))/_.lonInterval,k=Math.round(K);if(o.wrap_round&&(k%=_.width),0<=k&&k<_.width){var S=V*_.width+k,R=A[S];U[F]=R}}}o.tile_cache.set(c,p),u()}return e}var c=n(e,t,a);if(o.tile_cache.get(c))return void u();var g=[];if(o.tiled){for(var v=d[0],m=d[1],p=d[131070],_=d[131071],A=Math.abs(_-m)/256,b=Math.abs(v-p)/256,w=0,D=o.grid.LonInterval,T=o.grid.LatInterval;w<o.max_zoom&&!(D>=A&&T>=b);)D*=2,T*=2,w++;for(var I=Math.pow(2,w),P=o.grid.TileSize*I,x=o.grid.LatInterval*P,S=o.grid.LonInterval*P,R=Math.ceil(o.grid.Height/P),O=Math.ceil(o.grid.Width/P),l=0;l<R;l++){var G=o.grid.LatBase-l*x,L=G-x;if(!(p>G||L>v))for(var s=0;s<O;s++){var H=o.grid.LonBase+s*S,M=H+S;if(H<-180?H+=360:H>=180&&(H-=360),M<-180?M+=360:M>=180&&(M-=360),M<H&&(M+=360),m<=M&&H<_||m+360<=M&&H<_+360)for(var N=r(e,{z:w,y:l,x:s}),W=0;W<N.length;W++){var C=o.data_cache.get(N[W].file),F=o.grid.TileSize,U=o.grid.TileSize;(s+1)*P>o.grid.Width&&(F=Math.floor((o.grid.Width-s*P)/I)),(l+1)*P>o.grid.Height&&(U=Math.floor((o.grid.Height-l*P)/I)),g.push({file:N[W].file,index:N[W].index,element:N.length,width:o.grid.TileSize,height:o.grid.TileSize,active_width:F,active_height:U,n:G,w:H,s:L,e:M,latInterval:o.grid.LatInterval*I,lonInterval:o.grid.LonInterval*I,data:C?C.data:null})}}}}else for(var N=r(e),W=0;W<N.length;W++){var C=o.data_cache.get(N[W]),E=e.element;N.length>1&&(E=e.element[N[W].index]);var V=o.grid.MinValue,K=o.grid.MaxValue,k=o.grid.element&&o.grid.element[E];k&&(k.MinValue&&(V=k.MinValue),k.MaxValue&&(K=k.MaxValue)),g.push({file:N[W].file,index:N[W].index,element:N.length,width:o.grid.Width,height:o.grid.Height,active_width:o.grid.Width,active_height:o.grid.Height,n:o.grid.LatBase,w:o.grid.LonBase,s:o.grid.LatBase-o.grid.LatInterval*o.grid.Height,e:o.grid.LonBase+o.grid.LonInterval*o.grid.Width,latInterval:o.grid.LatInterval,lonInterval:o.grid.LonInterval,minValue:V,maxValue:K,data:C?C.data:null})}if(!h())for(var W=0;W<g.length;W++)g[W].data||(g[W].data={},o.data_cache.set(g[W].file,g[W].data),y(g[W].file,g[W].minValue,g[W].maxValue,function(e,t){var a={data:t};o.data_cache.set(e,a);for(var i=0;i<g.length;i++)if(g[i].file==e){g[i].data=a,h();break}}))},o.update_interval>0&&o.ref.load()},WRAP.DH.DataHandler.TMS=function(e,t,a){function i(e,t){var a=n.file;for(var i in e){var r=e[i];if(r){"satdb"==n.api&&"validtime"==i&&(12==n.satdb_timestamp_length?r=r.substr(0,8)+r.substr(9,4):14==n.satdb_timestamp_length&&(r=r.substr(0,8)+r.substr(9,6)));var o="%"+i+"%";a.indexOf(o)>=0&&(a=a.replace(o,r))}}if(t)for(var i in t){var o="%"+i+"%";a.indexOf(o)>=0&&(a=a.replace(o,t[i]))}return a}function r(e,t,a){var i="",r=0;for(var n in e){var o=e[n];if(Array.isArray(o)&&o.length)for(var l=o[0],s=0;s<o.length;s++)l+="+"+o[s];r++&&(i+="/"),i+=o}return i+="/"+t,a&&(i+="/"+a),i}var n=this;n.name=t.Name,n.ref=e,n.tile_cache=new WRAP.DH._cache(1e3),n.data_cache=new WRAP.DH._cache(200),n.api=t.Attributes.API,n.file=t.Attributes.File,n.grid=t.Attributes.DataGrid,n.bbox=n.grid.BoundingBox,n.ycoordinate=n.grid.YCoordinate||1,n.min_z=n.grid.MinZoom,n.max_z=n.grid.MaxZoom,n.update_interval=parseFloat(t.Attributes.UpdateInterval),this.load=function(e,i){var r=t.Attributes.TimeList;r&&WRAP.DH._getJSON(r,"Timelist",function(t){if(t.timelist)a.timelist=t.timelist,i("completed",e);else if(t.validtime)a.validtime=t.validtime,i("completed",e);else{if("satdb"==n.api){a.validtime=[];for(var r=0;r<t.length;r++){var o=t[r].split("_");if(o.length>0){var l=o[o.length-1];n.satdb_timestamp_length=l.length,l=l.substr(0,8)+"T"+l.substr(8,6),13==l.length&&(l+="00"),a.validtime.push(l)}}return a.validtime.sort(function(e,t){return e>t?-1:e<t?1:0}),void i("completed",e)}WRAP.DH._error(n.name+" Timelist format."),i("error",null)}n.update_interval>0&&setTimeout(function(){n.ref.load()},1e3*n.update_interval)})},this.getTile=function(e,t,a){var i=this.tile_cache.get(r(e,t,a));return i&&i.data?i.data:null},this.loadTile=function(e,t,a,o,l,s,d,f,u){d=null;var h=r(e,t,a);if(n.tile_cache.get(h))return void u();if(n.bbox){var c=f.north/60,g=f.south/60,v=f.west/60,m=f.east/60;if(n.bbox.North<g||n.bbox.South>c||(n.bbox.East<v||n.bbox.West>m)&&(n.bbox.East+360<v||n.bbox.West+360>m)){var p={empty:!0,data:new Uint8Array(262144)};return n.tile_cache.set(h,p),void u()}}var _=s,A=l,y=o;if(o>n.max_z){var b=Math.pow(2,o-n.max_z);y=n.max_z,A=Math.floor(l/b),_=Math.floor(s/b);var w="M/"+y+"/"+A+"/"+_,D=r(e,w,a),p=n.tile_cache.get(D);if(p&&p.data){if(p.data.canvas){var T=Math.floor(256/b),I=document.createElement("canvas");I.width=256,I.height=256;var P=I.getContext("2d"),x=P.getImageData(0,0,256,256),S=s-_*b,R=b-1-(l-A*b),O=p.data.data,G=x.data,L=R*T,H=S*T;if(b<256)for(var l=0;l<T;l++)for(var M=l*b,s=0;s<T;s++)for(var N=s*b,W=4*(256*(L+l)+(H+s)),C=O[W],F=O[W+1],U=O[W+2],E=O[W+3],V=0;V<b;V++)for(var K=4*(256*(M+V)+N),k=0;k<b;k++)G[K++]=C,G[K++]=F,G[K++]=U,G[K++]=E;else for(var K=0,W=4*(256*L+H),C=O[W],F=O[W+1],U=O[W+2],E=O[W+3],l=0;l<256;l++)for(var s=0;s<256;s++)G[K++]=C,G[K++]=F,G[K++]=U,G[K++]=E;var p={width:256,height:256,canvas:I,ctx:P,data:x.data};n.tile_cache.set(h,p),u()}else{var p={empty:!0,data:new Uint8Array(262144)};n.tile_cache.set(h,p),u()}return}h=D}n.ycoordinate==-1&&(A=Math.pow(2,y)-1-A);var z=i(e,{z:y,y:A,x:_});if(!z||z.indexOf("%")>=0){var p={empty:!0,data:new Uint8Array(262144)};return n.tile_cache.set(h,p),void u()}var j=new Image;j.crossOrigin="use-credentials",j.onload=function(){var e=document.createElement("canvas");e.width=256,e.height=256;var t=e.getContext("2d");t.drawImage(j,0,0);var a=t.getImageData(0,0,256,256),i={width:256,height:256,canvas:e,ctx:t,data:a.data};n.tile_cache.set(h,i),u()},j.onerror=function(){var e={empty:!0,data:new Uint8Array(262144)};n.tile_cache.set(h,e),u()},j.src=z},n.update_interval>0&&n.ref.load()},WRAP.DH.DataHandler.DataJSON=function(e,t,a){var i=this;i.name=t.Name,i.ref=e,i.conf=t,i.update_interval=parseFloat(t.Attributes.UpdateInterval),i.position=null,a.data={},this.load=function(e,r){var n=t.Attributes.PointFile,o=t.Attributes.DataFile;WRAP.DH.customer&&(n.indexOf("%user%")>=0&&(n=n.replace(/%user%/g,WRAP.DH.user)),n.indexOf("%customer%")>=0&&(n=n.replace(/%customer%/g,WRAP.DH.customer)),o.indexOf("%user%")>=0&&(o=o.replace(/%user%/g,WRAP.DH.user)),o.indexOf("%customer%")>=0&&(o=o.replace(/%customer%/g,WRAP.DH.customer))),WRAP.DH._getJSON(n,t.Name,function(t){a.data.position=t,a.data.data&&r("completed",e)}),WRAP.DH._getJSON(o,t.Name,function(t){a.data.data=t,a.data.position&&r("completed",e),i.update_interval>0&&setTimeout(function(){i.ref.load()},1e3*i.update_interval)})},this.reload=function(){this.load(i.reference,function(){})},i.update_interval>0&&i.ref.load()},WRAP.DH.DataHandler.GeoJSON=function(e,t,a){function i(e,t){var a=r.file;WRAP.DH.user&&a.indexOf("%user%")>=0&&(a=a.replace(/%user%/g,WRAP.DH.user)),WRAP.DH.customer&&a.indexOf("%customer%")>=0&&(a=a.replace(/%customer%/g,WRAP.DH.customer));for(var i in e){var n="%"+i+"%";a.indexOf(n)>=0&&(a=a.replace(n,e[i]))}if(t)for(var i in t){var n="%"+i+"%";a.indexOf(n)>=0&&(a=a.replace(n,t[i]))}return a}var r=this;if(r.data_cache=new WRAP.DH._cache(500),r.name=t.Name,r.file=t.Attributes.File,r.timelist=t.Attributes.TimeList,r.grid=t.Attributes.DataGrid){r.min_zoom=r.grid.MinZoom,r.max_zoom=r.grid.MaxZoom;var n=r.grid.BoundingBox;if(n){r.sx=n.West,r.sy=n.North,r.ex=n.East,r.ey=n.South;var o=r.ex-r.sx,l=r.sy-r.ey;r.size=o>=l?o:l}}r.ref=e,r.update_interval=parseFloat(t.Attributes.UpdateInterval),this.load=function(e,i){if(r.timelist)WRAP.DH._getJSON(r.timelist,"Timelist",function(t){t.timelist?(a.timelist=t.timelist,i("completed",e)):t.validtime?(a.validtime=t.validtime,i("completed",e)):(WRAP.DH._error(r.name+" Timelist format."),i("error",null)),r.update_interval>0&&setTimeout(function(){r.ref.load()},1e3*r.update_interval)});else if(r.file){if(r.tiled())return;var n=r.file;if(WRAP.DH.user&&n.indexOf("%user%")>=0&&(n=n.replace(/%user%/g,WRAP.DH.user)),WRAP.DH.customer&&n.indexOf("%customer%")>=0&&(n=n.replace(/%customer%/g,WRAP.DH.customer)),n.indexOf("%")>=0)return;WRAP.DH._getJSON(n,t.Name,function(t){a.data=t,i&&i("completed",e),r.update_interval>0&&setTimeout(function(){r.ref.load()},1e3*r.update_interval)})}},this.reload=function(){this.load(r.reference,function(){})},this.tiled=function(){return r.max_zoom},this.getTileList=function(e,t){var a=[];if(r.size>0){var n=Math.round((r.min_zoom+r.max_zoom)/2);if(t.tiles.length){var o=t.zoom,l=360/Math.pow(2,o);n=0;for(var s=r.size;s>l;)s/=2,n++}n<r.min_zoom?n=r.min_zoom:n>r.max_zoom&&(n=r.max_zoom);var d=Math.pow(2,n),f=r.size/d,u=Math.floor((r.ex-r.sx)/f);u*f==r.ex-r.sx&&u--;var h=Math.floor((r.sy-r.ey)/f);h*f==r.sy-r.ey&&h--;for(var c=0;c<t.tiles.length;c++){for(var g=t.tiles[c],v=g.cood,m=v[0],p=v[1],_=v[131070],A=v[131071],y=Math.floor((r.sy-m)/f),b=Math.floor((r.sy-_)/f),w=Math.floor((p-r.sx)/f),D=Math.floor((A-r.sx)/f),T=y;T<=b;T++)if(0<=T&&T<=h)for(var I=w;I<=D;I++)if(0<=I&&I<=u){var P=i(e,{z:n,y:T,x:I});a.indexOf(P)<0&&a.push(P)}if(p>=180||A>=180){w=Math.floor((p-360-r.sx)/f),D=Math.floor((A-360-r.sx)/f);for(var T=y;T<=b;T++)if(0<=T&&T<=h)for(var I=w;I<=D;I++)if(0<=I&&I<=u){var P=i(e,{z:n,y:T,x:I});a.indexOf(P)<0&&a.push(P)}}}}return a},this.getTiles=function(e){for(var t=[],a=0;a<e.length;a++){var i=this.data_cache.get(e[a]);if(!i||!i.data)return null;t.push(i.data)}return t},this.getData=function(e,t){if(this.tiled()){var a=this.getTileList(e,t);return this.getTiles(a)}t=null;var r=i(e),n=this.data_cache.get(r);return n&&n.data?[n.data]:null},this.loadData=function(e,a,n){if(this.tiled())for(var o=this.getTileList(e,a),l=0;l<o.length;l++){var s=o[l],d=this.data_cache.get(s);d||WRAP.DH._getJSON(s,t.Name,function(e,t){r.data_cache.set(t,e),n&&r.getTiles(o)&&n()},function(e){r.data_cache.set(e,{}),n&&r.getTiles(o)&&n()})}else{var s=i(e);if(!s||s.indexOf("%")>=0)return;var d=this.data_cache.get(s);if(d&&d.data)return[d.data];WRAP.DH._getJSON(s,t.Name,function(e){r.data_cache.set(s,e),n&&n()})}},r.update_interval>0&&r.ref.load()},WRAP.DH.DataHandler.IndexedGeoJSON=function(e,t,a){var i=this;i.name=t.Name,i.indexfile=t.Attributes.Index,i.datafile=t.Attributes.File,i.ref=e,i.update_interval=parseFloat(t.Attributes.UpdateInterval),this.load=function(e,t){i.indexfile&&WRAP.DH._getJSON(i.indexfile,"Index",function(r){if(r.index){a.index=r,a.data={},console.log("loaded index:"+i.indexfile);var n=r.index;if(n)for(var o in n){var l=i.datafile.replace("%id%",o);WRAP.DH._getJSON(l,"Indexed GeoJSON",function(i){var r=i.id;if(r){a.data[r]=i,n[r].loaded=!0,console.log("loaded data:"+r);for(var o in n)if(!n[o].loaded)return;console.log("load completed"),t("completed",e)}})}}else WRAP.DH._error(i.name+" Index format."),t("error",null);i.update_interval>0&&setTimeout(function(){i.ref.load()},1e3*i.update_interval)})},this.reload=function(){this.load(i.reference,function(){})},i.update_interval>0&&i.ref.load()},WRAP.DH.DataHandler.LiveCamera=function(e,t,a){var i=36e3,r=10,n=this;n.initial=!0,n.ref=e,n.name=t.Name,n.update_interval=parseFloat(t.Attributes.UpdateInterval),n.auto_update=!1,this.load=function(e,o){var l=e._path.length;if(l<3)console.log("Load LiveCamera Info (autou pdate="+n.auto_update+")"),a.data&&!n.auto_update||WRAP.DH._get(t.Attributes.CameraMaster,"LiveCamera Master",function(i){if(i){a.data||(a.data={});for(var r=i.split("\n"),l=0,s=0;s<r.length;s++){var d=r[s];d.length&&(l++,a.data[d]||(a.data[d]={}),a.data[d].active=!0)}var f=0;for(var u in a.data)if(a.data[u].active){delete a.data[u].active;var h=t.Attributes.CameraServer+"/info/public/camera_master/"+u;WRAP.DH.Test.Camera&&(h="./pri/data/LIVE_CAMERA/test/"+u+"/info.json"),WRAP.DH._getJSON(h,"LiveCamera Info",function(i){if(i){if(a.data[i.AREA]){var r=a.data[i.AREA];r.area_name=i.AREA,r.e_name=i.Shibakoen,r.l_name=i.LNAME,r.company=i.COMPNY,r.jpscsn=i.JPSCSN,r.lat=60*parseFloat(i.LATD),r.lon=60*parseFloat(i.LOND),r.dir=i.DIR!=-1?22.5*i.DIR:void 0,r.gid=i.GID,!n.initial||t.Attributes.InitialLoad?e.query("data").query(i.AREA).load(function(){++f>=l&&(n.initial=!1,o("completed",e))}):++f>=l&&(n.initial=!1,
o("completed",e))}}else++f>=l&&(n.initial=!1,o("completed",e))})}else delete a.data[u]}else WRAP.DH._error("LiveCamera Master not found."),o("error",null);n.auto_update&&n.update_interval>0&&setTimeout(function(){n.ref.load()},1e3*n.update_interval)});else if(l>=3){var s=e._path[2],d=WRAP.DH._currentTime(),f=WRAP.DH._setTime(d,-i),u=WRAP.DH._timeString(f,"","",""),h=WRAP.DH._timeString(d,"","",""),c=t.Attributes.CameraServer+"/date/public/"+s+"/"+u+"/"+h+"/";WRAP.DH.Test.Camera&&(c="./pri/data/LIVE_CAMERA/test/"+s+"/files.json"),WRAP.DH._getJSON(c,"LiveCamera File List",function(i){if(i&&i.keys&&a.data[s]){i.keys.sort(function(e,t){return e>t?-1:e<t?1:0});for(var n=a.data[s].image,d=a.data[s].image=[],f=0,u=0;u<i.keys.length;u++){var h=i.keys[u].split("."),c=WRAP.DH._time(h[0]),g=WRAP.DH._timeString(c),v=null,m=!1;if(n)for(var p=0;p<n.length;p++)if(n[p].time==g){m=!0,v=n[p].image;break}if(l>3||0==u||m){var _;if(d.push(_={time:g,image:v}),!m){var A=new Image;_.image=A,A.target=_,A.onload=function(){},A.onerror=function(){A.onerror=null,A.src="img/broken_img.png"};var c=WRAP.DH._time(g),y=WRAP.DH._timeString(c,"","",""),b=t.Attributes.CameraServer+"/img/public/"+s+"/"+y+".jpeg";WRAP.DH.Test.Camera&&(b="./pri/data/LIVE_CAMERA/test/"+s+"/"+y+".jpeg"),A.src=b}}if(++f>=r)break}}o("completed",e)})}},n.update_interval>0&&n.ref.load()};
//# sourceMappingURL=../build/js/WRAP.DH-1.2.0.4-min.js.map