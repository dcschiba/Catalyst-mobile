var WRAP;"undefined"==typeof WRAP&&(WRAP={}),WRAP.Geo={version:"1.1",setLayer:function(t){this.container={interactive_layers:t.interactive_layers,plot_layers:t.plot_layers,upper_layers:t.upper_layers,lower_layers:t.lower_layers},this.container.upper_layers||(this.container.container.upper_layers=[]),this.container.plot_layers&&(this.container.upper_layers=this.container.upper_layers.concat(this.container.plot_layers)),this.container.interactive_layers&&(this.container.upper_layers=this.container.upper_layers.concat(this.container.interactive_layers))},getSize:function(){return this.map.getSize()},getScreenPoint:function(t){return this.map.getScreenPoint(t)},getScreenLine:function(t){var e,i,n,o,r=[];if(t&&t.length>0){var a=t[0][1],s=t[0][0];e=i=a,n=o=s;var l=[a,s];r.push(l);for(var h=1;h<t.length;h++){var f=t[h][1],c=t[h][0],u=c-s;u<-180?c+=360:u>=180&&(c-=360),e<f&&(e=f),i>f&&(i=f),o>c&&(o=c),n<c&&(n=c);var l=[f,c];r.push(l),a=f,s=c}}if(o<-180){o+=360,n+=360;for(var h=0;h<r.length;h++)r[h][1]+=360}return this.map.getScreenLine(r,e,i,o,n)},getPoint:function(t){return this.map.getPoint(t)},getCenterPoint:function(){return this.map.getCenterPoint()},setCenterPoint:function(t){this.map.setCenterPoint(t)},getZoom:function(){return this.map.getZoom()},setZoom:function(t){this.map.setZoom(t)},getPerspective:function(t,e){return this.map.getPerspective(t,e)},getDistance:function(t,e){return this.map&&this.map.getDistance?this.map.getDistance(t,e):distance(t.lonDegree(),t.latDegree(),e.lonDegree(),e.latDegree())},getGCPoint:function(t,e,i){if(e<=0)return t;e/=1851.8518518518517;var n=WRAP.Geo.gcPos(t.latDegree(),t.lonDegree(),i,e);return new WRAP.Geo.Point(60*n.lat,60*n.lon)},addEventHandler:function(t,e){var i=this.Interaction[t];i&&i.push(e)},removeEventHandler:function(t,e){var i=this.Interaction[t];if(i){var n=i.indexOf(e);n>=0&&i.splice(n,1)}},switchMap:function(t){var e,i;WRAP.Geo.map&&(e=WRAP.Geo.map.getZoom(),i=WRAP.Geo.map.getCenterPoint()),WRAP.Geo.map.context&&(t.context.revision=WRAP.Geo.map.context.revision),t.context.revision++,WRAP.Geo.map=t,e&&i&&(WRAP.Geo.map.setZoom(e),WRAP.Geo.map.setCenterPoint(i)),setTimeout(function(){t.update(!0),WRAP.Geo.invalidate()},1e3)},setInteraction:function(t,e){var i=this;WRAP.Geo.Interaction.init(e,t),i.lastHit=null,i.lastClick=null,i.lastX=0,i.lastY=0,t.addEventListener("mousemove",function(e){if(!e._prevent){var n=t.getBoundingClientRect(),o=e.clientX-n.left,r=e.clientY-n.top;i.lastX=o,i.lastY=r;var a=e.which;if(a){if(i.lastClick&&i.lastClick.feature.draggable)return i.lastClick.feature.drag(o,r),void i.invalidate()}else i.lastClick&&(WRAP.Geo.enableScroll(!0),i.lastClick=null);var s=new WRAP.Geo.ScreenPoint(o,r),l=i.hit(s);if(l.pixel||!i.lastHit||l.feature!=i.lastHit.feature)if(l.feature&&l.feature.draggable&&WRAP.Geo.enableScroll(!1),i.lastHit&&i.lastHit.feature&&i.lastHit.feature.mouseout&&i.lastHit.feature.mouseout(o,r),l.feature&&l.feature.mouseover&&l.feature.mouseover(o,r),i.lastHit=l,i.lastHit.feature){var h,f=i.lastHit.layer,c=[];if(i._tooltipGroup)for(var u=0;u<i._tooltipGroup.length;u++){var d=i._tooltipGroup[u];if(d.indexOf(f)>=0){for(var v=0;v<d.length;v++){var g=d[v];if(g.visible())for(var p=g._dl.length-1;p>=0;p--){var _=g._dl[p],m=_.hit(s.x,s.y);if(m){c.push({layer:g,feature:_,x:m.x,y:m.y});break}}}break}}c.length||c.push(i.lastHit);for(var u=0;u<c.length;u++){var g=c[u].layer;if(g._tooltip_handler){h&&h.length?h+="<br/>":h="";var P=g._tooltip_handler(c[u].feature.geo,c[u].feature.data);P&&(h+=P)}}h&&h.length?(WRAP.Geo.currentFeature=i.lastHitfeature,WRAP.Geo.Interaction.setTooltip(h),WRAP.Geo.Interaction.showTooltip(i.lastHit.x,i.lastHit.y)):(WRAP.Geo.currentFeature=null,WRAP.Geo.Interaction.clearTooltip())}else WRAP.Geo.enableScroll(!0),WRAP.Geo.currentFeature=null,WRAP.Geo.Interaction.clearTooltip()}});var n,o;t.addEventListener("mousedown",function(e){n=e.clientX,o=e.clientY;var r=t.getBoundingClientRect(),a=e.clientX-r.left,s=e.clientY-r.top,l=i.hit(new WRAP.Geo.ScreenPoint(a,s));l&&l.feature&&(i.lastClick=l,i.lastClick.feature.draggable&&i.lastClick.feature.dragStart(a,s),l.feature.touch&&l.feature.touch(a,s))}),t.addEventListener("mouseup",function(t){if(i.lastClick)i.lastClick.feature.draggable&&i.lastClick.feature.dragEnd(),WRAP.Geo.enableScroll(!0),i.lastClick=null;else if(n==t.clientX&&o==t.clientY)for(var e=t.target.getBoundingClientRect(),r=t.clientX-e.left,a=t.clientY-e.top,s=WRAP.Geo.Interaction.touch,l=new WRAP.Geo.ScreenPoint(r,a),h=0;h<s.length;h++)s[h](null,null,l)}),t.addEventListener("mouseout",function(){WRAP.Geo.enableScroll(!0),WRAP.Geo.currentFeature=null,WRAP.Geo.Interaction.clearTooltip()})},currentTooltip:function(){var t=WRAP.Geo.Interaction.getTooltip();if(t&&WRAP.Geo.currentFeature)return{geo:WRAP.Geo.currentFeature.geo,data:WRAP.Geo.currentFeature.data,content:t}},addTooltipGroup:function(t){if(t&&t.length){this._tooltipGroup||(this._tooltipGroup=[]);for(var e=0;e<this._tooltipGroup;e++){var i=this._tooltipGroup[e];if(t.length==i.length){for(var n=0;n<t.length&&!(i.indexOf(t[n++])<0););if(n>=t.length)return}}this._tooltipGroup.push(t)}},removeTooltipGroup:function(t){if(t&&t.length&&this._tooltipGroup)for(var e=0;e<this._tooltipGroup;e++){var i=this._tooltipGroup[e];if(t.length==i.length){for(var n=0;n<t.length&&!(i.indexOf(t[n++])<0););if(n>=t.length)return void this._tooltipGroup.splice(e,1)}}},Point:function(t,e){this.set=function(t,e){this.lat=parseFloat(t),this.lon=parseFloat(e),this.lon<-10800?this.lon+=21600:this.lon>=10800&&(this.lon-=21600)},this.setDegree=function(t,e){set(parseFloat(t)*60..parseFloat(e)*60)},this.latDegree=function(){return this.lat/60},this.lonDegree=function(){return this.lon/60},this.set(t,e)},Bounds:function(t,e,i,n){this.contains=function(t){if(t.lat>this.north||t.lat<this.south)return!1;if(this.west<this.east){if(t.lon>this.east||t.lon<this.west)return!1}else if(t.lon>this.east&&t.lon<this.west)return!1;return!0},this.north=t,this.south=e,this.east=i,this.west=n},ScreenPoint:function(t,e){this.x=t,this.y=e},ScreenBounds:function(t,e,i,n){this.x=t,this.y=e,this.width=i,this.height=n},Layer:function(t){var e=this;this._name=t,this._visible=!0,this._style=null,this._content=null,this._attr=null,this._data=null,this._conf=null,this._dl=[],this._revision={data:0,conf:0,context:0,content:0,style:0},this.configure=function(t,i){this._data=t,this._conf=i,this._revision.conf++;var n=i.Renderer;n&&WRAP.Geo.Renderer[n]?this._renderer=new WRAP.Geo.Renderer[n]:e._error("Implementation WRAP.Geo.Renderer."+n+" not found."),this._data?this._data.inspect(function(){e._revision.data++,e.render()},!0):e.render()},this.show=function(){this.setVisible(!0)},this.hide=function(){this.setVisible(!1)},this.visible=function(){return this._visible},this.setVisible=function(t){if(this._visible!=t){if(this._visible=t,this.blended)for(var e=0;e<this.blended.length;e++)this.blended[e].invalidate();var i=WRAP.Geo.isBlended(this);i&&i.invalidate();var n=WRAP.Geo.Interaction.visibilityChange;if(n)for(var e=0;e<n.length;e++)n[e](this);this.render(),WRAP.Geo.invalidate()}},this.addFeature=function(t){t.layer=this,this._dl.push(t)},this.removeFeature=function(t){var e=this._dl.indexOf(t);e>=0&&this._dl.splice(e,1)},this.clear=function(){WRAP.Geo.map.clearDisplayCache&&WRAP.Geo.map.clearDisplayCache(this._dc),this._dc={},this._dl=[],WRAP.Geo.invalidate()},this.set=function(t){var i=JSON.parse(JSON.stringify(t));return this._timeController&&this._data&&!this._timeController.validate(this,i)?(this._content=i,void e.clear()):void(JSON.stringify(this._content)!=JSON.stringify(i)&&(this._content=i,e._revision.content++,e.render()))},this.get=function(){return this._content},this.setAttributes=function(t){this._content&&t&&JSON.stringify(this._content)==JSON.stringify(t)||(e._revision.conf++,this._attr=t,this.render())},this.name=function(){return this._name},this.setStyle=function(t){this._style!=t&&(e._revision.style++,this._style=t,this.render())},this.setTooltip=function(t){this._tooltip_handler=t},this.invalidate=function(){this._revision.conf++,this._revision.content++,this._revision.data++,this._dl=[],this.render()},this.merge=function(t){this.merged!=t&&(this.merged&&t&&this.merged.toString()==t.toString()||(this.merged=t,this.invalidate()))},this.blend=function(t){this.blended!=t&&(this.blended&&t&&this.blended.toString()==t.toString()||(this.blended=t,this._dl=[],this.invalidate()))},this.getBlendLayer=function(){return this.blended},this.getValue=function(t){if(this._renderer&&this._renderer.getValue){var e=this._content,i=WRAP.Geo.map.context,n=this._data;return this._renderer.getValue(e,i,n,t)}return null},this._currentConfiguration=function(){function t(e,i){for(var n in i)Array.isArray(i[n])?e[n]=i[n]:"object"==typeof i[n]?t(e[n]={},i[n]):e[n]=i[n]}function e(t,i){if(i)for(var n in i)"object"==typeof i[n]&&t[n]?e(t[n],i[n]):t[n]=i[n]}var i={};return t(i,this._conf),i.Attributes||(i.Attributes={}),e(i.Attributes,this._attr),i},this.render=function(){if(WRAP.Geo.map.context&&this._visible&&this._renderer&&this._renderer.draw){var t=this._data;if(t&&!t._handler())return;if(WRAP.Geo.isBlended(this))return this._revision.data++,this._revision.conf++,void(this._dl=[]);var e=this._content,i=this._currentConfiguration(),n=WRAP.Geo.map.context,o=this._style,r=this._revision,a=this._dl;r.context=n.revision,this._renderer.draw(this,e,i,n,o,t,r,a);for(var s=0;s<a.length;s++)a[s].layer=this}},this.renderMerge=function(t){var e=[];if(this._visible)if(this.merged&&this._renderer&&this._renderer.merge){var i=this._currentConfiguration(),n=this._style;this._renderer.merge(e,this._dl,i,n),this._merged_revision=t;for(var o=0;o<this.merged.length;o++){var r=this.merged[o];r._visible&&r._renderer&&r._renderer.merge&&(i=r._currentConfiguration(),n=r._style,r._renderer.merge(e,r._dl,i,n),r._merged_revision=t)}}else e=this._dl;return e},this.setTimeController=function(t){this._timeController=t},this._error=function(t){console.warn(this.name()+":"+t)}},Feature:{Point:function(t){this.draw=function(e){e.layer=this.layer,e.drawPoint(t.point,t.pointSize,t.lineWidth,t.strokeStyle,t.fillStyle)},this.hit=function(e,i){var n=t.pointSize;t.sensorSize&&(n=t.sensorSize);var o=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),r=o.x-n/2,a=r+n;if(e<r||a<e)return null;var s=o.y-n/2,l=s+n;return i<s||l<i?null:{x:o.x,y:o.y}},this.setDraggable=function(t,e){this.draggable=t,this.dragHandler=e},this.style=function(){return t},this.mouseover=function(){for(var e=WRAP.Geo.Interaction.mouseover,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),n=0;n<e.length;n++)e[n](this.layer,this,i)},this.mouseout=function(){for(var e=WRAP.Geo.Interaction.mouseout,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),n=0;n<e.length;n++)e[n](this.layer,this,i)},this.touch=function(){for(var e=WRAP.Geo.Interaction.touch,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),n=0;n<e.length;n++)e[n](this.layer,this,i)},this.dragStart=function(e,i){var n=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0]));this.anchor={lon:t.point[0],lat:t.point[1],ox:e,oy:i,x:n.x,y:n.y}},this.drag=function(e,i){if(this.anchor){var n=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(this.anchor.x+(e-this.anchor.ox),this.anchor.y+(i-this.anchor.oy)));t.point[0]=n.lonDegree(),t.point[1]=n.latDegree(),this.dragHandler&&this.dragHandler(this,t.point)}},this.dragEnd=function(){this.anchor=null}},Text:function(t){this.draw=function(e){e.layer=this.layer,e.drawText(t.point,t.text,t.fontSize,t.fillStyle,t.strokeStyle,t.offsetX,t.offsetY,t.align,t.rotation)},this.hit=function(e,i){var n=WRAP.Geo._internal_context;if(!n){var o=WRAP.Geo._internal_canvas=document.createElement("canvas");n=WRAP.Geo._internal_context=o.getContext("2d")}var r=t.fontSize;if(t.fontSize)n.font=t.fontSize+"px Arial";else{var a=n.measureText("W");r=1.5*a.width}var s=parseFloat(t.offsetX)||0,l=parseFloat(t.offsetY)||0,h=n.measureText(t.text);"left"==t.align?s+=0:s-="right"==t.align?h.width:.5*h.width;var f=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),c=f.x+s,u=f.y+l-r,d=c+h.width,v=u+r;return c<=e&&e<=d&&u<=i&&i<=v?{x:f.x,y:f.y}:null},this.mouseover=function(){for(var e=WRAP.Geo.Interaction.mouseover,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),n=0;n<e.length;n++)e[n](this.layer,this,i)},this.mouseout=function(){for(var e=WRAP.Geo.Interaction.mouseout,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),n=0;n<e.length;n++)e[n](this.layer,this,i)},this.touch=function(){for(var e=WRAP.Geo.Interaction.touch,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),n=0;n<e.length;n++)e[n](this.layer,this,i)},this.style=function(){return t}},Line:function(t){this.draw=function(e){e.layer=this.layer,e.drawLine(t.point,t.line,t.lineWidth,t.lineDash,t.strokeStyle,t.fillStyle,t.fillImage,t.option,t.rotation,this.id)},this.hit=function(t,e,i){return i.hit(t,e,this.id)?{x:t,y:e}:null},this.mouseover=function(t,e){for(var i=WRAP.Geo.Interaction.mouseover,n=new WRAP.Geo.ScreenPoint(t,e),o=0;o<i.length;o++)i[o](this.layer,this,n)},this.mouseout=function(t,e){for(var i=WRAP.Geo.Interaction.mouseout,n=new WRAP.Geo.ScreenPoint(t,e),o=0;o<i.length;o++)i[o](this.layer,this,n)},this.touch=function(t,e){for(var i=WRAP.Geo.Interaction.touch,n=new WRAP.Geo.ScreenPoint(t,e),o=0;o<i.length;o++)i[o](this.layer,this,n)},this.style=function(){return t}},Image:function(t){this.draw=function(e){e.layer=this.layer,t.image.data?(e.layer=this.layer,e.drawImageData(t.point,t.image,t.width,t.height,t.offsetX,t.offsetY,t.rotation)):e.drawImage(t.point,t.image,t.width,t.height,t.offsetX,t.offsetY,t.rotation)},this.hit=function(e,i){var n=t.width,o=t.height,r=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),a=r.x-n/2,s=a+n;if(e<a||s<e)return null;var l=r.y-o/2,h=l+o;return i<l||h<i?null:{x:r.x,y:r.y}},this.style=function(){return t},this.mouseover=function(){for(var e=WRAP.Geo.Interaction.mouseover,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),n=0;n<e.length;n++)e[n](this.layer,this,i)},this.mouseout=function(){for(var e=WRAP.Geo.Interaction.mouseout,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),n=0;n<e.length;n++)e[n](this.layer,this,i)},this.touch=function(){for(var e=WRAP.Geo.Interaction.touch,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),n=0;n<e.length;n++)e[n](this.layer,this,i)},this.set=function(e,i){this.layer=e,this.reference=i,this.mouseover=function(){for(var e=WRAP.Geo.Interaction.mouseover,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),n=0;n<e.length;n++)e[n](this.layer,this.reference,i)},this.mouseout=function(){for(var e=WRAP.Geo.Interaction.mouseout,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),n=0;n<e.length;n++)e[n](this.layer,this.reference,i)},this.touch=function(){for(var e=WRAP.Geo.Interaction.touch,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),n=0;n<e.length;n++)e[n](this.layer,this.reference,i)}}},GeoLine:function(t){this.draw=function(e){e.layer=this.layer,e.drawPath(t.path,t.lineWidth,t.lineDash,t.strokeStyle,t.fillStyle,t.fillImage,t.option,void 0===t.geodesic||t.geodesic,this.id)},this.hit=function(t,e,i){return i.hit(t,e,this.id)?{x:t,y:e}:null},this.mouseover=function(t,e){for(var i=WRAP.Geo.Interaction.mouseover,n=new WRAP.Geo.ScreenPoint(t,e),o=0;o<i.length;o++)i[o](this.layer,this,n)},this.mouseout=function(t,e){for(var i=WRAP.Geo.Interaction.mouseout,n=new WRAP.Geo.ScreenPoint(t,e),o=0;o<i.length;o++)i[o](this.layer,this,n)},this.touch=function(t,e){for(var i=WRAP.Geo.Interaction.touch,n=new WRAP.Geo.ScreenPoint(t,e),o=0;o<i.length;o++)i[o](this.layer,this,n)},this.style=function(){return t}},GeoArc:function(t){this.draw=function(e){e.layer=this.layer,e.drawArc(t.point,t.radius,t.start,t.end,t.lineWidth,t.strokeStyle,t.fillStyle,t.fillImage,this.id)},this.hit=function(t,e,i){return i.hit(t,e,this.id)?{x:t,y:e}:null},this.mouseover=function(t,e){for(var i=WRAP.Geo.Interaction.mouseover,n=new WRAP.Geo.ScreenPoint(t,e),o=0;o<i.length;o++)i[o](this.layer,this,n)},this.mouseout=function(t,e){for(var i=WRAP.Geo.Interaction.mouseout,n=new WRAP.Geo.ScreenPoint(t,e),o=0;o<i.length;o++)i[o](this.layer,this,n)},this.touch=function(t,e){for(var i=WRAP.Geo.Interaction.touch,n=new WRAP.Geo.ScreenPoint(t,e),o=0;o<i.length;o++)i[o](this.layer,this,n)},this.style=function(){return t}},Tile:function(t){this.draw=function(e){e.layer=this.layer,e.drawTile(t.tile,t.imageData)},this.hit=function(t,e){if(t<0||e<0)return null;var i,n=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(t,e));return this.layer&&(i=this.layer.getValue(n)),this.geo={geometry:{type:"Point",coordinates:[n.lonDegree(),n.latDegree()]},properties:i},{x:t,y:e,pixel:!0}},this.style=function(){return t}}},Animation:function(){this.setTimeRange=function(t,e){this._frame=t,this._interval=parseFloat(e),this._last_time=0,this._next_time=0,this._current=-1,this._time=0,this._setFrame(0),this._running=null,this._cb=null},this.setValidTimeRange=function(t,e,i,n){for(var o=[{validtime:t}],r=WRAP.DH._time(t),a=WRAP.DH._time(e),s=WRAP.DH._setTime(r,i);s<a;)o.push({validtime:WRAP.DH._timeString(s)}),s=WRAP.DH._setTime(s,i);return r<a&&o.push({validtime:e}),this._frame=o,this._interval=parseFloat(n),this._last_time=0,this._next_time=0,this._current=-1,this._time=0,this._setFrame(0),this._running=null,this._cb=null,o},this.setLayer=function(t){this._layer=t},this.setTimeController=function(t){this._controller=t},this.setTime=function(t){this._running=!1;for(var e=0;e<this._frame.length&&(t.basetime&&t.basetime!=this._frame[e].basetime||!(t.validtime<=this._frame[e].validtime));)e++;this._setFrame(e)},this.start=function(t){this._cb=t,this._running||(this._running=!0,this._current_time=WRAP.Geo.addAnimation(this),this._next_time=this._current_time+this._interval)},this.stop=function(){this._running=!1,WRAP.Geo.removeAnimation(this)},this.time=function(){return this._time},this._setFrame=function(t){if(!this._frame||!this._frame.length)return this._time=void 0,this._current=-1,!1;if(t<0&&(t=0),t>=this._frame.length&&(t=this._frame.length-1),this._current!=t){if(this._current=t,this._time=this._frame[t],this._layer)for(var e=0;e<this._layer.length;e++)this._layer[e].set(this._frame[t]);return this._controller&&this._controller.setDisplayTime(this._frame[t].validtime),!0}return!1},this._go=function(t){if(this._running&&this._next_time<=t){if(WRAP.Geo.upper_layers_updating)return void WRAP.Geo.drawTiles();this._next_time=t+this._interval,this._setFrame(this._current+1)&&this._cb&&this._cb(this._time),this._current>=this._frame.length-1&&this.stop()}}},Context:function(t){this.revision=0,this.tiles=[],this.setTileBand=function(t,e,i,n,o){if(this.zoom!=t||this.min_tile_x!=e||this.max_tile_x!=i||this.min_tile_y!=n||this.max_tile_y!=o){if(this.zoom=t,this.tile_band=Math.pow(2,t),this.canvas_band=256*this.tile_band,this.min_tile_x=e,this.max_tile_x=i,this.min_tile_y=n,this.max_tile_y=o,this.offset_x=256*(this.min_tile_x-this.tile_band/2),this.offset_y=256*(this.tile_band/2-1-this.max_tile_y),this.tiles.length){var r={};r.n=this.tiles[0].bounds.north/60,r.s=this.tiles[0].bounds.south/60;for(var a=1;a<this.tiles.length;a++)r.n<this.tiles[a].bounds.north/60&&(r.n=this.tiles[a].bounds.north/60),r.s>this.tiles[a].bounds.south/60&&(r.s=this.tiles[a].bounds.south/60)}r.w=(this.min_tile_x-this.tile_band/2)/this.tile_band*360,r.e=(this.max_tile_x+1-this.tile_band/2)/this.tile_band*360,this.bounds=r;var s=Math.pow(2,Math.floor(t)),l=this.tile_band/s;this.offset_x=Math.floor(256*(this.min_tile_x-s/2)*l),this.offset_y=Math.floor(256*(s/2-1-this.max_tile_y)*l),this.canvas||(this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"));var h=this.max_tile_y-this.min_tile_y+1,f=this.max_tile_x-this.min_tile_x+1;this.max_tile_x<this.min_tile_x&&(f=s-this.min_tile_x+this.max_tile_x+1),this.canvas.width=Math.floor(256*f*l),this.canvas.height=Math.floor(256*h*l);for(var c=Math.floor(t),u=0;u<h;u++)for(var d=this.max_tile_y-u,v=0;v<f;v++){var g=(this.min_tile_x+v)%s,p=this.findTile(c,d,g);p&&(p.canvas=this.canvas,p.ctx=this.ctx,p.offset_x=Math.floor(256*v*l),p.offset_y=Math.floor(256*u*l),p.width=Math.floor(256*(v+1)*l)-p.offset_x,p.height=Math.floor(256*(u+1)*l)-p.offset_y,p.racio=l)}}},this.lockTile=function(){for(var t=0;t<this.tiles.length;t++)this.tiles[t].locked=!0},this.clearLockedTile=function(){for(var t=this.tiles.length-1;t>=0;t--)this.tiles[t].locked&&this.tiles.splice(t,1)},this.findTile=function(t,e,i){for(var n=0;n<this.tiles.length;n++){var o=this.tiles[n];if(o.z==t&&o.y==e&&o.x==i)return o}return null},this.addTile=function(t,e,i,n,o,r){this.revision++,this.tiles.push({id:t+"/"+e+"/"+i+"/"+n,type:t,z:e,y:i,x:n,cood:o,bounds:r})},this.tile=function(t){for(var e=0;e<this.tiles.length;e++){var i=this.tiles[e];i.valid||t(i)}},this.drawImageData=function(e,i,n,o,r,a,s){function l(t,e,i,n,o,l){s?(t.save(),t.translate(i,n),t.rotate(s/180*Math.PI),t.drawImage(e,r,a,o,l),t.restore()):t.drawImage(e,i+r,n+a,o,l)}function h(t){var e=document.createElement("canvas");e.width=t.width,e.height=t.height;var i=e.getContext("2d");return i.putImageData(t,0,0),e}var f=this.ctx,c=t.getScreenPoint(new WRAP.Geo.Point(0,0)),u=this.offset_x+c.x,d=this.offset_y+c.y,v=t.getScreenPoint(new WRAP.Geo.Point(60*e[1],60*e[0])),g=v.x-u,p=v.y-d,_=1.5*(n>o?n:o),m=-_,P=this.canvas.width+_,y=-_,x=this.canvas.height+_;if(!(p<y||x<p)){var w=null;m<=g&&g<=P&&(w||(w=h(i)),l(f,w,g,p,n,o));var A=g-this.canvas_band;m<=A&&A<=P&&(w||(w=h(i)),l(f,w,A,p,n,o));var b=g+this.canvas_band;m<=b&&b<=P&&(w||(w=h(i)),l(f,w,b,p,n,o))}},this.drawImage=function(e,i,n,o,r,a,s){function l(t,e,i,n,o){s?(t.save(),t.translate(e,i),t.rotate(s/180*Math.PI),t.drawImage(f,r,a,n,o),t.restore()):t.drawImage(f,e+r,i+a,n,o)}var h=WRAP.Geo.imageCache[i];if(void 0==h)return h=WRAP.Geo.imageCache[i]={loaded:!1,image:new Image},h.image.onload=function(){h.loaded=!0,WRAP.Geo.invalidate()},void(h.image.src=i);if(h.loaded){var f=h.image;0==n&&(n=f.width),0==o&&(o=f.height);var c=this.ctx,u=t.getScreenPoint(new WRAP.Geo.Point(0,0)),d=this.offset_x+u.x,v=this.offset_y+u.y,g=t.getScreenPoint(new WRAP.Geo.Point(60*e[1],60*e[0])),p=g.x-d,_=g.y-v,m=1.5*(n>o?n:o),P=-m,y=this.canvas.width+m,x=-m,w=this.canvas.height+m;if(_<x||w<_)return;P<=p&&p<=y&&l(c,p,_,n,o);var A=p-this.canvas_band;P<=A&&A<=y&&l(c,A,_,n,o);var b=p+this.canvas_band;P<=b&&b<=y&&l(c,b,_,n,o)}},this.hit=function(t,e,i){if(!i)return!1;for(var n=WRAP.Geo.getScreenPoint(this.hitctx.anchor);n.x>=this.canvas_band;)n.x-=this.canvas_band;for(;n.x<0;)n.x+=this.canvas_band;t-=n.x,e-=n.y;var o=this.hitctx.getImageData(t,e,1,1);if(o&&o.data){var r=(o.data[0]<<16)+(o.data[1]<<8)+o.data[2];return i==r}return!1},this._drawLines=function(e,i,n,o,r,a,s,l){if(l&&(r||a)){l=parseInt(l);var h=(16711680&l)>>16,f=(65280&l)>>8,c=255&l;this.hitctx.fillStyle="rgb("+h+","+f+","+c+")",this.hitctx.beginPath();for(var u=0;u<e.length;u++){var d=e[u],v=d[0].x,g=d[0].y,p=0;for(this.hitctx.moveTo(v,g);++p<e[u].length;)v=d[p].x,g=d[p].y,this.hitctx.lineTo(v,g)}this.hitctx.closePath(),this.hitctx.fill("evenodd")}for(var _=this.ctx,m=t.getScreenPoint(new WRAP.Geo.Point(0,0)),P=t.getSize().width/2;m.x-P>=this.canvas_band/2;)m.x-=this.canvas_band;for(;m.x-P<-this.canvas_band/2;)m.x+=this.canvas_band;var y=this.offset_x+m.x,x=this.offset_y+m.y,w=0,A=this.canvas.height,b=0,G=this.canvas.width;"cloud"==s&&(w-=10,A+=10,b-=10,G+=10);var W=[];if(r)W=e;else for(var u=0;u<e.length;u++){for(var R=!1,S=15,p=-1;++p<e[u].length;){var M=0,v=e[u][p].x-y;v<b?M|=1:v>G&&(M|=2);var g=e[u][p].y-x;if(g<w?M|=4:g>A&&(M|=8),!(S|M&&S&M)){R=!0;break}S=M}R&&W.push(e[u])}if(W.length){_.beginPath();for(var u=0;u<W.length;u++){var d=W[u];if("cloud"==s||"counter_cloud"==s){var I=Math.PI/3;"counter_cloud"==s&&(I=-I);var k=Math.cos(I),T=Math.sin(I),F=10,v=d[0].x-y,g=d[0].y-x,p=0;_.moveTo(v,g);for(var L=v,C=g,z=F;++p<d.length;){for(var G=d[p].x-y,A=d[p].y-x,D=G-v,E=A-g,X=Math.sqrt(D*D+E*E),B=X,j=0;B>=z;){j+=z;var h=j/X,H=v+D*h,Y=g+E*h,N=H-L,O=Y-C,P=k*N-T*O+L,V=T*N+k*O+C;_.quadraticCurveTo(P,V,H,Y),L=H,C=Y,B-=z,z=F}z-=B,v=G,g=A}v=d[d.length-1].x-y,g=d[d.length-1].y-x,_.lineTo(v,g)}else{var v=d[0].x-y,g=d[0].y-x,p=0;for(_.moveTo(v,g);++p<W[u].length;)v=d[p].x-y,g=d[p].y-x,_.lineTo(v,g)}}if(r&&(_.closePath(),_.fillStyle=r,_.fill("evenodd")),a){_.closePath();var U=_.createPattern(a,"");_.fillStyle=U,_.fill("evenodd")}if(o){if(_.lineWidth=i||1,n&&_.setLineDash(n),_.strokeStyle=o,_.stroke(),"outset"==s||"inset"==s){_.beginPath();for(var u=0;u<W.length;u++){var d=W[u],I=Math.PI/3;"inset"==s&&(I=-I);for(var k=Math.cos(I),T=Math.sin(I),F=10,v=d[0].x-y,g=d[0].y-x,p=0,L=v,C=g,z=F;++p<d.length;){for(var G=d[p].x-y,A=d[p].y-x,D=G-v,E=A-g,X=Math.sqrt(D*D+E*E),B=X,j=0;B>=z;){j+=z;var h=j/X,H=v+D*h,Y=g+E*h,N=H-L,O=Y-C,Z=L+.5*(H-L),q=C+.5*(Y-C),P=k*N-T*O+L,V=T*N+k*O+C;_.moveTo(P,V),_.lineTo(Z,q),L=H,C=Y,B-=z,z=F}z-=B,v=G,g=A}}_.stroke()}n&&_.setLineDash([])}}},this._fragmentPath=function(t){for(var e=[],i=0;i<t.length;i++){var n=t[i][1],o=t[i][0];if(i>0){var r=t[i-1][1],a=t[i-1][0],s=o-a;s<-180?(s+=360,o+=360):s>=180&&(s-=360,a+=360);var l=Math.abs(s);if(l>1){var h=new WRAP.Geo.GreatCircle(r,a,n,o),f=r,c=a;e.push([c,f]);for(var u=0;u+1<l;){u+=1;var d=u/l,v=h.getPosition(d);e.push([v.lon,v.lat]),f=v.lat,c=v.lon}}else e.push([a,r])}e.push([o,n])}return e},this._addFragments=function(t,e){for(var i=WRAP.Geo.getScreenLine(e),n=0;n<i.length;n++)t.push(i[n])},this.drawPath=function(t,e,i,n,o,r,a,s,l){if(t&&t.length){var h={};if(r){var f=r;if(h=WRAP.Geo.imageCache[f],void 0==h)return h=WRAP.Geo.imageCache[f]={loaded:!1,image:new Image},h.image.onload=function(){h.loaded=!0,WRAP.Geo.invalidate()},void(h.image.src=f)}if(!r||h.loaded){var c=[];if(Array.isArray(t[0][0])){for(var u=0;u<t.length;u++)if(!(t[u].length<2)){var d=t[u];s&&(d=this._fragmentPath(t[u])),this._addFragments(c,d)}if(!c.length)return}else{if(t.length<2)return;var d=t;s&&(d=this._fragmentPath(t)),this._addFragments(c,d)}this._drawLines(c,e,i,n,o,h.image,a,l)}}},this.drawArc=function(t,e,i,n,o,r,a,s,l){var h={};if(s){var f=s;if(h=WRAP.Geo.imageCache[f],void 0==h)return h=WRAP.Geo.imageCache[f]={loaded:!1,image:new Image},h.image.onload=function(){h.loaded=!0,WRAP.Geo.invalidate()},void(h.image.src=f)}if(!s||h.loaded){var c=[],u=!1;if(i==n||Math.abs(n-i)>360){var u=!0;i=0,n=360}var d=1;e<5e5?d=5:e<1e5&&(d=2),e/=1851.8518518518517;for(var v=i;v<n;v+=d){var g=WRAP.Geo.gcPos(t[1],t[0],v,e);c.push([g.lon,g.lat])}var g=WRAP.Geo.gcPos(t[1],t[0],n,e);if(c.push([g.lon,g.lat]),c.length<2)return;var p=[],_=this._fragmentPath(c);if(this._addFragments(p,_),u)this._drawLines(p,o,null,r,a,h.image,null,l);else{if(a||h.image){var m=[];c.push(t),c.unshift(t);var _=this._fragmentPath(c);this._addFragments(m,_),this._drawLines(m,o,null,null,a,h.image,null,l)}this._drawLines(p,o,null,r,null,null,null,l)}}},this.drawPoint=function(e,i,n,o,r){function a(t,e,a){r&&(t.fillStyle=r,t.beginPath(),t.arc(e,a,i/2-1,0,2*Math.PI,!0),t.closePath(),t.fill()),o&&(t.strokeStyle=o,t.lineWidth=n||1,t.beginPath(),t.arc(e,a,i/2-1,0,2*Math.PI,!0),t.closePath(),t.stroke())}var s=t.getScreenPoint(new WRAP.Geo.Point(60*e[1],60*e[0])),l=this.ctx,h=t.getScreenPoint(new WRAP.Geo.Point(0,0)),f=this.offset_x+h.x,c=this.offset_y+h.y,u=s.x-f,d=s.y-c,v=-i,g=this.canvas.width+i,p=-i,_=this.canvas.height+i;if(!(d<p||_<d)){v<=u&&u<=g&&a(l,u,d);var m=u-this.canvas_band;v<=m&&m<=g&&a(l,m,d);var P=u+this.canvas_band;v<=P&&P<=g&&a(l,P,d)}},this.drawLine=function(e,i,n,o,r,a,s,l,h,f){function c(t,e,i){if(!(e.length<2)){for(var n,o,r=[],a=0;a<e.length;a++){var s=e[a][0],l=e[a][1];if(h){var f=s*p-l*_,c=s*_+l*p;s=f,l=c}s+=g.x,l+=g.y,0==a?n=o=s:(n>s&&(n=s),o<s&&(o=s)),r.push(new WRAP.Geo.ScreenPoint(s,l))}t.push(r);var d=u.x-i/2,v=d-i,m=u.x+i/2,P=m+i;if(n<d&&o>v){for(var y=[],a=0;a<r.length;a++)y.push(new WRAP.Geo.ScreenPoint(r[a].x+i,r[a].y));t.push(y)}if(n<P&&o>m){for(var y=[],a=0;a<r.length;a++)y.push(new WRAP.Geo.ScreenPoint(r[a].x-i,r[a].y));t.push(y)}}}var u={};if(s){var d=s;if(u=WRAP.Geo.imageCache[d],void 0==u)return u=WRAP.Geo.imageCache[d]={loaded:!1,image:new Image},u.image.onload=function(){u.loaded=!0,WRAP.Geo.invalidate()},void(u.image.src=d)}if(!s||u.loaded){for(var u=t.getScreenPoint(new WRAP.Geo.Point(0,0)),v=t.getSize().width/2;u.x-v>=this.canvas_band/2;)u.x-=this.canvas_band;for(;u.x-v<-this.canvas_band/2;)u.x+=this.canvas_band;for(var g=t.getScreenPoint(new WRAP.Geo.Point(60*e[1],60*e[0]));g.x-u.x>this.offset_x+this.canvas_band;)g.x-=this.canvas_band;for(;g.x-u.x<this.offset_x;)g.x+=this.canvas_band;var p,_;h&&(p=Math.cos(Math.PI*h/180),_=Math.sin(Math.PI*h/180));var m=[];if(Array.isArray(i[0][0]))for(var P=0;P<i.length;P++)c(m,i[P],this.canvas_band);else c(m,i,this.canvas_band);if(!m.length)return;this._drawLines(m,n,o,r,a,u.image,l,f)}},this.drawText=function(e,i,n,o,r,a,s,l,h){function f(t,e,n,o,a){h?(t.save(),t.translate(e,n),t.rotate(h/180*Math.PI),t.translate(o,a),r&&(t.lineWidth=2,t.strokeStyle=r,t.strokeText(i,0,0)),t.fillText(i,0,0),t.restore()):(r&&(t.lineWidth=2,t.strokeStyle=r,t.strokeText(i,e+o,n+a)),t.fillText(i,e+o,n+a))}var c=this.ctx;n&&(c.font=n+"px Arial"),o&&(c.fillStyle=o);var u=parseFloat(a)||0,d=parseFloat(s)||0,v=c.measureText(i);"left"==l?u+=0:u-="right"==l?v.width:.5*v.width;var g=t.getScreenPoint(new WRAP.Geo.Point(0,0)),p=this.offset_x+g.x,_=this.offset_y+g.y,m=t.getScreenPoint(new WRAP.Geo.Point(60*e[1],60*e[0])),P=m.x-p,y=m.y-_,x=v.width,w=-x,A=this.canvas.width+x,b=-x,G=this.canvas.height+x;if(!(y<b||G<=y)){w<=P&&P<=A&&f(c,P,y,u,d);var W=P-this.canvas_band;w<=W&&W<=A&&f(c,W,y,u,d);var R=P+this.canvas_band;w<=R&&R<=A&&f(c,R,y,u,d)}},this.drawTile=function(t,e){this.tile(function(i){if(i.id==t.id){var n=document.createElement("canvas");n.width=256,n.height=256;var o=n.getContext("2d");o.putImageData(e,0,0,0,0,256,256),o.fillStyle="rgba(0,0,0,0.0)",o.fillRect(0,0,1,1),i.ctx.drawImage(n,i.offset_x,i.offset_y,t.width,t.height)}})},this.begin=function(e){this.hitcvs||(this.hitcvs=document.createElement("canvas"),this.hitctx=this.hitcvs.getContext("2d"));var i=t.getSize();if(this.hitcvs.width==i.width&&this.hitcvs.width==i.width||(this.hitcvs.width=i.width,this.hitcvs.height=i.height),this.hitctx.anchor=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(0,0)),this.hitctx.clearRect(0,0,i.width,i.height),this.ctx){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(var n=0;n<this.tiles.length;n++){var o=this.tiles[n];o.revision!=e&&(o.valid=!1)}}},this.end=function(e){this.rev++;for(var i=0;i<this.tiles.length;i++){var n=this.tiles[i];n.context_rev=this.rev,n.revision!=e&&(n.revision=e,n.valid=!0),t.setTile(n,e)}t.update()},this.rev=0},GreatCircle:function(t,e,i,n){if(this.p1=[],this.p2=[],this.omeda=0,this.heading=0,this.neg=!1,n<e){this.neg=!0;var o;o=e,e=n,n=o,o=t,t=i,i=o}this.offset=e,e=0,n-=this.offset,t*=Math.PI/180,e*=Math.PI/180,i*=Math.PI/180,n*=Math.PI/180,this.p1[0]=Math.cos(t)*Math.cos(e),this.p1[1]=Math.cos(t)*Math.sin(e),this.p1[2]=Math.sin(t),this.p2[0]=Math.cos(i)*Math.cos(n),this.p2[1]=Math.cos(i)*Math.sin(n),this.p2[2]=Math.sin(i),this.omega=Math.acos(this.p1[0]*this.p2[0]+this.p1[1]*this.p2[1]+this.p1[2]*this.p2[2]),this.sinomega=Math.sin(this.omega);var r=Math.cos(t)*this.simomega;if(Math.abs(r)>.001){var a=(Math.sin(i)-Math.sin(t)*Math.cos(this.omega))/r;a<-1&&(a=-1),a>1&&(a=1),this.heading=Math.acos(a);for(var s=n-e;s<-Math.PI;)s+=2*Math.PI;for(;s>Math.PI;)s-=2*Math.PI;s<0&&(this.heading=2*Math.PI-this.heading)}else this.heading=0;this.getDistance=function(){var t=3443.96;return this.omega*t},this.getPosition=function(t){this.neg&&(t=1-t);var e=Math.sin((1-t)*this.omega)/this.sinomega,i=Math.sin(t*this.omega)/this.sinomega,n=[];n[0]=this.p1[0]*e+this.p2[0]*i,
n[1]=this.p1[1]*e+this.p2[1]*i,n[2]=this.p1[2]*e+this.p2[2]*i;var o=Math.atan2(n[1],n[0])*(180/Math.PI),r=Math.asin(n[2])*(180/Math.PI);return o+=this.offset,{lat:r,lon:o}}},Bridge:{},Renderer:{},Interaction:{mouseover:[],mouseout:[],touch:[],boundsChange:[],visibilityChange:[]},timer:null,rendering:!1,redrawQueue:[],valid:!0,redraw:function(t){this.redrawQueue.indexOf(t)<0&&this.redrawQueue.push(t)},dl:[],renderContext:function(t){var e=this,i=e.map.context,n=e.dl;if(n&&i){t&&e.revision++,i.begin(e.revision);for(var o=1e3,r=0;r<n.length;r++)for(var a=n[r],s=a.length,l=0;l<s;l++)a[l].id=o++,a[l].draw(i);e.valid=!0,i.end(e.revision)}},render:function(){var t=this;t.valid=!1,this.timer||(this.timer=setInterval(function(){if(t.redrawQueue.length)for(var e;e=t.redrawQueue.shift();)e.visible()&&e.render();else if(!t.valid){var i=t.map.context;if(!i.tiles.length)return;var n=t.container.upper_layers;if(!n||!n.length)return;if(t.rendering)return;t.rendering=!0;for(var o=n.length-1;o>=0;o--){var e=n[o];e.visible()&&e.merged&&e.merged.length&&(e._merged_dl=e.renderMerge(t.revision))}for(var r=[],o=n.length-1;o>=0;o--){var e=n[o];e.visible()&&(e._merged_dl?r.push(e._merged_dl):e._merged_revision!=t.revision&&r.push(e._dl))}for(var o=n.length-1;o>=0;o--){var e=n[o];e._merged_dl=null}if(t.dl=r,t.renderContext(),t.rendering=!1,void 0!==t.lastX){var a=t.hit(new WRAP.Geo.ScreenPoint(t.lastX,t.lastY));t.lastHit&&a.feature==t.lastHit.feature||(a.feature&&a.feature.draggable&&WRAP.Geo.enableScroll(!1),t.lastHit=a)}}},20))},invalidate:function(){this.revision++,this.render()},lastZoom:-1,lastContext:-1,updateBounds:function(t){WRAP.Geo.Interaction&&(WRAP.Geo.lastHit=null,WRAP.Geo.Interaction.clearTooltip());var e=WRAP.Geo.Interaction.boundsChange;if(e)for(var i=0;i<e.length;i++)e[i](t);var n=this.lastContext!=this.map.context.revision;this.lastContext=this.map.context.revision;var o=WRAP.Geo.container.upper_layers;if(o&&o.length){for(var r=o.length-1;r>=0;r--)o[r].render();n&&this.render()}},isBlended:function(t){var e=WRAP.Geo.container.upper_layers;if(!e)return!1;for(var i=0;i<e.length;i++)if(e[i].visible()&&e[i].blended&&e[i].blended.indexOf(t)>=0)return e[i];return!1},hit:function(t){for(var e=this.map.getSize(),i=this.map.context,n=i.canvas_band,o=t.x,r=t.y,a=[0],s=1;o-n*s>-n;s++)a.push(-n*s);for(var s=1;o+n*s<e.width+n;s++)a.push(n*s);if(this.container&&this.container.upper_layers)for(var l=0;l<this.container.upper_layers.length;l++){var h=this.container.upper_layers[l];if(h.visible())for(var f=0;f<a.length;f++){var c=a[f];o=t.x+c;for(var u=h._dl.length-1;u>=0;u--){var d=h._dl[u],v=d.hit(o,r,i);if(v)return{layer:h,feature:d,x:v.x-c,y:v.y,pixel:v.pixel}}}}return{layer:null,geo:null}},addAnimation:function(t){var e=this;this.animations.push(t);var i=new Date;return this.animation_timer||(this.animation_start=i,this.animation_timer=setInterval(function(){for(var t=new Date,i=(t-e.animation_start)/1e3,n=0;n<e.animations.length;n++)e.animations[n]._go(i)},15)),(i-this.animation_start)/1e3},removeAnimation:function(t){var e=this.animations.indexOf(t);e>=0&&this.animations.splice(e,1),!this.animations.length&&this.animation_timer&&(clearInterval(this.animation_timer),this.animation_timer=null,this.animation_start=null)},TimeController:function(){this._layers=[];var t=this;this.setDisplayTime=function(e){t._current_time=e;for(var i=0;i<t._layers.length;i++){var n=t._layers[i],o=n.get();o&&n.set(o)}},this.displayTime=function(){return t._current_time},this.addLayer=function(e){t._layers.indexOf(e)<0&&(e.setTimeController(this),t._layers.push(e)),this.setDisplayTime(t._current_time)},this.removeLayer=function(e){var i=t._layers.indexOf(e);indexOf>=0&&(t._layers[i].setTimeController(null),t._layers.splice(i,1))},this.validate=function(e,i){if(!i)return!1;if(t._current_time&&e._data){if(e._data.validator)return e._data.validator(t._current_time,e._data,i);var n,o=e._data.query("timelist").value();if(o&&i.basetime){for(var r=0;r<o.length;r++)if(o[r].basetime==i.basetime){n=o[r].validtime;break}}else n=e._data.query("validtime").value();if(n){n=n.concat(),n.sort(function(t,e){return t<e?-1:t>e?1:0});for(var a=WRAP.DH._time(t._current_time),s=86400,r=0;r<n.length;r++){var l=WRAP.DH._time(n[r]),h=r<n.length-1?WRAP.DH._time(n[r+1]):WRAP.DH._setTime(l,s);if(l<=a&&a<h)return i.validtime=WRAP.DH._timeString(l),!0;s=WRAP.DH._elapsed(l,h)}}}return i.validtime=null,!1}},parseColor:function(t){var e=document.createElement("canvas");e.width=1,e.height=1;var i=e.getContext("2d");return i.fillStyle=t,i.fillRect(0,0,1,1),i.getImageData(0,0,1,1).data},enableScroll:function(t){this.map.enableScroll&&this.map.enableScroll(t)},gcPos:function(t,e,i,n){function o(t){return t*Math.PI*h}function r(t){return t*l*c}var a,s=n,l=10800,h=9259259e-11,f=Math.PI/2,c=1/Math.PI,u=60*t,d=60*e,v=180-i,g=i/180*Math.PI,p=Math.cos(g),_=o(s),m=(.5-u*h)*Math.PI,P=Math.cos(_),y=Math.cos(m),x=Math.sin(_),w=Math.sin(m),A=P*y+x*w*p;a=A>1?0:A<-1?Math.PI:Math.acos(A);var b=f-a;b=r(b);var G,W=Math.sin(a),R=(P*w-x*y*p)/W;G=R>1?0:R<-1?Math.PI:Math.acos(R);var S;return S=v>0?o(d)+G:o(d)-G,S=r(S),S>l?S=2*-l+S:S<-l&&(S=2*l+S),{lat:b/60,lon:S/60}},_tileCheck:function(t,e){for(var i=e._dl,n=0;n<t.tiles.length;n++){var o,r=t.tiles[n],a=65792,s=r.cood[a],l=r.cood[a+1];o=new WRAP.Geo.Feature.Text({point:[l,s],text:r.id,fontSize:14,fillStyle:"rgb(255,0,0)",offsetX:0,offsetY:0,align:"center"}),i.push(o),o=new WRAP.Geo.Feature.Text({point:[l,s],text:"lat="+s,fontSize:14,fillStyle:"rgb(0,0,200)",offsetX:-50,offsetY:-40,align:"left"}),i.push(o),o=new WRAP.Geo.Feature.Text({point:[l,s],text:"lon="+l,fontSize:14,fillStyle:"rgb(0,0,200)",offsetX:-50,offsetY:-20,align:"left"}),i.push(o),o=new WRAP.Geo.Feature.Line({point:[l,s],line:[[-120,-120],[120,-120],[120,120],[-120,120],[-120,-120]],lineWidth:1,strokeStyle:"rgb(40,40,200)"}),i.push(o),o=new WRAP.Geo.Feature.Line({point:[l,s],line:[[-124,-124],[124,-124],[124,124],[-124,124],[-124,-124]],lineWidth:1,strokeStyle:"rgb(40,200,40)"}),i.push(o)}},container:{},timer:null,animation_timer:null,animation_start:null,animations:[],revision:1,tiles:[],imageCache:{},distance:function(t,e,i,n){var o=6378137,r=6356752.314245,a=Math.sqrt((o*o-r*r)/(o*o)),s=o*(1-a*a);t=t*Math.PI/180,e=e*Math.PI/180,i=i*Math.PI/180,n=n*Math.PI/180;var l=i-t,h=n-e,f=(n+e)/2,c=Math.sqrt(1-a*a*Math.sin(f)*Math.sin(f)),u=s/c/c/c,d=o/c,v=h*u*(h*u)+l*d*Math.cos(f)*(l*d*Math.cos(f));return Math.sqrt(v)},check:function(){}},WRAP.Geo.Interaction=function(){function t(t,e,i){if(t&&e&&e.value){var e=e&&e.value();if(e){var n;if(0==t.name().indexOf("LiveCamera")){var o;if((o=u(e.area_name))||(o=new v(e)),d(o),_!=o){var r=_;_&&_.tooltip&&_.hide(),_=o,r&&r.set(),_.visible||(_.tooltip=!0,o.show(e.lat,e.lon)),_.set()}}else t._tooltip_handler&&(n=t._tooltip_handler(e));if(n&&n.length)return s(n),void f(i.x,i.y)}l()}}function e(t){if(t&&(l(),0==t.name().indexOf("LiveCamera"))){_&&_.tooltip&&_.hide();var e=_;_=null,e&&e.set()}}function i(t,e){t&&(l(),0==t.name().indexOf("LiveCamera")&&_&&_.tooltip&&(e.query("image").load(function(){}),_.tooltip=!1,_.set()))}function n(){for(var t=0;t<S.length;t++){var e=S[t];if(e.pinned){var i=WRAP.Geo.getScreenPoint(e.window.point);i.x+=M,i.y+=M,e.window.style.left=i.x+"px",e.window.style.top=i.y+"px"}}}function o(t){if(0==t.name().indexOf("LiveCamera")){for(var e=0;e<S.length;e++){var i=S[e];t.visible()?i.window.style.display=i.visible?"block":"none":(i.window.style.display="none",i.setImage(0)),i.animating=!1}WRAP.Geo.Interaction.live_camera._data.handler&&(WRAP.Geo.Interaction.live_camera._data.handler.auto_update=t.visible())&&WRAP.Geo.Interaction.live_camera.load()}}function r(t){var e=document.createElement("style"),i=document.createTextNode(t);e.media="screen",e.type="text/css",e.styleSheet?e.styleSheet.cssText=i.nodeValue:e.appendChild(i),document.getElementsByTagName("head")[0].appendChild(e)}function a(){if(!p){p=document.createElement("div"),g.appendChild(p),p.style.display="block",p.style.top="-1000px",p.style.left="-1000px";var t=".tooltip {position: absolute;background: "+b+";color: "+G+";border: 1px solid "+W+";padding: 10px;    border-radius: 6px;    z-index: "+A+";    pointer-events: none;}.lt-arrow:after, .lt-arrow:before {right: 100%;top: "+R+"px;border: solid transparent;content: ' ';height: 0;width: 0;position: absolute;}.lt-arrow:after {    border-right-color: "+b+";    border-width: 8px;    margin-top: -8px;}.lt-arrow:before {    border-right-color: "+W+";    border-width: 9px;    margin-top: -9px;}.lb-arrow:after, .lb-arrow:before {right: 100%;bottom: "+R+"px;border: solid transparent;content: ' ';height: 0;width: 0;position: absolute;}.lb-arrow:after {    border-right-color: "+b+";    border-width: 8px;    margin-top: -8px;}.lb-arrow:before {    border-right-color: "+W+";    border-width: 9px;    margin-top: -9px;}.rt-arrow:after, .rt-arrow:before {left: 100%;top: "+R+"px;border: solid transparent;content: ' ';height: 0;width: 0;position: absolute;}.rt-arrow:after {    border-left-color: "+b+";    border-width: 8px;    margin-top: -8px;}.rt-arrow:before {    border-left-color: "+W+";    border-width: 9px;    margin-top: -9px;}.rb-arrow:after, .rb-arrow:before {left: 100%;bottom: "+R+"px;border: solid transparent;content: ' ';height: 0;width: 0;position: absolute;}.rb-arrow:after {    border-left-color: "+b+";    border-width: 8px;    margin-top: -8px;}.rb-arrow:before {    border-left-color: "+W+";    border-width: 9px;    margin-top: -9px;}";r(t)}}function s(t){p&&(p.innerHTML=t)}function l(){p&&(p.style.display="none",p.innerHTML="")}function h(){return"block"==p.style.display?p.innerHTML:null}function f(t,e){if(p&&p.innerHTML){var i=p.parentNode.clientWidth,n=p.parentNode.clientHeight;if(t<0||t>=i||e<0||e>=n)return void(p.style.display="none");p.style.display="block";var o=p.clientWidth,r=p.clientHeight;o>=i&&(o=0);var a,s,l=26,h=14,f=h+R;t+o+2*l>=i?(t-=o+l,a=" r"):(t+=l,a=" l"),e<f?e=h:e>=n-h-R?e=n-h-r:e+r-R>=n-f?(e-=r-R-2,e>h?s="b-arrow":e=h):(e-=R,e>h?s="t-arrow":e=h);var c="tooltip";a&&s&&(c+=a+s),p.style.top=""+e+"px",p.style.left=""+t+"px",p.setAttribute("class",c)}}function c(t){if(t){WRAP.Geo.Interaction.live_camera=t;var e=".smooth_tran {-webkit-transition-duration : 0.2s;-moz-transition-duration : 0.2s;-o-transition-duration : 0.2s;-ms-transition-duration : 0.2s;}.current_window {box-shadow : 0px 0px 50px #fff;border: 1px solid #fff;}.live_camera {position: absolute;background-color: "+E+";border: 1px solid "+X+";user-select: none;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;}.small_window {width: "+B+"px;height: "+(j+z)+"px;}.middle_window {width: "+H+"px;height: "+(Y+z+D)+"px;}.image_s {position: absolute;width: 100%;height: "+j+"px;top: "+z+"px;background-color: #bbb;}.image_m {position: absolute;width: 100%;height: "+Y+"px;top: "+z+"px;background-color: #bbb;}.camera_button {position: absolute;width:20px;height:20px;padding:0;border:solid 1px rgba(0,0,0,0);border-radius:4px;cursor:pointer;user-select: none;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;}.camera_button:hover {border:solid 1px rgba(150,150,150,0.8);}.camera_zoomin {top:3px; right:28px;background:url(img/bt_zoomIn.png) no-repeat left top;}.camera_zoomout {top:3px; right:28px;background:url(img/bt_zoomOut.png) no-repeat left top;}.camera_close {top:3px; right:4px;background:url(img/closebtn.png) no-repeat left top;}.camera_text {user-select: none;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;cursor:default;position: absolute;font-size:11px;color:black;width:100px;height:10px;}.camera_name {top:0px; left:4px;}.camera_time {top:11px; left:4px;}.camera_time_button {font-size:10px;color:black;position: absolute;bottom:1px;width:32px;height:18px;padding:0;vertical-align:middle;border:solid 1px rgba(120,120,120,1.0);border-radius:4px;background-color: "+E+";cursor:pointer;}.camera_time_button:hover {background: #fefeff;}.camera_time_button:disabled {color:#999;border:solid 1px rgba(170,170,170,0.8);pointer-events: none;cursor:default;}";r(e),t.inspect(function(){for(var t=0;t<S.length;t++){var e=S[t];e.visible&&!e.animating&&0==e.index&&e.setImage(e.index)}})}}function u(t){for(var e=0;e<S.length;e++)if(S[e].camera.area_name==t)return S[e];return null}function d(t){for(var e=k,i=0;i<S.length;){var n=S[i];if(n==t){for(var o=i+1;o<S.length;)n=S[o-1]=S[o],n.window.style["z-index"]=e++,o++;S[o-1]=t;break}n.window.style["z-index"]=e++,i++}i==S.length&&S.push(t),t.window.style["z-index"]=e}function v(t){var e=this;this.camera=t,this.visible=!1,this.small=!0,this.pinned=!0,this.tooltip=!0,this.animating=!1,this.smooth=!1;var i=this.window=document.createElement("div");i.controller=this,i.style.display="none",i.setAttribute("class","live_camera small_window");var n=this.canvas=document.createElement("div");n.width=T,n.height=F,n.setAttribute("class","image_s"),i.appendChild(this.name=document.createElement("div")),this.name.setAttribute("class","camera_text camera_name"),i.appendChild(this.time=document.createElement("div")),this.time.setAttribute("class","camera_text camera_time"),i.appendChild(this.zoom=document.createElement("button")),this.zoom.setAttribute("class","camera_button camera_zoomin"),i.appendChild(this.close=document.createElement("button")),this.close.setAttribute("class","camera_button camera_close");var o;i.appendChild(o=this.time_frst=document.createElement("button")),o.setAttribute("class","camera_time_button"),o.innerHTML="|＜",o.style.left="100px",o.style.display="none",i.appendChild(o=this.time_prev=document.createElement("button")),o.setAttribute("class","camera_time_button"),o.innerHTML="＜",o.style.left="140px",o.style.display="none",i.appendChild(o=this.time_play=document.createElement("button")),o.setAttribute("class","camera_time_button"),o.innerHTML="▶",o.style.left="180px",o.style.display="none",i.appendChild(o=this.time_next=document.createElement("button")),o.setAttribute("class","camera_time_button"),o.innerHTML="＞",o.style.left="220px",o.style.display="none",i.appendChild(o=this.time_last=document.createElement("button")),o.setAttribute("class","camera_time_button"),o.innerHTML="＞|",o.style.left="260px",o.style.display="none",i.appendChild(n),this.setImage=function(i){if(n=this.canvas,n.innerHTML="",this.index=i,this.name.innerHTML=t.l_name,this.time.innerHTML="--",t.image&&t.image.length){i<0&&(i=0),i>=t.image.length&&(i=t.image.length-1);var o=t.image[i];o.image&&(n.width=o.image.width||600,n.height=o.image.height||480,o.image.style.width="100%",o.image.style.height="100%",o.image.style["pointer-events"]="none",n.appendChild(o.image));var r=WRAP.DH._timeString(WRAP.DH._setTime(WRAP.DH._time(o.time),32400)),a=Number(r.substr(6,2)),s=Number(r.substr(9,2)),l=Number(r.substr(11,2));this.time.innerHTML=""+a+"日 "+s+"時 "+l+"分",e.time_frst.disabled=i==t.image.length-1,e.time_prev.disabled=i==t.image.length-1,e.time_play.disabled=t.image.length<=1,e.time_next.disabled=0==i,e.time_last.disabled=0==i}else e.time_frst.disabled=!0,e.time_prev.disabled=!0,e.time_play.disabled=!0,e.time_next.disabled=!0,e.time_last.disabled=!0;this.index=i},this.close.onclick=function(){e.hide()},this.zoom.onclick=function(){e.smooth=!0,e.small?(e.small=!1,e.set()):(e.small=!0,e.set())},this.animate=function(){if(!e.animating)return void(e.time_play.innerHTML="▶");e.time_play.innerHTML="■";var t=e.index-1;t<0&&(t=e.camera.image.length-1),e.setImage(t),setTimeout(function(){e.animate()},500)},this.time_frst.onclick=function(){e.setImage(e.camera.image.length-1)},this.time_prev.onclick=function(){e.setImage(e.index+1)},this.time_play.onclick=function(){(e.animating=!e.animating)&&e.animate()},this.time_next.onclick=function(){e.setImage(e.index-1)},this.time_last.onclick=function(){e.setImage(0)},i.onmousedown=function(t){m=this,P=i.style.left.replace(/px/,""),y=i.style.top.replace(/px/,""),x=t.clientX-P,w=t.clientY-y,d(m.controller)},i.onmouseup=function(){m=!1},i.onmousemove=function(t){if(m){var e=t.clientX-x,i=t.clientY-w;m.controller.pinned=!0,m.point=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(e-M,i-I)),m.style.left=e+"px",m.style.top=i+"px"}t._prevent=!0,t.preventDefault()},this.set=function(){var t=e.smooth?"smooth_tran ":"";t+="live_camera",t+=e.small?" small_window":" middle_window",this.tooltip||this!=_||(t+=" current_window"),e.window.setAttribute("class",t),t=e.smooth?"smooth_tran ":"",t+=e.small?" image_s":" image_m",e.canvas.setAttribute("class",t),e.zoom.setAttribute("class",e.small?"camera_button camera_zoomin":"camera_button camera_zoomout"),e.time_frst.style.display=e.small?"none":"block",e.time_prev.style.display=e.small?"none":"block",e.time_play.style.display=e.small?"none":"block",e.time_next.style.display=e.small?"none":"block",e.time_last.style.display=e.small?"none":"block",e.zoom.style.display=e.tooltip?"none":"block",e.close.style.display=e.tooltip?"none":"block",!e.small&&e.visible||(e.animating=!1),e.small&&e.setImage(0),e.smooth&&setTimeout(function(){e.smooth=!1,e.set()},250)},this.show=function(t,i){e.set(),e.visible=!0,this.window.point=new WRAP.Geo.Point(t,i);var n=WRAP.Geo.getScreenPoint(this.window.point);n.x+=M,n.y+=M,this.window.style.top=""+n.y+"px",this.window.style.left=""+n.x+"px",this.window.style.display="block"},this.hide=function(){this.window.style.display="none",e.visible=!1,e.small=!0,e.animating=!1,e.setImage(0)},g.appendChild(i),this.setImage(0)}var g,p,_,m,P,y,x,w,A=1e4,b="#2e3a54",G="#ffffff",W="#ffffff",R=20,S=[],M=10,I=10,k=2e4,T=640,F=480,L=.3,C=.6,z=26,D=20,E="#f2f2f2",X="rgba(150,150,150,0.6)",B=Math.floor(T*L),j=Math.floor(F*L),H=Math.floor(T*C),Y=Math.floor(F*C);return{init:function(r,s){g=s,a(),c(r),WRAP.Geo.addEventHandler("mouseover",t),WRAP.Geo.addEventHandler("mouseout",e),WRAP.Geo.addEventHandler("touch",i),WRAP.Geo.addEventHandler("boundsChange",n),WRAP.Geo.addEventHandler("visibilityChange",o)},setTooltip:function(t){s(t)},showTooltip:function(t,e){f(t,e)},clearTooltip:function(t,e){l(t,e)},getTooltip:function(){return h()},alignLiveCamera:function(){for(var t=0;t<S.length;t++){var e=S[t];e.pinned=!0}for(var i=g.clientLeft,n=g.clientTop,o=i+g.clientWidth,r=n+g.clientHeight,a=10,s=B+a,l=j+z+a,h=a;h+s<o;h+=s)for(var f=a;f+l<r;f+=l){for(var c=99999999,u=null,t=0;t<S.length;t++){var e=S[t];if(e.pinned&&e.visible){var d=e.window.style.left.replace(/px/,""),v=e.window.style.top.replace(/px/,""),p=d-h,_=v-f,m=p*p+_*_;c>m&&(c=m,u=e)}}u&&(u.smooth=!0,u.small=!0,u.pinned=!1,u.window.point=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(h,f)),u.window.style.left=h+"px",u.window.style.top=f+"px",u.set())}},mouseover:[],mouseout:[],touch:[],boundsChange:[],visibilityChange:[]}}(),WRAP.Geo.setOpenLayers=function(t){return WRAP.Geo.map=new WRAP.Geo.Bridge.OpenLayers(t),WRAP.Geo.render(),WRAP.Geo.map},WRAP.Geo.Bridge.OpenLayers=function(t){var e=this;this.map=t,this.view=t.getView(),this.context=new WRAP.Geo.Context(this),this.canvas,this.tile_revision={},this.tiles=[],this.markers=[],this.lines=[],this.touch=null,this.zoom=this.view.getZoom(),this.center=this.view.getCenter(),this.bounds=0,this.tileID=function(t,e,i){return"M/"+t+"/"+e+"/"+i},this.updateBounds=function(t){function i(t,e,i,n){var o=t.findTile(e,i,n);if(o)return void(o.locked=!1);var a=new Float32Array(131072),s=Math.pow(2,parseInt(e)),l=parseFloat(n)/s,h=(parseFloat(i)+1)/s;l=l*(r[2]-r[0])+r[0],h=h*(r[3]-r[1])+r[1];for(var f=(r[2]-r[0])/s/256,c=(r[3]-r[1])/s/256,u={x:[256],y:[256]},d=0;d<256;d++){var v=l+f*parseFloat(d),g=h-c*parseFloat(d),p=ol.proj.transform([v,h],"EPSG:3857","EPSG:4326");u.x[d]=p[0],u.x[d]<-180?u.x[d]+=360:u.x[d]>=180&&(u.x[d]-=360);var _=ol.proj.transform([l,g],"EPSG:3857","EPSG:4326");u.y[d]=_[1]}for(var d=0,m=0;m<256;m++)for(var P=0;P<256;P++)a[d++]=u.y[m],a[d++]=u.x[P];t.addTile("M",e,i,n,a,new WRAP.Geo.Bounds(60*a[0],60*a[130560],60*a[131071],60*a[1]))}var n=this.view.getCenter(),o=ol.proj.transform(n,"EPSG:3857","EPSG:4326");if(o[0]<-180)for(;o[0]<-180;)o[0]+=360,this.view.setCenter(ol.proj.transform(o,"EPSG:4326","EPSG:3857"));if(o[0]>=180)for(;o[0]>=180;)o[0]-=360,this.view.setCenter(ol.proj.transform(o,"EPSG:4326","EPSG:3857"));var r=ol.proj.get("EPSG:3857").getExtent();e.zoom=e.view.getZoom(),e.center=e.view.getCenter();var a=e.map.getSize(),s=e.map.getCoordinateFromPixel([0,0]),l=e.map.getCoordinateFromPixel(a),h=ol.proj.transform(s,"EPSG:3857","EPSG:4326"),f=ol.proj.transform(l,"EPSG:3857","EPSG:4326"),c=256*Math.pow(2,e.zoom);a[0]>=c?e.bounds=new WRAP.Geo.Bounds(60*h[1],60*f[1],10800,-10800):e.bounds=new WRAP.Geo.Bounds(60*h[1],60*f[1],60*f[0],60*h[0]);var u=Math.floor(e.zoom),d=Math.pow(2,u);s[0]-=r[0],l[0]-=r[0],s[1]-=r[1],l[1]-=r[1];var v=r[2]-r[0],g=r[3]-r[1];s[0]=s[0]/v,l[0]=l[0]/v,s[1]=s[1]/g,l[1]=l[1]/g;var p=Math.floor(s[0]*d),_=Math.floor((256==l[0]?255:l[0])*d),m=Math.floor(l[1]*d),P=Math.floor(s[1]*d);for(P>=d&&(P=d-1),m<0&&(m=0),_-p>=d-1&&(p=0,_=d-1),p%=d,_%=d;p<0;)p+=d;for(;_<0;)_+=d;if(!t){this.context.lockTile();for(var y=Math.pow(2,u),x=m;x<=P;x++)if(p<=_)for(var w=p;w<=_;w++)i(this.context,u,x,w);else{for(var w=p;w<y;w++)i(this.context,u,x,w);for(var w=0;w<=_;w++)i(this.context,u,x,w)}this.context.clearLockedTile(),e.context.setTileBand(e.zoom,p,_,m,P)}WRAP.Geo.updateBounds(e.bounds,t)},window.setTimeout(function(){e.updateBounds()},1e3),this.setTile=function(t,i){function n(t,i,n,o){var r=parseFloat(t)/n,a=parseFloat(i+1)/n;r=r*(o[2]-o[0])+o[0],a=a*(o[3]-o[1])+o[1];var s=e.map.getPixelFromCoordinate([e.canvas.extent[0],e.canvas.extent[3]]),l=e.map.getPixelFromCoordinate([r,a]),h=Math.round(l[0])-Math.floor(s[0]),f=Math.round(l[1])-Math.floor(s[1]);return{x:h,y:f}}if(e.canvas){var o=e.tileID(t.z,t.y,t.x);e.tile_revision[o]=i;var r=ol.proj.get("EPSG:3857").getExtent(),a=Math.pow(2,parseInt(t.z)),s=Math.floor(this.context.canvas_band),l=n(t.x,t.y,a,r),h=n(t.x+1,t.y-1,a,r),f=l.x,c=l.y,u=window.devicePixelRatio,d=h.x-f,v=h.y-c,g=Math.floor(t.offset_x),p=Math.floor(t.offset_y),_=Math.floor(256*t.racio),m=Math.floor(256*t.racio);e.canvas.ctx.clearRect(f*u,c*u,d*u,v*u),e.canvas.ctx.drawImage(t.canvas,g,p,_,m,f*u,c*u,d*u,v*u);for(var P,y=1;(P=f-s*y)>-256;)e.canvas.ctx.clearRect(P*u,c*u,d*u,v*u),e.canvas.ctx.drawImage(t.canvas,g,p,_,m,P*u,c*u,d*u,v*u),y++;for(y=1;(P=f+s*y)<e.canvas.width;)e.canvas.ctx.clearRect(P*u,c*u,d*u,v*u),e.canvas.ctx.drawImage(t.canvas,g,p,_,m,P*u,c*u,d*u,v*u),y++}},this.map.on("move",function(){e.updateBounds(!0)}),this.map.on("moveend",function(){e.updateBounds()}),this.map.on("pointermove",function(t){var i=e.map.getPixelFromCoordinate(t.coordinate),n=ol.proj.transform(t.coordinate,"EPSG:3857","EPSG:4326");e.mouse_point=new WRAP.Geo.Point(60*n[1],60*n[0]),e.mouse_screenpoint=new WRAP.Geo.ScreenPoint(i[0],i[1])});var i=function(t,i,n,o,r){i=null,n=null,r=null;var a=e.canvas;e.tile_revision={},e.canvas=document.createElement("canvas"),e.canvas.ctx=e.canvas.getContext("2d"),e.canvas.extent=t;var s=o[0],l=o[1];if(e.canvas.setAttribute("width",s),e.canvas.setAttribute("height",l),a){var h=e.map.getPixelFromCoordinate([a.extent[0],a.extent[3]]),f=e.map.getPixelFromCoordinate([t[0],t[3]]),c=a.extent[2]-a.extent[0],u=t[2]-t[0],d=h[0]-f[0],v=h[1]-f[1],g=c/u,p=a.width,_=a.height,m=e.canvas.width*g,P=e.canvas.height*g;e.zoom=e.view.getZoom();for(var y=256*Math.pow(2,e.zoom),x=[d],w=y;d+w<e.canvas.width;)x.push(d+w),w+=y;for(w=-y;d+w+m>0;)x.push(d+w),w+=-y;for(var A=0;A<x.length;A++)e.canvas.ctx.clearRect(x[A],v,m,P),e.canvas.ctx.drawImage(a,0,0,p,_,x[A],v,m,P)}return WRAP.Geo.invalidate(),e.canvas},n=new ol.layer.Image({source:new ol.source.ImageCanvas({canvasFunction:i,projection:"EPSG:3857"})});this.map.addLayer(n),this.getSize=function(){var t=e.map.getSize();return{width:t[0],height:t[1]}},this.getScreenPoint=function(t){if(!t)return new WRAP.Geo.ScreenPoint(0,0);var i=ol.proj.transform([t.lonDegree(),t.latDegree()],"EPSG:4326","EPSG:3857");if(!i)return new WRAP.Geo.ScreenPoint(0,0);var n=e.map.getPixelFromCoordinate(i);return n?new WRAP.Geo.ScreenPoint(n[0],n[1]):new WRAP.Geo.ScreenPoint(0,0)},this.getScreenLine=function(t,i,n){var o=[],r=e.bounds.north/60,a=e.bounds.south/60;if(n>=r||i<=a)return o;for(var s=999999,l=-999999,h=[],f=0;f<t.length;f++){var c=ol.proj.transform([t[f][1],t[f][0]],"EPSG:4326","EPSG:3857"),u=e.map.getPixelFromCoordinate(c),d=u[0];s>d&&(s=d),l<d&&(l=d),h.push(new WRAP.Geo.ScreenPoint(u[0],u[1]))}for(var v=e.context.canvas_band,g=e.getScreenPoint(new WRAP.Geo.Point(0,0)),p=e.map.getSize()[0]/2;g.x-p>=v/2;)g.x-=v;for(;g.x-p<-v/2;)g.x+=v;var _=g.x+e.context.offset_x,m=_+v;_<l&&s<m&&o.push(h);for(var P=-v;l+P>_;){if(_<l+P&&s+P<m){for(var y=[],f=0;f<h.length;f++)y.push(new WRAP.Geo.ScreenPoint(h[f].x+P,h[f].y));o.push(y)}P-=v}for(P=v;s+P<m;){if(_<l+P&&s+P<m){for(var y=[],f=0;f<h.length;f++)y.push(new WRAP.Geo.ScreenPoint(h[f].x+P,h[f].y));o.push(y)}P+=v}return o},this.getPoint=function(t){if(!t)return new WRAP.Geo.Point(0,0);var i=e.map.getCoordinateFromPixel([t.x,t.y]);if(!i)return new WRAP.Geo.Point(0,0);var n=ol.proj.transform(i,"EPSG:3857","EPSG:4326");return new WRAP.Geo.Point(60*n[1],60*n[0])},this.getCenterPoint=function(){var t=this.view.getCenter(),e=ol.proj.transform(t,"EPSG:3857","EPSG:4326");return new WRAP.Geo.Point(60*e[1],60*e[0])},this.setCenterPoint=function(t){this.view.setCenter(ol.proj.transform([t.lonDegree(),t.latDegree()],"EPSG:4326","EPSG:3857"))},this.getZoom=function(){return this.zoom},this.setZoom=function(t){this.view.setZoom(this.zoom=t)},this.getPerspective=function(e,i){void 0===i&&(i=0);for(var n=e[0].lat,o=e[0].lon,r=n,a=n,s=o,l=o,h=1;h<e.length;h++){var n=e[h].lat,f=e[h].lon-o;o=f>=10800?e[h].lon-21600:f<-10800?e[h].lon+21600:e[h].lon,s>o&&(s=o),l<o&&(l=o),r>n&&(r=n),a<n&&(a=n)}o<-10800?o+=21600:o>=10800&&(o-=21600);var c=ol.proj.transform([s/60,r/60],"EPSG:4326","EPSG:3857"),u=ol.proj.transform([l/60,a/60],"EPSG:4326","EPSG:3857"),d=(c[1]+u[1])/2,v=(u[0]+c[0])/2,g=ol.proj.transform([v,d],"EPSG:3857","EPSG:4326");n=g[1],o=g[0];var p=6388019798183263e-21;c=[c[0]*p,c[1]*p],u=[u[0]*p,u[1]*p];var _=Math.abs(c[1]-u[1]),m=Math.abs(u[0]-c[0]),P=t.getSize(),y=P[0]-2*i,x=P[1]-2*i,w=Math.log(2),A=_>0?Math.log(x/_)/w:this.zoom,b=m>0?Math.log(y/m)/w:this.zoom,G=Math.floor(A<b?A:b);return G>19&&(G=19),{center:new WRAP.Geo.Point(60*n,60*o),zoom:G}},this.update=function(t){t&&this.updateBounds(),this.map.render()},this.enableScroll=function(t){this.map.getInteractions().forEach(function(e){e instanceof ol.interaction.DragPan&&e.setActive(t)},this)}},WRAP.Geo.setGoogleMaps=function(t){function e(t){this.tileSize=t}WRAP.Geo.map=new WRAP.Geo.Bridge.GoogleMaps(t);var i=WRAP.Geo.map.map;return e.prototype.getTile=function(t,e,i){var n=Math.pow(2,e),o=t.x,r=n-t.y-1,a=WRAP.Geo.map.tileID(e,r,o),s=document.getElementById(a);return s?s:(s=i.createElement("canvas"),s.id=a,s.width=256,s.height=256,s.ctx=s.getContext("2d"),setTimeout(function(){WRAP.Geo.render()},10),s)},WRAP.Geo.map.overland_layer=new e(new google.maps.Size(256,256)),WRAP.Geo.map.overland_layer_index=i.overlayMapTypes.length,i.overlayMapTypes.push(null),WRAP.Geo.map.setOverLandLayer(!0),WRAP.Geo.map},WRAP.Geo.Bridge.GoogleMaps=function(t){var e=this;this.map=t,this.context=new WRAP.Geo.Context(this),this.zoom=t.getZoom(),this.center=t.getCenter(),this.projection=t.getProjection(),this.bounds=t.getBounds(),this.tileID=function(t,e,i){return"M/"+t+"/"+e+"/"+i},this.updateBounds=function(i){this.updateTimer&&clearTimeout(this.updateTimer),this.updateTimer=setTimeout(function(){function n(t,i,n,o){var r=t.findTile(i,n,o);if(r)return void(r.locked=!1);for(var a=new Float32Array(131072),s=Math.pow(2,parseInt(i)),l=256*parseFloat(o)/s,h=256*(s-parseFloat(n)-1)/s,f=1/s,c={x:[256],y:[256]},u=0;u<256;u++){var d=l+f*parseFloat(u),v=h+f*parseFloat(u),g=e.projection.fromPointToLatLng(new google.maps.Point(d,h));c.x[u]=g.lng();var p=e.projection.fromPointToLatLng(new google.maps.Point(l,v));c.y[u]=p.lat()}for(var u=0,_=0;_<256;_++)for(var m=0;m<256;m++)a[u++]=c.y[_],a[u++]=c.x[m];t.addTile("M",i,n,o,a,new WRAP.Geo.Bounds(60*a[0],60*a[130560],60*a[131071],60*a[1]))}if(e.projection=t.getProjection(),e.center=t.getCenter(),e.zoom=t.getZoom(),e.bounds=t.getBounds(),e.bounds&&e.projection){var o=e.bounds,r=o.getNorthEast(),a=o.getSouthWest(),s=e.projection.fromLatLngToPoint(r),l=e.projection.fromLatLngToPoint(a),h=Math.pow(2,e.zoom),f=Math.floor(l.x*h/256),c=Math.floor((256==s.x?255:s.x)*h/256),u=h-Math.floor(l.y*h/256)-1,d=h-Math.floor(s.y*h/256)-1;if(!i){e.context.lockTile();for(var v=Math.pow(2,e.zoom),g=u;g<=d;g++)if(f<=c)for(var p=f;p<=c;p++)n(e.context,e.zoom,g,p);else{for(var p=f;p<v;p++)n(e.context,e.zoom,g,p);for(var p=0;p<=c;p++)n(e.context,e.zoom,g,p)}e.context.clearLockedTile(),e.context.setTileBand(e.zoom,f,c,u,d)}WRAP.Geo.updateBounds(new WRAP.Geo.Bounds(60*r.lat(),60*a.lat(),60*r.lng(),60*a.lng()),i)}},10)},window.setTimeout(function(){e.updateBounds()},1e3),google.maps.event.addListener(t,"zoom_changed",function(){e.updateBounds()}),google.maps.event.addListener(t,"bounds_changed",function(){e.updateBounds()}),google.maps.event.addListener(t,"idle",function(){e.updateBounds()}),this.setOverLandLayer=function(t){this.map.overlayMapTypes.setAt(WRAP.Geo.map.overland_layer_index,t?WRAP.Geo.map.overland_layer:null)},this.setTile=function(t,i){function n(n,o,r){var a=e.tileID(n,o,r),s=document.getElementById(a);return!!s&&(s.revision!=i&&(s.revision=i,s.ctx.clearRect(0,0,256,256),s.ctx.drawImage(t.canvas,t.offset_x,t.offset_y,256,256,0,0,256,256)),!0)}var o=Math.pow(2,t.z);n(t.z,t.y,t.x);for(var r=parseInt(t.x),a=1;a<24;)n(t.z,t.y,r+a*o)?(r+=a*o,a=1):a++;for(r=parseInt(t.x),a=1;a<24;)n(t.z,t.y,r-a*o)?(r-=a*o,a=1):a++},this.getSize=function(){return{width:t.getDiv().offsetWidth,height:t.getDiv().offsetHeight}},this.getScreenPoint=function(e){if(this.projection){var i=this.projection.fromLatLngToPoint(new google.maps.LatLng(e.latDegree(),e.lonDegree())),n=this.projection.fromLatLngToPoint(this.center),o=i.x-n.x,r=i.y-n.y;o<-128&&(o+=256),o>=128&&(o-=256);var a=Math.pow(2,this.zoom),s=.5*t.getDiv().offsetWidth+o*a,l=.5*t.getDiv().offsetHeight+r*a;return new WRAP.Geo.ScreenPoint(parseInt(s),parseInt(l))}return new WRAP.Geo.ScreenPoint(0,0)},this.getScreenLine=function(e,i,n){function o(t){R.indexOf(t)<0&&R.push(t)}var r=[];if(!this.projection)return r;var a=Math.pow(2,this.zoom),s=256*a,l=.5*t.getDiv().offsetWidth,h=.5*t.getDiv().offsetHeight,f=this.context.offset_x,c=f+this.context.canvas.width,u=this.context.bounds.n,d=this.context.bounds.s;if(n>=u||i<=d)return r;for(var v=this.projection.fromLatLngToPoint(this.center);v.x>256;)v.x-=256;for(;v.x<0;)v.x+=256;for(var g=(v.x-128)*a,p=(v.y-128)*a,_=0;g<f;)g+=s,_+=s;for(;g>=c;)g-=s,_-=s;for(var m=[],P=256*s,y=-P,x=0;x<e.length;x++){var w=e[x][0],A=e[x][1],b=this.projection.fromLatLngToPoint(new google.maps.LatLng(w,A));b.y-=128,b.x=128*A/180;var G=b.x*a,W=b.y*a;P>G&&(P=G),y<G&&(y=G),m.push([G+l-g,W+h-p])}var R=[];f<y&&P<c&&(o(0),o(0+_)),f<y-s&&P-s<c&&(o(-s),o(-s+_)),f<y+s&&P+s<c&&(o(s),o(s+_));for(var S=0;S<R.length;S++){for(var n=R[S],M=[],x=0;x<m.length;x++){var I=m[x],G=I[0]+n,W=I[1];M.push(new WRAP.Geo.ScreenPoint(G,W))}r.push(M)}return r},this.getPoint=function(e){if(this.projection){var i=e.x-.5*t.getDiv().offsetWidth,n=e.y-.5*t.getDiv().offsetHeight,o=this.projection.fromLatLngToPoint(this.center),r=Math.pow(2,this.zoom),a=o.x+i/r,s=o.y+n/r,l=this.projection.fromPointToLatLng(new google.maps.Point(a,s));return new WRAP.Geo.Point(60*l.lat(),60*l.lng())}return new WRAP.Geo.Point(0,0)},this.getCenterPoint=function(){return new WRAP.Geo.Point(60*e.center.lat(),60*e.center.lng())},this.setCenterPoint=function(e){t.setCenter(this.center=new google.maps.LatLng(e.latDegree(),e.lonDegree()))},this.getZoom=function(){return this.zoom},this.setZoom=function(e){t.setZoom(this.zoom=e)},this.getPerspective=function(e,i){if(!this.projection||!e||!e.length)return{center:this.getCenterPoint(),zoom:this.zoom};void 0===i&&(i=0);for(var n=e[0].lat,o=e[0].lon,r=n,a=n,s=o,l=o,h=1;h<e.length;h++){
var n=e[h].lat,f=e[h].lon-o;o=f>=10800?e[h].lon-21600:f<-10800?e[h].lon+21600:e[h].lon,s>o&&(s=o),l<o&&(l=o),r>n&&(r=n),a<n&&(a=n)}o<-10800?o+=21600:o>=10800&&(o-=21600);var c=this.projection.fromLatLngToPoint(new google.maps.LatLng(r/60,s/60)),u=this.projection.fromLatLngToPoint(new google.maps.LatLng(a/60,l/60)),d=(c.y+u.y)/2;u.x<c.x&&(u.x+=256);var v=(u.x+c.x)/2;v>=128&&(v-=256);var g=this.projection.fromPointToLatLng(new google.maps.Point(v,d));n=g.lat(),o=g.lng();var p=c.y-u.y,_=Math.abs(u.x-c.x),m=t.getDiv().offsetWidth-2*i,P=t.getDiv().offsetHeight-2*i,y=Math.log(2),x=p>0?Math.log(P/p)/y:this.zoom,w=_>0?Math.log(m/_)/y:this.zoom,A=Math.floor(x<w?x:w);return A>19&&(A=19),{center:new WRAP.Geo.Point(60*n,60*o),zoom:A}},this.getDistance=function(t,e){var i=new google.maps.LatLng(t.latDegree(),t.lonDegree()),n=new google.maps.LatLng(e.latDegree(),e.lonDegree());return google.maps.geometry.spherical.computeDistanceBetween(i,n)},this.update=function(){},this.enableScroll=function(t){this.map.setOptions({draggable:t})}},WRAP.Geo.setWebGLMap=function(t){return WRAP.Geo.map=new WRAP.Geo.Bridge.WebGLMap(t),WRAP.Geo.map},WRAP.Geo.Bridge.WebGLMap=function(t){var e=this,i=null;for(this.map=t,this.canvas=document.createElement("canvas");t.firstChild;)t.removeChild(t.firstChild);t.appendChild(this.canvas),this.canvas.style.width="100%",this.canvas.style.height="100%",this.zoom=5,this.center={lat:0,lon:0};try{i=this.canvas.getContext("webgl")||this.canvas.getContext("experimental-webgl")}catch(t){}return i?(this.setProjection=function(t){this.projection=new WRAP.Geo.WebGL.Projection[t](i),this.projection.setZoom(this.zoom),this.projection.setCenter(this.center),this.context=new this.projection.Context(this.projection,i)},this.clearDisplayCache=function(t){if(t){if(t.list){for(var e=0;e<t.list.length;e++){var i=t.list[e];i.shader&&i.vbo&&i.shader.deleteBuffer(i.vbo)}t.list=[]}t.cached=!1}},this.render=function(){},this.tileID=function(t,e,i){return"W/"+t+"/"+e+"/"+i},this.updateBounds=function(){this.canvas.width=this.map.clientWidth,this.canvas.height=this.map.clientHeight,this.projection.setSize(this.canvas.width,this.canvas.height),this.updateTimer&&clearTimeout(this.updateTimer),this.updateTimer=setTimeout(function(){function t(t,e,i,n){var o=t.findTile(e,i,n);if(o)return void(o.locked=!1);var r=new Float32Array(131072);e=Math.floor(parseFloat(e));for(var a=Math.pow(2,e),s=parseFloat(n)/a,l=parseFloat(i)/a,h=1/(256*a),f={x:[256],y:[256]},c=0;c<256;c++){var u=s+h*c,d=l+h*c;f.x[c]=-180+360*u,f.y[256-c-1]=-90+360*d}for(var c=0,v=0;v<256;v++)for(var g=0;g<256;g++)r[c++]=f.y[v],r[c++]=f.x[g];t.addTile("W",e,i,n,r,new WRAP.Geo.Bounds(60*r[0],60*r[130560],60*r[131071],60*r[1]))}var i=e.canvas.width/2,n=e.canvas.height/2,o=e.projection.point([-i,-n]),r=e.projection.point([i,n]),a=Math.pow(2,Math.floor(e.zoom)),s=a/2,l=360/a,h=Math.floor((o[0]+180)/l),f=Math.floor((r[0]+180)/l);f-h>=a&&(h=0,f=a-1);var c=0,u=0;s>=1&&(c=s-Math.floor((90-r[1])/l)-1,u=s-Math.floor((90-o[1])/l)-1),c<0&&(c=0),u<0&&(u=0),c>=s&&(c=s-1),u>=s&&(u=s-1),f-h>a?(h=0,f=a-1):(h%=a,f%=a),h<0&&(h+=a),f<0&&(f+=a),e.context.lockTile();for(var d=Math.pow(2,e.zoom),v=c;v<=u;v++)if(h<=f)for(var g=h;g<=f;g++)t(e.context,e.zoom,v,g);else{for(var g=h;g<d;g++)t(e.context,e.zoom,v,g);for(var g=0;g<=f;g++)t(e.context,e.zoom,v,g)}e.context.clearLockedTile(),e.context.setTileBand(e.zoom,h,f,c,u),WRAP.Geo.updateBounds(new WRAP.Geo.Bounds(60*o[1],60*r[1],60*r[0],60*o[0])),WRAP.Geo.render()},10),this.render()},window.setTimeout(function(){e.updateBounds()},1e3),this.adjustXY=function(t){var e=t.target.getBoundingClientRect();this._mx=t.clientX-e.left,this._my=t.clientY-e.top},this.canvas.onmousemove=function(t){if(e.adjustXY(t),e._drag){var i=e._mx-e._drag_x,n=e._my-e._drag_y,o=this.width/2,r=this.height/2,a=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(o-i,r-n));WRAP.Geo.setCenterPoint(a),e._drag_x=e._mx,e._drag_y=e._my}},this.canvas.onmousedown=function(t){e.adjustXY(t),e._drag=!0,e._drag_offset=e._content_offset,e._drag_x=e._mx,e._drag_y=e._my},this.canvas.onmouseup=function(t){e.adjustXY(t),e._drag=!1},this.canvas.onmouseout=function(){e._drag=!1},this.canvas.onmousewheel=function(t){e.adjustXY(t);var i=t.wheelDelta/400,n=WRAP.Geo.getZoom();n+=i,n<0&&(n=0),n>10&&(n=10),WRAP.Geo.setZoom(n),t.preventDefault()},window.addEventListener("resize",function(){e.updateBounds()}),this.setTile=function(){console.log("##setTile")},this.getSize=function(){return{width:this.canvas.width,height:this.canvas.height}},this.getScreenPoint=function(t){if(this.projection){var e=this.canvas.width/2,i=this.canvas.height/2,n=this.projection.screenPoint([t.lonDegree(),t.latDegree()]);return new WRAP.Geo.ScreenPoint(parseInt(e+n[0]),parseInt(i+n[1]))}return new WRAP.Geo.ScreenPoint(0,0)},this.getScreenLine=function(){console.log("##getScreenLine")},this.getPoint=function(t){if(this.projection){var e=this.canvas.width/2,i=this.canvas.height/2,n=this.projection.point([t.x-e,t.y-i]);return new WRAP.Geo.Point(60*n[1],60*n[0])}return new WRAP.Geo.Point(0,0)},this.getCenterPoint=function(){return new WRAP.Geo.Point(60*this.center_lat,60*this.center_lon)},this.setCenterPoint=function(t){this.center.lat=t.latDegree(),this.center.lon=t.lonDegree(),this.projection.setCenter(this.center),this.updateBounds()},this.getZoom=function(){return this.zoom},this.setZoom=function(t){this.zoom=t,this.projection.setZoom(this.zoom),this.updateBounds()},this.getPerspective=function(){console.log("##getPerspective")},this.update=function(){},this.enableScroll=function(){},this.normalizeLon=function(t){for(;t<-180;)t+=360;for(;t>=180;)t-=360},void this.setProjection("EQR")):void alert("WebGL not supported.")},WRAP.Geo.WebGL={orthogonalMatrix:function(t,e,i,n,o,r){var a=new Float32Array(16),s=e-t,l=n-i,h=r-o;return a[0]=2/s,a[5]=2/l,a[10]=-2/h,a[12]=-(e+t)/s,a[13]=-(n+i)/l,a[14]=-(r+o)/h,a[15]=1,a[1]=a[2]=a[3]=a[4]=a[6]=a[7]=a[8]=a[9]=a[11]=0,a},setup:function(t,e,i){var n=t.createShader(t.VERTEX_SHADER);t.shaderSource(n,e),t.compileShader(n),t.getShaderParameter(n,t.COMPILE_STATUS)||console.log("Vertex Shader Error : "+t.getShaderInfoLog(n));var o=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(o,i),t.compileShader(o),t.getShaderParameter(o,t.COMPILE_STATUS)||console.log("Fragment Shader Error : "+t.getShaderInfoLog(o));var r=t.createProgram();return t.attachShader(r,n),t.attachShader(r,o),t.linkProgram(r),t.getProgramParameter(r,t.LINK_STATUS)||console.log(t.getProgramInfoLog(r)),r},Projection:{EQR:function(t){var e=this;this.setSize=function(t,e){this.width=t,this.height=e},this.setZoom=function(t){this.zoom=t,this.ppd=256*Math.pow(2,t)/360,this.dpp=1/this.ppd},this.setCenter=function(t){this.center=t},this.point=function(t){return[this.center.lon+t[0]*this.dpp,this.center.lat-t[1]*this.dpp]},this.screenPoint=function(t){return[(t[0]-this.center.lon)*this.ppd,(this.center.lat-t[1])*this.ppd]},this.Context=function(t,e){this.revision=0,this.tiles=[],this.setTileBand=function(t,e,i,n,o){if(this.zoom!=t||this.min_tile_x!=e||this.max_tile_x!=i||this.min_tile_y!=n||this.max_tile_y!=o){if(this.zoom=t,this.tile_band=Math.pow(2,t),this.canvas_band=256*this.tile_band,this.min_tile_x=e,this.max_tile_x=i,this.min_tile_y=n,this.max_tile_y=o,this.offset_x=256*(this.min_tile_x-this.tile_band/2),this.offset_y=256*(this.tile_band/2-1-this.max_tile_y),this.tiles.length){var r={};r.n=this.tiles[0].bounds.north/60,r.s=this.tiles[0].bounds.south/60;for(var a=1;a<this.tiles.length;a++)r.n<this.tiles[a].bounds.north/60&&(r.n=this.tiles[a].bounds.north/60),r.s>this.tiles[a].bounds.south/60&&(r.s=this.tiles[a].bounds.south/60)}r.w=(this.min_tile_x-this.tile_band/2)/this.tile_band*360,r.e=(this.max_tile_x+1-this.tile_band/2)/this.tile_band*360,this.bounds=r,this.canvas||(this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"));var s=this.max_tile_y-this.min_tile_y+1,l=this.max_tile_x-this.min_tile_x+1;this.max_tile_x<this.min_tile_x&&(l=this.tile_band-this.min_tile_x+this.max_tile_x+1),this.canvas.width=256*l,this.canvas.height=256*s;for(var h=t,f=0;f<s;f++)for(var c=this.max_tile_y-f,u=0;u<l;u++){var d=(this.min_tile_x+u)%this.tile_band,v=this.findTile(h,c,d);v&&(v.canvas=this.canvas,v.ctx=this.ctx,v.offset_x=256*u,v.offset_y=256*f)}}},this.lockTile=function(){for(var t=0;t<this.tiles.length;t++)this.tiles[t].locked=!0},this.clearLockedTile=function(){for(var t=this.tiles.length-1;t>=0;t--)this.tiles[t].locked&&this.tiles.splice(t,1)},this.findTile=function(t,e,i){for(var n=0;n<this.tiles.length;n++){var o=this.tiles[n];if(o.z==t&&o.y==e&&o.x==i)return o}return null},this.addTile=function(t,e,i,n,o,r){this.revision++,this.tiles.push({id:t+"/"+e+"/"+i+"/"+n,type:t,z:e,y:i,x:n,cood:o,bounds:r})},this.tile=function(t){for(var e=0;e<this.tiles.length;e++){var i=this.tiles[e];i.valid||t(i)}},this.drawImageData=function(t,e,i,n,o,r,a){function s(t,e,i,n,s,l){a?(t.save(),t.translate(i,n),t.rotate(a/180*Math.PI),t.drawImage(e,o,r,s,l),t.restore()):t.drawImage(e,i+o,n+r,s,l)}function l(t){var e=document.createElement("canvas");e.width=t.width,e.height=t.height;var i=e.getContext("2d");return i.putImageData(t,0,0),e}var h=this.ctx,f=map.getScreenPoint(new WRAP.Geo.Point(0,0)),c=this.offset_x+f.x,u=this.offset_y+f.y,d=map.getScreenPoint(new WRAP.Geo.Point(60*t[1],60*t[0])),v=d.x-c,g=d.y-u,p=1.5*(i>n?i:n),_=-p,m=this.canvas.width+p,P=-p,y=this.canvas.height+p;if(!(g<P||y<g)){var x=null;_<=v&&v<=m&&(x||(x=l(e)),s(h,x,v,g,i,n));var w=v-this.canvas_band;_<=w&&w<=m&&(x||(x=l(e)),s(h,x,w,g,i,n));var A=v+this.canvas_band;_<=A&&A<=m&&(x||(x=l(e)),s(h,x,A,g,i,n))}},this.drawImage=function(t,e,i,n,o,r,a){function s(t,e,i,n,s){a?(t.save(),t.translate(e,i),t.rotate(a/180*Math.PI),t.drawImage(h,o,r,n,s),t.restore()):t.drawImage(h,e+o,i+r,n,s)}var l=WRAP.Geo.imageCache[e];if(void 0==l)return l=WRAP.Geo.imageCache[e]={loaded:!1,image:new Image},l.image.onload=function(){l.loaded=!0,WRAP.Geo.invalidate()},void(l.image.src=e);if(l.loaded){var h=l.image;0==i&&(i=h.width),0==n&&(n=h.height);var f=this.ctx,c=map.getScreenPoint(new WRAP.Geo.Point(0,0)),u=this.offset_x+c.x,d=this.offset_y+c.y,v=map.getScreenPoint(new WRAP.Geo.Point(60*t[1],60*t[0])),g=v.x-u,p=v.y-d,_=1.5*(i>n?i:n),m=-_,P=this.canvas.width+_,y=-_,x=this.canvas.height+_;if(p<y||x<p)return;m<=g&&g<=P&&s(f,g,p,i,n);var w=g-this.canvas_band;m<=w&&w<=P&&s(f,w,p,i,n);var A=g+this.canvas_band;m<=A&&A<=P&&s(f,A,p,i,n)}},this.hit=function(t,e,i){if(!i)return!1;var n=WRAP.Geo.getScreenPoint(this.hitctx.anchor);t-=n.x,e-=n.y;var o=this.hitctx.getImageData(t,e,1,1);if(o&&o.data){var r=(o.data[0]<<16)+(o.data[1]<<8)+o.data[2];return i==r}return!1},this._drawLines=function(e,i,n,o,r,a,s,l){function h(t,e){var i=t.length,n=[],o=d(t[0],t[1],e);n.push(o[0]),n.push(o[1]);for(var r=0;r<i-2;r++)for(var a=v(t[r],t[r+1],t[r+2],e),s=0;s<a.length;s++)n.push(a[s]);var l=d(t[i-1],t[i-2],e);return n.push(l[1]),n.push(l[0]),n}function f(t,e){var i=[];for(i.push(t[0]);;){if(t.length<2)return i;var n=t[0],o=t[1],r=Math.sqrt((n[0]-o[0])*(n[0]-o[0])+(n[1]-o[1])*(n[1]-o[1]));if(!(r<e)){if(r==e)return i.push(o),t.shift(),i;var a=n[0]+(o[0]-n[0])*e/r,s=n[1]+(o[1]-n[1])*e/r;return t.shift(),t.unshift([a,s,n[2]]),i.push([a,s,n[2]]),i}i.push(o),t.shift(),e-=r}return i}function c(t,e,i){var n=u(t);if(!i.safe())return h(n,e);for(var o=[];;){var r=i.get(),a=f(n,r);if(i.active()&&o.push(a),n.length<=1)break}for(var s=[],l=0;l<o.length;l++){var a=h(o[l],e);l>0&&s.push(a[0]);for(var c=0;c<a.length;c++)s.push(a[c]);l<o.length-1&&s.push(a[a.length-1])}return s}function u(t){for(var e=[t[0]],i=0;i<t.length-1;i++)(t[i][0]-t[i+1][0])*(t[i][0]-t[i+1][0])+(t[i][1]-t[i+1][1])*(t[i][1]-t[i+1][1])>P*P&&e.push(t[i+1]);return e}function d(t,e,i){var n=e[0]-t[0],o=e[1]-t[1],r=Math.sqrt(n*n+o*o),a=-o*i/r,s=n*i/r,l=t[0]+a,h=t[1]+s,f=t[0]-a,c=t[1]-s;return[[l,h,t[2]],[f,c,t[2]]]}function v(t,e,i,n){var o=e[0]-t[0],r=e[1]-t[1],a=i[0]-e[0],s=i[1]-e[1],l=Math.sqrt(o*o+r*r),h=Math.sqrt(a*a+s*s),f=-r*n/l,c=o*n/l,u=-s*n/h,d=a*n/h,v=o*s-r*a;if(v<-P){var g=(-h*n-f*s+c*a)/v,p=e[0]-f-g*o,_=e[1]-c-g*r,m=Math.sqrt(n*n+g*g*l*l),y=e[0]+(f+g*o)*n/m,x=e[1]+(c+g*r)*n/m,w=e[0]+f,A=e[1]+c,b=e[0]+u,G=e[1]+d;return(p-t[0])*o+(_-t[1])*r<0||(p-i[0])*a+(_-i[1])*s>0?[[w,A,e[2]],[e[0]-f,e[1]-c,e[2]],[y,x,e[2]],e,[b,G,e[2]],[e[0]-u,e[1]-d,e[2]]]:[[w,A,e[2]],[p,_,e[2]],[y,x,e[2]],[p,_,e[2]],[b,G,e[2]],[p,_,e[2]]]}if(v>P){var g=(-h*n-f*s+c*a)/v,W=e[0]+f+g*o,R=e[1]+c+g*r,S=Math.sqrt(n*n+g*g*l*l),M=e[0]-(f+g*o)*n/S,I=e[1]-(c+g*r)*n/S,k=e[0]-f,T=e[1]-c,F=e[0]-u,L=e[1]-d;return(W-t[0])*o+(R-t[1])*r<0||(W-i[0])*a+(R-i[1])*s>0?[[e[0]+f,e[1]+c,e[2]],[k,T,e[2]],e,[M,I,e[2]],[e[0]+u,e[1]+d,e[2]],[F,L,e[2]]]:[[W,R,e[2]],[k,T,e[2]],[W,R,e[2]],[M,I,e[2]],[W,R,e[2]],[F,L,e[2]]]}if(o*a+r*s<0){var C=[e[0]+f,e[1]+c,e[2]],z=[e[0]+u,e[1]+d,e[2]],D=[e[0]+(c-d)/2,e[1]+(-f+u)/2,e[2]];return[C,z,D,e,z,C]}var E=[e[0]+(f+u)/2,e[1]+(c+d)/2,e[2]],X=[e[0]-(f+u)/2,e[1]-(c+d)/2,e[2]];return[E,X]}var g=WRAP.Geo.WebGL,p=this.layer;if(p){this.setLayer();var _=p._dc;if(_&&!_.cached){var m=function(t){this.array=t,this.index=0,this.count=0,this.safe=function(){if(!this.array||0==this.array.length)return!1;for(var t=0;t<this.array.length;t++)if(this.array[t]<=0)return!1;return!0},this.get=function(){var t=this.array[this.index++];return this.index>=this.array.length&&(this.index=0),this.count++,t},this.active=function(){return 1==(1&this.count)}},P=1e-5;if(o){var y=this.getColor(o),x=t.colorShader;_.list||(_.list=[]);var w=_.list,A=w.length?w[w.length-1]:null;if(!(i<=1)||n&&n.length)for(var b=0;b<e.length;b++){for(var G=e[b],W=[],R=0;R<G.length;R++){var S=G[R],M=t.screenPoint(S);W.push([M[0],M[1],R])}for(var I=new m(n),k=c(W,i,I),T=[],R=0;R<k.length;R++){var F=k[R],L=F[2],C=G[L],z=W[L];T.push([C[0],C[1],F[0]-z[0],-F[1]+z[1]])}A&&A.shader==x&&"triangleStrip"==A.method||(A={shader:x,method:"triangleStrip",vertices:[],elements:[]},w.push(A));var F=A.vertices,G=e[b];A.elements.push({index:F.length/9,num:T.length});for(var R=0;R<T.length;R++){var S=T[R];F.push(S[0]),F.push(S[1]),F.push(y[0]),F.push(y[1]),F.push(y[2]),F.push(y[3]),F.push(0),F.push(S[2]),F.push(S[3])}}else{A&&A.shader==x&&"lineStrip"==A.method||(A={shader:x,method:"lineStrip",vertices:[],elements:[]},w.push(A));for(var F=A.vertices,b=0;b<e.length;b++){var G=e[b];A.elements.push({index:F.length/9,num:G.length});for(var R=0;R<G.length;R++){var S=G[R];F.push(S[0]),F.push(S[1]),F.push(y[0]),F.push(y[1]),F.push(y[2]),F.push(y[3]),F.push(0),F.push(0),F.push(0)}}}}if(l&&(r||a)){l=parseInt(l);var D=(16711680&l)>>16,E=(65280&l)>>8,X=255&l;this.hitctx.fillStyle="rgb("+D+","+E+","+X+")",this.hitctx.beginPath();for(var R=0;R<e.length;R++){var G=e[R],B=G[0].x,j=G[0].y,b=0;for(this.hitctx.moveTo(B,j);++b<e[R].length;)B=G[b].x,j=G[b].y,this.hitctx.lineTo(B,j)}this.hitctx.closePath(),this.hitctx.fill("evenodd")}if(r){var y=this.getColor(r),x=t.colorShader;_.list||(_.list=[]);var w=_.list,A=w.length?w[w.length-1]:null;A&&A.shader==x&&"triangles"==A.method||(A={shader:x,method:"triangles",vertices:[],elements:[]},w.push(A));for(var H=[],F=A.vertices,b=0;b<e.length;b++){for(var G=e[b],Y=new Float32Array(2*G.length),R=0;R<G.length;R++)Y[2*R]=G[R][0],Y[2*R+1]=G[R][1];H.push(Y)}var N=g.tessellate(H);if(N&&N.triangles.length){A.elements.push({index:F.length/9,num:N.triangles.length});for(var R=0;R<N.triangles.length;R++){var L=2*N.triangles[R];F.push(N.vertices[L]),F.push(N.vertices[L+1]),F.push(y[0]),F.push(y[1]),F.push(y[2]),F.push(y[3]),F.push(0),F.push(0),F.push(0)}}}WRAP.Geo.check(i,n,s)}}},this._fragmentPath=function(t){for(var e=[],i=0;i<t.length;i++){var n=t[i][1],o=t[i][0];if(i>0){var r=t[i-1][1],a=t[i-1][0],s=o-a;s<-180?(s+=360,o+=360):s>=180&&(s-=360,a+=360);var l=Math.abs(s);if(l>1){var h=new WRAP.Geo.GreatCircle(r,a,n,o),f=r,c=a;e.push([c,f]);for(var u=0;u+1<l;){u+=1;var d=u/l,v=h.getPosition(d);e.push([v.lon,v.lat]),f=v.lat,c=v.lon}}else e.push([a,r])}e.push([o,n])}return e},this._normalizePath=function(t){for(var e=[],i=0;i<t.length;i++){var n=t[i][1],o=t[i][0];if(i>0){var r=t[i-1][1],a=t[i-1][0],s=o-a;s<-180?(s+=360,o+=360):s>=180&&(s-=360,a+=360);var l=Math.abs(s);if(0==l)e.push([a,r]);else{(a<-180||o<-180)&&(a+=360,o+=360);var h=(n-r)/(o-a);if(a<180&&180<o){var l=180-a,f=r+l*h;e.push([a,r]),e.push([180,f]),e.push([180,f])}else e.push([a,r])}}e.push([o,n])}return e},this._addFragments=function(t,e){t.push(e);for(var i=9999,n=-9999,o=0;o<e.length;o++){var r=e[o][0];i>r&&(i=r),n<r&&(n=r)}if(i<-180){for(var a=[],o=0;o<e.length;o++){var s=[e[o][0]+360,e[o][1]];a.push(s)}t.push(a)}if(n>180){for(var a=[],o=0;o<e.length;o++){var s=[e[o][0]-360,e[o][1]];a.push(s)}t.push(a)}},this._gcPos=function(t,e,i,n){function o(t){return t*Math.PI*h}function r(t){return t*l*c}var a,s=n,l=10800,h=9259259e-11,f=Math.PI/2,c=1/Math.PI,u=60*t,d=60*e,v=180-i,g=i/180*Math.PI,p=Math.cos(g),_=o(s),m=(.5-u*h)*Math.PI,P=Math.cos(_),y=Math.cos(m),x=Math.sin(_),w=Math.sin(m),A=P*y+x*w*p;a=A>1?0:A<-1?Math.PI:Math.acos(A);var b=f-a;b=r(b);var G,W=Math.sin(a),R=(P*w-x*y*p)/W;G=R>1?0:R<-1?Math.PI:Math.acos(R);var S;return S=v>0?o(d)+G:o(d)-G,S=r(S),S>l?S=2*-l+S:S<-l&&(S=2*l+S),{lat:b/60,lon:S/60}},this.drawPath=function(t,e,i,n,o,r,a,s,l){var h={};if(r){var f=r;if(h=WRAP.Geo.imageCache[f],void 0==h)return h=WRAP.Geo.imageCache[f]={loaded:!1,image:new Image},h.image.onload=function(){h.loaded=!0,WRAP.Geo.invalidate()},void(h.image.src=f)}if(!r||h.loaded){var c=[];if(Array.isArray(t[0][0])){for(var u=0;u<t.length;u++)if(!(t[u].length<2)){var d=t[u];d=s?this._fragmentPath(t[u]):this._normalizePath(t[u]),this._addFragments(c,d)}if(!c.length)return}else{if(t.length<2)return;var d=t;d=s?this._fragmentPath(t):this._normalizePath(t),this._addFragments(c,d)}this._drawLines(c,e,i,n,o,h.image,a,l)}},this.drawArc=function(t,e,i,n,o,r,a,s,l){var h={};if(s){var f=s;if(h=WRAP.Geo.imageCache[f],void 0==h)return h=WRAP.Geo.imageCache[f]={loaded:!1,image:new Image},h.image.onload=function(){h.loaded=!0,WRAP.Geo.invalidate()},void(h.image.src=f)}if(!s||h.loaded){var c=[];(i==n||Math.abs(n-i)>360)&&(i=0,n=360);var u=1;e<5e5?u=5:e<1e5&&(u=2),e/=1851.8518518518517;for(var d=i;d<n;d+=u){var v=this._gcPos(t[1],t[0],d,e);c.push([v.lon,v.lat])}var v=this._gcPos(t[1],t[0],n,e);c.push([v.lon,v.lat]);var g=[];if(c.length<2)return;var p=this._fragmentPath(c);this._addFragments(g,p),this._drawLines(g,o,null,r,a,h.image,null,l)}},this.drawPoint=function(e,i,n,o,r){var a=this.layer;if(a){this.setLayer();var s=a._dc;if(s&&!s.cached){var l=t.pointShader;s.list||(s.list=[]);var h=s.list,f=h.length?h[h.length-1]:null;f&&f.shader==l||(f={shader:l,method:"points",vertices:[],elements:[{index:0,num:0}]},h.push(f));var c=f.elements[0],u=f.vertices;if(o){var d=this.getColor(o);u.push(e[0]),u.push(e[1]),u.push(d[0]),u.push(d[1]),u.push(d[2]),u.push(d[3]),u.push(i+1),u.push(0),u.push(0),c.num++}if(r){var d=this.getColor(r);u.push(e[0]),u.push(e[1]),u.push(d[0]),u.push(d[1]),u.push(d[2]),u.push(d[3]),u.push(i-1),u.push(0),u.push(0),c.num++}n=0}}},this.drawLine=function(t,e,i,n,o,r,a,s,l,h){function f(t,e,i){if(!(e.length<2)){for(var n,o,r=[],a=0;a<e.length;a++){var s=e[a][0],h=e[a][1];if(l){var f=s*g-h*p,u=s*p+h*g;s=f,h=u}s+=v.x,h+=v.y,0==a?n=o=s:(n>s&&(n=s),o<s&&(o=s)),r.push(new WRAP.Geo.ScreenPoint(s,h))}t.push(r);var d=c.x-i/2,_=d-i,m=c.x+i/2,P=m+i;if(n<d&&o>_){for(var y=[],a=0;a<r.length;a++)y.push(new WRAP.Geo.ScreenPoint(r[a].x+i,r[a].y));t.push(y)}if(n<P&&o>m){for(var y=[],a=0;a<r.length;a++)y.push(new WRAP.Geo.ScreenPoint(r[a].x-i,r[a].y));t.push(y)}}}var c={};if(a){var u=a;if(c=WRAP.Geo.imageCache[u],void 0==c)return c=WRAP.Geo.imageCache[u]={loaded:!1,image:new Image},c.image.onload=function(){c.loaded=!0,WRAP.Geo.invalidate()},void(c.image.src=u)}if(!a||c.loaded){for(var c=map.getScreenPoint(new WRAP.Geo.Point(0,0)),d=map.getSize().width/2;c.x-d>=this.canvas_band/2;)c.x-=this.canvas_band;for(;c.x-d<-this.canvas_band/2;)c.x+=this.canvas_band;for(var v=map.getScreenPoint(new WRAP.Geo.Point(60*t[1],60*t[0]));v.x-c.x>this.offset_x+this.canvas_band;)v.x-=this.canvas_band;for(;v.x-c.x<this.offset_x;)v.x+=this.canvas_band;var g,p;l&&(g=Math.cos(Math.PI*l/180),p=Math.sin(Math.PI*l/180));var _=[];if(Array.isArray(e[0][0]))for(var m=0;m<e.length;m++)f(_,e[m],this.canvas_band);else f(_,e,this.canvas_band);if(!_.length)return;this._drawLines(_,i,n,o,r,c.image,s,h)}},this.drawText=function(){},this.drawTile=function(t,e){this.tile(function(i){if(i.id==t.id){var n=document.createElement("canvas");n.width=256,n.height=256;var o=n.getContext("2d");o.putImageData(e,0,0,0,0,256,256),o.fillStyle="rgba(0,0,0,0.0)",o.fillRect(0,0,1,1),i.ctx.drawImage(n,i.offset_x,i.offset_y)}})},this.begin=function(t){this.layers=[],this.hitcvs||(this.hitcvs=document.createElement("canvas"),this.hitctx=this.hitcvs.getContext("2d"));var e=WRAP.Geo.getSize();if(this.hitcvs.width==e.width&&this.hitcvs.width==e.width||(this.hitcvs.width=e.width,this.hitcvs.height=e.height),this.hitctx.anchor=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(0,0)),this.hitctx.clearRect(0,0,e.width,e.height),this.ctx){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(var i=0;i<this.tiles.length;i++){var n=this.tiles[i];n.revision!=t&&(n.valid=!1)}}},this.setLayer=function(){this.layers.length&&this.layers[this.layers.length-1]==this.layer||this.layers.push(this.layer)},this.end=function(){var i=WRAP.Geo.WebGL;e.clearColor(.8,.8,.9,1),e.clear(e.COLOR_BUFFER_BIT);for(var n=t.ppd,o=360*n,r=t.width,a=t.height,s=r/2,l=a/2,h=l+(90-t.center.lat)*n,f=l-(t.center.lat+90)*n,c=s-(t.center.lon+180)*n,u=s+(180-t.center.lon)*n,d=[0],v=0;0<c+v;)v-=o,d.push(v);for(v=0;u+v<r;)v+=o,d.push(v);h>a&&(h=a),f<0&&(f=0);for(var g=h-f,p=c,_=u,m=0;m<d.length;m++){v=d[m],c=p+v,u=_+v,c<0&&(c=0),u>r&&(u=r);var P=u-c,y=i.orthogonalMatrix(-P/2,P/2,-g/2,g/2,-100,100),x=(r-P)/2,w=(a-g)/2;y[3]=(-c+v+x)/(P/2),y[7]=(-f+w)/(g/2),e.viewport(c,f,P,g);for(var A=0;A<this.layers.length;A++){var b=this.layers[A];if(b._dc){for(var G=b._dc.list,W=0;W<G.length;W++){var R=G[W];R.vbo||(R.vbo=R.shader.createBuffer(),R.shader.set(R.vbo,R.vertices),R.vertices=null),R.shader[R.method](y,R.vbo,R.elements)}b._dc.cached=!0}}}e.flush()},this.getColor=function(t){this.color_cache||(this.color_cache={});var e=this.color_cache[t];if(!e){var i=WRAP.Geo.parseColor(t);e=[],e[0]=parseFloat(i[0])/255,e[1]=parseFloat(i[1])/255,e[2]=parseFloat(i[2])/255,e[3]=parseFloat(i[3])/255,this.color_cache[t]=e}return e},this.rev=0},this.ColorShader=function(){var i=WRAP.Geo.WebGL;this.pg=i.setup(t,"attribute vec4 position;attribute vec2 offset;attribute vec4 color;uniform float scale;uniform float center_lat;uniform float center_lon;uniform mat4 projection;varying vec4 v_color;void main(){    float y = (position.y-center_lat)*scale;    float x = (position.x-center_lon)*scale;    vec4 p = vec4(x+offset.x, y+offset.y, 0.0, 1.0);    gl_Position = p * projection;    v_color = color;}","precision mediump float;\nvarying vec4 v_color;void main(){    gl_FragColor = v_color;}"),t.useProgram(this.pg);var n=t.getAttribLocation(this.pg,"offset"),o=t.getAttribLocation(this.pg,"position"),r=t.getAttribLocation(this.pg,"color"),a=t.getUniformLocation(this.pg,"projection"),s=t.getUniformLocation(this.pg,"center_lat"),l=t.getUniformLocation(this.pg,"center_lon"),h=t.getUniformLocation(this.pg,"scale");this.createBuffer=function(){return t.createBuffer()},this.deleteBuffer=function(e){t.deleteBuffer(e)},this.set=function(e,i){t.bindBuffer(t.ARRAY_BUFFER,e),t.bufferData(t.ARRAY_BUFFER,new Float32Array(i),t.DYNAMIC_DRAW)},this.draw=function(i,f,c,u){t.useProgram(this.pg),t.uniformMatrix4fv(a,!1,f),t.uniform1f(s,e.center.lat),t.uniform1f(l,e.center.lon),t.uniform1f(h,e.ppd);var d=4;t.bindBuffer(t.ARRAY_BUFFER,c),t.vertexAttribPointer(o,2,t.FLOAT,!1,9*d,0),t.enableVertexAttribArray(o),t.vertexAttribPointer(r,4,t.FLOAT,!1,9*d,2*d),t.enableVertexAttribArray(r),t.vertexAttribPointer(n,2,t.FLOAT,!1,9*d,7*d),t.enableVertexAttribArray(n);for(var v=0;v<u.length;v++){var g=u[v];t.drawArrays(i,g.index,g.num)}},this.triangleStrip=function(e,i,n){this.draw(t.TRIANGLE_STRIP,e,i,n)},this.triangles=function(e,i,n){this.draw(t.TRIANGLES,e,i,n)},this.lineStrip=function(e,i,n){this.draw(t.LINE_STRIP,e,i,n)}},this.PointShader=function(){var i=WRAP.Geo.WebGL;this.pg=i.setup(t,"attribute vec4 position;attribute vec4 color;attribute float value;uniform float scale;uniform float center_lat;uniform float center_lon;uniform mat4 projection;varying vec4 v_color;void main(){    float y = (position.y-center_lat)*scale;    float x = (position.x-center_lon)*scale;    vec4 p = vec4(x, y, 0.0, 1.0);    gl_Position = p * projection;    gl_PointSize = value;    v_color = color;}","precision mediump float;\nvarying vec4 v_color;void main(){    float dist = distance(gl_PointCoord, vec2(0.5, 0.5));    if ( dist < 0.5 ) {        gl_FragColor = v_color;    } else {        discard;    }}"),t.useProgram(this.pg);var n=t.getAttribLocation(this.pg,"position"),o=t.getAttribLocation(this.pg,"color"),r=t.getAttribLocation(this.pg,"value"),a=t.getUniformLocation(this.pg,"projection"),s=t.getUniformLocation(this.pg,"center_lat"),l=t.getUniformLocation(this.pg,"center_lon"),h=t.getUniformLocation(this.pg,"scale");this.createBuffer=function(){return t.createBuffer()},this.deleteBuffer=function(e){t.deleteBuffer(e)},this.set=function(e,i){t.bindBuffer(t.ARRAY_BUFFER,e),t.bufferData(t.ARRAY_BUFFER,new Float32Array(i),t.DYNAMIC_DRAW)},this.draw=function(i,f,c,u){t.useProgram(this.pg),t.uniformMatrix4fv(a,!1,f),t.uniform1f(s,e.center.lat),t.uniform1f(l,e.center.lon),t.uniform1f(h,e.ppd);var d=4;t.bindBuffer(t.ARRAY_BUFFER,c),t.vertexAttribPointer(n,2,t.FLOAT,!1,9*d,0),t.enableVertexAttribArray(n),t.vertexAttribPointer(o,4,t.FLOAT,!1,9*d,2*d),t.enableVertexAttribArray(o),t.vertexAttribPointer(r,1,t.FLOAT,!1,9*d,6*d),t.enableVertexAttribArray(r);for(var v=0;v<u.length;v++){var g=u[v];t.drawArrays(i,g.index,g.num)}},this.points=function(e,i,n){this.draw(t.POINTS,e,i,n)}},this.colorShader=new this.ColorShader,this.pointShader=new this.PointShader}},tessellate:function(t){var e,i=Module.cwrap("tessellate","void",["number","number","number","number","number","number"]);if(0===t.length)throw"Expected at least one loop";for(var n=[],o=[0],r=0;r<t.length;++r){var a=t[r];if(a.length%2!==0)throw"Expected even number of coordinates";n.push.apply(n,a),o.push(n.length)}var s=Module._malloc(8*n.length);for(e=0;e<n.length;++e)Module.setValue(s+8*e,n[e],"double");var l=Module._malloc(4*o.length);for(e=0;e<o.length;++e)Module.setValue(l+4*e,s+8*o[e],"i32");var h=Module._malloc(4),f=Module._malloc(4),c=Module._malloc(4),u=Module._malloc(4);i(h,c,f,u,l,l+4*o.length);var d=Module.getValue(h,"i32"),v=Module.getValue(f,"i32"),g=Module.getValue(c,"i32"),p=Module.getValue(u,"i32"),_=new Float64Array(2*g),m=new Int32Array(3*p);for(e=0;e<2*g;++e)_[e]=Module.getValue(d+8*e,"double");for(e=0;e<3*p;++e)m[e]=Module.getValue(v+4*e,"i32");return Module._free(c),Module._free(u),Module._free(h),Module._free(f),Module._free(d),Module._free(v),Module._free(s),Module._free(l),{vertices:_,triangles:m}}},WRAP.Geo.Renderer.Mesh=function(){var t=this;this.palette=null,this.palette_value_min=0,this.palette_value_max=0,this.palette_gradient=!0,this.palette_scale=10,this.palette_step=1,this.setPalette=function(e){if(!t.palette&&e.palette){t.palette=[],t.palette_gradient=e.palette_gradient,t.palette_step=e.palette_step||1,t.palette_scale=1/t.palette_step;for(var i=e.palette,n=[],o=0;o<i.length;o++){var r=[],a=i[o].value;0==o?(this.palette_value_min=a,this.palette_value_max=a):(this.palette_value_min>a&&(this.palette_value_min=a),this.palette_value_max<a&&(this.palette_value_max=a)),r.push(a);var s=WRAP.Geo.parseColor(i[o].color);r.push(s[0]),r.push(s[1]),r.push(s[2]),r.push(s[3]),n.push(r)}for(var l=0,h=t.palette_value_min;h<=t.palette_value_max+t.palette_step;h+=t.palette_step){for(;l<n.length-1&&h>=n[l+1][0];)l++;if(l==n.length-1)t.palette.push([parseInt(n[l][1]),parseInt(n[l][2]),parseInt(n[l][3]),parseInt(n[l][4])]);else{var f=n[l][1],c=n[l][2],u=n[l][3],d=n[l][4];if(t.palette_gradient){var v=(h-n[l][0])/(n[l+1][0]-n[l][0]),g=n[l+1][1],p=n[l+1][2],_=n[l+1][3],m=n[l+1][4];t.palette.push([parseInt(f+(g-f)*v),parseInt(c+(p-c)*v),parseInt(u+(_-u)*v),parseInt(d+(m-d)*v)])}else t.palette.push([parseInt(f),parseInt(c),parseInt(u),parseInt(d)])}}}},this.getColor=function(e){var i=Math.floor((e-t.palette_value_min)*t.palette_scale);return i<0?[0,0,0,0]:(i>=t.palette.length&&(i=t.palette.length-1),t.palette[i])},this.draw=function(e,i,n,o,r,a,s,l){if(i){var h=!0;if(this.context_revision!=s.context&&(h=!1),this.content_revision!=s.content&&(h=!1),this.conf_revision!=s.conf&&(t.palette=null,l.length=0,e.clear(),h=!1),this.style_revision!=s.style&&(h=!1,this.palette=null),!h){var f=n.Attributes.data_scale||1,c=n.Attributes.data_offset||0,u=n.Attributes.style.default;if(!r&&n.Attributes.style_selector){if(!n.Attributes.style_selector.key||!n.Attributes.style_selector.styles)return void console.log("style_selector formar error.");for(var d=n.Attributes.style_selector.key,v=0;v<n.Attributes.style_selector.styles.length;v++){var g=n.Attributes.style_selector.styles[v].values;if(g.indexOf(i[d])>=0){r=n.Attributes.style_selector.styles[v].style;break}}}if(r&&n.Attributes.style[r]&&(u=n.Attributes.style[r]),u){this.setPalette(u);for(var p="block"!=u.fill_type?"interpolate":"nearest",_=u.fill_type,m=u.contour,P=[],y=[],v=0;v<o.tiles.length;v++){for(var x=o.tiles[v],w=0;w<l.length;w++){var A=l[w];if(A.data&&A.data.tile&&A.data.tile.id==x.id&&A.data.revision==s.content){y.push(A),x=null;break}}x&&P.push(x)}for(var b=[],v=0;v<P.length;v++){var x=P[v];if(!(b[v]=a._handler().getTile(i,x.id,p)))return void a._handler().loadTile(i,x.id,p,x.z,x.y,x.x,x.cood,x.bounds,function(){WRAP.Geo.redraw(e)})}var G=[],W=e.getBlendLayer();if(W)for(var w=0;w<W.length;w++){var R=W[w];if(R.visible()){for(var S=[],v=0;v<P.length;v++){var x=P[v];if(!(S[v]=R._data._handler().getTile(i,x.id,p)))return void R._data._handler().loadTile(i,x.id,p,x.z,x.y,x.x,x.cood,x.bounds,function(){WRAP.Geo.redraw(e)})}G.push(S)}}var M=[];e.clear();for(var v=0;v<y.length;v++)e.addFeature(y[v]),M.push(y[v]);for(var v=0;v<b.length;v++){var I=b[v],u=null;I&&!I.empty&&(u=this.getData(i,I.data)),G.length&&u&&(u=u.concat());for(var w=0;w<G.length;w++){var k=G[w][v];if(k&&!k.empty){u||(u=new Array(65536));var T=this.getData(i,k.data);if(T)for(var F=0;F<65536;F++){var L=T[F];isNaN(L)||(u[F]=L)}}}if(u){var x=P[v],C=x.ctx.createImageData(256,256),z=C.data;if(_)for(var F=0;F<65536;F++){var D=u[F];if(!isNaN(D)){D=D*f+c;var E=this.getColor(D),X=4*F;z[X]=E[0],z[X+1]=E[1],z[X+2]=E[2],z[X+3]=E[3]}}var B=[];if(m){for(var j=0,H=0,X=0;X<65536;X++){var D=u[X];isNaN(D)||(0==X?j=H=D:(j>D&&(j=D),H<D&&(H=D)))}for(var w=0;w<m.length;w++)for(var Y=m[w],E=WRAP.Geo.parseColor(Y.strokeStyle),N=Y.unit_label||"",O=void 0===Y.fractional_digits?void 0:parseInt(Y.fractional_digits),V=Y.interval/f,U=Y.base,D=(Y.base-c)/f,Z=0;Z<Y.num;Z++){if(j<=D&&D<=H){for(var q=-1,J=0,Q=0,K=0,$=0;$<256;$++)for(var tt=0==$?0:-256,et=255==$?0:256,it=0;it<256;it++){var nt=0==it?0:-1,ot=255==it?0:1,rt=u[K];try{if(rt>=D){var at=u[K+tt],st=u[K+nt],lt=u[K+ot],ht=u[K+et];if(at<D||st<D||lt<D||ht<D){z[4*K]=E[0],z[4*K+1]=E[1],z[4*K+2]=E[2],z[4*K+3]=E[3],Y.lineWidth>1&&(z[4*K+4]=E[0],z[4*K+5]=E[1],z[4*K+6]=E[2],z[4*K+7]=E[3],z[4*K+1024]=E[0],z[4*K+1024+1]=E[1],z[4*K+1024+2]=E[2],z[4*K+1024+3]=E[3]);var ft=Math.abs(it-128)+Math.abs($-128);(q<0||ft<q)&&(q=ft,J=it,Q=$)}}}catch(t){}K++}if(20<J&&J<=236&&20<Q&&Q<=236){var ct=void 0===O?U:U.toFixed(O);B.push({x:J,y:Q,value:ct+N,color:Y.textColor})}}U+=Y.interval,D+=V}}var ut=new WRAP.Geo.Feature.Tile({tile:x,imageData:C});e.addFeature(ut),M.push(ut);for(var dt=[],ft=0;ft<B.length;ft++){var vt=2*(256*B[ft].y+B[ft].x),gt=x.cood[vt],pt=x.cood[vt+1],_t=new WRAP.Geo.Feature.Text({point:[pt,gt],text:B[ft].value,fontSize:12,fillStyle:B[ft].color,offsetX:0,offsetY:0,align:"center"});dt.push(_t)}ut.data={tile:x,label:dt,length:B.length,
revision:s.content}}}for(var F=0;F<M.length;F++){var A=M[F];if(A.data&&A.data.label)for(var B=A.data.label,ft=0;ft<B.length;ft++)e.addFeature(B[ft])}this.context_revision=s.context,this.content_revision=s.content,this.conf_revision=s.conf,this.style_revision=s.style,WRAP.Geo.invalidate()}}}}},WRAP.Geo.Renderer.Mesh.prototype.getData=function(t,e){if(!t.element||!Array.isArray(t.element))return e},WRAP.Geo.Renderer.Image=function(){this.draw=function(t,e,i,n,o,r,a,s){if(e){var l=!0;if(this.context_revision!=a.context&&(l=!1),this.content_revision!=a.content&&(l=!1),this.conf_revision!=a.conf&&(l=!1,s.length=0,this.palette=null),this.style_revision!=a.style&&(l=!1,s.length=0,this.palette=null),!l){var h=i.Attributes.style.default;if(o&&i.Attributes.style[o]&&(h=i.Attributes.style[o]),h){for(var f=null,c=[],u=[],d=0;d<n.tiles.length;d++){for(var v=n.tiles[d],g=0;g<s.length;g++){var p=s[g];if(p.data&&p.data.tile&&p.data.tile.id==v.id&&p.data.revision==a.content){u.push(p),v=null;break}}v&&c.push(v)}for(var _=[],d=0;d<c.length;d++){var v=c[d];if(!(_[d]=r._handler().getTile(e,v.id,f)))return void r._handler().loadTile(e,v.id,f,v.z,v.y,v.x,v.cood,v.bounds,function(){WRAP.Geo.redraw(t)})}t.clear();for(var d=0;d<u.length;d++)t.addFeature(u[d]);for(var d=0;d<_.length;d++){var m=_[d];if(m&&!m.empty&&m.data){var v=c[d],P=v.ctx.createImageData(256,256),y=m.data,x=P.data,w=0;if("rgb_palette"==h.type&&h.palette)for(var A=h.palette,b=0;b<65536;b++){for(var G=y[w],W=y[w+1],R=y[w+2],S=y[w+3],g=0;g<A.length;g++){var M=A[g][0];if(G==M[0]&&W==M[1]&&R==M[2]){G=A[g][1][0],W=A[g][1][1],R=A[g][1][2],S=A[g][1][3];break}}x[w++]=G,x[w++]=W,x[w++]=R,x[w++]=S}else if("grayscale_palette"==h.type&&h.palette)for(var A=h.palette,g=0;g<65536;g++){var I=y[w],b=A[I];x[w++]=b[0],x[w++]=b[1],x[w++]=b[2],x[w++]=b[3]}else if("filter"==h.type)for(var k=parseInt(h.rgb_offset)||0,T=parseFloat(h.opacity)||1,g=0;g<65536;g++){var G=y[w]+k,W=y[w+1]+k,R=y[w+2]+k,S=y[w+3]*T;G<0?G=0:G>255&&(G=255),W<0?W=0:W>255&&(W=255),R<0?R=0:R>255&&(R=255),x[w++]=G,x[w++]=W,x[w++]=R,x[w++]=S}else for(var F=y.length,g=0;g<F;g++)x[g]=y[g];var L=new WRAP.Geo.Feature.Tile({tile:v,imageData:P});L.data={tile:v,revision:a.content},t.addFeature(L)}}this.context_revision=a.context,this.content_revision=a.content,this.conf_revision=n.conf,this.style_revision=a.style,WRAP.Geo.invalidate()}}}},this.merge=function(t,e,i,n){var o=[256,256,256,256],r=i.Attributes.style.default;n&&i.Attributes.style[n]&&(r=i.Attributes.style[n]),r&&r.alternative_color&&4==r.alternative_color.length&&(o=r.alternative_color);for(var a=[],s=0;s<e.length;s++){var r=e[s].style();if(r.tile){for(var l=null,h=0;h<t.length;h++){var f=t[h].style();if(f.tile&&f.tile.id==r.tile.id){l=f;break}}if(l){if(r.imageData&&l.imageData)for(var c=r.imageData.data,u=l.imageData.data,d=0;d<65536;d++){var v=4*d;c[v]==o[0]&&c[v+1]==o[1]&&c[v+2]==o[2]&&c[v+3]==o[3]?0==u[v+3]&&(u[v]=o[0],u[v+1]=o[1],u[v+2]=o[2],u[v+3]=o[3]):c[v+3]&&(u[v]=c[v],u[v+1]=c[v+1],u[v+2]=c[v+2],u[v+3]=c[v+3])}}else{for(var g=r.tile.ctx.createImageData(256,256),c=r.imageData.data,u=g.data,d=0;d<65536;d++){var v=4*d;c[v]==o[0]&&c[v+1]==o[1]&&c[v+2]==o[2]&&c[v+3]==o[3]?(u[v]=o[0],u[v+1]=o[1],u[v+2]=o[2],u[v+3]=o[3]):(u[v]=c[v],u[v+1]=c[v+1],u[v+2]=c[v+2],u[v+3]=c[v+3])}a.push(new WRAP.Geo.Feature.Tile({tile:r.tile,imageData:g}))}}}for(var s=0;s<a.length;s++)t.push(a[s])},this.getValue=function(t,e,i,n){for(var o=0;o<e.tiles.length;o++){var r=e.tiles[o],a=r.bounds.north,s=r.bounds.south;if(!(n.lat>a||n.lat<s)){var l=r.bounds.east;l<-10800?l+=21600:l>=10800&&(l-=21600);var h=r.bounds.west;if(h<-10800?h+=21600:h>=10800&&(h-=21600),h<l){if(n.lon>l||n.lon<h)continue}else if(n.lon>l&&n.lon<h)continue;var f=i._handler().getTile(t,r.id);if(f){for(var c=n.latDegree(),u=n.lonDegree(),o=0,d=0;d<256&&r.cood[o]>c;)d++,o+=512;for(var v=0;v<256;){var g=r.cood[o+1];if(g<0?g+=360:g>=180&&(g-=360),u<=g)break;v++,o+=2}var p=4*(256*d+v);return{data:[f.data[p],f.data[p+1],f.data[p+2],f.data[p+3]]}}break}}return null}},WRAP.Geo.Renderer.GridValue=function(){this.style_revision,this.context_revision,this.draw=function(t,e,i,n,o,r,a,s){if(e&&(!this.revision||this.revision.context!=a.context)){this.style_revision!=a.style&&(this.style_revision=a.style);var l=i.Attributes.style.default;if(o&&i.Attributes.style[o]&&(l=i.Attributes.style[o]),l){for(var h="value",f=[],c=0;c<n.tiles.length;c++){var u=n.tiles[c];if(!(f[c]=r._handler().getTile(e,u.id,h)))return void r._handler().loadTile(e,u.id,h,u.z,u.y,u.x,u.cood,u.bounds,function(){WRAP.Geo.redraw(t)})}var d=i.Attributes.data_scale||1,v=i.Attributes.data_offset||0,g=void 0===l.fractional_digits?1:parseInt(l.fractional_digits),p=l.offset_x||0,_=l.offset_y||0;s.length=0;for(var c=0;c<f.length;c++)for(var r=f[c].data,m=0;m<r.length;m++){var P=r[m];if(P.value&&!isNaN(P.value)){var y,x=(P.value*d+v).toFixed(g);y=new WRAP.Geo.Feature.Text({point:[P.lon,P.lat],text:x,fontSize:14,fillStyle:l.color,offsetX:p,offsetY:_,align:"center"}),s.push(y)}}this.context_revision=n.revision,WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.WindArrow=function(){this.style_revision,this.context_revision,this.image=null,this.arrow_step=0,this.image_width=32,this.image_height=64,this.draw=function(t,e,i,n,o,r,a){function s(t,e,i,n){for(var o=5;o<200;o+=5){i.clearRect(0,0,e.width,e.height);var r=1.5,a=4,s=24,l={x:e.width/2,y:e.height-1},h=o;for(h*=2,h/=10,h=Math.round(h),h*=10,h/=2,h>=50&&(s+=5*Math.floor(h/50)),h>0&&(i.beginPath(),i.moveTo(l.x,l.y),i.lineTo(l.x,l.y+(-s-(h<6?4:0))*r),i.stroke());h>=50;)i.beginPath(),i.moveTo(l.x,l.y+-s*r),i.lineTo(l.x+10*n*r,l.y+(-s+1.5)*r),i.lineTo(l.x,l.y+(-s+5)*r),i.lineTo(l.x,l.y+-s*r),i.stroke(),h-=50,s-=a+2.5;for(o>50&&(s-=2);h>=10;)i.moveTo(l.x,l.y+-s*r),i.lineTo(l.x+10*n*r,l.y+(-s-4)*r),h-=10,s-=a;h>=5&&(i.moveTo(l.x,l.y+-s*r),i.lineTo(l.x+7*n*r,l.y+(-s-3)*r),h-=5,s-=a),i.stroke(),t.push(i.getImageData(0,0,e.width,e.height))}}function l(t,e,i){i.clearRect(0,0,e.width,e.height);var n=1.5,o=24,r={x:e.width/2,y:e.height-1};i.beginPath(),i.moveTo(r.x,r.y),i.lineTo(r.x,r.y+(-o-4)*n),i.stroke(),t.push(i.getImageData(0,0,e.width,e.height))}function h(t,e,i){i.clearRect(0,0,e.width,e.height),i.lineWidth=1.5,i.beginPath(),i.arc(e.width/2,e.height-6,3,0,2*Math.PI,!0),i.closePath(),i.stroke(),i.fill(),t.push(i.getImageData(0,0,e.width,e.height))}if(e&&(!this.revision||this.revision.context!=a.context)){this.style_revision!=a.style&&(this.style_revision=a.style);var f=i.Attributes.style.default;if(o&&i.Attributes.style[o]&&(f=i.Attributes.style[o]),f){if(!this.image){this.image=[];var c=document.createElement("canvas");c.width=this.image_width,c.height=this.image_height;var u=c.getContext("2d");u.strokeStyle=f.color,u.fillStyle=f.color,u.lineCap="round",u.lineWidth=1.5,s(this.image,c,u,1),this.arrow_step=this.image.length,s(this.image,c,u,-1),l(this.image,c,u),h(this.image,c,u)}for(var d="value",v=[],g=0;g<n.tiles.length;g++){var p=n.tiles[g];if(!(v[g]=r._handler().getTile(e,p.id,d)))return void r._handler().loadTile(e,p.id,d,p.z,p.y,p.x,p.cood,p.bounds,function(){WRAP.Geo.redraw(t)})}var _=i.Attributes.data_scale||1,m=i.Attributes.data_offset||0,P=i.Attributes.threshold||0;t.clear(0);for(var g=0;g<v.length;g++)for(var r=v[g].data,y=0;y<r.length;y++){var x=r[y];if(x.value&&2==x.value.length&&!isNaN(x.value[0])&&!isNaN(x.value[1])){var w=x.value[0]*_+m,A=x.value[1]*_+m,b=Math.sqrt(w*w+A*A)/.514;if(b>P){var G=b;b=Math.round(b);var W=0;b>0&&(W=Math.atan2(w,A)*(180/Math.PI),W-=180,W<0&&(W+=360));var R,S=Math.floor(b),M=Math.floor(W),M=S?M||360:0,I=S+"KT",k=S?("000"+M).slice(-3):"",T=.6*this.image_width,F=.6*this.image_height,L=Math.floor((b+2)/5)-1;L>=this.arrow_step&&(L=this.arrow_step-1);var C=W,z=-T/2,D=-F;L==-1?Math.floor(b)>0?L=this.image.length-2:(C=0,D+=5,L=this.image.length-1):x.lat<0&&(L+=this.arrow_step),R=new WRAP.Geo.Feature.Image({point:[x.lon,x.lat],image:this.image[L],width:T,height:F,offsetX:z,offsetY:D,rotation:C}),t.addFeature(R),R.geo={geometry:{type:"Point",coordinates:[x.lon,x.lat]},properties:{u:w,v:A,speed:G,direction:W,speed_text:I,direction_text:k}}}}}this.context_revision=n.revision,WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.GridArrow=function(){var t=this;this.style_revision,this.context_revision,this.palette=null,this.palette_value_min=0,this.palette_value_max=0,this.palette_gradient=!0,this.palette_scale=10,this.palette_step=1,this.color=null,this.setPalette=function(e){if(!t.color&&e.color&&(t.color=WRAP.Geo.parseColor(e.color)),!t.palette&&e.palette){t.palette=[],t.palette_gradient=e.palette_gradient,t.palette_step=e.palette_step||1,t.palette_scale=1/t.palette_step;for(var i=e.palette,n=[],o=0;o<i.length;o++){var r=[],a=i[o].value;0==o?(this.palette_value_min=a,this.palette_value_max=a):(this.palette_value_min>a&&(this.palette_value_min=a),this.palette_value_max<a&&(this.palette_value_max=a)),r.push(a);var s=WRAP.Geo.parseColor(i[o].color);r.push(s[0]),r.push(s[1]),r.push(s[2]),r.push(s[3]),n.push(r)}for(var l=0,h=t.palette_value_min;h<=t.palette_value_max;h+=t.palette_step){for(;l<n.length-1&&h>=n[l+1][0];)l++;if(l==n.length-1)t.palette.push([parseInt(n[l][1]),parseInt(n[l][2]),parseInt(n[l][3]),parseInt(n[l][4])]);else{var f=n[l][1],c=n[l][2],u=n[l][3],d=n[l][4];if(t.palette_gradient){var v=(h-n[l][0])/(n[l+1][0]-n[l][0]),g=n[l+1][1],p=n[l+1][2],_=n[l+1][3],m=n[l+1][4];t.palette.push([parseInt(f+(g-f)*v),parseInt(c+(p-c)*v),parseInt(u+(_-u)*v),parseInt(d+(m-d)*v)])}else t.palette.push([parseInt(f),parseInt(c),parseInt(u),parseInt(d)])}}}},this.getColor=function(e){if(t.color)return t.color;var i=Math.floor((e-t.palette_value_min)*t.palette_scale);return i<0?[0,0,0,0]:(i>=t.palette.length&&(i=t.palette.length-1),t.palette[i])},this.draw=function(t,e,i,n,o,r,a){if(e&&(!this.revision||this.revision.context!=a.context)){this.style_revision!=a.style&&(this.style_revision=a.style);var s=i.Attributes.style.default;if(o&&i.Attributes.style[o]&&(s=i.Attributes.style[o]),s){this.setPalette(s);var l="value";s.min_blocksize&&(l+=" "+s.min_blocksize);for(var h=[],f=0;f<n.tiles.length;f++){var c=n.tiles[f];if(!(h[f]=r._handler().getTile(e,c.id,l)))return void r._handler().loadTile(e,c.id,l,c.z,c.y,c.x,c.cood,c.bounds,function(){WRAP.Geo.redraw(t)})}var u=[],d=t.getBlendLayer();if(d)for(var v=0;v<d.length;v++){var g=d[v];if(g.visible()){for(var p=[],f=0;f<n.tiles.length;f++){var c=n.tiles[f];if(!(p[f]=g._data._handler().getTile(e,c.id,l)))return void g._data._handler().loadTile(e,c.id,l,c.z,c.y,c.x,c.cood,c.bounds,function(){WRAP.Geo.redraw(t)})}u.push(p)}}var _=i.Attributes.data_scale||1,m=i.Attributes.data_offset||0,P=i.Attributes.type,y=i.Attributes.threshold||0,x=s.base_length||16,w=s.speed_length_racio||0;t.clear();for(var f=0;f<h.length;f++){var r=h[f].data;u.length&&r&&(r=r.concat());for(var v=0;v<u.length;v++){var A=u[v][f].data;if(A){r||(r=new Array);for(var b=0;b<A.length;b++){var G=A[b];if(void 0!==G.value&&!isNaN(G.value)){for(var W=0;W<r.length;W++){var R=r[W];if(R.lat==G.lat&&R.lon==G.lon){r.splice(W,1);break}}r.push(G)}}}}if(r)for(var v=0;v<r.length;v++){var S=r[v],M=0,I=0;if("SpeedDirection"==P){if(!S.value||2!=S.value.length||isNaN(S.value[0])||isNaN(S.value[1]))continue;M=S.value[0]*_+m,I=S.value[1]}else if("Direction"==P){if(void 0===S.value||isNaN(S.value))continue;M=-1,I=S.value*_+m}else{if(!S.value||2!=S.value.length||isNaN(S.value[0])||isNaN(S.value[1]))continue;var k=S.value[0],T=S.value[1];M=Math.sqrt(k*k+T*T)*_+m,M>0&&(I=Math.atan2(k,T)*(180/Math.PI),I+=180,I<0&&(I+=360))}if(M<0||M>=y){var F=this.getColor(M),W=x+M*w,L=new WRAP.Geo.Feature.Line({point:[S.lon,S.lat],line:[[[0,0],[0,W]],[[2,W-4],[0,W],[-2,W-4]]],strokeStyle:"rgba("+F[0]+","+F[1]+","+F[2]+","+F[3]/255+")",rotation:I});t.addFeature(L)}}}this.context_revision=n.revision,WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.DataJSON=function(){this.draw=function(t,e,i,n,o,r,a,s){function l(t,e){for(var i=null,n=0;n<d.length;n++){var o=d[n].selector;if(!o){i=d[n].style;break}if("key_value"==o.type&&t[o.key]==o.value){i=d[n].style;break}}var r=i&&i[c];if(r){var a=_[e];if(a){var l=a.geometry;if(l&&t.display_flag!==!1)if("Point"==l.type){var h=l.coordinates;if("image"==r.type){var f=new WRAP.Geo.Feature.Image({point:h,image:r.url,width:r.width,height:r.height,offsetX:r.offset_x,offsetY:r.offset_y,rotation:r.rotation});f.geo=a,f.data=t,s.push(f)}else if("point"==r.type){var f=new WRAP.Geo.Feature.Point({point:h,strokeStyle:r.line_color,strokeWidth:r.line_width,fillStyle:r.point_color,pointSize:r.point_size,sensorSize:r.sensor_size});f.geo=a,f.data=t,s.push(f)}}else if("MultiPoint"==l.type)for(var u=0;u<l.coordinates.length;u++){var h=l.coordinates[u];if("image"==r.type){var f=new WRAP.Geo.Feature.Image({point:h,image:r.url,width:r.width,height:r.height,offsetX:r.offset_x,offsetY:r.offset_y,rotation:r.rotation});f.geo=a,f.data=t,s.push(f)}else if("point"==r.type){var f=new WRAP.Geo.Feature.Point({point:h,strokeStyle:r.line_color,strokeWidth:r.line_width,fillStyle:r.point_color,pointSize:r.point_size,sensorSize:r.sensor_size});f.geo=a,f.data=t,s.push(f)}}else if("LineString"==l.type||"MultiLineString"==l.type){var v=l.coordinates;if(v){var f=new WRAP.Geo.Feature.GeoLine({path:v,lineWidth:r.line_width,strokeStyle:r.line_color});f.geo=a,f.data=t,s.push(f)}}else if("Polygon"==l.type){var v=l.coordinates;if(v){var f=new WRAP.Geo.Feature.GeoLine({path:v,lineWidth:r.line_width,strokeStyle:r.line_color,fillStyle:r.fill_color,fillImage:r.fill_image});f.geo=a,f.data=t,s.push(f)}}else if("MultiPolygon"==l.type)for(var g=0;g<l.coordinates.length;g++){var v=l.coordinates[g];if(v){var f=new WRAP.Geo.Feature.GeoLine({path:v,lineWidth:r.line_width,strokeStyle:r.line_color,fillStyle:r.fill_color,fillImage:r.fill_image});f.geo=a,f.data=t,s.push(f)}}}}}o=null,e=null,n=null;var h=r.query("data").value();if(h&&h.position&&h.data){var f=!0;if(this.content_revision!=a.content&&(f=!1),this.conf_revision!=a.conf&&(f=!1),this.style_revision!=a.style&&(f=!1),this.data_revision!=a.data&&(f=!1),!f){t=null,s.length=0;var c="default",u=h.position.features;u||(u=[],"Feature"==h.position.type&&u.push(h.position));for(var d=i.Attributes.features,v=r._handler().conf,g=v.Attributes.DataStructure.geo_position_key||"position_id",p=v.Attributes.DataStructure.data_position_key||"position_id",_={},m=0,P=u.length,y=0;y<P;y++){var x=u[y],w=x.properties;if(w){var A=x.geometry;if(A){var b=w[g];_[b]&&m++,_[b]=x}}}var G=0;if(Array.isArray(h.data.data)){G=h.data.data.length;for(var y=0;y<G;y++){var x=h.data.data[y],b=x[p];l(x,b)}}else for(var W in h.data.data){var x=h.data.data[W];l(x,W),G++}this.content_revision=a.content,this.conf_revision=a.conf,this.style_revision=a.style,this.data_revision=a.data,WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.GeoJSON=function(){this.initialized=!1,this.draw=function(t,e,i,n,o,r,a,s){WRAP.Geo.check(t,e,i,n,o,r,a,s);var l=-1;n&&n.tiles.length&&(l=n.zoom);var h=r._handler().tiled();if(h){if(this.content_revision==a.content&&this.context_revision==a.context&&this.conf_revision==a.conf&&this.style_revision==a.style&&this.data_revision==a.data)return}else if(i.Attributes.min_zoom){if(this.last_zoom==l&&this.content_revision==a.content&&this.conf_revision==a.conf&&this.style_revision==a.style&&this.data_revision==a.data)return}else if(this.content_revision==a.content&&this.conf_revision==a.conf&&this.style_revision==a.style&&this.data_revision==a.data)return;var f=r._handler().getData(e,n);if(!f)return void r._handler().loadData(e,n,function(){WRAP.Geo.redraw(t)});for(var c=[],u=0;u<f.length;u++){var d=f[u].features;if(d)for(var v=0;v<d.length;v++)c.push(d[v]);else"Feature"==f[u].type&&c.push(f[u])}if(t.clear(),!i.Attributes.min_zoom||l>=i.Attributes.min_zoom)for(var g=o||"default",p=i.Attributes.features,_=c.length,u=0;u<_;u++){var m=c[u],P=m.geometry;if(P){var y=m.properties;if(!y||y.display_flag!==!1){for(var o=null,v=0;v<p.length;v++){var x=p[v].selector;if(!x){o=p[v].style;break}if("key_value"==x.type&&y[x.key]==x.value){o=p[v].style;break}}var w=o&&o[g];if(w){var A=void 0===w.geodesic||w.geodesic===!0;if("Point"==P.type){var b=P.coordinates;if("image"==w.type){var G=new WRAP.Geo.Feature.Image({point:b,image:w.url,width:w.width,height:w.height,offsetX:w.offset_x,offsetY:w.offset_y,rotation:w.rotation});G.geo=m,t.addFeature(G)}else if("point"==w.type){var G=new WRAP.Geo.Feature.Point({point:b,strokeStyle:w.line_color,strokeWidth:w.line_width,fillStyle:w.point_color,pointSize:w.point_size,sensorSize:w.sensor_size});G.geo=m,t.addFeature(G)}}else if("MultiPoint"==P.type)for(var W=0;W<P.coordinates.length;W++){var b=P.coordinates[W];if("image"==w.type){var G=new WRAP.Geo.Feature.Image({point:b,image:w.url,width:w.width,height:w.height,offsetX:w.offset_x,offsetY:w.offset_y,rotation:w.rotation});G.geo=m,t.addFeature(G)}else if("point"==w.type){var G=new WRAP.Geo.Feature.Point({point:b,strokeStyle:w.line_color,strokeWidth:w.line_width,fillStyle:w.point_color,pointSize:w.point_size,sensorSize:w.sensor_size});G.geo=m,t.addFeature(G)}}else if("LineString"==P.type||"MultiLineString"==P.type){var R=P.coordinates;if(R){var G=new WRAP.Geo.Feature.GeoLine({path:R,lineWidth:w.line_width,strokeStyle:w.line_color,option:w.option,geodesic:A});G.geo=m,t.addFeature(G)}}else if("Polygon"==P.type){var R=P.coordinates;if(R){var G=new WRAP.Geo.Feature.GeoLine({path:R,lineWidth:w.line_width,strokeStyle:w.line_color,fillStyle:w.fill_color,fillImage:w.fill_image,option:w.option,geodesic:A});G.geo=m,t.addFeature(G)}}else if("MultiPolygon"==P.type)for(var S=0;S<P.coordinates.length;S++){var R=P.coordinates[S];if(R){var G=new WRAP.Geo.Feature.GeoLine({path:R,lineWidth:w.line_width,strokeStyle:w.line_color,fillStyle:w.fill_color,fillImage:w.fill_image,geodesic:A});G.geo=m,t.addFeature(G)}}}}}}this.content_revision=a.content,this.context_revision=a.context,this.conf_revision=a.conf,this.style_revision=a.style,this.data_revision=a.data,this.last_zoom=l,WRAP.Geo.invalidate()}},WRAP.Geo.Renderer.Lightning=function(){this.draw=function(t,e,i,n,o,r,a,s){n=null,e=null,o=null;var l=r.query("data").value();if(l){var h=!0;if(this.conf_revision!=a.conf&&(h=!1),this.data_revision!=a.data&&(h=!1),!h){console.log("draw:"+t.name());var o=i.Attributes.style.default,f=o.icon_width,c=o.icon_height,u=o.icon_offset_x,d=o.icon_offset_y,v=o.icon;s.length=0;var g=l.features;g||(g=[],"Feature"==l.type&&g.push(l));for(var p=g.length,_=0;_<p;_++){var m=g[_],P=m.geometry;if(P&&"Point"==P.type){var y=m.properties;if(y&&y.display_flag===!1)continue;for(var x=WRAP.Core.currentTime(),w=new WRAP.Core.DateTime(y.obs_time),A=w.diff(x)/60,b=0;b<v.length;b++)if(parseInt(v[b].ge)<=A&&A<parseInt(v[b].lt)){var G=P.coordinates,W=new WRAP.Geo.Feature.Image({point:G,image:v[b].image,width:f,height:c,offsetX:u,offsetY:d});W.geo=m,s.push(W);break}}}this.conf_revision=a.conf,this.style_data=a.data,WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.SIGWX=function(){this.draw=function(t,e,i,n,o,r,a,s){function l(t){Array.isArray(t[0])&&(t=t[0]);var e=[],i=WRAP.Geo.getSize(),n=WRAP.Geo.getScreenLine(t);if(!n)return e;for(var o=0;o<n.length;o++){for(var r=n[o],a=9999,s=-9999,l=9999,h=-9999,f=0;f<r.length;f++){var c=r[f].x,u=r[f].y;u<0||i.height<=u||c<0||i.width<=c||(a>c&&(a=c),s<c&&(s=c),l>u&&(l=u),h<u&&(h=u))}if(s>0&&h>0){var c=(a+s)/2,u=(l+h)/2,d=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(c,u));e.push([d.lonDegree(),d.latDegree()])}}return e}function h(t){return t&&Math.round(t/30.48)||"XXX"}var f=!0;if(this.content_revision!=a.content&&(f=!1),f=!1,this.conf_revision!=a.conf&&(f=!1),!f){var c=r._handler().getData(e,n);if(!c)return void r._handler().loadData(e,n,function(){WRAP.Geo.redraw(t)});s.length=0;for(var u=[],d=0;d<c.length;d++){var v=c[d].features;if(v)for(var g=0;g<v.length;g++)u.push(v[g]);else"Feature"==c[d].type&&u.push(c[d])}for(var p,o=i.Attributes,_=u.length,m="-99999",d=0;d<_;d++){var P=u[d],y=P.geometry;if(y){var x=P.properties;if("TURBULENCE"==x.contents_kind){var w,A,b;6==x.extended_degree?(w=o.turbulence_color_mod,A=[[[0,0],[0,0]],[[0,2],[1,2],[2,1],[3,2],[4,2]]],b=2):7==x.extended_degree?(w=o.turbulence_color_sev,A=[[[1,1],[2,0],[3,1]],[[0,2],[1,2],[2,1],[3,2],[4,2]]],b=2):(w=o.turbulence_color_mod_to_sev,A=[[[0,2],[1,2],[2,1],[3,2],[4,2]],[[6,1],[7,0],[8,1]],[[5,2],[6,2],[7,1],[8,2],[9,2]]],b=4.5);var G=y.coordinates;G&&(p=new WRAP.Geo.Feature.GeoLine({path:G,lineWidth:o.turbulence_line_width,strokeStyle:w,lineDash:[12,12]}),s.push(p));var W=l(G);if(W&&W.length)for(var R=0;R<W.length;W++){var S=W[R],M=null,I=null;if(1==x.altitudes.length?M=x.altitudes[0]:2==x.altitudes.length&&(I=x.altitudes[0],M=x.altitudes[1]),p=new WRAP.Geo.Feature.Text({point:S,text:h(M),fontSize:11,fillStyle:o.turbulence_label_color,offsetX:0,offsetY:0,align:"center"}),s.push(p),p=new WRAP.Geo.Feature.Text({point:S,text:h(I),fontSize:11,fillStyle:o.turbulence_label_color,offsetX:0,offsetY:12,align:"center"}),s.push(p),A){for(var k=4,g=0;g<A.length;g++)for(var T=A[g],F=0;F<T.length;F++){var L=T[F];L[0]=L[0]*k-b*k,L[1]=L[1]*k-24}p=new WRAP.Geo.Feature.Line({point:S,line:A,lineWidth:1,strokeStyle:o.turbulence_label_color}),s.push(p)}}}}}for(var C="counterclockwise"==o.cloud_line_orientation?"counter_cloud":"cloud",d=0;d<_;d++){var P=u[d],y=P.geometry;if(y){var x=P.properties;if("CLOUD"==x.contents_kind){var G=y.coordinates;G&&(p=new WRAP.Geo.Feature.GeoLine({path:G,lineWidth:o.cloud_line_width,strokeStyle:o.cloud_line_color,option:C}),s.push(p));var W=l(G);if(W&&W.length)for(var R=0;R<W.length;W++){var S=W[R];if(x.cloud_distribution){for(var z=-36,D=x.cloud_distribution.split("/"),F=0;F<D.length;F++)p=new WRAP.Geo.Feature.Text({point:S,text:D[F],fontSize:11,fillStyle:o.turbulence_label_color,offsetX:0,offsetY:z+=12,align:"center"}),s.push(p);p=new WRAP.Geo.Feature.Text({point:S,text:x.cloud_type,fontSize:11,fillStyle:o.turbulence_label_color,offsetX:0,offsetY:z+=12,align:"center"}),s.push(p);var E="XXX",X="XXX";0<x.altitudes.length&&(E=h(x.altitudes[0])),1<x.altitudes.length&&(X=h(x.altitudes[1])),p=new WRAP.Geo.Feature.Text({point:S,text:E,fontSize:11,fillStyle:o.turbulence_label_color,offsetX:0,offsetY:z+=12,align:"center"}),s.push(p),p=new WRAP.Geo.Feature.Text({point:S,text:X,fontSize:11,fillStyle:o.turbulence_label_color,offsetX:0,offsetY:z+=12,align:"center"}),s.push(p)}else{if(x.extended_degree){var B="XXX",j="XXX";x.airframe_icing?3<x.altitudes.length&&(x.altitudes[0]!=m&&(j=h(x.altitudes[0])),x.altitudes[1]!=m&&(B=h(x.altitudes[1]))):1<x.altitudes.length&&(x.altitudes[0]!=m&&(j=h(x.altitudes[0])),x.altitudes[1]!=m&&(B=h(x.altitudes[1])));var H;2==x.extended_degree?H=o.cloud_turb_mod_icon:3==x.extended_degree&&(H=o.cloud_turb_sev_icon);var z=-26;H&&(p=new WRAP.Geo.Feature.Image({point:S,image:H,width:o.cloud_icon_width,height:o.cloud_icon_height,offsetX:-o.cloud_icon_width/2-6,offsetY:z+6}),s.push(p)),p=new WRAP.Geo.Feature.Text({point:S,text:B,fontSize:11,fillStyle:o.turbulence_label_color,offsetX:14,offsetY:z+=12,align:"center"}),s.push(p),p=new WRAP.Geo.Feature.Text({point:S,text:j,fontSize:11,fillStyle:o.turbulence_label_color,offsetX:14,offsetY:z+=12,align:"center"}),s.push(p)}if(x.airframe_icing){var Y="MOD",H=o.cloud_ice_mod_icon;0===x.airframe_icing.lastIndexOf("MOD",0)?Y="MOD":0===x.airframe_icing.lastIndexOf("SEV",0)&&(Y="SEV",H=o.cloud_ice_sev_icon);var B="XXX",j="XXX";x.extended_degree?3<x.altitudes.length&&(x.altitudes[2]!=m&&(j=h(x.altitudes[2])),x.altitudes[3]!=m&&(B=h(x.altitudes[3]))):1<x.altitudes.length&&(x.altitudes[0]!=m&&(j=h(x.altitudes[0])),x.altitudes[1]!=m&&(B=h(x.altitudes[1])));var z=-2;p=new WRAP.Geo.Feature.Image({point:S,image:H,width:o.cloud_icon_width,height:o.cloud_icon_height,offsetX:-o.cloud_icon_width/2-6,offsetY:z+6}),s.push(p),p=new WRAP.Geo.Feature.Text({point:S,text:B,fontSize:11,fillStyle:o.turbulence_label_color,offsetX:14,offsetY:z+=12,align:"center"}),s.push(p),p=new WRAP.Geo.Feature.Text({point:S,text:j,fontSize:11,fillStyle:o.turbulence_label_color,offsetX:14,offsetY:z+=12,align:"center"}),s.push(p)}}}}}}for(var d=0;d<_;d++){var P=u[d],y=P.geometry;if(y){var x=P.properties;if("VOLCANO"==x.contents_kind)for(var F=0;F<y.coordinates.length;F++){var N=y.coordinates[F];p=new WRAP.Geo.Feature.Image({point:N,image:o.volcano_icon,width:o.volcano_icon_width,height:o.volcano_icon_height,offsetX:-o.volcano_icon_width/2,offsetY:-o.volcano_icon_height/2}),p.geo=P,s.push(p),p=new WRAP.Geo.Feature.Text({point:N,text:x.feature_name,fontSize:11,fillStyle:o.volcano_label_color,offsetX:2,offsetY:22,align:"left"}),s.push(p)}}}for(var O=12,V=20,U=-3,Z=-6,q=20,J=4,Q=12,d=0;d<_;d++){var P=u[d],y=P.geometry;if(y){var x=P.properties;if("JET STREAM"==x.contents_kind)for(var G=y.coordinates,K=x.points,g=0;g<G.length;g++)for(var $=WRAP.Geo.getScreenLine(G[g]),tt=G[g][0][1]<0,et=0;et<$.length;et++){for(var T=$[et],it=G[g].concat(),nt=K.concat(),ot=[],rt=0,F=0;F<T.length;F++){var N=it[F],at=T[F],st=nt[F],lt=st[0]||0;lt&&(lt=Number(lt)/.514,lt=Math.round(lt)+2);var ht={knots:lt,arrow:null,changeBar:null};if(ot.push(ht),F<T.length-1){var ft=T[F+1],ct=ft.x-at.x,ut=ft.y-at.y,dt=ct*ct+ut*ut;if(rt=180*Math.atan2(ft.y-at.y,ft.x-at.x)/Math.PI,lt>0){for(var vt="FL"+h(N[2]||0),gt=st[2]?h(st[2]):0,pt=st[4]?h(st[4]):0,_t=Math.floor(lt/50),mt=Math.floor(lt%50/10),Pt=Math.floor(lt%10/5),yt=mt+Pt,xt=(_t+yt)*O+(_t-1)*U+(yt-1)*Z+(_t>0?Z:U),wt=0;dt<=xt*xt;){wt++;var At=F+1+wt;if(At>T.length-1)break;var bt=T[At],ct=bt.x-at.x,ut=bt.y-at.y;dt=ct*ct+ut*ut}if(dt>xt*xt){wt>0&&(T.splice(F+1,wt),it.splice(F+1,wt),nt.splice(F+1,wt),ft=T[F+1],ct=ft.x-at.x,ut=ft.y-at.y,dt=ct*ct+ut*ut,rt=180*Math.atan2(ft.y-at.y,ft.x-at.x)/Math.PI);for(var Gt=[],Wt=[],Rt=_t+mt+Pt,St=tt?V:-V,Mt=0,et=0;et<Rt;et++){var It=Z;et<_t?(0==et&&(It=U),et==_t-1&&(It=Z),Gt.push([[Mt,0],[Mt+O,0],[Mt,St],[Mt,0]])):et<_t+mt?Wt.push([[Mt+O,0],[Mt,St]]):Wt.push([[Mt+O,0],[Mt+O/2,St/2]]),Mt+=O+It}for(var R=0;R<Gt.length;R++)p=new WRAP.Geo.Feature.Line({point:N,line:Gt[R],fillStyle:o.jetstream_line_color,rotation:rt}),s.push(p);Wt.length&&(p=new WRAP.Geo.Feature.Line({point:N,line:Wt,lineWidth:1,strokeStyle:o.jetstream_line_color,rotation:rt}),s.push(p));var kt=2,Tt=12,Ft=2,Lt=24,wt=rt;tt?wt<-90||wt>90?(wt+=180,kt-=30,Ft-=30):(Tt=-4,Lt=-16):(wt<-90||wt>90)&&(wt+=180,kt-=30,Ft-=30,Tt=-4,Lt=-16),N[2]&&(p=new WRAP.Geo.Feature.Text({point:N,text:vt,fontSize:11,fillStyle:o.jetstream_label_color,offsetX:kt,offsetY:Tt,align:"left",rotation:wt}),s.push(p)),pt&&gt&&(p=new WRAP.Geo.Feature.Text({point:N,text:pt+"/"+gt,fontSize:11,fillStyle:o.jetstream_label_color,offsetX:Ft,offsetY:Lt,align:"left",rotation:wt}),s.push(p)),ht.arrow=!0}else if(dt>J*J){var Ct=q/2,zt=[];zt.push([[0,Ct],[0,-Ct]]),zt.push([[J,Ct],[J,-Ct]]),p=new WRAP.Geo.Feature.Line({point:N,line:zt,lineWidth:1,strokeStyle:o.jetstream_line_color,rotation:rt}),ht.changeBar=p}}var Dt=ft.x-at.x,Et=ft.y-at.y;p=new WRAP.Geo.Feature.Line({point:N,line:[[0,0],[Dt,Et]],lineWidth:o.jetstream_line_width,strokeStyle:o.jetstream_line_color}),s.push(p)}else if(F>0){var Xt=[];Xt.push([[0,0],[Q,-Q/2],[Q,Q/2],[0,0]]),p=new WRAP.Geo.Feature.Line({point:N,line:Xt,fillStyle:o.jetstream_line_color,rotation:rt-180}),s.push(p)}}for(var F=0;F<ot.length;F++){var ht=ot[F];if(ht.changeBar){for(var Bt=0,jt=0,et=F-1;et>=0;et--)if(ot[et].arrow){Bt=ot[et].knots;break}for(var et=F+1;et<ot.length;et++)if(ot[et].arrow){jt=ot[et].knots;break}(Bt&&Math.abs(Bt-ht.knots)>=20||jt&&Math.abs(jt-ht.knots)>=20)&&s.push(ht.changeBar)}}}}}for(var d=0;d<_;d++){var P=u[d],y=P.geometry;if(y){var x=P.properties;if("TROPOPAUSE"==x.contents_kind)for(var g=0;g<y.coordinates.length;g++){var N=y.coordinates[g];if(N&&N[2]){var Ht=h(N[2]);"MINIMUM"==x.significance?(p=new WRAP.Geo.Feature.Line({point:N,line:[[-13,-7],[13,-7],[13,12],[0,19],[-13,12],[-13,-7]],lineWidth:.5,strokeStyle:"#000000",fillStyle:"#ffffff"}),s.push(p),p=new WRAP.Geo.Feature.Text({point:N,text:"L",fontSize:11,fillStyle:"#000",offsetX:0,offsetY:15,align:"center"}),s.push(p)):"MAXIMUM"==x.significance?(p=new WRAP.Geo.Feature.Line({point:N,line:[[-13,-12],[0,-19],[13,-12],[13,7],[-13,7],[-13,-7]],lineWidth:.5,strokeStyle:"#000000",fillStyle:"#ffffff"}),s.push(p),p=new WRAP.Geo.Feature.Text({point:N,text:"H",fontSize:11,fillStyle:"#000",offsetX:0,offsetY:-7,align:"center"}),s.push(p)):(p=new WRAP.Geo.Feature.Line({point:N,line:[[-13,-7],[13,-7],[13,7],[-13,7],[-13,-7]],lineWidth:.5,strokeStyle:"#000000",fillStyle:"#ffffff"}),s.push(p)),p=new WRAP.Geo.Feature.Text({point:N,text:Ht,fontSize:11,fillStyle:"#000",offsetX:0,offsetY:4,align:"center"}),s.push(p)}}}}this.content_revision=a.content,this.context_revision=a.context,this.conf_revision=a.conf,WRAP.Geo.invalidate()}}},WRAP.Geo.Renderer.ASCScale=function(){this.style_revision,this.context_revision,this.draw=function(t,e,i,n,o,r,a,s){function l(t,e,i,n,o,r){var a=[e+.17*n,i+.72*o],s=[e+.23*n,i+.46*o],l=[e+.4*n,i+.35*o],h=[e+.5*n,i+.333*o],f=[e+.6*n,i+.35*o],c=[e+.77*n,i+.46*o],u=[e+.83*n,i+.72*o],d=i+.5*o,v=i+.2*o;1==r?(t.push([a,s,l,h,f,c,u]),t.push([[e+.5*n,d],[e+.5*n,v]])):4==r&&(t.push([a,s,l,h,f,c,u]),t.push([[e+.4*n,d],[e+.4*n,v]]),t.push([[e+.6*n,d],[e+.6*n,v]]))}function h(t,e,i,n,o,r){var a=e+.2*n,s=e+.35*n,l=e+.5*n,h=e+.65*n,f=e+.8*n,c=i+.2*o,u=i+.5*o,d=i+.8*o;7==r?(t.push([[a,c],[s,c],[l,u],[h,c],[f,c]]),t.push([[s,u],[l,d],[h,u]])):t.push([[a,c],[s,c],[l,d],[h,c],[f,c]])}if(!this.revision||this.revision.context!=a.context){this.style_revision!=a.style&&(this.style_revision=a.style);var f=i.Attributes.style.default;if(o&&i.Attributes.style[o]&&(f=i.Attributes.style[o]),f){var c=r._handler().getGrid();if(c){var u=parseInt(c.Width),d=parseInt(c.Height),v="highest";if(f.min_blocksize&&(v+=" "+f.min_blocksize),e&&e.element&&e.level){var g=Array.isArray(e.element)?e.element:[e.element],p=Array.isArray(e.level)?e.level:[e.level],_={};for(var m in e)"element"!=m&&"level"!=m&&(_[m]=e[m]);for(var P=[],y=0;y<g.length;y++){P[y]=[];for(var x=0;x<p.length;x++)P[y][x]=[]}for(var w=0;w<n.tiles.length;w++)for(var A=n.tiles[w],y=0;y<g.length;y++){_.element=g[y];for(var x=0;x<p.length;x++){_.level=p[x];var b;if(!(b=r._handler().getTile(_,A.id,v)))return void r._handler().loadTile(_,A.id,v,A.z,A.y,A.x,A.cood,A.bounds,function(){WRAP.Geo.redraw(t)});P[y][x][w]=b}}s.length=0;for(var G,W=new Uint8Array(u*d),R=[],S=["rgba(0,0,0,0)",f.icing_lgt_color,f.conv_lgt_color,f.turb_mod_color,f.icing_mod_color,f.conv_mod_color,f.turb_mod_to_sev_color,f.turb_sev_color],M=[-1,0,1,2,0,1,2,2],I=10,k=12,y=0;y<g.length;y++)for(var T=g[y],x=0;x<p.length;x++)for(var F=P[y][x],w=0;w<F.length;w++)for(var r=F[w].data,L=0;L<r.length;L++){var C=r[L];if(C.value&&!isNaN(C.value)&&C.step){var z;if("ICING"==T?1==C.value?z=1:2==C.value&&(z=4):"CONV"==T?1==C.value?z=2:2==C.value&&(z=5):"TURB"==T&&(3==C.value?z=3:4==C.value?z=6:5==C.value&&(z=7)),z){var D=C.y*u+C.x;(!W[D]||W[D]<z)&&(W[D]=z,R[D]={lat:C.lat,lon:C.lon},G=C.step)}}}if(G)for(var E=parseFloat(c.LonInterval)*G,X=parseFloat(c.LatInterval)*G,B=E/2,j=X/2,H=1;H<=7;H++)for(var Y=M[H],w=0,N=0;N<d;N++)for(var f=w,O=0;O<u;O++){var C=W[w];if(C==H){var V,U,Z,q,J,Q=S[C],K=R[w],$=K.lon-B,tt=K.lon+B,et=K.lat+j,it=K.lat-B;if(0==Y||2==Y){U=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*et,60*$)),Z=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*it,60*tt)),q=Math.abs(U.x-Z.x),J=Math.abs(U.y-Z.y);var nt=Math.floor(q/k),ot=Math.floor(J/k);if(nt&&ot){for(var rt=(tt-$)/nt,at=(et-it)/ot,st=[],lt=0;lt<ot;lt++)for(var ht=et-at*(lt+.5),ft=ht-at/2,ct=0;ct<nt;ct++){var ut=$+rt*(ct+.5),dt=ut-rt/2;0==Y?l(st,dt,ft,rt,at,H):h(st,dt,ft,rt,at,H)}s.push(new WRAP.Geo.Feature.GeoLine({path:st,strokeStyle:Q,lineWidth:1.5}))}}var vt=w-u*G;if(vt>0&&W[vt]<C)if(0==Y){var nt=Math.floor(q/I),ot=Math.floor(J/I);if(nt&&ot)for(var rt=(tt-$)/nt,at=(et-it)/ot,gt=.3*rt,pt=.2*at,_t=0;_t<nt;_t++){var ut=$+rt*(_t+.5);s.push(new WRAP.Geo.Feature.GeoLine({path:[[ut-gt,et+pt],[ut,et-pt],[ut+gt,et+pt]],strokeStyle:Q,lineWidth:1.5}))}}else 1==Y?s.push(new WRAP.Geo.Feature.GeoLine({path:[[tt,et],[$,et]],strokeStyle:Q,lineWidth:2,option:"cloud"})):2==Y&&s.push(new WRAP.Geo.Feature.GeoLine({path:[[[tt,et],[tt+.33*($-tt),et]],[[tt+.66*($-tt),et],[$,et]]],
strokeStyle:Q,lineWidth:2}));var mt=w+u*G;if(mt<W.length&&W[mt]<C)if(0==Y){var nt=Math.floor(q/I),ot=Math.floor(J/I);if(nt&&ot)for(var rt=(tt-$)/nt,at=(et-it)/ot,gt=.3*rt,pt=.2*at,_t=0;_t<nt;_t++){var ut=$+rt*(_t+.5);s.push(new WRAP.Geo.Feature.GeoLine({path:[[ut-gt,it+pt],[ut,it-pt],[ut+gt,it+pt]],strokeStyle:Q,lineWidth:1.5}))}}else 1==Y?s.push(new WRAP.Geo.Feature.GeoLine({path:[[$,it],[tt,it]],strokeStyle:Q,lineWidth:2,option:"cloud"})):2==Y&&s.push(new WRAP.Geo.Feature.GeoLine({path:[[[tt,it],[tt+.33*($-tt),it]],[[tt+.66*($-tt),it],[$,it]]],strokeStyle:Q,lineWidth:2}));var x=f+(O-G)%u;if(W[x]<C)if(0==Y){var nt=Math.floor(q/I),ot=Math.floor(J/I);if(nt&&ot)for(var rt=(tt-$)/nt,at=(et-it)/ot,gt=.3*rt,pt=.2*at,_t=0;_t<ot;_t++){var ht=et-at*(_t+.5);s.push(new WRAP.Geo.Feature.GeoLine({path:[[$-gt,ht+pt],[$,ht-pt],[$+gt,ht+pt]],strokeStyle:Q,lineWidth:1.5}))}}else 1==Y?s.push(new WRAP.Geo.Feature.GeoLine({path:[[$,et],[$,it]],strokeStyle:Q,lineWidth:2,option:"cloud"})):2==Y&&s.push(new WRAP.Geo.Feature.GeoLine({path:[[[$,et],[$,et+.33*(it-et)]],[[$,et+.66*(it-et)],[$,it]]],strokeStyle:Q,lineWidth:2}));var Pt=f+(O+G)%u;if(W[Pt]<C)if(0==Y){var nt=Math.floor(q/I),ot=Math.floor(J/I);if(nt&&ot)for(var rt=(tt-$)/nt,at=(et-it)/ot,gt=.3*rt,pt=.2*at,_t=0;_t<ot;_t++){var ht=et-at*(_t+.5);s.push(new WRAP.Geo.Feature.GeoLine({path:[[tt-gt,ht+pt],[tt,ht-pt],[tt+gt,ht+pt]],strokeStyle:Q,lineWidth:1.5}))}}else 1==Y?s.push(new WRAP.Geo.Feature.GeoLine({path:[[tt,it],[tt,et]],strokeStyle:Q,lineWidth:2,option:"cloud"})):2==Y&&s.push(new WRAP.Geo.Feature.GeoLine({path:[[[tt,et],[tt,et+.33*(it-et)]],[[tt,et+.66*(it-et)],[tt,it]]],strokeStyle:Q,lineWidth:2}))}w++}var yt=!1;if(yt)for(var w=0,N=0;N<d;N++)for(var O=0;O<u;O++){var C=W[w];if(C){var V,K=R[w];V=new WRAP.Geo.Feature.Text({point:[K.lon,K.lat],text:C,fontSize:12,fillStyle:"#000",offsetX:0,offsetY:6,align:"center"}),s.push(V)}w++}this.context_revision=n.revision,WRAP.Geo.invalidate()}}}}}},WRAP.Geo.Renderer.Isotach=function(){var t=this;this.palette=null,this.palette_value_min=0,this.palette_value_max=0,this.palette_gradient=!0,this.palette_scale=10,this.palette_step=1,this.setPalette=function(e){if(!t.palette&&e.palette){t.palette=[],t.palette_gradient=e.palette_gradient,t.palette_step=e.palette_step||1,t.palette_scale=1/t.palette_step;for(var i=e.palette,n=[],o=0;o<i.length;o++){var r=[],a=i[o].value;0==o?(this.palette_value_min=a,this.palette_value_max=a):(this.palette_value_min>a&&(this.palette_value_min=a),this.palette_value_max<a&&(this.palette_value_max=a)),r.push(a);var s=WRAP.Geo.parseColor(i[o].color);r.push(s[0]),r.push(s[1]),r.push(s[2]),r.push(s[3]),n.push(r)}for(var l=0,h=t.palette_value_min;h<=t.palette_value_max;h+=t.palette_step){for(;l<n.length-1&&h>=n[l+1][0];)l++;if(l==n.length-1)t.palette.push([parseInt(n[l][1]),parseInt(n[l][2]),parseInt(n[l][3]),parseInt(n[l][4])]);else{var f=n[l][1],c=n[l][2],u=n[l][3],d=n[l][4];if(t.palette_gradient){var v=(h-n[l][0])/(n[l+1][0]-n[l][0]),g=n[l+1][1],p=n[l+1][2],_=n[l+1][3],m=n[l+1][4];t.palette.push([parseInt(f+(g-f)*v),parseInt(c+(p-c)*v),parseInt(u+(_-u)*v),parseInt(d+(m-d)*v)])}else t.palette.push([parseInt(f),parseInt(c),parseInt(u),parseInt(d)])}}}},this.getColor=function(e){var i=Math.floor((e-t.palette_value_min)*t.palette_scale);return i<0||i>=t.palette.length?[0,0,0,0]:t.palette[i]},this.draw=function(t,e,i,n,o,r,a,s){if(e){var l=!0;if(this.context_revision!=a.context&&(l=!1),this.content_revision!=a.content&&(l=!1),this.conf_revision!=a.conf&&(l=!1),this.style_revision!=a.style&&(l=!1,this.palette=null),!l){var h=i.Attributes.data_scale||1,f=i.Attributes.data_offset||0,c=i.Attributes.style.default;if(!o&&i.Attributes.style_selector){if(!i.Attributes.style_selector.key||!i.Attributes.style_selector.styles)return void console.log("style_selector formar error.");for(var u=i.Attributes.style_selector.key,d=0;d<i.Attributes.style_selector.styles.length;d++){var v=i.Attributes.style_selector.styles[d].values;if(v.indexOf(e[u])>=0){o=i.Attributes.style_selector.styles[d].style;break}}}if(o&&i.Attributes.style[o]&&(c=i.Attributes.style[o]),c){this.setPalette(c);for(var g="block"!=c.fill_type?"interpolate":"nearest",p=c.fill_type,_=c.contour,m=[],d=0;d<n.tiles.length;d++){var P=n.tiles[d];if(!(m[d]=r._handler().getTile(e,P.id,g)))return void r._handler().loadTile(e,P.id,g,P.z,P.y,P.x,P.cood,P.bounds,function(){WRAP.Geo.redraw(t)})}s.length=0;for(var d=0;d<m.length;d++){var y=m[d];if(y&&!y.empty){var P=n.tiles[d],x=P.ctx.createImageData(256,256),c=this.getData(e,y.data);if(c){var w=x.data;if(p)for(var A=0;A<65536;A++){var b=c[A];if(void 0!==b){b=b*h+f;var G=this.getColor(b),W=4*A;w[W]=G[0],w[W+1]=G[1],w[W+2]=G[2],w[W+3]=G[3]}}var R=[];if(_){for(var S=0,M=0,W=0;W<65536;W++){var b=c[W];void 0!==b&&(0==W?S=M=b:(S>b&&(S=b),M<b&&(M=b)))}for(var I=0;I<_.length;I++)for(var k=_[I],G=WRAP.Geo.parseColor(k.strokeStyle),T=k.unit_label||"",F=void 0===k.fractional_digits?void 0:parseInt(k.fractional_digits),L=k.interval/h,C=k.base,b=(k.base-f)/h,z=0;z<k.num;z++){if(S<=b&&b<=M){for(var D=-1,E=0,X=0,B=0,j=0;j<256;j++)for(var H=0==j?0:-256,Y=255==j?0:256,N=0;N<256;N++){var O=0==N?0:-1,V=255==N?0:1,U=c[B];if(U>=b){var Z=c[B+H],q=c[B+O],J=c[B+V],Q=c[B+Y];if(Z<b||q<b||J<b||Q<b){w[4*B]=G[0],w[4*B+1]=G[1],w[4*B+2]=G[2],w[4*B+3]=G[3],k.lineWidth>1&&(w[4*B+4]=G[0],w[4*B+5]=G[1],w[4*B+6]=G[2],w[4*B+7]=G[3],w[4*B+1024]=G[0],w[4*B+1024+1]=G[1],w[4*B+1024+2]=G[2],w[4*B+1024+3]=G[3]);var K=Math.abs(N-128)+Math.abs(j-128);(D<0||K<D)&&(D=K,E=N,X=j)}}B++}if(20<E&&E<=236&&20<X&&X<=236){var $=void 0===F?C:C.toFixed(F);R.push({x:E,y:X,value:$+T,color:k.textColor})}}C+=k.interval,b+=L}}var tt=new WRAP.Geo.Feature.Tile({tile:P,imageData:x});s.push(tt);for(var K=0;K<R.length;K++){var tt,et=65792,it=P.cood[et],nt=P.cood[et+1];tt=new WRAP.Geo.Feature.Text({point:[nt,it],text:R[K].value,fontSize:12,fillStyle:R[K].color,offsetX:R[K].x-128,offsetY:R[K].y-128,align:"center"}),s.push(tt)}}}}this.context_revision=a.context,this.content_revision=a.content,this.conf_revision=n.conf,this.style_revision=a.style,WRAP.Geo.invalidate()}}}}},WRAP.Geo.Renderer.Isotach.prototype.getData=function(t,e){if(t.element&&Array.isArray(t.element)){for(var i=e[0],n=e[1],o=[],r=0;r<65536;r++){var a=i[r],s=n[r];isNaN(a)||isNaN(s)||(o[r]=Math.sqrt(a*a+s*s)/.514)}return o}},WRAP.Geo.Renderer.IcingProbavility=function(){this.style_revision,this.context_revision,this.draw=function(t,e,i,n,o,r,a,s){if(e&&(!this.revision||this.revision.context!=a.context)){this.style_revision!=a.style&&(this.style_revision=a.style);var l=i.Attributes.style.default;if(o&&i.Attributes.style[o]&&(l=i.Attributes.style[o]),l){var h="value";l.min_blocksize&&(h+=" "+l.min_blocksize);for(var f=[],c=0;c<n.tiles.length;c++){var u=n.tiles[c];if(!(f[c]=r._handler().getTile(e,u.id,h)))return void r._handler().loadTile(e,u.id,h,u.z,u.y,u.x,u.cood,u.bounds,function(){WRAP.Geo.redraw(t)})}s.length=0;for(var c=0;c<f.length;c++)for(var r=f[c].data,d=0;d<r.length;d++){var v=r[d];if(v.value&&2==v.value.length){var g=v.value[0];if(!isNaN(g)){var p=v.value[1];if(!isNaN(p)&&(g-=273.15,-15<=g&&g<=0&&p>=90)){var _,m="＊";_=new WRAP.Geo.Feature.Text({point:[v.lon,v.lat],text:m,fontSize:14,fillStyle:l.icon_color,offsetX:0,offsetY:-7,align:"center"}),s.push(_)}}}}this.context_revision=n.revision,WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.GridLine=function(){this.draw=function(t,e,i,n,o,r,a){r=null,e=null,n=null;var s=i.Attributes.style.default;if(o&&i.Attributes.style[o]&&(s=i.Attributes.style[o]),s){t.clear();var l,h,f,c,u=s.grid_interval||10,d=s.line_width||1,v=s.line_color,g=s.font_size||14,p=s.text_color||"black",_=s.text_edge_color;s.position&&(l=s.position.indexOf("top")>=0,h=s.position.indexOf("bottom")>=0,f=s.position.indexOf("left")>=0,c=s.position.indexOf("right")>=0);for(var m=90,P=[],y=[],x=0;x<=180;)0==x||180==x?y.push({lon:x,text:x}):(y.push({lon:x,text:"E"+x}),y.push({lon:-x,text:"W"+x})),x+=u;for(var w=0;w<=m;)0==w?P.push({lat:w,text:w}):(P.push({lat:w,text:"N"+w}),P.push({lat:-w,text:"S"+w})),w+=u;for(x=0;x<y.length;x++){var A=y[x].lon;for(t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[A,m],[A,-m]],lineWidth:d,strokeStyle:v,geodesic:!1})),w=0;w<P.length;w++){var b=P[w].lat;t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[A,b],[A+u,b]],lineWidth:d,strokeStyle:v,geodesic:!1}))}}for(var G=WRAP.Geo.getSize(),A=10;A<G.width-10;A++){if(l){var W=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(A,0)),R=W.lonDegree();for(x=0;x<y.length;x++){var S=y[x],M=S.lon,I=Math.abs(M-R);(!S.top||S.top.d>I)&&(S.top={d:I,point:W})}}if(h){var W=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(A,G.height)),R=W.lonDegree();for(x=0;x<y.length;x++){var S=y[x],M=S.lon,I=Math.abs(M-R);(!S.bottom||S.bottom.d>I)&&(S.bottom={d:I,point:W})}}}for(var b=20;b<G.height-20;b++){if(f){var W=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(0,b)),R=W.latDegree();for(w=0;w<P.length;w++){var S=P[w],M=S.lat,I=Math.abs(M-R);(!S.left||S.left.d>I)&&(S.left={d:I,point:W})}}if(c){var W=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(G.width,b)),R=W.latDegree();for(w=0;w<P.length;w++){var S=P[w],M=S.lat,I=Math.abs(M-R);(!S.right||S.right.d>I)&&(S.right={d:I,point:W})}}}for(x=0;x<y.length;x++){var S;(S=y[x].top)&&S.d<4&&t.addFeature(new WRAP.Geo.Feature.Text({point:[S.point.lonDegree(),S.point.latDegree()],text:y[x].text,fontSize:g,strokeStyle:_,fillStyle:p,offsetX:0,offsetY:g+2,align:"center"})),(S=y[x].bottom)&&S.d<4&&t.addFeature(new WRAP.Geo.Feature.Text({point:[S.point.lonDegree(),S.point.latDegree()],text:y[x].text,fontSize:g,strokeStyle:_,fillStyle:p,offsetX:0,offsetY:-4,align:"center"}))}for(w=0;w<P.length;w++)(S=P[w].left)&&S.d<4&&t.addFeature(new WRAP.Geo.Feature.Text({point:[S.point.lonDegree(),S.point.latDegree()],text:P[w].text,fontSize:g,strokeStyle:_,fillStyle:p,offsetX:2,offsetY:g/2,align:"left"})),(S=P[w].right)&&S.d<4&&t.addFeature(new WRAP.Geo.Feature.Text({point:[S.point.lonDegree(),S.point.latDegree()],text:P[w].text,fontSize:g,strokeStyle:_,fillStyle:p,offsetX:-3,offsetY:g/2,align:"right"}));this.context_revision=a.context,WRAP.Geo.invalidate()}}},WRAP.Geo.Renderer.TropicalStorm=function(){this.draw=function(t,e,i,n,o,r,a,s){function l(e,i,n,o,r,a){if(i||n){var s=WRAP.Geo.getGCPoint(e,i,o),l=WRAP.Geo.getGCPoint(e,n,o),h=new WRAP.Geo.Feature.GeoLine({path:[[s.lonDegree(),s.latDegree()],[l.lonDegree(),l.latDegree()]],strokeStyle:r,lineWidth:a});t.addFeature(h)}}function h(e,i){var n=1852,o=i.stmrds_35_1&&i.stmrds_35_1*n||0,r=i.stmrds_35_2&&i.stmrds_35_2*n||0,a=i.stmrds_35_3&&i.stmrds_35_3*n||0,s=i.stmrds_35_4&&i.stmrds_35_4*n||0,h=i.stmrds_50_1&&i.stmrds_50_1*n||0,f=i.stmrds_50_2&&i.stmrds_50_2*n||0,c=i.stmrds_50_3&&i.stmrds_50_3*n||0,d=i.stmrds_50_4&&i.stmrds_50_4*n||0;if(o){var v=new WRAP.Geo.Feature.GeoArc({point:e,radius:o,start:i.stmrda_35_1,end:i.stmrda_35_2,strokeStyle:u.wind_line_color_35kt,lineWidth:u.wind_line_width,fillStyle:u.wind_fill_color_35kt});t.addFeature(v)}if(r){var v=new WRAP.Geo.Feature.GeoArc({point:e,radius:r,start:i.stmrda_35_2,end:i.stmrda_35_3,strokeStyle:u.wind_line_color_35kt,lineWidth:u.wind_line_width,fillStyle:u.wind_fill_color_35kt});t.addFeature(v)}if(a){var v=new WRAP.Geo.Feature.GeoArc({point:e,radius:a,start:i.stmrda_35_3,end:i.stmrda_35_4,strokeStyle:u.wind_line_color_35kt,lineWidth:u.wind_line_width,fillStyle:u.wind_fill_color_35kt});t.addFeature(v)}if(s){var v=new WRAP.Geo.Feature.GeoArc({point:e,radius:s,start:i.stmrda_35_4,end:i.stmrda_35_1+360,strokeStyle:u.wind_line_color_35kt,lineWidth:u.wind_line_width,fillStyle:u.wind_fill_color_35kt});t.addFeature(v)}var g=new WRAP.Geo.Point(60*e[1],60*e[0]);if(l(g,o,s,i.stmrda_35_1,u.wind_line_color_35kt,u.wind_line_width),l(g,o,r,i.stmrda_35_2,u.wind_line_color_35kt,u.wind_line_width),l(g,r,a,i.stmrda_35_3,u.wind_line_color_35kt,u.wind_line_width),l(g,a,s,i.stmrda_35_4,u.wind_line_color_35kt,u.wind_line_width),h){var v=new WRAP.Geo.Feature.GeoArc({point:e,radius:h,start:i.stmrda_50_1,end:i.stmrda_50_2,strokeStyle:u.wind_line_color_50kt,lineWidth:u.wind_line_width,fillStyle:u.wind_fill_color_50kt});t.addFeature(v)}if(f){var v=new WRAP.Geo.Feature.GeoArc({point:e,radius:f,start:i.stmrda_50_2,end:i.stmrda_50_3,strokeStyle:u.wind_line_color_50kt,lineWidth:u.wind_line_width,fillStyle:u.wind_fill_color_50kt});t.addFeature(v)}if(c){var v=new WRAP.Geo.Feature.GeoArc({point:e,radius:c,start:i.stmrda_50_3,end:i.stmrda_50_4,strokeStyle:u.wind_line_color_50kt,lineWidth:u.wind_line_width,fillStyle:u.wind_fill_color_50kt});t.addFeature(v)}if(d){var v=new WRAP.Geo.Feature.GeoArc({point:e,radius:d,start:i.stmrda_50_4,end:i.stmrda_50_1+360,strokeStyle:u.wind_line_color_50kt,lineWidth:u.wind_line_width,fillStyle:u.wind_fill_color_50kt});t.addFeature(v)}l(g,h,d,i.stmrda_50_1,u.wind_line_color_50kt,u.wind_line_width),l(g,h,f,i.stmrda_50_2,u.wind_line_color_50kt,u.wind_line_width),l(g,f,c,i.stmrda_50_3,u.wind_line_color_50kt,u.wind_line_width),l(g,c,d,i.stmrda_50_4,u.wind_line_color_50kt,u.wind_line_width)}WRAP.Geo.check(t,e,i,n,o,r,a,s);var f=r.query("data").value();if(f){var c=!0;if(this.conf_revision!=a.conf&&(c=!1),this.style_revision!=a.style&&(c=!1),this.data_revision!=a.data&&(c=!1),!c){var u=i.Attributes;t.clear();for(var d in f){var v=f[d];if(v.features){for(var g=[],p=[],_=0;_<v.features.length;_++){var m=v.features[_],P=m.properties,y=P.wrap_feature_type,x=m.geometry.coordinates;"track"==y?g.push(x):"forecast"==y&&p.push(x)}for(var _=0;_<v.features.length;_++){var m=v.features[_],P=m.properties,y=P.wrap_feature_type,x=m.geometry.coordinates;"analysis"==y&&(g.push(x),p.unshift(x))}var w=["analysis"];if(void 0===u.show_track_history||u.show_track_history===!0){w.push("track");var A=new WRAP.Geo.Feature.GeoLine({path:g,strokeStyle:u.track_history_line_color,lineWidth:u.track_history_line_width});t.addFeature(A)}if(void 0===u.show_forcast_track||u.show_forcast_track===!0){w.push("forecast");var A=new WRAP.Geo.Feature.GeoLine({path:p,strokeStyle:u.forecst_track_line_color,lineWidth:u.forecst_track_line_width});t.addFeature(A)}if(void 0===u.show_analysis_wind_radii||u.show_analysis_wind_radii===!0)for(var _=0;_<v.features.length;_++){var m=v.features[_],P=m.properties;if("analysis"==P.wrap_feature_type){var x=m.geometry.coordinates;h(x,P)}}if(!(void 0!==u.show_forcast_track&&u.show_forcast_track!==!0||void 0!==u.show_forcast_wind_radii&&u.show_forcast_wind_radii!==!0))for(var _=0;_<v.features.length;_++){var m=v.features[_],P=m.properties;if("forecast"==P.wrap_feature_type){var x=m.geometry.coordinates;h(x,P)}}for(var _=0;_<v.features.length;_++){var m=v.features[_],P=m.properties;if("track"!=P.wrap_feature_type&&!(w.indexOf(P.wrap_feature_type)<0)){var b=P.valid;if(b&&b.length>=11){var G=b.substr(6,2);G+=" / ",G+=b.substr(9,2),G+="Z";var x=m.geometry.coordinates,A=new WRAP.Geo.Feature.Text({text:G,point:x,strokeStyle:u.label_edge_color,fillStyle:u.label_text_color,offsetX:u.label_offset_x,offsetY:u.label_offset_y,align:"left"});A.geo=m,t.addFeature(A)}}}for(var _=0;_<v.features.length;_++){var m=v.features[_],P=m.properties;if(!(w.indexOf(P.wrap_feature_type)<0)){var y=P.class,x=m.geometry.coordinates,W=u.icon[y];if(x[1]<0&&u.icon_south&&u.icon_south[y]&&(W=u.icon_south[y]),W){var A=new WRAP.Geo.Feature.Image({image:W,point:x,width:u.icon_width,height:u.icon_height,offsetX:u.icon_offset_x,offsetY:u.icon_offset_y});A.geo=m,t.addFeature(A)}}}}}this.conf_revision=a.conf,this.style_revision=a.style,this.data_revision=a.data,WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.LiveCamera=function(){function t(t,i,n){i.img=null;var o=new Image;o.onload=function(){i.img=[];for(var n=document.createElement("canvas"),r=n.getContext("2d"),a=0;a<e;a++){var s=a*(360/e)*Math.PI/180;n.width=32,n.height=32;var l=n.width/2,h=n.height/2;r.save(),r.translate(l,h),r.rotate(s),r.translate(-l,-h),r.drawImage(o,0,0,32,32),r.restore();var f=n.toDataURL("image/png");i.img.push(f)}WRAP.Geo.redraw(t)},o.onerror=function(){i.img=[];for(var t=0;t<e;t++)i.img.push(n)},o.src=i.url}var e=16,i={t:{},s:{},a:{}};this.draw=function(n,o,r,a,s,l,h,f){o=null,a=null;var c=l.query("data").value();if(c){var s=r.Attributes.style.default,u=s.icon_width,d=s.icon_height,v=s.icon_offset_x,g=s.icon_offset_y,p=s.icon_nondir,_=s.icon_t,m=s.icon_s,P=s.icon_a;if(p&&_&&m&&P){if(i.a.url!=P&&(i.a.url=P,t(n,i.a,p)),i.s.url!=m&&(i.s.url=m,t(n,i.s,m)),i.t.url!=_&&(i.t.url=_,t(n,i.t,p)),!i.a.img||!i.s.img||!i.t.img)return void setTimeout(function(){WRAP.Geo.redraw(n)},500);var y=!0;if(this.content_revision!=h.content&&(y=!1,this.content_revision=h.content),!y){console.log("draw:"+n.name()),f.length=0;for(var x in c){var w=c[x];if(w.lat&&w.lon){var A;if(w.dir){var b=Math.floor((w.dir+360/(2*e))/(360/e));b%=e,A=i.s.img[b]}else A=p;var G=new WRAP.Geo.Feature.Image({point:[w.lon/60,w.lat/60],image:A,width:u,height:d,offsetX:v,offsetY:g});G.set(n,l.query("data."+x)),f.push(G)}}WRAP.Geo.invalidate(),console.log("  display list -> "+f.length)}}}}};
//# sourceMappingURL=../build/js/WRAP.Geo-1.2.0.4-min.js.map