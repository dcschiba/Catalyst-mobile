var WRAP;"undefined"==typeof WRAP&&(WRAP={}),WRAP.Geo={version:"1.1",setLayer:function(t){this.container={interactive_layers:t.interactive_layers,plot_layers:t.plot_layers,upper_layers:t.upper_layers,lower_layers:t.lower_layers},this.container.upper_layers||(this.container.container.upper_layers=[]),this.container.plot_layers&&(this.container.upper_layers=this.container.upper_layers.concat(this.container.plot_layers)),this.container.interactive_layers&&(this.container.upper_layers=this.container.upper_layers.concat(this.container.interactive_layers))},getSize:function(){return this.map.getSize()},getScreenPoint:function(t){return this.map.getScreenPoint(t)},getScreenLine:function(t){var e,i,n,o,r=[];if(t&&t.length>0){var a=t[0][1],s=t[0][0];e=i=a,n=o=s;var l=[a,s];r.push(l);for(var h=1;h<t.length;h++){var f=t[h][1],u=t[h][0],c=u-s;c<-180?u+=360:c>=180&&(u-=360),e<f&&(e=f),i>f&&(i=f),o>u&&(o=u),n<u&&(n=u);var l=[f,u];r.push(l),a=f,s=u}}if(o<-180){o+=360,n+=360;for(var h=0;h<r.length;h++)r[h][1]+=360}return this.map.getScreenLine(r,e,i,o,n)},getPoint:function(t){return this.map.getPoint(t)},getCenterPoint:function(){return this.map.getCenterPoint()},setCenterPoint:function(t){this.map.setCenterPoint(t)},getZoom:function(){return this.map.getZoom()},setZoom:function(t){this.map.setZoom(t)},getPerspective:function(t,e){return this.map.getPerspective(t,e)},getDistance:function(t,e){return this.map&&this.map.getDistance?this.map.getDistance(t,e):distance(t.lonDegree(),t.latDegree(),e.lonDegree(),e.latDegree())},addEventHandler:function(t,e){var i=this.Interaction[t];i&&i.push(e)},removeEventHandler:function(t,e){var i=this.Interaction[t];if(i){var n=i.indexOf(e);n>=0&&i.splice(n,1)}},switchMap:function(t){var e,i;WRAP.Geo.map&&(e=WRAP.Geo.map.getZoom(),i=WRAP.Geo.map.getCenterPoint()),WRAP.Geo.map.context&&(t.context.revision=WRAP.Geo.map.context.revision),t.context.revision++,WRAP.Geo.map=t,e&&i&&(WRAP.Geo.map.setZoom(e),WRAP.Geo.map.setCenterPoint(i)),setTimeout(function(){t.update(!0),WRAP.Geo.invalidate()},1e3)},setInteraction:function(t,e){var i=this;WRAP.Geo.Interaction.init(e,t),i.lastHit=null,i.lastClick=null,i.lastX=0,i.lastY=0,t.addEventListener("mousemove",function(e){if(!e._prevent){var n=t.getBoundingClientRect(),o=e.clientX-n.left,r=e.clientY-n.top;i.lastX=o,i.lastY=r;var a=e.which;if(a){if(i.lastClick&&i.lastClick.feature.draggable)return i.lastClick.feature.drag(o,r),void i.invalidate()}else i.lastClick&&(WRAP.Geo.enableScroll(!0),i.lastClick=null);var s=new WRAP.Geo.ScreenPoint(o,r),l=i.hit(s);if(l.pixel||!i.lastHit||l.feature!=i.lastHit.feature)if(l.feature&&l.feature.draggable&&WRAP.Geo.enableScroll(!1),i.lastHit&&i.lastHit.feature&&i.lastHit.feature.mouseout&&i.lastHit.feature.mouseout(o,r),l.feature&&l.feature.mouseover&&l.feature.mouseover(o,r),i.lastHit=l,i.lastHit.feature){var h,f=i.lastHit.layer,u=[];if(i._tooltipGroup)for(var c=0;c<i._tooltipGroup.length;c++){var d=i._tooltipGroup[c];if(d.indexOf(f)>=0){for(var v=0;v<d.length;v++){var p=d[v];if(p.visible())for(var g=p._dl.length-1;g>=0;g--){var _=p._dl[g],m=_.hit(s.x,s.y);if(m){u.push({layer:p,feature:_,x:m.x,y:m.y});break}}}break}}u.length||u.push(i.lastHit);for(var c=0;c<u.length;c++){var p=u[c].layer;if(p._tooltip_handler){h&&h.length?h+="<br/>":h="";var y=p._tooltip_handler(u[c].feature.geo,u[c].feature.data);y&&(h+=y)}}h&&h.length?(WRAP.Geo.currentFeature=i.lastHitfeature,WRAP.Geo.Interaction.setTooltip(h),WRAP.Geo.Interaction.showTooltip(i.lastHit.x,i.lastHit.y)):(WRAP.Geo.currentFeature=null,WRAP.Geo.Interaction.clearTooltip())}else WRAP.Geo.enableScroll(!0),WRAP.Geo.currentFeature=null,WRAP.Geo.Interaction.clearTooltip()}});var n,o;t.addEventListener("mousedown",function(e){n=e.clientX,o=e.clientY;var r=t.getBoundingClientRect(),a=e.clientX-r.left,s=e.clientY-r.top,l=i.hit(new WRAP.Geo.ScreenPoint(a,s));l&&l.feature&&(i.lastClick=l,i.lastClick.feature.draggable&&i.lastClick.feature.dragStart(a,s),l.feature.touch&&l.feature.touch(a,s))}),t.addEventListener("mouseup",function(t){if(i.lastClick)i.lastClick.feature.draggable&&i.lastClick.feature.dragEnd(),WRAP.Geo.enableScroll(!0),i.lastClick=null;else if(n==t.clientX&&o==t.clientY)for(var e=t.target.getBoundingClientRect(),r=t.clientX-e.left,a=t.clientY-e.top,s=WRAP.Geo.Interaction.touch,l=new WRAP.Geo.ScreenPoint(r,a),h=0;h<s.length;h++)s[h](null,null,l)}),t.addEventListener("mouseout",function(){WRAP.Geo.enableScroll(!0),WRAP.Geo.currentFeature=null,WRAP.Geo.Interaction.clearTooltip()})},currentTooltip:function(){var t=WRAP.Geo.Interaction.getTooltip();if(t&&WRAP.Geo.currentFeature)return{geo:WRAP.Geo.currentFeature.geo,data:WRAP.Geo.currentFeature.data,content:t}},addTooltipGroup:function(t){if(t&&t.length){this._tooltipGroup||(this._tooltipGroup=[]);for(var e=0;e<this._tooltipGroup;e++){var i=this._tooltipGroup[e];if(t.length==i.length){for(var n=0;n<t.length&&!(i.indexOf(t[n++])<0););if(n>=t.length)return}}this._tooltipGroup.push(t)}},removeTooltipGroup:function(t){if(t&&t.length&&this._tooltipGroup)for(var e=0;e<this._tooltipGroup;e++){var i=this._tooltipGroup[e];if(t.length==i.length){for(var n=0;n<t.length&&!(i.indexOf(t[n++])<0););if(n>=t.length)return void this._tooltipGroup.splice(e,1)}}},Point:function(t,e){this.set=function(t,e){this.lat=parseFloat(t),this.lon=parseFloat(e),this.lon<-10800?this.lon+=21600:this.lon>=10800&&(this.lon-=21600)},this.setDegree=function(t,e){set(parseFloat(t)*60..parseFloat(e)*60)},this.latDegree=function(){return this.lat/60},this.lonDegree=function(){return this.lon/60},this.set(t,e)},Bounds:function(t,e,i,n){this.contains=function(t){if(t.lat>this.north||t.lat<this.south)return!1;if(this.west<this.east){if(t.lon>this.east||t.lon<this.west)return!1}else if(t.lon>this.east&&t.lon<this.west)return!1;return!0},this.north=t,this.south=e,this.east=i,this.west=n},ScreenPoint:function(t,e){this.x=t,this.y=e},ScreenBounds:function(t,e,i,n){this.x=t,this.y=e,this.width=i,this.height=n},Layer:function(t){var e=this;this._name=t,this._visible=!0,this._style=null,this._content=null,this._attr=null,this._data=null,this._conf=null,this._dl=[],this._revision={data:0,conf:0,context:0,content:0,style:0},this.configure=function(t,i){this._data=t,this._conf=i,this._revision.conf++;var n=i.Renderer;n&&WRAP.Geo.Renderer[n]?this._renderer=new WRAP.Geo.Renderer[n]:e._error("Implementation WRAP.Geo.Renderer."+n+" not found."),this._data?this._data.inspect(function(){e._revision.data++,e.render()},!0):e.render()},this.show=function(){this.setVisible(!0)},this.hide=function(){this.setVisible(!1)},this.visible=function(){return this._visible},this.setVisible=function(t){if(this._visible!=t){this._visible=t;var e=WRAP.Geo.Interaction.visibilityChange;if(e)for(var i=0;i<e.length;i++)e[i](this);this.render(),WRAP.Geo.invalidate()}},this.addFeature=function(t){t.layer=this,this._dl.push(t)},this.removeFeature=function(t){var e=this._dl.indexOf(t);e>=0&&this._dl.splice(e,1)},this.clear=function(){this._dl=[],WRAP.Geo.invalidate()},this.set=function(t){var i=JSON.parse(JSON.stringify(t));return this._timeController&&this._data&&!this._timeController.validate(this,i)?(this._content=i,void e.clear()):void(JSON.stringify(this._content)!=JSON.stringify(i)&&(this._content=i,e._revision.content++,e.render()))},this.get=function(){return this._content},this.setAttributes=function(t){this._content&&t&&JSON.stringify(this._content)==JSON.stringify(t)||(e._revision.conf++,this._attr=t,this.render())},this.name=function(){return this._name},this.setStyle=function(t){this._style!=t&&(e._revision.style++,this._style=t,this.render())},this.setTooltip=function(t){this._tooltip_handler=t},this.invalidate=function(){this._revision.data++,this.render()},this.merge=function(t){this.merged!=t&&(this.merged&&t&&this.merged.toString()==t.toString()||(this.merged=t,this.invalidate()))},this.getValue=function(t){if(this._renderer&&this._renderer.getValue){var e=this._content,i=WRAP.Geo.map.context,n=this._data;return this._renderer.getValue(e,i,n,t)}return null},this._currentConfiguration=function(){function t(e,i){for(var n in i)Array.isArray(i[n])?e[n]=i[n]:"object"==typeof i[n]?t(e[n]={},i[n]):e[n]=i[n]}function e(t,i){if(i)for(var n in i)"object"==typeof i[n]&&t[n]?e(t[n],i[n]):t[n]=i[n]}var i={};return t(i,this._conf),i.Attributes||(i.Attributes={}),e(i.Attributes,this._attr),i},this.render=function(){if(this._visible&&this._renderer&&this._renderer.draw){var t=this._content,e=this._currentConfiguration(),i=WRAP.Geo.map.context,n=this._style,o=this._data,r=this._revision,a=this._dl;r.context=i.revision,this._renderer.draw(this,t,e,i,n,o,r,a);for(var s=0;s<a.length;s++)a[s].layer=this}},this.renderMerge=function(t){var e=[];if(this._visible)if(this.merged&&this._renderer&&this._renderer.merge){var i=this._currentConfiguration(),n=this._style;this._renderer.merge(e,this._dl,i,n),this._merged_revision=t;for(var o=0;o<this.merged.length;o++){var r=this.merged[o];r._visible&&r._renderer&&r._renderer.merge&&(i=r._currentConfiguration(),n=r._style,r._renderer.merge(e,r._dl,i,n),r._merged_revision=t)}}else e=this._dl;return e},this.setTimeController=function(t){this._timeController=t},this._error=function(t){console.warn(this.name()+":"+t)}},Feature:{Point:function(t){this.draw=function(e){e.drawPoint(t.point,t.pointSize,t.lineWidth,t.strokeStyle,t.fillStyle)},this.hit=function(e,i){var n=t.pointSize;t.sensorSize&&(n=t.sensorSize);var o=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),r=o.x-n/2,a=r+n;if(e<r||a<e)return null;var s=o.y-n/2,l=s+n;return i<s||l<i?null:{x:o.x,y:o.y}},this.setDraggable=function(t,e){this.draggable=t,this.dragHandler=e},this.style=function(){return t},this.mouseover=function(){for(var e=WRAP.Geo.Interaction.mouseover,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),n=0;n<e.length;n++)e[n](this.layer,this,i)},this.mouseout=function(){for(var e=WRAP.Geo.Interaction.mouseout,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),n=0;n<e.length;n++)e[n](this.layer,this,i)},this.touch=function(){for(var e=WRAP.Geo.Interaction.touch,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),n=0;n<e.length;n++)e[n](this.layer,this,i)},this.dragStart=function(e,i){var n=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0]));this.anchor={lon:t.point[0],lat:t.point[1],ox:e,oy:i,x:n.x,y:n.y}},this.drag=function(e,i){if(this.anchor){var n=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(this.anchor.x+(e-this.anchor.ox),this.anchor.y+(i-this.anchor.oy)));t.point[0]=n.lonDegree(),t.point[1]=n.latDegree(),this.dragHandler&&this.dragHandler(this,t.point)}},this.dragEnd=function(){this.anchor=null}},Text:function(t){this.draw=function(e){e.drawText(t.point,t.text,t.fontSize,t.fillStyle,t.strokeStyle,t.offsetX,t.offsetY,t.align,t.rotation)},this.hit=function(e,i){var n=WRAP.Geo._internal_context;if(!n){var o=WRAP.Geo._internal_canvas=document.createElement("canvas");n=WRAP.Geo._internal_context=o.getContext("2d")}var r=t.fontSize;if(t.fontSize)n.font=t.fontSize+"px Arial";else{var a=n.measureText("W");r=1.5*a.width}var s=parseFloat(t.offsetX)||0,l=parseFloat(t.offsetY)||0,h=n.measureText(t.text);"left"==t.align?s+=0:s-="right"==t.align?h.width:.5*h.width;var f=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),u=f.x+s,c=f.y+l-r,d=u+h.width,v=c+r;return u<=e&&e<=d&&c<=i&&i<=v?{x:f.x,y:f.y}:null},this.mouseover=function(){for(var e=WRAP.Geo.Interaction.mouseover,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),n=0;n<e.length;n++)e[n](this.layer,this,i)},this.mouseout=function(){for(var e=WRAP.Geo.Interaction.mouseout,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),n=0;n<e.length;n++)e[n](this.layer,this,i)},this.touch=function(){for(var e=WRAP.Geo.Interaction.touch,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),n=0;n<e.length;n++)e[n](this.layer,this,i)},this.style=function(){return t}},Line:function(t){this.draw=function(e){e.drawLine(t.point,t.line,t.lineWidth,t.lineDash,t.strokeStyle,t.fillStyle,t.fillImage,t.option,t.rotation,this.id)},this.hit=function(t,e,i){return i.hit(t,e,this.id)?{x:t,y:e}:null},this.mouseover=function(t,e){for(var i=WRAP.Geo.Interaction.mouseover,n=new WRAP.Geo.ScreenPoint(t,e),o=0;o<i.length;o++)i[o](this.layer,this,n)},this.mouseout=function(t,e){for(var i=WRAP.Geo.Interaction.mouseout,n=new WRAP.Geo.ScreenPoint(t,e),o=0;o<i.length;o++)i[o](this.layer,this,n)},this.touch=function(t,e){for(var i=WRAP.Geo.Interaction.touch,n=new WRAP.Geo.ScreenPoint(t,e),o=0;o<i.length;o++)i[o](this.layer,this,n)},this.style=function(){return t}},Image:function(t){this.draw=function(e){t.image.data?e.drawImageData(t.point,t.image,t.width,t.height,t.offsetX,t.offsetY,t.rotation):e.drawImage(t.point,t.image,t.width,t.height,t.offsetX,t.offsetY,t.rotation)},this.hit=function(e,i){var n=t.width,o=t.height,r=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),a=r.x-n/2,s=a+n;if(e<a||s<e)return null;var l=r.y-o/2,h=l+o;return i<l||h<i?null:{x:r.x,y:r.y}},this.style=function(){return t},this.mouseover=function(){for(var e=WRAP.Geo.Interaction.mouseover,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),n=0;n<e.length;n++)e[n](this.layer,this,i)},this.mouseout=function(){for(var e=WRAP.Geo.Interaction.mouseout,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),n=0;n<e.length;n++)e[n](this.layer,this,i)},this.touch=function(){for(var e=WRAP.Geo.Interaction.touch,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),n=0;n<e.length;n++)e[n](this.layer,this,i)},this.set=function(e,i){this.layer=e,this.reference=i,this.mouseover=function(){for(var e=WRAP.Geo.Interaction.mouseover,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),n=0;n<e.length;n++)e[n](this.layer,this.reference,i)},this.mouseout=function(){for(var e=WRAP.Geo.Interaction.mouseout,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),n=0;n<e.length;n++)e[n](this.layer,this.reference,i)},this.touch=function(){for(var e=WRAP.Geo.Interaction.touch,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),n=0;n<e.length;n++)e[n](this.layer,this.reference,i)}}},GeoLine:function(t){this.draw=function(e){e.drawPath(t.path,t.lineWidth,t.lineDash,t.strokeStyle,t.fillStyle,t.fillImage,t.option,void 0===t.geodesic||t.geodesic,this.id)},this.hit=function(t,e,i){return i.hit(t,e,this.id)?{x:t,y:e}:null},this.mouseover=function(t,e){for(var i=WRAP.Geo.Interaction.mouseover,n=new WRAP.Geo.ScreenPoint(t,e),o=0;o<i.length;o++)i[o](this.layer,this,n)},this.mouseout=function(t,e){for(var i=WRAP.Geo.Interaction.mouseout,n=new WRAP.Geo.ScreenPoint(t,e),o=0;o<i.length;o++)i[o](this.layer,this,n)},this.touch=function(t,e){for(var i=WRAP.Geo.Interaction.touch,n=new WRAP.Geo.ScreenPoint(t,e),o=0;o<i.length;o++)i[o](this.layer,this,n)},this.style=function(){return t}},GeoArc:function(t){this.draw=function(e){e.drawArc(t.point,t.radius,t.start,t.end,t.lineWidth,t.strokeStyle,t.fillStyle,t.fillImage,this.id)},this.hit=function(t,e,i){return i.hit(t,e,this.id)?{x:t,y:e}:null},this.mouseover=function(t,e){for(var i=WRAP.Geo.Interaction.mouseover,n=new WRAP.Geo.ScreenPoint(t,e),o=0;o<i.length;o++)i[o](this.layer,this,n)},this.mouseout=function(t,e){for(var i=WRAP.Geo.Interaction.mouseout,n=new WRAP.Geo.ScreenPoint(t,e),o=0;o<i.length;o++)i[o](this.layer,this,n)},this.touch=function(t,e){for(var i=WRAP.Geo.Interaction.touch,n=new WRAP.Geo.ScreenPoint(t,e),o=0;o<i.length;o++)i[o](this.layer,this,n)},this.style=function(){return t}},Tile:function(t){this.draw=function(e){e.drawTile(t.tile,t.imageData)},this.hit=function(t,e){if(t<0||e<0)return null;var i,n=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(t,e));return this.layer&&(i=this.layer.getValue(n)),this.geo={geometry:{type:"Point",coordinates:[n.lonDegree(),n.latDegree()]},properties:i},{x:t,y:e,pixel:!0}},this.style=function(){return t}}},Animation:function(){this.setTimeRange=function(t,e){this._frame=t,this._interval=parseFloat(e),this._last_time=0,this._next_time=0,this._current=-1,this._time=0,this._setFrame(0),this._running=null,this._cb=null},this.setValidTimeRange=function(t,e,i,n){for(var o=[{validtime:t}],r=WRAP.DH._time(t),a=WRAP.DH._time(e),s=WRAP.DH._setTime(r,i);s<a;)o.push({validtime:WRAP.DH._timeString(s)}),s=WRAP.DH._setTime(s,i);return r<a&&o.push({validtime:e}),this._frame=o,this._interval=parseFloat(n),this._last_time=0,this._next_time=0,this._current=-1,this._time=0,this._setFrame(0),this._running=null,this._cb=null,o},this.setLayer=function(t){this._layer=t},this.setTimeController=function(t){this._controller=t},this.setTime=function(t){this._running=!1;for(var e=0;e<this._frame.length&&(t.basetime&&t.basetime!=this._frame[e].basetime||!(t.validtime<=this._frame[e].validtime));)e++;this._setFrame(e)},this.start=function(t){this._cb=t,this._running||(this._running=!0,this._current_time=WRAP.Geo.addAnimation(this),this._next_time=this._current_time+this._interval)},this.stop=function(){this._running=!1,WRAP.Geo.removeAnimation(this)},this.time=function(){return this._time},this._setFrame=function(t){if(!this._frame||!this._frame.length)return this._time=void 0,this._current=-1,!1;if(t<0&&(t=0),t>=this._frame.length&&(t=this._frame.length-1),this._current!=t){if(this._current=t,this._time=this._frame[t],this._layer)for(var e=0;e<this._layer.length;e++)this._layer[e].set(this._frame[t]);return this._controller&&this._controller.setDisplayTime(this._frame[t].validtime),!0}return!1},this._go=function(t){if(this._running&&this._next_time<=t){if(WRAP.Geo.upper_layers_updating)return void WRAP.Geo.drawTiles();this._next_time=t+this._interval,this._setFrame(this._current+1)&&this._cb&&this._cb(this._time),this._current>=this._frame.length-1&&this.stop()}}},Context:function(t){this.revision=0,this.tiles=[],this.setTileBand=function(t,e,i,n,o){if(this.zoom!=t||this.min_tile_x!=e||this.max_tile_x!=i||this.min_tile_y!=n||this.max_tile_y!=o){if(this.zoom=t,this.tile_band=Math.pow(2,t),this.canvas_band=256*this.tile_band,this.min_tile_x=e,this.max_tile_x=i,this.min_tile_y=n,this.max_tile_y=o,this.offset_x=256*(this.min_tile_x-this.tile_band/2),this.offset_y=256*(this.tile_band/2-1-this.max_tile_y),this.tiles.length){var r={};r.n=this.tiles[0].bounds.north/60,r.s=this.tiles[0].bounds.south/60;for(var a=1;a<this.tiles.length;a++)r.n<this.tiles[a].bounds.north/60&&(r.n=this.tiles[a].bounds.north/60),r.s>this.tiles[a].bounds.south/60&&(r.s=this.tiles[a].bounds.south/60)}r.w=(this.min_tile_x-this.tile_band/2)/this.tile_band*360,r.e=(this.max_tile_x+1-this.tile_band/2)/this.tile_band*360,this.bounds=r,this.canvas||(this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"));var s=this.max_tile_y-this.min_tile_y+1,l=this.max_tile_x-this.min_tile_x+1;this.max_tile_x<this.min_tile_x&&(l=this.tile_band-this.min_tile_x+this.max_tile_x+1),this.canvas.width=256*l,this.canvas.height=256*s;for(var h=t,f=0;f<s;f++)for(var u=this.max_tile_y-f,c=0;c<l;c++){var d=(this.min_tile_x+c)%this.tile_band,v=this.findTile(h,u,d);v&&(v.canvas=this.canvas,v.ctx=this.ctx,v.offset_x=256*c,v.offset_y=256*f)}}},this.lockTile=function(){for(var t=0;t<this.tiles.length;t++)this.tiles[t].locked=!0},this.clearLockedTile=function(){for(var t=this.tiles.length-1;t>=0;t--)this.tiles[t].locked&&this.tiles.splice(t,1)},this.findTile=function(t,e,i){for(var n=0;n<this.tiles.length;n++){var o=this.tiles[n];if(o.z==t&&o.y==e&&o.x==i)return o}return null},this.addTile=function(t,e,i,n,o,r){this.revision++,this.tiles.push({id:"M/"+e+"/"+i+"/"+n,type:t,z:e,y:i,x:n,cood:o,bounds:r})},this.tile=function(t){for(var e=0;e<this.tiles.length;e++){var i=this.tiles[e];i.valid||t(i)}},this.drawImageData=function(e,i,n,o,r,a,s){function l(t,e,i,n,o,l){s?(t.save(),t.translate(i,n),t.rotate(s/180*Math.PI),t.drawImage(e,r,a,o,l),t.restore()):t.drawImage(e,i+r,n+a,o,l)}function h(t){var e=document.createElement("canvas");e.width=t.width,e.height=t.height;var i=e.getContext("2d");return i.putImageData(t,0,0),e}var f=this.ctx,u=t.getScreenPoint(new WRAP.Geo.Point(0,0)),c=this.offset_x+u.x,d=this.offset_y+u.y,v=t.getScreenPoint(new WRAP.Geo.Point(60*e[1],60*e[0])),p=v.x-c,g=v.y-d,_=1.5*(n>o?n:o),m=-_,y=this.canvas.width+_,P=-_,x=this.canvas.height+_;if(!(g<P||x<g)){var w=null;m<=p&&p<=y&&(w||(w=h(i)),l(f,w,p,g,n,o));var A=p-this.canvas_band;m<=A&&A<=y&&(w||(w=h(i)),l(f,w,A,g,n,o));var b=p+this.canvas_band;m<=b&&b<=y&&(w||(w=h(i)),l(f,w,b,g,n,o))}},this.drawImage=function(e,i,n,o,r,a,s){function l(t,e,i,n,o){s?(t.save(),t.translate(e,i),t.rotate(s/180*Math.PI),t.drawImage(f,r,a,n,o),t.restore()):t.drawImage(f,e+r,i+a,n,o)}var h=WRAP.Geo.imageCache[i];if(void 0==h)return h=WRAP.Geo.imageCache[i]={loaded:!1,image:new Image},h.image.onload=function(){h.loaded=!0,WRAP.Geo.invalidate()},void(h.image.src=i);if(h.loaded){var f=h.image;0==n&&(n=f.width),0==o&&(o=f.height);var u=this.ctx,c=t.getScreenPoint(new WRAP.Geo.Point(0,0)),d=this.offset_x+c.x,v=this.offset_y+c.y,p=t.getScreenPoint(new WRAP.Geo.Point(60*e[1],60*e[0])),g=p.x-d,_=p.y-v,m=1.5*(n>o?n:o),y=-m,P=this.canvas.width+m,x=-m,w=this.canvas.height+m;if(_<x||w<_)return;y<=g&&g<=P&&l(u,g,_,n,o);var A=g-this.canvas_band;y<=A&&A<=P&&l(u,A,_,n,o);var b=g+this.canvas_band;y<=b&&b<=P&&l(u,b,_,n,o)}},this.hit=function(t,e,i){if(!i)return!1;var n=WRAP.Geo.getScreenPoint(this.hitctx.anchor);t-=n.x,e-=n.y;var o=this.hitctx.getImageData(t,e,1,1);if(o&&o.data){var r=(o.data[0]<<16)+(o.data[1]<<8)+o.data[2];return i==r}return!1},this._drawLines=function(e,i,n,o,r,a,s,l){if(l&&(r||a)){l=parseInt(l);var h=(16711680&l)>>16,f=(65280&l)>>8,u=255&l;this.hitctx.fillStyle="rgb("+h+","+f+","+u+")",this.hitctx.beginPath();for(var c=0;c<e.length;c++){var d=e[c],v=d[0].x,p=d[0].y,g=0;for(this.hitctx.moveTo(v,p);++g<e[c].length;)v=d[g].x,p=d[g].y,this.hitctx.lineTo(v,p)}this.hitctx.closePath(),this.hitctx.fill("evenodd")}for(var _=this.ctx,m=t.getScreenPoint(new WRAP.Geo.Point(0,0)),y=t.getSize().width/2;m.x-y>=this.canvas_band/2;)m.x-=this.canvas_band;for(;m.x-y<-this.canvas_band/2;)m.x+=this.canvas_band;var P=this.offset_x+m.x,x=this.offset_y+m.y,w=0,A=this.canvas.height,b=0,W=this.canvas.width;"cloud"==s&&(w-=10,A+=10,b-=10,W+=10);var G=[];if(r)G=e;else for(var c=0;c<e.length;c++){for(var R=!1,S=15,g=-1;++g<e[c].length;){var M=0,v=e[c][g].x-P;v<b?M|=1:v>W&&(M|=2);var p=e[c][g].y-x;if(p<w?M|=4:p>A&&(M|=8),!(S|M&&S&M)){R=!0;break}S=M}R&&G.push(e[c])}if(G.length){_.beginPath();for(var c=0;c<G.length;c++){var d=G[c];if("cloud"==s||"counter_cloud"==s){var I=Math.PI/3;"counter_cloud"==s&&(I=-I);var T=Math.cos(I),k=Math.sin(I),L=10,v=d[0].x-P,p=d[0].y-x,g=0;_.moveTo(v,p);for(var z=v,F=p,C=L;++g<d.length;){for(var W=d[g].x-P,A=d[g].y-x,D=W-v,E=A-p,X=Math.sqrt(D*D+E*E),H=X,Y=0;H>=C;){Y+=C;var h=Y/X,j=v+D*h,O=p+E*h,N=j-z,B=O-F,y=T*N-k*B+z,Z=k*N+T*B+F;_.quadraticCurveTo(y,Z,j,O),z=j,F=O,H-=C,C=L}C-=H,v=W,p=A}v=d[d.length-1].x-P,p=d[d.length-1].y-x,_.lineTo(v,p)}else{var v=d[0].x-P,p=d[0].y-x,g=0;for(_.moveTo(v,p);++g<G[c].length;)v=d[g].x-P,p=d[g].y-x,_.lineTo(v,p)}}if(r&&(_.closePath(),_.fillStyle=r,_.fill("evenodd")),a){_.closePath();var q=_.createPattern(a,"");_.fillStyle=q,_.fill("evenodd")}if(o){if(_.lineWidth=i||1,n&&_.setLineDash(n),_.strokeStyle=o,_.stroke(),"outset"==s||"inset"==s){_.beginPath();for(var c=0;c<G.length;c++){var d=G[c],I=Math.PI/3;"inset"==s&&(I=-I);for(var T=Math.cos(I),k=Math.sin(I),L=10,v=d[0].x-P,p=d[0].y-x,g=0,z=v,F=p,C=L;++g<d.length;){for(var W=d[g].x-P,A=d[g].y-x,D=W-v,E=A-p,X=Math.sqrt(D*D+E*E),H=X,Y=0;H>=C;){Y+=C;var h=Y/X,j=v+D*h,O=p+E*h,N=j-z,B=O-F,V=z+.5*(j-z),J=F+.5*(O-F),y=T*N-k*B+z,Z=k*N+T*B+F;_.moveTo(y,Z),_.lineTo(V,J),z=j,F=O,H-=C,C=L}C-=H,v=W,p=A}}_.stroke()}n&&_.setLineDash([])}}},this._fragmentPath=function(t){for(var e=[],i=0;i<t.length;i++){var n=t[i][1],o=t[i][0];if(i>0){var r=t[i-1][1],a=t[i-1][0],s=o-a;s<-180?(s+=360,o+=360):s>=180&&(s-=360,a+=360);var l=Math.abs(s);if(l>1){var h=new WRAP.Geo.GreatCircle(r,a,n,o),f=r,u=a;e.push([u,f]);for(var c=0;c+1<l;){c+=1;var d=c/l,v=h.getPosition(d);e.push([v.lon,v.lat]),f=v.lat,u=v.lon}}else e.push([a,r])}e.push([o,n])}return e},this._addFragments=function(t,e){for(var i=WRAP.Geo.getScreenLine(e),n=0;n<i.length;n++)t.push(i[n])},this._gcPos=function(t,e,i,n){function o(t){return t*Math.PI*h}function r(t){return t*l*u}var a,s=n,l=10800,h=9259259e-11,f=Math.PI/2,u=1/Math.PI,c=60*t,d=60*e,v=180-i,p=i/180*Math.PI,g=Math.cos(p),_=o(s),m=(.5-c*h)*Math.PI,y=Math.cos(_),P=Math.cos(m),x=Math.sin(_),w=Math.sin(m),A=y*P+x*w*g;a=A>1?0:A<-1?Math.PI:Math.acos(A);var b=f-a;b=r(b);var W,G=Math.sin(a),R=(y*w-x*P*g)/G;W=R>1?0:R<-1?Math.PI:Math.acos(R);var S;return S=v>0?o(d)+W:o(d)-W,S=r(S),S>l?S=2*-l+S:S<-l&&(S=2*l+S),{lat:b/60,lon:S/60}},this.drawPath=function(t,e,i,n,o,r,a,s,l){var h={};if(r){var f=r;if(h=WRAP.Geo.imageCache[f],void 0==h)return h=WRAP.Geo.imageCache[f]={loaded:!1,image:new Image},h.image.onload=function(){h.loaded=!0,WRAP.Geo.invalidate()},void(h.image.src=f)}if(!r||h.loaded){var u=[];if(Array.isArray(t[0][0])){for(var c=0;c<t.length;c++)if(!(t[c].length<2)){var d=t[c];s&&(d=this._fragmentPath(t[c])),this._addFragments(u,d)}if(!u.length)return}else{if(t.length<2)return;var d=t;s&&(d=this._fragmentPath(t)),this._addFragments(u,d)}this._drawLines(u,e,i,n,o,h.image,a,l)}},this.drawArc=function(t,e,i,n,o,r,a,s,l){var h={};if(s){var f=s;if(h=WRAP.Geo.imageCache[f],void 0==h)return h=WRAP.Geo.imageCache[f]={loaded:!1,image:new Image},h.image.onload=function(){h.loaded=!0,WRAP.Geo.invalidate()},void(h.image.src=f)}if(!s||h.loaded){var u=[];(i==n||Math.abs(n-i)>360)&&(i=0,n=360);var c=1;e<5e5?c=5:e<1e5&&(c=2),e/=1851.8518518518517;for(var d=i;d<n;d+=c){var v=this._gcPos(t[1],t[0],d,e);u.push([v.lon,v.lat])}var v=this._gcPos(t[1],t[0],n,e);u.push([v.lon,v.lat]);var p=[];if(u.length<2)return;var g=this._fragmentPath(u);this._addFragments(p,g),this._drawLines(p,o,null,r,a,h.image,null,l)}},this.drawPoint=function(e,i,n,o,r){function a(t,e,a){r&&(t.fillStyle=r,t.beginPath(),t.arc(e,a,i/2-1,0,2*Math.PI,!0),t.closePath(),t.fill()),o&&(t.strokeStyle=o,t.lineWidth=n||1,t.beginPath(),t.arc(e,a,i/2-1,0,2*Math.PI,!0),t.closePath(),t.stroke())}var s=t.getScreenPoint(new WRAP.Geo.Point(60*e[1],60*e[0])),l=this.ctx,h=t.getScreenPoint(new WRAP.Geo.Point(0,0)),f=this.offset_x+h.x,u=this.offset_y+h.y,c=s.x-f,d=s.y-u,v=-i,p=this.canvas.width+i,g=-i,_=this.canvas.height+i;if(!(d<g||_<d)){v<=c&&c<=p&&a(l,c,d);var m=c-this.canvas_band;v<=m&&m<=p&&a(l,m,d);var y=c+this.canvas_band;v<=y&&y<=p&&a(l,y,d)}},this.drawLine=function(e,i,n,o,r,a,s,l,h,f){function u(t,e,i){if(!(e.length<2)){for(var n,o,r=[],a=0;a<e.length;a++){var s=e[a][0],l=e[a][1];if(h){var f=s*g-l*_,u=s*_+l*g;s=f,l=u}s+=p.x,l+=p.y,0==a?n=o=s:(n>s&&(n=s),o<s&&(o=s)),r.push(new WRAP.Geo.ScreenPoint(s,l))}t.push(r);var d=c.x-i/2,v=d-i,m=c.x+i/2,y=m+i;if(n<d&&o>v){for(var P=[],a=0;a<r.length;a++)P.push(new WRAP.Geo.ScreenPoint(r[a].x+i,r[a].y));t.push(P)}if(n<y&&o>m){for(var P=[],a=0;a<r.length;a++)P.push(new WRAP.Geo.ScreenPoint(r[a].x-i,r[a].y));t.push(P)}}}var c={};if(s){var d=s;if(c=WRAP.Geo.imageCache[d],void 0==c)return c=WRAP.Geo.imageCache[d]={loaded:!1,image:new Image},c.image.onload=function(){c.loaded=!0,WRAP.Geo.invalidate()},void(c.image.src=d)}if(!s||c.loaded){for(var c=t.getScreenPoint(new WRAP.Geo.Point(0,0)),v=t.getSize().width/2;c.x-v>=this.canvas_band/2;)c.x-=this.canvas_band;for(;c.x-v<-this.canvas_band/2;)c.x+=this.canvas_band;for(var p=t.getScreenPoint(new WRAP.Geo.Point(60*e[1],60*e[0]));p.x-c.x>this.offset_x+this.canvas_band;)p.x-=this.canvas_band;for(;p.x-c.x<this.offset_x;)p.x+=this.canvas_band;var g,_;h&&(g=Math.cos(Math.PI*h/180),_=Math.sin(Math.PI*h/180));var m=[];if(Array.isArray(i[0][0]))for(var y=0;y<i.length;y++)u(m,i[y],this.canvas_band);else u(m,i,this.canvas_band);if(!m.length)return;this._drawLines(m,n,o,r,a,c.image,l,f)}},this.drawText=function(e,i,n,o,r,a,s,l,h){function f(t,e,n,o,a){h?(t.save(),t.translate(e,n),t.rotate(h/180*Math.PI),t.translate(o,a),r&&(t.lineWidth=2,t.strokeStyle=r,t.strokeText(i,0,0)),t.fillText(i,0,0),t.restore()):(r&&(t.lineWidth=2,t.strokeStyle=r,t.strokeText(i,e+o,n+a)),t.fillText(i,e+o,n+a))}var u=this.ctx;n&&(u.font=n+"px Arial"),o&&(u.fillStyle=o);var c=parseFloat(a)||0,d=parseFloat(s)||0,v=u.measureText(i);"left"==l?c+=0:c-="right"==l?v.width:.5*v.width;var p=t.getScreenPoint(new WRAP.Geo.Point(0,0)),g=this.offset_x+p.x,_=this.offset_y+p.y,m=t.getScreenPoint(new WRAP.Geo.Point(60*e[1],60*e[0])),y=m.x-g,P=m.y-_,x=v.width,w=-x,A=this.canvas.width+x,b=-x,W=this.canvas.height+x;if(!(P<b||W<=P)){w<=y&&y<=A&&f(u,y,P,c,d);var G=y-this.canvas_band;w<=G&&G<=A&&f(u,G,P,c,d);var R=y+this.canvas_band;w<=R&&R<=A&&f(u,R,P,c,d)}},this.drawTile=function(t,e){this.tile(function(i){if(i.id==t.id){var n=document.createElement("canvas");n.width=256,n.height=256;var o=n.getContext("2d");o.putImageData(e,0,0,0,0,256,256),o.fillStyle="rgba(0,0,0,0.0)",o.fillRect(0,0,1,1),i.ctx.drawImage(n,i.offset_x,i.offset_y)}})},this.begin=function(e){this.hitcvs||(this.hitcvs=document.createElement("canvas"),this.hitctx=this.hitcvs.getContext("2d"));var i=t.getSize();if(this.hitcvs.width==i.width&&this.hitcvs.width==i.width||(this.hitcvs.width=i.width,this.hitcvs.height=i.height),this.hitctx.anchor=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(0,0)),this.hitctx.clearRect(0,0,i.width,i.height),this.ctx){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(var n=0;n<this.tiles.length;n++){var o=this.tiles[n];o.revision!=e&&(o.valid=!1)}}},this.end=function(e){this.rev++;for(var i=0;i<this.tiles.length;i++){var n=this.tiles[i];n.context_rev=this.rev,n.revision!=e&&(n.revision=e,n.valid=!0),t.setTile(n,e)}t.update()},this.rev=0},GreatCircle:function(t,e,i,n){if(this.p1=[],this.p2=[],this.omeda=0,this.heading=0,this.neg=!1,n<e){this.neg=!0;var o;o=e,e=n,n=o,o=t,t=i,i=o}this.offset=e,e=0,n-=this.offset,t*=Math.PI/180,e*=Math.PI/180,i*=Math.PI/180,n*=Math.PI/180,this.p1[0]=Math.cos(t)*Math.cos(e),this.p1[1]=Math.cos(t)*Math.sin(e),this.p1[2]=Math.sin(t),this.p2[0]=Math.cos(i)*Math.cos(n),this.p2[1]=Math.cos(i)*Math.sin(n),this.p2[2]=Math.sin(i),this.omega=Math.acos(this.p1[0]*this.p2[0]+this.p1[1]*this.p2[1]+this.p1[2]*this.p2[2]),this.sinomega=Math.sin(this.omega);var r=Math.cos(t)*this.simomega;if(Math.abs(r)>.001){var a=(Math.sin(i)-Math.sin(t)*Math.cos(this.omega))/r;a<-1&&(a=-1),a>1&&(a=1),this.heading=Math.acos(a);for(var s=n-e;s<-Math.PI;)s+=2*Math.PI;for(;s>Math.PI;)s-=2*Math.PI;s<0&&(this.heading=2*Math.PI-this.heading)}else this.heading=0;this.getDistance=function(){var t=3443.96;return this.omega*t},this.getPosition=function(t){this.neg&&(t=1-t);var e=Math.sin((1-t)*this.omega)/this.sinomega,i=Math.sin(t*this.omega)/this.sinomega,n=[];n[0]=this.p1[0]*e+this.p2[0]*i,n[1]=this.p1[1]*e+this.p2[1]*i,n[2]=this.p1[2]*e+this.p2[2]*i;var o=Math.atan2(n[1],n[0])*(180/Math.PI),r=Math.asin(n[2])*(180/Math.PI);return o+=this.offset,{lat:r,lon:o}}},Bridge:{},Renderer:{},Interaction:{mouseover:[],mouseout:[],touch:[],boundsChange:[],visibilityChange:[]},timer:null,rendering:!1,redrawQueue:[],valid:!0,redraw:function(t){this.redrawQueue.indexOf(t)<0&&this.redrawQueue.push(t)},render:function(){var t=this;t.valid=!1,this.timer||(this.timer=setInterval(function(){if(t.redrawQueue.length)for(var e;e=t.redrawQueue.shift();)e.visible()&&e.render();else if(!t.valid){var i=t.map.context;if(!i.tiles.length)return;var n=t.container.upper_layers;if(!n||!n.length)return;if(t.rendering)return;t.rendering=!0;for(var o=n.length-1;o>=0;o--){var e=n[o];e.visible()&&e.merged&&e.merged.length&&(e._merged_dl=e.renderMerge(t.revision))}for(var r=[],o=n.length-1;o>=0;o--){var e=n[o];e.visible()&&(e._merged_dl?r.push(e._merged_dl):e._merged_revision!=t.revision&&r.push(e._dl))}for(var o=n.length-1;o>=0;o--){var e=n[o];e._merged_dl=null;
}i.begin(t.revision);for(var a=1e3,s=0;s<r.length;s++)for(var l=r[s],h=l.length,o=0;o<h;o++)l[o].id=a++,l[o].draw(i);if(t.valid=!0,i.end(t.revision),t.rendering=!1,void 0!==t.lastX){var f=t.hit(new WRAP.Geo.ScreenPoint(t.lastX,t.lastY));t.lastHit&&f.feature==t.lastHit.feature||(f.feature&&f.feature.draggable&&WRAP.Geo.enableScroll(!1),t.lastHit=f)}}},20))},invalidate:function(){this.revision++,this.render()},lastZoom:-1,lastContext:-1,updateBounds:function(t){WRAP.Geo.Interaction&&(WRAP.Geo.lastHit=null,WRAP.Geo.Interaction.clearTooltip());var e=WRAP.Geo.Interaction.boundsChange;if(e)for(var i=0;i<e.length;i++)e[i](t);this.lastContext=this.map.context.revision;var n=WRAP.Geo.container.upper_layers;if(n&&n.length)for(var o=n.length-1;o>=0;o--)n[o].render()},hit:function(t){var e=this.map.context;if(this.container&&this.container.upper_layers)for(var i=0;i<this.container.upper_layers.length;i++){var n=this.container.upper_layers[i];if(n.visible())for(var o=n._dl.length-1;o>=0;o--){var r=n._dl[o],a=r.hit(t.x,t.y,e);if(a)return{layer:n,feature:r,x:a.x,y:a.y,pixel:a.pixel}}}return{layer:null,geo:null}},addAnimation:function(t){var e=this;this.animations.push(t);var i=new Date;return this.animation_timer||(this.animation_start=i,this.animation_timer=setInterval(function(){for(var t=new Date,i=(t-e.animation_start)/1e3,n=0;n<e.animations.length;n++)e.animations[n]._go(i)},15)),(i-this.animation_start)/1e3},removeAnimation:function(t){var e=this.animations.indexOf(t);e>=0&&this.animations.splice(e,1),!this.animations.length&&this.animation_timer&&(clearInterval(this.animation_timer),this.animation_timer=null,this.animation_start=null)},TimeController:function(){this._layers=[];var t=this;this.setDisplayTime=function(e){t._current_time=e;for(var i=0;i<t._layers.length;i++){var n=t._layers[i],o=n.get();o&&n.set(o)}},this.displayTime=function(){return t._current_time},this.addLayer=function(e){t._layers.indexOf(e)<0&&(e.setTimeController(this),t._layers.push(e)),this.setDisplayTime(t._current_time)},this.removeLayer=function(e){var i=t._layers.indexOf(e);indexOf>=0&&(t._layers[i].setTimeController(null),t._layers.splice(i,1))},this.validate=function(e,i){if(!i)return!1;if(t._current_time&&e._data){if(e._data.validator)return e._data.validator(t._current_time,e._data,i);var n,o=e._data.query("timelist").value();if(o&&i.basetime){for(var r=0;r<o.length;r++)if(o[r].basetime==i.basetime){n=o[r].validtime;break}}else n=e._data.query("validtime").value();if(n){n=n.concat(),n.sort(function(t,e){return t<e?-1:t>e?1:0});for(var a=WRAP.DH._time(t._current_time),s=86400,r=0;r<n.length;r++){var l=WRAP.DH._time(n[r]),h=r<n.length-1?WRAP.DH._time(n[r+1]):WRAP.DH._setTime(l,s);if(l<=a&&a<h)return i.validtime=WRAP.DH._timeString(l),!0;s=WRAP.DH._elapsed(l,h)}}}return i.validtime=null,!1}},parseColor:function(t){var e=document.createElement("canvas");e.width=1,e.height=1;var i=e.getContext("2d");return i.fillStyle=t,i.fillRect(0,0,1,1),i.getImageData(0,0,1,1).data},enableScroll:function(t){this.map.enableScroll&&this.map.enableScroll(t)},_tileCheck:function(t,e){for(var i=0;i<t.tiles.length;i++){var n,o=t.tiles[i],r=65792,a=o.cood[r],s=o.cood[r+1];n=new WRAP.Geo.Feature.Text({point:[s,a],text:o.id,fontSize:14,fillStyle:"rgb(255,0,0)",offsetX:0,offsetY:0,align:"center"}),e.push(n),n=new WRAP.Geo.Feature.Text({point:[s,a],text:"lat="+a,fontSize:14,fillStyle:"rgb(0,0,200)",offsetX:-50,offsetY:-40,align:"left"}),e.push(n),n=new WRAP.Geo.Feature.Text({point:[s,a],text:"lon="+s,fontSize:14,fillStyle:"rgb(0,0,200)",offsetX:-50,offsetY:-20,align:"left"}),e.push(n),n=new WRAP.Geo.Feature.Line({point:[s,a],line:[[-120,-120],[120,-120],[120,120],[-120,120],[-120,-120]],lineWidth:1,strokeStyle:"rgb(40,40,200)"}),e.push(n),n=new WRAP.Geo.Feature.Line({point:[s,a],line:[[-124,-124],[124,-124],[124,124],[-124,124],[-124,-124]],lineWidth:1,strokeStyle:"rgb(40,200,40)"}),e.push(n)}},container:{},timer:null,animation_timer:null,animation_start:null,animations:[],revision:1,tiles:[],imageCache:{},distance:function(t,e,i,n){var o=6378137,r=6356752.314245,a=Math.sqrt((o*o-r*r)/(o*o)),s=o*(1-a*a);t=t*Math.PI/180,e=e*Math.PI/180,i=i*Math.PI/180,n=n*Math.PI/180;var l=i-t,h=n-e,f=(n+e)/2,u=Math.sqrt(1-a*a*Math.sin(f)*Math.sin(f)),c=s/u/u/u,d=o/u,v=h*c*(h*c)+l*d*Math.cos(f)*(l*d*Math.cos(f));return Math.sqrt(v)},check:function(){}},WRAP.Geo.Interaction=function(){function t(t,e,i){if(t&&e&&e.value){var e=e&&e.value();if(e){var n;if(0==t.name().indexOf("LiveCamera")){var o;if((o=c(e.area_name))||(o=new v(e)),d(o),_!=o){var r=_;_&&_.tooltip&&_.hide(),_=o,r&&r.set(),_.visible||(_.tooltip=!0,o.show(e.lat,e.lon)),_.set()}}else t._tooltip_handler&&(n=t._tooltip_handler(e));if(n&&n.length)return s(n),void f(i.x,i.y)}l()}}function e(t){if(t&&(l(),0==t.name().indexOf("LiveCamera"))){_&&_.tooltip&&_.hide();var e=_;_=null,e&&e.set()}}function i(t,e){t&&(l(),0==t.name().indexOf("LiveCamera")&&_&&_.tooltip&&(e.query("image").load(function(){}),_.tooltip=!1,_.set()))}function n(){for(var t=0;t<S.length;t++){var e=S[t];if(e.pinned){var i=WRAP.Geo.getScreenPoint(e.window.point);i.x+=M,i.y+=M,e.window.style.left=i.x+"px",e.window.style.top=i.y+"px"}}}function o(t){if(0==t.name().indexOf("LiveCamera")){for(var e=0;e<S.length;e++){var i=S[e];t.visible()?i.window.style.display=i.visible?"block":"none":(i.window.style.display="none",i.setImage(0)),i.animating=!1}WRAP.Geo.Interaction.live_camera._data.handler&&(WRAP.Geo.Interaction.live_camera._data.handler.auto_update=t.visible())&&WRAP.Geo.Interaction.live_camera.load()}}function r(t){var e=document.createElement("style"),i=document.createTextNode(t);e.media="screen",e.type="text/css",e.styleSheet?e.styleSheet.cssText=i.nodeValue:e.appendChild(i),document.getElementsByTagName("head")[0].appendChild(e)}function a(){if(!g){g=document.createElement("div"),p.appendChild(g),g.style.display="block",g.style.top="-1000px",g.style.left="-1000px";var t=".tooltip {position: absolute;background: "+b+";color: "+W+";border: 1px solid "+G+";padding: 10px;    border-radius: 6px;    z-index: "+A+";    pointer-events: none;}.lt-arrow:after, .lt-arrow:before {right: 100%;top: "+R+"px;border: solid transparent;content: ' ';height: 0;width: 0;position: absolute;}.lt-arrow:after {    border-right-color: "+b+";    border-width: 8px;    margin-top: -8px;}.lt-arrow:before {    border-right-color: "+G+";    border-width: 9px;    margin-top: -9px;}.lb-arrow:after, .lb-arrow:before {right: 100%;bottom: "+R+"px;border: solid transparent;content: ' ';height: 0;width: 0;position: absolute;}.lb-arrow:after {    border-right-color: "+b+";    border-width: 8px;    margin-top: -8px;}.lb-arrow:before {    border-right-color: "+G+";    border-width: 9px;    margin-top: -9px;}.rt-arrow:after, .rt-arrow:before {left: 100%;top: "+R+"px;border: solid transparent;content: ' ';height: 0;width: 0;position: absolute;}.rt-arrow:after {    border-left-color: "+b+";    border-width: 8px;    margin-top: -8px;}.rt-arrow:before {    border-left-color: "+G+";    border-width: 9px;    margin-top: -9px;}.rb-arrow:after, .rb-arrow:before {left: 100%;bottom: "+R+"px;border: solid transparent;content: ' ';height: 0;width: 0;position: absolute;}.rb-arrow:after {    border-left-color: "+b+";    border-width: 8px;    margin-top: -8px;}.rb-arrow:before {    border-left-color: "+G+";    border-width: 9px;    margin-top: -9px;}";r(t)}}function s(t){g&&(g.innerHTML=t)}function l(){g&&(g.style.display="none",g.innerHTML="")}function h(){return"block"==g.style.display?g.innerHTML:null}function f(t,e){if(g&&g.innerHTML){var i=g.parentNode.clientWidth,n=g.parentNode.clientHeight;if(t<0||t>=i||e<0||e>=n)return void(g.style.display="none");g.style.display="block";var o=g.clientWidth,r=g.clientHeight;o>=i&&(o=0);var a,s,l=26,h=14,f=h+R;t+o+2*l>=i?(t-=o+l,a=" r"):(t+=l,a=" l"),e<f?e=h:e>=n-h-R?e=n-h-r:e+r-R>=n-f?(e-=r-R-2,e>h?s="b-arrow":e=h):(e-=R,e>h?s="t-arrow":e=h);var u="tooltip";a&&s&&(u+=a+s),g.style.top=""+e+"px",g.style.left=""+t+"px",g.setAttribute("class",u)}}function u(t){if(t){WRAP.Geo.Interaction.live_camera=t;var e=".smooth_tran {-webkit-transition-duration : 0.2s;-moz-transition-duration : 0.2s;-o-transition-duration : 0.2s;-ms-transition-duration : 0.2s;}.current_window {box-shadow : 0px 0px 50px #fff;border: 1px solid #fff;}.live_camera {position: absolute;background-color: "+E+";border: 1px solid "+X+";user-select: none;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;}.small_window {width: "+H+"px;height: "+(Y+C)+"px;}.middle_window {width: "+j+"px;height: "+(O+C+D)+"px;}.image_s {position: absolute;width: 100%;height: "+Y+"px;top: "+C+"px;background-color: #bbb;}.image_m {position: absolute;width: 100%;height: "+O+"px;top: "+C+"px;background-color: #bbb;}.camera_button {position: absolute;width:20px;height:20px;padding:0;border:solid 1px rgba(0,0,0,0);border-radius:4px;cursor:pointer;user-select: none;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;}.camera_button:hover {border:solid 1px rgba(150,150,150,0.8);}.camera_zoomin {top:3px; right:28px;background:url(img/bt_zoomIn.png) no-repeat left top;}.camera_zoomout {top:3px; right:28px;background:url(img/bt_zoomOut.png) no-repeat left top;}.camera_close {top:3px; right:4px;background:url(img/closebtn.png) no-repeat left top;}.camera_text {user-select: none;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;cursor:default;position: absolute;font-size:11px;color:black;width:100px;height:10px;}.camera_name {top:0px; left:4px;}.camera_time {top:11px; left:4px;}.camera_time_button {font-size:10px;color:black;position: absolute;bottom:1px;width:32px;height:18px;padding:0;vertical-align:middle;border:solid 1px rgba(120,120,120,1.0);border-radius:4px;background-color: "+E+";cursor:pointer;}.camera_time_button:hover {background: #fefeff;}.camera_time_button:disabled {color:#999;border:solid 1px rgba(170,170,170,0.8);pointer-events: none;cursor:default;}";r(e),t.inspect(function(){for(var t=0;t<S.length;t++){var e=S[t];e.visible&&!e.animating&&0==e.index&&e.setImage(e.index)}})}}function c(t){for(var e=0;e<S.length;e++)if(S[e].camera.area_name==t)return S[e];return null}function d(t){for(var e=T,i=0;i<S.length;){var n=S[i];if(n==t){for(var o=i+1;o<S.length;)n=S[o-1]=S[o],n.window.style["z-index"]=e++,o++;S[o-1]=t;break}n.window.style["z-index"]=e++,i++}i==S.length&&S.push(t),t.window.style["z-index"]=e}function v(t){var e=this;this.camera=t,this.visible=!1,this.small=!0,this.pinned=!0,this.tooltip=!0,this.animating=!1,this.smooth=!1;var i=this.window=document.createElement("div");i.controller=this,i.style.display="none",i.setAttribute("class","live_camera small_window");var n=this.canvas=document.createElement("div");n.width=k,n.height=L,n.setAttribute("class","image_s"),i.appendChild(this.name=document.createElement("div")),this.name.setAttribute("class","camera_text camera_name"),i.appendChild(this.time=document.createElement("div")),this.time.setAttribute("class","camera_text camera_time"),i.appendChild(this.zoom=document.createElement("button")),this.zoom.setAttribute("class","camera_button camera_zoomin"),i.appendChild(this.close=document.createElement("button")),this.close.setAttribute("class","camera_button camera_close");var o;i.appendChild(o=this.time_frst=document.createElement("button")),o.setAttribute("class","camera_time_button"),o.innerHTML="|＜",o.style.left="100px",o.style.display="none",i.appendChild(o=this.time_prev=document.createElement("button")),o.setAttribute("class","camera_time_button"),o.innerHTML="＜",o.style.left="140px",o.style.display="none",i.appendChild(o=this.time_play=document.createElement("button")),o.setAttribute("class","camera_time_button"),o.innerHTML="▶",o.style.left="180px",o.style.display="none",i.appendChild(o=this.time_next=document.createElement("button")),o.setAttribute("class","camera_time_button"),o.innerHTML="＞",o.style.left="220px",o.style.display="none",i.appendChild(o=this.time_last=document.createElement("button")),o.setAttribute("class","camera_time_button"),o.innerHTML="＞|",o.style.left="260px",o.style.display="none",i.appendChild(n),this.setImage=function(i){if(n=this.canvas,n.innerHTML="",this.index=i,this.name.innerHTML=t.l_name,this.time.innerHTML="--",t.image&&t.image.length){i<0&&(i=0),i>=t.image.length&&(i=t.image.length-1);var o=t.image[i];o.image&&(n.width=o.image.width||600,n.height=o.image.height||480,o.image.style.width="100%",o.image.style.height="100%",o.image.style["pointer-events"]="none",n.appendChild(o.image));var r=WRAP.DH._timeString(WRAP.DH._setTime(WRAP.DH._time(o.time),32400)),a=Number(r.substr(6,2)),s=Number(r.substr(9,2)),l=Number(r.substr(11,2));this.time.innerHTML=""+a+"日 "+s+"時 "+l+"分",e.time_frst.disabled=i==t.image.length-1,e.time_prev.disabled=i==t.image.length-1,e.time_play.disabled=t.image.length<=1,e.time_next.disabled=0==i,e.time_last.disabled=0==i}else e.time_frst.disabled=!0,e.time_prev.disabled=!0,e.time_play.disabled=!0,e.time_next.disabled=!0,e.time_last.disabled=!0;this.index=i},this.close.onclick=function(){e.hide()},this.zoom.onclick=function(){e.smooth=!0,e.small?(e.small=!1,e.set()):(e.small=!0,e.set())},this.animate=function(){if(!e.animating)return void(e.time_play.innerHTML="▶");e.time_play.innerHTML="■";var t=e.index-1;t<0&&(t=e.camera.image.length-1),e.setImage(t),setTimeout(function(){e.animate()},500)},this.time_frst.onclick=function(){e.setImage(e.camera.image.length-1)},this.time_prev.onclick=function(){e.setImage(e.index+1)},this.time_play.onclick=function(){(e.animating=!e.animating)&&e.animate()},this.time_next.onclick=function(){e.setImage(e.index-1)},this.time_last.onclick=function(){e.setImage(0)},i.onmousedown=function(t){m=this,y=i.style.left.replace(/px/,""),P=i.style.top.replace(/px/,""),x=t.clientX-y,w=t.clientY-P,d(m.controller)},i.onmouseup=function(){m=!1},i.onmousemove=function(t){if(m){var e=t.clientX-x,i=t.clientY-w;m.controller.pinned=!0,m.point=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(e-M,i-I)),m.style.left=e+"px",m.style.top=i+"px"}t._prevent=!0,t.preventDefault()},this.set=function(){var t=e.smooth?"smooth_tran ":"";t+="live_camera",t+=e.small?" small_window":" middle_window",this.tooltip||this!=_||(t+=" current_window"),e.window.setAttribute("class",t),t=e.smooth?"smooth_tran ":"",t+=e.small?" image_s":" image_m",e.canvas.setAttribute("class",t),e.zoom.setAttribute("class",e.small?"camera_button camera_zoomin":"camera_button camera_zoomout"),e.time_frst.style.display=e.small?"none":"block",e.time_prev.style.display=e.small?"none":"block",e.time_play.style.display=e.small?"none":"block",e.time_next.style.display=e.small?"none":"block",e.time_last.style.display=e.small?"none":"block",e.zoom.style.display=e.tooltip?"none":"block",e.close.style.display=e.tooltip?"none":"block",!e.small&&e.visible||(e.animating=!1),e.small&&e.setImage(0),e.smooth&&setTimeout(function(){e.smooth=!1,e.set()},250)},this.show=function(t,i){e.set(),e.visible=!0,this.window.point=new WRAP.Geo.Point(t,i);var n=WRAP.Geo.getScreenPoint(this.window.point);n.x+=M,n.y+=M,this.window.style.top=""+n.y+"px",this.window.style.left=""+n.x+"px",this.window.style.display="block"},this.hide=function(){this.window.style.display="none",e.visible=!1,e.small=!0,e.animating=!1,e.setImage(0)},p.appendChild(i),this.setImage(0)}var p,g,_,m,y,P,x,w,A=1e4,b="#2e3a54",W="#ffffff",G="#ffffff",R=20,S=[],M=10,I=10,T=2e4,k=640,L=480,z=.3,F=.6,C=26,D=20,E="#f2f2f2",X="rgba(150,150,150,0.6)",H=Math.floor(k*z),Y=Math.floor(L*z),j=Math.floor(k*F),O=Math.floor(L*F);return{init:function(r,s){p=s,a(),u(r),WRAP.Geo.addEventHandler("mouseover",t),WRAP.Geo.addEventHandler("mouseout",e),WRAP.Geo.addEventHandler("touch",i),WRAP.Geo.addEventHandler("boundsChange",n),WRAP.Geo.addEventHandler("visibilityChange",o)},setTooltip:function(t){s(t)},showTooltip:function(t,e){f(t,e)},clearTooltip:function(t,e){l(t,e)},getTooltip:function(){return h()},alignLiveCamera:function(){for(var t=0;t<S.length;t++){var e=S[t];e.pinned=!0}for(var i=p.clientLeft,n=p.clientTop,o=i+p.clientWidth,r=n+p.clientHeight,a=10,s=H+a,l=Y+C+a,h=a;h+s<o;h+=s)for(var f=a;f+l<r;f+=l){for(var u=99999999,c=null,t=0;t<S.length;t++){var e=S[t];if(e.pinned&&e.visible){var d=e.window.style.left.replace(/px/,""),v=e.window.style.top.replace(/px/,""),g=d-h,_=v-f,m=g*g+_*_;u>m&&(u=m,c=e)}}c&&(c.smooth=!0,c.small=!0,c.pinned=!1,c.window.point=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(h,f)),c.window.style.left=h+"px",c.window.style.top=f+"px",c.set())}},mouseover:[],mouseout:[],touch:[],boundsChange:[],visibilityChange:[]}}(),WRAP.Geo.setOpenLayers=function(t){return WRAP.Geo.map=new WRAP.Geo.Bridge.OpenLayers(t),WRAP.Geo.map},WRAP.Geo.Bridge.OpenLayers=function(t){var e=this;this.tile_prefix="o_",this.map=t,this.view=t.getView(),this.context=new WRAP.Geo.Context(this),this.canvas,this.tile_revision={},this.tiles=[],this.markers=[],this.lines=[],this.touch=null,this.zoom=this.view.getZoom(),this.center=this.view.getCenter(),this.bounds=0,this.tileID=function(t,e,i){return"G/"+t+"/"+e+"/"+i},this.updateBounds=function(t){function i(t,e,i,o){var r=t.findTile(e,i,o);if(r)return void(r.locked=!1);var a=new Float32Array(131072),s=Math.pow(2,parseInt(e)),l=parseFloat(o)/s,h=(parseFloat(i)+1)/s;l=l*(n[2]-n[0])+n[0],h=h*(n[3]-n[1])+n[1];for(var f=(n[2]-n[0])/s/256,u=(n[3]-n[1])/s/256,c={x:[256],y:[256]},d=0;d<256;d++){var v=l+f*parseFloat(d),p=h-u*parseFloat(d),g=ol.proj.transform([v,h],"EPSG:3857","EPSG:4326");c.x[d]=g[0],c.x[d]<-180?c.x[d]+=360:c.x[d]>=180&&(c.x[d]-=360);var _=ol.proj.transform([l,p],"EPSG:3857","EPSG:4326");c.y[d]=_[1]}for(var d=0,m=0;m<256;m++)for(var y=0;y<256;y++)a[d++]=c.y[m],a[d++]=c.x[y];t.addTile("M",e,i,o,a,new WRAP.Geo.Bounds(60*a[0],60*a[130560],60*a[131071],60*a[1]))}var n=ol.proj.get("EPSG:3857").getExtent();e.zoom=e.view.getZoom(),e.center=e.view.getCenter();var o=e.map.getSize(),r=e.map.getCoordinateFromPixel([0,0]),a=e.map.getCoordinateFromPixel(o),s=ol.proj.transform(r,"EPSG:3857","EPSG:4326"),l=ol.proj.transform(a,"EPSG:3857","EPSG:4326");e.bounds=new WRAP.Geo.Bounds(60*s[1],60*l[1],60*l[0],60*s[0]);var h=Math.pow(2,e.zoom);r[0]-=n[0],a[0]-=n[0],r[1]-=n[1],a[1]-=n[1];var f=n[2]-n[0],u=n[3]-n[1];r[0]=r[0]/f*256,a[0]=a[0]/f*256,r[1]=r[1]/u*256,a[1]=a[1]/u*256;var c=Math.floor(r[0]*h/256),d=Math.floor(a[0]*h/256),v=Math.floor(a[1]*h/256),p=Math.floor(r[1]*h/256);for(c%=h,d%=h;c<0;)c+=h;for(;d<0;)d+=h;if(!t){this.context.lockTile();for(var g=Math.pow(2,e.zoom),_=v;_<=p;_++)if(c<=d)for(var m=c;m<=d;m++)i(this.context,e.zoom,_,m);else{for(var m=c;m<g;m++)i(this.context,e.zoom,_,m);for(var m=0;m<=d;m++)i(this.context,e.zoom,_,m)}this.context.clearLockedTile(),e.context.setTileBand(e.zoom,c,d,v,p)}WRAP.Geo.updateBounds(e.bounds,t)},window.setTimeout(function(){e.updateBounds()},1e3),this.setTile=function(t,i){if(e.canvas){var n=e.tileID(t.z,t.y,t.x);e.tile_revision[n]=i;var o=ol.proj.get("EPSG:3857").getExtent(),r=Math.pow(2,parseInt(t.z)),a=256*r,s=parseFloat(t.x)/r,l=parseFloat(t.y+1)/r;s=s*(o[2]-o[0])+o[0],l=l*(o[3]-o[1])+o[1];var h=e.map.getPixelFromCoordinate([e.canvas.extent[0],e.canvas.extent[3]]),f=e.map.getPixelFromCoordinate([s,l]),u=Math.floor(f[0])-Math.floor(h[0]);u<-256&&(u+=a),u>=a&&(u-=a);var c=Math.floor(f[1])-Math.floor(h[1]),d=window.devicePixelRatio;e.canvas.ctx.clearRect(u*d,c*d,256*d,256*d),e.canvas.ctx.drawImage(t.canvas,t.offset_x,t.offset_y,256,256,u*d,c*d,256*d,256*d);for(var v=1;u-a*v>=0;)e.canvas.ctx.clearRect((u-a*v)*d,c*d,256*d,256*d),e.canvas.ctx.drawImage(t.canvas,t.offset_x,t.offset_y,256,256,(u-a*v)*d,c*d,256*d,256*d),v++;for(v=1;u+a*v<e.canvas.width;)e.canvas.ctx.clearRect((u+a*v)*d,c*d,256*d,256*d),e.canvas.ctx.drawImage(t.canvas,t.offset_x,t.offset_y,256,256,(u+a*v)*d,c*d,256*d,256*d),v++}},this.map.on("move",function(){e.updateBounds(!0)}),this.map.on("moveend",function(){e.updateBounds()}),this.map.on("pointermove",function(t){var i=e.map.getPixelFromCoordinate(t.coordinate),n=ol.proj.transform(t.coordinate,"EPSG:3857","EPSG:4326");e.mouse_point=new WRAP.Geo.Point(60*n[1],60*n[0]),e.mouse_screenpoint=new WRAP.Geo.ScreenPoint(i[0],i[1])});var i=function(t,i,n,o,r){i=null,n=null,r=null,e.tile_revision={},e.canvas=document.createElement("canvas"),e.canvas.ctx=e.canvas.getContext("2d"),e.canvas.extent=t;var a=o[0],s=o[1];return e.canvas.setAttribute("width",a),e.canvas.setAttribute("height",s),e.canvas},n=new ol.layer.Image({source:new ol.source.ImageCanvas({canvasFunction:i,projection:"EPSG:3857"})});this.map.addLayer(n),this.getSize=function(){var t=e.map.getSize();return{width:t[0],height:t[1]}},this.getScreenPoint=function(t){if(!t)return new WRAP.Geo.ScreenPoint(0,0);var i=ol.proj.transform([t.lonDegree(),t.latDegree()],"EPSG:4326","EPSG:3857");if(!i)return new WRAP.Geo.ScreenPoint(0,0);var n=e.map.getPixelFromCoordinate(i);return n?new WRAP.Geo.ScreenPoint(n[0],n[1]):new WRAP.Geo.ScreenPoint(0,0)},this.getScreenLine=function(t,i,n,o,r){var a=[],s=e.bounds.north/60,l=e.bounds.south/60,h=e.bounds.east/60,f=e.bounds.west/60;if(h<f&&(h+=360),n>=s||i<=l)return a;if(f<r&&o<h){for(var u=[],c=0;c<t.length;c++)u.push(this.getScreenPoint(new WRAP.Geo.Point(60*t[c][0],60*t[c][1])));a.push(u)}if(f<r-360&&o<h-360){for(var u=[],c=0;c<t.length;c++)u.push(this.getScreenPoint(new WRAP.Geo.Point(60*(60*t[c][0],t[c][1]-360))));a.push(u)}else if(f-360<r&&o-360<h){for(var u=[],c=0;c<t.length;c++)u.push(this.getScreenPoint(new WRAP.Geo.Point(60*(60*t[c][0],t[c][1]+360))));a.push(u)}return a},this.getPoint=function(t){if(!t)return new WRAP.Geo.Point(0,0);var i=e.map.getCoordinateFromPixel([t.x,t.y]);if(!i)return new WRAP.Geo.Point(0,0);var n=ol.proj.transform(i,"EPSG:3857","EPSG:4326");return new WRAP.Geo.Point(60*n[1],60*n[0])},this.getCenterPoint=function(){var t=this.view.getCenter(),e=ol.proj.transform(t,"EPSG:3857","EPSG:4326");return new WRAP.Geo.Point(60*e[1],60*e[0])},this.setCenterPoint=function(t){this.view.setCenter(ol.proj.transform([t.lonDegree(),t.latDegree()],"EPSG:4326","EPSG:3857"))},this.getZoom=function(){return this.zoom},this.setZoom=function(t){this.view.setZoom(this.zoom=t)},this.getPerspective=function(e,i){void 0===i&&(i=0);for(var n=e[0].lat,o=e[0].lon,r=n,a=n,s=o,h=o,f=1;f<e.length;f++){var n=e[f].lat,u=e[f].lon-o;o=u>=10800?e[f].lon-21600:l<-10800?e[f].lon+21600:e[f].lon,s>o&&(s=o),h<o&&(h=o),r>n&&(r=n),a<n&&(a=n)}o<-10800?o+=21600:o>=10800&&(o-=21600);var c=ol.proj.transform([s/60,r/60],"EPSG:4326","EPSG:3857"),d=ol.proj.transform([h/60,a/60],"EPSG:4326","EPSG:3857"),v=(c[1]+d[1])/2,p=(d[0]+c[0])/2,g=ol.proj.transform([p,v],"EPSG:3857","EPSG:4326");n=g[1],o=g[0],c=[c[0]/262144,c[1]/262144],d=[d[0]/262144,d[1]/262144];var _=Math.abs(c[1]-d[1]),m=Math.abs(d[0]-c[0]),y=t.getSize(),P=y[0]-2*i,x=y[1]-2*i,w=Math.log(2),A=_>0?Math.log(x/_)/w:this.zoom,b=m>0?Math.log(P/m)/w:this.zoom,W=Math.floor(A<b?A:b);return W>19&&(W=19),{center:new WRAP.Geo.Point(60*n,60*o),zoom:W}},this.getCurrentPoint=function(){return{point:this.mouse_point,screenpoint:this.mouse_screenpoint}},this.update=function(t){t&&this.updateBounds(),this.map.render()},this.enableScroll=function(t){this.map.getInteractions().forEach(function(e){e instanceof ol.interaction.DragPan&&e.setActive(t)},this)}},WRAP.Geo.setGoogleMaps=function(t){function e(t){this.tileSize=t}WRAP.Geo.map=new WRAP.Geo.Bridge.GoogleMaps(t);var i=WRAP.Geo.map.map;return e.prototype.getTile=function(t,e,i){var n=Math.pow(2,e),o=t.x,r=n-t.y-1,a=WRAP.Geo.map.tileID(e,r,o),s=document.getElementById(a);return s?s:(s=i.createElement("canvas"),s.id=a,s.width=256,s.height=256,s.ctx=s.getContext("2d"),setTimeout(function(){WRAP.Geo.render()},10),s)},WRAP.Geo.map.overland_layer=new e(new google.maps.Size(256,256)),WRAP.Geo.map.overland_layer_index=i.overlayMapTypes.length,i.overlayMapTypes.push(null),WRAP.Geo.map.setOverLandLayer(!0),WRAP.Geo.map},WRAP.Geo.Bridge.GoogleMaps=function(t){var e=this;this.map=t,this.markers=[],this.lines=[],this.touch=null,this.context=new WRAP.Geo.Context(this),this.zoom=t.getZoom(),this.center=t.getCenter(),this.projection=t.getProjection(),this.bounds=t.getBounds(),this.tileID=function(t,e,i){return"G/"+t+"/"+e+"/"+i},this.updateBounds=function(i){this.updateTimer&&clearTimeout(this.updateTimer),this.updateTimer=setTimeout(function(){function n(t,i,n,o){var r=t.findTile(i,n,o);if(r)return void(r.locked=!1);for(var a=new Float32Array(131072),s=Math.pow(2,parseInt(i)),l=256*parseFloat(o)/s,h=256*(s-parseFloat(n)-1)/s,f=1/s,u={x:[256],y:[256]},c=0;c<256;c++){var d=l+f*parseFloat(c),v=h+f*parseFloat(c),p=e.projection.fromPointToLatLng(new google.maps.Point(d,h));u.x[c]=p.lng();var g=e.projection.fromPointToLatLng(new google.maps.Point(l,v));u.y[c]=g.lat()}for(var c=0,_=0;_<256;_++)for(var m=0;m<256;m++)a[c++]=u.y[_],a[c++]=u.x[m];t.addTile("M",i,n,o,a,new WRAP.Geo.Bounds(60*a[0],60*a[130560],60*a[131071],60*a[1]))}if(e.projection=t.getProjection(),e.center=t.getCenter(),e.zoom=t.getZoom(),e.bounds=t.getBounds(),e.bounds&&e.projection){var o=e.bounds,r=o.getNorthEast(),a=o.getSouthWest(),s=e.projection.fromLatLngToPoint(r),l=e.projection.fromLatLngToPoint(a),h=Math.pow(2,e.zoom),f=Math.floor(l.x*h/256),u=Math.floor((256==s.x?255:s.x)*h/256),c=h-Math.floor(l.y*h/256)-1,d=h-Math.floor(s.y*h/256)-1;if(!i){e.context.lockTile();for(var v=Math.pow(2,e.zoom),p=c;p<=d;p++)if(f<=u)for(var g=f;g<=u;g++)n(e.context,e.zoom,p,g);else{for(var g=f;g<v;g++)n(e.context,e.zoom,p,g);for(var g=0;g<=u;g++)n(e.context,e.zoom,p,g)}e.context.clearLockedTile(),e.context.setTileBand(e.zoom,f,u,c,d)}WRAP.Geo.updateBounds(new WRAP.Geo.Bounds(60*r.lat(),60*a.lat(),60*r.lng(),60*a.lng()),i)}},10)},window.setTimeout(function(){e.updateBounds()},1e3),google.maps.event.addListener(t,"zoom_changed",function(){e.updateBounds()}),google.maps.event.addListener(t,"bounds_changed",function(){e.touch&&(e.touch.feature&&e.touch.feature.mouseout&&e.touch.feature.mouseout(),e.touch=null),e.updateBounds()}),google.maps.event.addListener(t,"idle",function(){e.touch&&(e.touch.feature&&e.touch.feature.mouseout&&e.touch.feature.mouseout(),e.touch=null),e.updateBounds()}),google.maps.event.addListener(t,"mousemove",function(t){e.mouse_point=new WRAP.Geo.Point(60*t.latLng.lat(),60*t.latLng.lng()),e.mouse_screenpoint=new WRAP.Geo.ScreenPoint(t.pixel.x,t.pixel.y)}),google.maps.event.addListener(t,"click",function(t){e.mouse_point=new WRAP.Geo.Point(60*t.latLng.lat(),60*t.latLng.lng()),e.mouse_screenpoint=new WRAP.Geo.ScreenPoint(t.pixel.x,t.pixel.y)}),this.setOverLandLayer=function(t){this.map.overlayMapTypes.setAt(WRAP.Geo.map.overland_layer_index,t?WRAP.Geo.map.overland_layer:null)},this.setTile=function(t,i){function n(n,o,r){var a=e.tileID(n,o,r),s=document.getElementById(a);return!!s&&(s.revision!=i&&(s.revision=i,s.ctx.clearRect(0,0,256,256),s.ctx.drawImage(t.canvas,t.offset_x,t.offset_y,256,256,0,0,256,256)),!0)}var o=Math.pow(2,t.z);n(t.z,t.y,t.x);for(var r=parseInt(t.x),a=1;a<24;)n(t.z,t.y,r+a*o)?(r+=a*o,a=1):a++;for(r=parseInt(t.x),a=1;a<24;)n(t.z,t.y,r-a*o)?(r-=a*o,a=1):a++},this.getSize=function(){return{width:t.getDiv().offsetWidth,height:t.getDiv().offsetHeight}},this.getScreenPoint=function(e){if(this.projection){var i=this.projection.fromLatLngToPoint(new google.maps.LatLng(e.latDegree(),e.lonDegree())),n=this.projection.fromLatLngToPoint(this.center),o=i.x-n.x,r=i.y-n.y;o<-128&&(o+=256),o>=128&&(o-=256);var a=Math.pow(2,this.zoom),s=.5*t.getDiv().offsetWidth+o*a,l=.5*t.getDiv().offsetHeight+r*a;return new WRAP.Geo.ScreenPoint(parseInt(s),parseInt(l))}return new WRAP.Geo.ScreenPoint(0,0)},this.getScreenLine=function(e,i,n){function o(t){R.indexOf(t)<0&&R.push(t)}var r=[];if(!this.projection)return r;var a=Math.pow(2,this.zoom),s=256*a,l=.5*t.getDiv().offsetWidth,h=.5*t.getDiv().offsetHeight,f=this.context.offset_x,u=f+this.context.canvas.width,c=this.context.bounds.n,d=this.context.bounds.s;if(n>=c||i<=d)return r;for(var v=this.projection.fromLatLngToPoint(this.center);v.x>256;)v.x-=256;for(;v.x<0;)v.x+=256;for(var p=(v.x-128)*a,g=(v.y-128)*a,_=0;p<f;)p+=s,_+=s;for(;p>=u;)p-=s,_-=s;for(var m=[],y=256*s,P=-y,x=0;x<e.length;x++){var w=e[x][0],A=e[x][1],b=this.projection.fromLatLngToPoint(new google.maps.LatLng(w,A));b.y-=128,b.x=128*A/180;var W=b.x*a,G=b.y*a;y>W&&(y=W),P<W&&(P=W),m.push([W+l-p,G+h-g])}var R=[];f<P&&y<u&&(o(0),o(0+_)),f<P-s&&y-s<u&&(o(-s),o(-s+_)),f<P+s&&y+s<u&&(o(s),o(s+_));for(var S=0;S<R.length;S++){for(var n=R[S],M=[],x=0;x<m.length;x++){var I=m[x],W=I[0]+n,G=I[1];M.push(new WRAP.Geo.ScreenPoint(W,G))}r.push(M)}return r},this.getPoint=function(e){if(this.projection){var i=e.x-.5*t.getDiv().offsetWidth,n=e.y-.5*t.getDiv().offsetHeight,o=this.projection.fromLatLngToPoint(this.center),r=Math.pow(2,this.zoom),a=o.x+i/r,s=o.y+n/r,l=this.projection.fromPointToLatLng(new google.maps.Point(a,s));return new WRAP.Geo.Point(60*l.lat(),60*l.lng())}return new WRAP.Geo.Point(0,0)},this.getCenterPoint=function(){return new WRAP.Geo.Point(60*e.center.lat(),60*e.center.lng())},this.setCenterPoint=function(e){t.setCenter(this.center=new google.maps.LatLng(e.latDegree(),e.lonDegree()))},this.getZoom=function(){return this.zoom},this.setZoom=function(e){t.setZoom(this.zoom=e)},this.getPerspective=function(e,i){if(!this.projection||!e||!e.length)return{center:this.getCenterPoint(),zoom:this.zoom};void 0===i&&(i=0);for(var n=e[0].lat,o=e[0].lon,r=n,a=n,s=o,l=o,h=1;h<e.length;h++){var n=e[h].lat,f=e[h].lon-o;o=f>=10800?e[h].lon-21600:f<-10800?e[h].lon+21600:e[h].lon,s>o&&(s=o),l<o&&(l=o),r>n&&(r=n),a<n&&(a=n)}o<-10800?o+=21600:o>=10800&&(o-=21600);var u=this.projection.fromLatLngToPoint(new google.maps.LatLng(r/60,s/60)),c=this.projection.fromLatLngToPoint(new google.maps.LatLng(a/60,l/60)),d=(u.y+c.y)/2,v=(c.x+u.x)/2,p=this.projection.fromPointToLatLng(new google.maps.Point(v,d));n=p.lat(),o=p.lng();var g=u.y-c.y,_=Math.abs(c.x-u.x),m=t.getDiv().offsetWidth-2*i,y=t.getDiv().offsetHeight-2*i,P=Math.log(2),x=g>0?Math.log(y/g)/P:this.zoom,w=_>0?Math.log(m/_)/P:this.zoom,A=Math.floor(x<w?x:w);return A>19&&(A=19),{center:new WRAP.Geo.Point(60*n,60*o),zoom:A}},this.getDistance=function(t,e){var i=new google.maps.LatLng(t.latDegree(),t.lonDegree()),n=new google.maps.LatLng(e.latDegree(),e.lonDegree());return google.maps.geometry.spherical.computeDistanceBetween(i,n)},this.getCurrentPoint=function(){return{point:this.mouse_point,screenpoint:this.mouse_screenpoint}},this.update=function(){},this.enableScroll=function(t){this.map.setOptions({draggable:t})}},WRAP.Geo.Renderer.Mesh=function(){var t=this;this.palette=null,this.palette_value_min=0,this.palette_value_max=0,this.palette_gradient=!0,this.palette_scale=10,this.palette_step=1,this.setPalette=function(e){if(!t.palette&&e.palette){t.palette=[],t.palette_gradient=e.palette_gradient,t.palette_step=e.palette_step||1,t.palette_scale=1/t.palette_step;for(var i=e.palette,n=[],o=0;o<i.length;o++){var r=[],a=i[o].value;0==o?(this.palette_value_min=a,this.palette_value_max=a):(this.palette_value_min>a&&(this.palette_value_min=a),this.palette_value_max<a&&(this.palette_value_max=a)),r.push(a);var s=WRAP.Geo.parseColor(i[o].color);r.push(s[0]),r.push(s[1]),r.push(s[2]),r.push(s[3]),n.push(r)}for(var l=0,h=t.palette_value_min;h<=t.palette_value_max;h+=t.palette_step){for(;l<n.length-1&&h>=n[l+1][0];)l++;if(l==n.length-1)t.palette.push([parseInt(n[l][1]),parseInt(n[l][2]),parseInt(n[l][3]),parseInt(n[l][4])]);else{var f=n[l][1],u=n[l][2],c=n[l][3],d=n[l][4];if(t.palette_gradient){var v=(h-n[l][0])/(n[l+1][0]-n[l][0]),p=n[l+1][1],g=n[l+1][2],_=n[l+1][3],m=n[l+1][4];t.palette.push([parseInt(f+(p-f)*v),parseInt(u+(g-u)*v),parseInt(c+(_-c)*v),parseInt(d+(m-d)*v)])}else t.palette.push([parseInt(f),parseInt(u),parseInt(c),parseInt(d)])}}}},this.getColor=function(e){var i=Math.floor((e-t.palette_value_min)*t.palette_scale);return i<0||i>=t.palette.length?[0,0,0,0]:t.palette[i]},this.draw=function(t,e,i,n,o,r,a,s){var l=!0;if(this.context_revision!=a.context&&(l=!1),this.content_revision!=a.content&&(l=!1),this.conf_revision!=a.conf&&(l=!1),
this.style_revision!=a.style&&(l=!1,this.palette=null),!l){var h=i.Attributes.data_offset||0,f=i.Attributes.style.default;if(!o&&i.Attributes.style_selector){if(!i.Attributes.style_selector.key||!i.Attributes.style_selector.styles)return void console.log("style_selector formar error.");for(var u=i.Attributes.style_selector.key,c=0;c<i.Attributes.style_selector.styles.length;c++){var d=i.Attributes.style_selector.styles[c].values;if(d.indexOf(e[u])>=0){o=i.Attributes.style_selector.styles[c].style;break}}}if(o&&i.Attributes.style[o]&&(f=i.Attributes.style[o]),f){this.setPalette(f);for(var v="block"!=f.fill_type?"interpolate":"nearest",p=f.fill_type,g=f.contour,_=[],m=[],c=0;c<n.tiles.length;c++){for(var y=n.tiles[c],P=0;P<s.length;P++){var x=s[P];if(x.data&&x.data.tile&&x.data.tile.id==y.id&&x.data.revision==a.content){m.push(x),y=null;break}}y&&_.push(y)}for(var w=[],c=0;c<_.length;c++){var y=_[c];if(!(w[c]=r._handler().getTile(e,y.id,v)))return void r._handler().loadTile(e,y.id,v,y.z,y.y,y.x,y.cood,y.bounds,function(){WRAP.Geo.redraw(t)})}var A=[];s.length=0;for(var c=0;c<m.length;c++)s.push(m[c]),A.push(m[c]);for(var c=0;c<w.length;c++){var b=w[c];if(b&&!b.empty){var y=_[c];if(y.ctx){var W=y.ctx.createImageData(256,256),f=this.getData(e,b.data);if(f){var G=W.data;if(p)for(var R=0;R<65536;R++){var S=f[R];if(!isNaN(S)){S+=h;var M=this.getColor(S),I=4*R;G[I]=M[0],G[I+1]=M[1],G[I+2]=M[2],G[I+3]=M[3]}}var T=[];if(g){for(var k=0,L=0,I=0;I<65536;I++){var S=f[I];isNaN(S)||(0==I?k=L=S:(k>S&&(k=S),L<S&&(L=S)))}for(var P=0;P<g.length;P++)for(var z=g[P],M=WRAP.Geo.parseColor(z.strokeStyle),S=z.base-h,F=0;F<z.num;F++){if(k<=S&&S<=L){for(var C=-1,D=0,E=0,X=0,H=0;H<256;H++)for(var Y=0==H?0:-256,j=255==H?0:256,O=0;O<256;O++){var N=0==O?0:-1,B=255==O?0:1,Z=f[X];try{if(Z>=S){var q=f[X+Y],V=f[X+N],J=f[X+B],U=f[X+j];if(q<S||V<S||J<S||U<S){G[4*X]=M[0],G[4*X+1]=M[1],G[4*X+2]=M[2],G[4*X+3]=M[3],z.lineWidth>1&&(G[4*X+4]=M[0],G[4*X+5]=M[1],G[4*X+6]=M[2],G[4*X+7]=M[3],G[4*X+1024]=M[0],G[4*X+1024+1]=M[1],G[4*X+1024+2]=M[2],G[4*X+1024+3]=M[3]);var Q=Math.abs(O-128)+Math.abs(H-128);(C<0||Q<C)&&(C=Q,D=O,E=H)}}}catch(t){}X++}20<D&&D<=236&&20<E&&E<=236&&T.push({x:D,y:E,value:S+h,color:z.textColor})}S+=z.interval}}var K=new WRAP.Geo.Feature.Tile({tile:y,imageData:W});s.push(K),A.push(K);for(var $=[],Q=0;Q<T.length;Q++){var tt=65792,et=y.cood[tt],it=y.cood[tt+1],nt=new WRAP.Geo.Feature.Text({point:[it,et],text:T[Q].value,fontSize:12,fillStyle:T[Q].color,offsetX:T[Q].x-128,offsetY:T[Q].y-128,align:"center"});$.push(nt)}K.data={tile:y,label:$,length:T.length,revision:a.content}}}else console.log("tile.ctx not found : "+y.id)}}for(var R=0;R<A.length;R++){var x=A[R];if(x.data&&x.data.label)for(var T=x.data.label,Q=0;Q<T.length;Q++)s.push(T[Q])}this.context_revision=a.context,this.content_revision=a.content,this.conf_revision=n.conf,this.style_revision=a.style,WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.Mesh.prototype.getData=function(t,e){if(!t.element||!Array.isArray(t.element))return e},WRAP.Geo.Renderer.Image=function(){this.draw=function(t,e,i,n,o,r,a,s){if(e){var l=!0;if(this.context_revision!=a.context&&(l=!1),this.content_revision!=a.content&&(l=!1),this.conf_revision!=a.conf&&(l=!1,s.length=0,this.palette=null),this.style_revision!=a.style&&(l=!1,s.length=0,this.palette=null),!l){var h=i.Attributes.style.default;if(o&&i.Attributes.style[o]&&(h=i.Attributes.style[o]),h){for(var f=null,u=[],c=[],d=0;d<n.tiles.length;d++){for(var v=n.tiles[d],p=0;p<s.length;p++){var g=s[p];if(g.data&&g.data.tile&&g.data.tile.id==v.id&&g.data.revision==a.content){c.push(g),v=null;break}}v&&u.push(v)}for(var _=[],d=0;d<u.length;d++){var v=u[d];if(!(_[d]=r._handler().getTile(e,v.id,f)))return void r._handler().loadTile(e,v.id,f,v.z,v.y,v.x,v.cood,v.bounds,function(){WRAP.Geo.redraw(t)})}s.length=0;for(var d=0;d<c.length;d++)s.push(c[d]);for(var d=0;d<_.length;d++){var m=_[d];if(m&&!m.empty&&m.data){var v=u[d],y=v.ctx.createImageData(256,256),P=m.data,x=y.data,w=0;if("rgb_palette"==h.type&&h.palette)for(var A=h.palette,b=0;b<65536;b++){for(var W=P[w],G=P[w+1],R=P[w+2],S=P[w+3],p=0;p<A.length;p++){var M=A[p][0];if(W==M[0]&&G==M[1]&&R==M[2]){W=A[p][1][0],G=A[p][1][1],R=A[p][1][2],S=A[p][1][3];break}}x[w++]=W,x[w++]=G,x[w++]=R,x[w++]=S}else if("grayscale_palette"==h.type&&h.palette)for(var A=h.palette,p=0;p<65536;p++){var I=P[w],b=A[I];x[w++]=b[0],x[w++]=b[1],x[w++]=b[2],x[w++]=b[3]}else if("filter"==h.type)for(var T=parseInt(h.rgb_offset)||0,k=parseFloat(h.opacity)||1,p=0;p<65536;p++){var W=P[w]+T,G=P[w+1]+T,R=P[w+2]+T,S=P[w+3]*k;W<0?W=0:W>255&&(W=255),G<0?G=0:G>255&&(G=255),R<0?R=0:R>255&&(R=255),x[w++]=W,x[w++]=G,x[w++]=R,x[w++]=S}else for(var L=P.length,p=0;p<L;p++)x[p]=P[p];var z=new WRAP.Geo.Feature.Tile({tile:v,imageData:y});z.data={tile:v,revision:a.content},s.push(z)}}this.context_revision=a.context,this.content_revision=a.content,this.conf_revision=n.conf,this.style_revision=a.style,WRAP.Geo.invalidate()}}}},this.merge=function(t,e,i,n){var o=[256,256,256,256],r=i.Attributes.style.default;n&&i.Attributes.style[n]&&(r=i.Attributes.style[n]),r&&r.alternative_color&&4==r.alternative_color.length&&(o=r.alternative_color);for(var a=[],s=0;s<e.length;s++){var r=e[s].style();if(r.tile){for(var l=null,h=0;h<t.length;h++){var f=t[h].style();if(f.tile&&f.tile.id==r.tile.id){l=f;break}}if(l){if(r.imageData&&l.imageData)for(var u=r.imageData.data,c=l.imageData.data,d=0;d<65536;d++){var v=4*d;u[v]==o[0]&&u[v+1]==o[1]&&u[v+2]==o[2]&&u[v+3]==o[3]?0==c[v+3]&&(c[v]=o[0],c[v+1]=o[1],c[v+2]=o[2],c[v+3]=o[3]):u[v+3]&&(c[v]=u[v],c[v+1]=u[v+1],c[v+2]=u[v+2],c[v+3]=u[v+3])}}else{for(var p=r.tile.ctx.createImageData(256,256),u=r.imageData.data,c=p.data,d=0;d<65536;d++){var v=4*d;u[v]==o[0]&&u[v+1]==o[1]&&u[v+2]==o[2]&&u[v+3]==o[3]?(c[v]=o[0],c[v+1]=o[1],c[v+2]=o[2],c[v+3]=o[3]):(c[v]=u[v],c[v+1]=u[v+1],c[v+2]=u[v+2],c[v+3]=u[v+3])}a.push(new WRAP.Geo.Feature.Tile({tile:r.tile,imageData:p}))}}}for(var s=0;s<a.length;s++)t.push(a[s])},this.getValue=function(t,e,i,n){for(var o=0;o<e.tiles.length;o++){var r=e.tiles[o],a=r.bounds.north,s=r.bounds.south;if(!(n.lat>a||n.lat<s)){var l=r.bounds.east;l<-10800?l+=21600:l>=10800&&(l-=21600);var h=r.bounds.west;if(h<-10800?h+=21600:h>=10800&&(h-=21600),h<l){if(n.lon>l||n.lon<h)continue}else if(n.lon>l&&n.lon<h)continue;var f=i._handler().getTile(t,r.id);if(f){for(var u=n.latDegree(),c=n.lonDegree(),o=0,d=0;d<256&&r.cood[o]>u;)d++,o+=512;for(var v=0;v<256;){var p=r.cood[o+1];if(p<0?p+=360:p>=180&&(p-=360),c<=p)break;v++,o+=2}var g=4*(256*d+v);return{data:[f.data[g],f.data[g+1],f.data[g+2],f.data[g+3]]}}break}}return null}},WRAP.Geo.Renderer.GridValue=function(){this.style_revision,this.context_revision,this.draw=function(t,e,i,n,o,r,a,s){if(!this.revision||this.revision.context!=a.context){this.style_revision!=a.style&&(this.style_revision=a.style);var l=i.Attributes.data_offset||0,h=i.Attributes.style.default;if(o&&i.Attributes.style[o]&&(h=i.Attributes.style[o]),h){for(var f="value",u=[],c=0;c<n.tiles.length;c++){var d=n.tiles[c];if(!(u[c]=r._handler().getTile(e,d.id,f)))return void r._handler().loadTile(e,d.id,f,d.z,d.y,d.x,d.cood,d.bounds,function(){WRAP.Geo.redraw(t)})}var l=i.Attributes.data_offset||0,v=void 0===h.fractional_digits?1:parseInt(h.fractional_digits),p=h.offset_x||0,g=h.offset_y||0;s.length=0;for(var c=0;c<u.length;c++)for(var r=u[c].data,_=0;_<r.length;_++){var m=r[_];if(m.value&&!isNaN(m.value)){var y,P=(m.value+l).toFixed(v);y=new WRAP.Geo.Feature.Text({point:[m.lon,m.lat],text:P,fontSize:14,fillStyle:h.color,offsetX:p,offsetY:g,align:"center"}),s.push(y)}}this.context_revision=n.revision,WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.WindArrow=function(){this.style_revision,this.context_revision,this.image=null,this.arrow_step=0,this.image_width=32,this.image_height=64,this.draw=function(t,e,i,n,o,r,a,s){function l(t,e,i,n){for(var o=5;o<200;o+=5){i.clearRect(0,0,e.width,e.height);var r=1.5,a=4,s=24,l={x:e.width/2,y:e.height-1},h=o;for(h*=2,h/=10,h=Math.round(h),h*=10,h/=2,h>=50&&(s+=5*Math.floor(h/50)),h>0&&(i.beginPath(),i.moveTo(l.x,l.y),i.lineTo(l.x,l.y+(-s-(h<6?4:0))*r),i.stroke());h>=50;)i.beginPath(),i.moveTo(l.x,l.y+-s*r),i.lineTo(l.x+10*n*r,l.y+(-s+1.5)*r),i.lineTo(l.x,l.y+(-s+5)*r),i.lineTo(l.x,l.y+-s*r),i.stroke(),h-=50,s-=a+2.5;for(o>50&&(s-=2);h>=10;)i.moveTo(l.x,l.y+-s*r),i.lineTo(l.x+10*n*r,l.y+(-s-4)*r),h-=10,s-=a;h>=5&&(i.moveTo(l.x,l.y+-s*r),i.lineTo(l.x+7*n*r,l.y+(-s-3)*r),h-=5,s-=a),i.stroke(),t.push(i.getImageData(0,0,e.width,e.height))}}function h(t,e,i){i.clearRect(0,0,e.width,e.height);var n=1.5,o=24,r={x:e.width/2,y:e.height-1};i.beginPath(),i.moveTo(r.x,r.y),i.lineTo(r.x,r.y+(-o-4)*n),i.stroke(),t.push(i.getImageData(0,0,e.width,e.height))}function f(t,e,i){i.clearRect(0,0,e.width,e.height),i.lineWidth=1.5,i.beginPath(),i.arc(e.width/2,e.height-6,3,0,2*Math.PI,!0),i.closePath(),i.stroke(),i.fill(),t.push(i.getImageData(0,0,e.width,e.height))}if(!this.revision||this.revision.context!=a.context){this.style_revision!=a.style&&(this.style_revision=a.style);var u=i.Attributes.data_offset||0,c=i.Attributes.style.default;if(o&&i.Attributes.style[o]&&(c=i.Attributes.style[o]),c){if(!this.image){this.image=[];var d=document.createElement("canvas");d.width=this.image_width,d.height=this.image_height;var v=d.getContext("2d");v.strokeStyle=c.color,v.fillStyle=c.color,v.lineCap="round",v.lineWidth=1.5,l(this.image,d,v,1),this.arrow_step=this.image.length,l(this.image,d,v,-1),h(this.image,d,v),f(this.image,d,v)}for(var p="value",g=[],_=0;_<n.tiles.length;_++){var m=n.tiles[_];if(!(g[_]=r._handler().getTile(e,m.id,p)))return void r._handler().loadTile(e,m.id,p,m.z,m.y,m.x,m.cood,m.bounds,function(){WRAP.Geo.redraw(t)})}var u=i.Attributes.data_offset||0;s.length=0;for(var _=0;_<g.length;_++)for(var r=g[_].data,y=0;y<r.length;y++){var P=r[y];if(P.value&&2==P.value.length&&!isNaN(P.value[0])&&!isNaN(P.value[1])){var x=P.value[0]+u,w=P.value[1]+u,A=Math.sqrt(x*x+w*w)/.514;A=Math.round(A);var b=0;A>0&&(b=Math.atan2(x,w)*(180/Math.PI),b-=180,b<0&&(b+=360));var W,G=Math.floor(A),R=Math.floor(b),R=G?R||360:0,S=G+"KT",M=G?("000"+R).slice(-3):"",I=.6*this.image_width,T=.6*this.image_height,k=Math.floor((A+2)/5)-1;k>=this.arrow_step&&(k=this.arrow_step-1);var L=b,z=-I/2,F=-T;k==-1?Math.floor(A)>0?k=this.image.length-2:(L=0,F+=5,k=this.image.length-1):P.lat<0&&(k+=this.arrow_step),W=new WRAP.Geo.Feature.Image({point:[P.lon,P.lat],image:this.image[k],width:I,height:T,offsetX:z,offsetY:F,rotation:L}),s.push(W),W.geo={geometry:{type:"Point",coordinates:[P.lon,P.lat]},properties:{u:x,v:w,speed:A,direction:b,speed_text:S,direction_text:M}}}}this.context_revision=n.revision,WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.DataJSON=function(){this.draw=function(t,e,i,n,o,r,a,s){function l(t,e){for(var i=null,n=0;n<d.length;n++){var o=d[n].selector;if(!o){i=d[n].style;break}if("key_value"==o.type&&t[o.key]==o.value){i=d[n].style;break}}var r=i&&i[u];if(r){var a=_[e];if(a){var l=a.geometry;if(l&&t.display_flag!==!1)if("Point"==l.type){var h=l.coordinates;if("image"==r.type){var f=new WRAP.Geo.Feature.Image({point:h,image:r.url,width:r.width,height:r.height,offsetX:r.offset_x,offsetY:r.offset_y,rotation:r.rotation});f.geo=a,f.data=t,s.push(f)}else if("point"==r.type){var f=new WRAP.Geo.Feature.Point({point:h,strokeStyle:r.line_color,strokeWidth:r.line_width,fillStyle:r.point_color,pointSize:r.point_size,sensorSize:r.sensor_size});f.geo=a,f.data=t,s.push(f)}}else if("MultiPoint"==l.type)for(var c=0;c<l.coordinates.length;c++){var h=l.coordinates[c];if("image"==r.type){var f=new WRAP.Geo.Feature.Image({point:h,image:r.url,width:r.width,height:r.height,offsetX:r.offset_x,offsetY:r.offset_y,rotation:r.rotation});f.geo=a,f.data=t,s.push(f)}else if("point"==r.type){var f=new WRAP.Geo.Feature.Point({point:h,strokeStyle:r.line_color,strokeWidth:r.line_width,fillStyle:r.point_color,pointSize:r.point_size,sensorSize:r.sensor_size});f.geo=a,f.data=t,s.push(f)}}else if("LineString"==l.type||"MultiLineString"==l.type){var v=l.coordinates;if(v){var f=new WRAP.Geo.Feature.GeoLine({path:v,lineWidth:r.line_width,strokeStyle:r.line_color});f.geo=a,f.data=t,s.push(f)}}else if("Polygon"==l.type){var v=l.coordinates;if(v){var f=new WRAP.Geo.Feature.GeoLine({path:v,lineWidth:r.line_width,strokeStyle:r.line_color,fillStyle:r.fill_color,fillImage:r.fill_image});f.geo=a,f.data=t,s.push(f)}}else if("MultiPolygon"==l.type)for(var p=0;p<l.coordinates.length;p++){var v=l.coordinates[p];if(v){var f=new WRAP.Geo.Feature.GeoLine({path:v,lineWidth:r.line_width,strokeStyle:r.line_color,fillStyle:r.fill_color,fillImage:r.fill_image});f.geo=a,f.data=t,s.push(f)}}}}}o=null,e=null,n=null;var h=r.query("data").value();if(h&&h.position&&h.data){var f=!0;if(this.content_revision!=a.content&&(f=!1),this.conf_revision!=a.conf&&(f=!1),this.style_revision!=a.style&&(f=!1),this.data_revision!=a.data&&(f=!1),!f){t=null,s.length=0;var u="default",c=h.position.features;c||(c=[],"Feature"==h.position.type&&c.push(h.position));for(var d=i.Attributes.features,v=r._handler().conf,p=v.Attributes.DataStructure.geo_position_key||"position_id",g=v.Attributes.DataStructure.data_position_key||"position_id",_={},m=0,y=c.length,P=0;P<y;P++){var x=c[P],w=x.properties;if(w){var A=x.geometry;if(A){var b=w[p];_[b]&&m++,_[b]=x}}}var W=0;if(Array.isArray(h.data.data)){W=h.data.data.length;for(var P=0;P<W;P++){var x=h.data.data[P],b=x[g];l(x,b)}}else for(var G in h.data.data){var x=h.data.data[G];l(x,G),W++}this.content_revision=a.content,this.conf_revision=a.conf,this.style_revision=a.style,this.data_revision=a.data,WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.GeoJSON=function(){this.initialized=!1,this.draw=function(t,e,i,n,o,r,a,s){WRAP.Geo.check(t,e,i,n,o,r,a,s);var l=[],h=-1;n&&n.tiles.length&&(h=n.zoom);var f=r._handler().tiled();if(f){if(this.content_revision==a.content&&this.context_revision==a.context&&this.conf_revision==a.conf&&this.style_revision==a.style&&this.data_revision==a.data)return;var u=r._handler().getData(e,n);if(!u)return void r._handler().loadData(e,n,function(){WRAP.Geo.redraw(t)});for(var c=0;c<u.length;c++){var d=u[c].features;if(d)for(var v=0;v<d.length;v++)l.push(d[v]);else"Feature"==u[c].type&&l.push(u[c])}}else{var p=r.query("data").value();if(!p)return void(this.initialized||(this.initialized=!0,r.load(function(){WRAP.Geo.redraw(t)})));if(i.Attributes.min_zoom){if(this.last_zoom==h&&this.content_revision==a.content&&this.conf_revision==a.conf&&this.style_revision==a.style&&this.data_revision==a.data)return}else if(this.content_revision==a.content&&this.conf_revision==a.conf&&this.style_revision==a.style&&this.data_revision==a.data)return;(l=p.features)||(l=[],"Feature"==p.type&&l.push(p))}if(s.length=0,!i.Attributes.min_zoom||h>=i.Attributes.min_zoom)for(var g=o||"default",_=i.Attributes.features,m=l.length,c=0;c<m;c++){var y=l[c],P=y.geometry;if(P){var x=y.properties;if(!x||x.display_flag!==!1){for(var o=null,v=0;v<_.length;v++){var w=_[v].selector;if(!w){o=_[v].style;break}if("key_value"==w.type&&x[w.key]==w.value){o=_[v].style;break}}var A=o&&o[g];if(A){var b=void 0===A.geodesic||A.geodesic===!0;if("Point"==P.type){var W=P.coordinates;if("image"==A.type){var G=new WRAP.Geo.Feature.Image({point:W,image:A.url,width:A.width,height:A.height,offsetX:A.offset_x,offsetY:A.offset_y,rotation:A.rotation});G.geo=y,s.push(G)}else if("point"==A.type){var G=new WRAP.Geo.Feature.Point({point:W,strokeStyle:A.line_color,strokeWidth:A.line_width,fillStyle:A.point_color,pointSize:A.point_size,sensorSize:A.sensor_size});G.geo=y,s.push(G)}}else if("MultiPoint"==P.type)for(var R=0;R<P.coordinates.length;R++){var W=P.coordinates[R];if("image"==A.type){var G=new WRAP.Geo.Feature.Image({point:W,image:A.url,width:A.width,height:A.height,offsetX:A.offset_x,offsetY:A.offset_y,rotation:A.rotation});G.geo=y,s.push(G)}else if("point"==A.type){var G=new WRAP.Geo.Feature.Point({point:W,strokeStyle:A.line_color,strokeWidth:A.line_width,fillStyle:A.point_color,pointSize:A.point_size,sensorSize:A.sensor_size});G.geo=y,s.push(G)}}else if("LineString"==P.type||"MultiLineString"==P.type){var S=P.coordinates;if(S){var G=new WRAP.Geo.Feature.GeoLine({path:S,lineWidth:A.line_width,strokeStyle:A.line_color,option:A.option,geodesic:b});G.geo=y,s.push(G)}}else if("Polygon"==P.type){var S=P.coordinates;if(S){var G=new WRAP.Geo.Feature.GeoLine({path:S,lineWidth:A.line_width,strokeStyle:A.line_color,fillStyle:A.fill_color,fillImage:A.fill_image,option:A.option,geodesic:b});G.geo=y,s.push(G)}}else if("MultiPolygon"==P.type)for(var M=0;M<P.coordinates.length;M++){var S=P.coordinates[M];if(S){var G=new WRAP.Geo.Feature.GeoLine({path:S,lineWidth:A.line_width,strokeStyle:A.line_color,fillStyle:A.fill_color,fillImage:A.fill_image,geodesic:b});G.geo=y,s.push(G)}}}}}}this.content_revision=a.content,this.context_revision=a.context,this.conf_revision=a.conf,this.style_revision=a.style,this.data_revision=a.data,this.last_zoom=h,WRAP.Geo.invalidate()}},WRAP.Geo.Renderer.Lightning=function(){this.draw=function(t,e,i,n,o,r,a,s){n=null,e=null,o=null;var l=r.query("data").value();if(l){var h=!0;if(this.conf_revision!=a.conf&&(h=!1),this.data_revision!=a.data&&(h=!1),!h){console.log("draw:"+t.name());var o=i.Attributes.style.default,f=o.icon_width,u=o.icon_height,c=o.icon_offset_x,d=o.icon_offset_y,v=o.icon;s.length=0;var p=l.features;p||(p=[],"Feature"==l.type&&p.push(l));for(var g=p.length,_=0;_<g;_++){var m=p[_],y=m.geometry;if(y&&"Point"==y.type){var P=m.properties;if(P&&P.display_flag===!1)continue;for(var x=WRAP.Core.currentTime(),w=new WRAP.Core.DateTime(P.obs_time),A=w.diff(x)/60,b=0;b<v.length;b++)if(parseInt(v[b].ge)<=A&&A<parseInt(v[b].lt)){var W=y.coordinates,G=new WRAP.Geo.Feature.Image({point:W,image:v[b].image,width:f,height:u,offsetX:c,offsetY:d});G.geo=m,s.push(G);break}}}this.conf_revision=a.conf,this.style_data=a.data,WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.SIGWX=function(){this.draw=function(t,e,i,n,o,r,a,s){function l(t){Array.isArray(t[0])&&(t=t[0]);var e=[],i=WRAP.Geo.getSize(),n=WRAP.Geo.getScreenLine(t);if(!n)return e;for(var o=0;o<n.length;o++){for(var r=n[o],a=9999,s=-9999,l=9999,h=-9999,f=0;f<r.length;f++){var u=r[f].x,c=r[f].y;c<0||i.height<=c||u<0||i.width<=u||(a>u&&(a=u),s<u&&(s=u),l>c&&(l=c),h<c&&(h=c))}if(s>0&&h>0){var u=(a+s)/2,c=(l+h)/2,d=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(u,c));e.push([d.lonDegree(),d.latDegree()])}}return e}function h(t){return t&&Math.round(t/30.48)||"XXX"}var f=!0;if(this.content_revision!=a.content&&(f=!1),f=!1,this.conf_revision!=a.conf&&(f=!1),!f){var u=r._handler().getData(e,n);if(!u)return void r._handler().loadData(e,n,function(){WRAP.Geo.redraw(t)});s.length=0;for(var c=[],d=0;d<u.length;d++){var v=u[d].features;if(v)for(var p=0;p<v.length;p++)c.push(v[p]);else"Feature"==u[d].type&&c.push(u[d])}for(var g,o=i.Attributes,_=c.length,m="-99999",d=0;d<_;d++){var y=c[d],P=y.geometry;if(P){var x=y.properties;if("TURBULENCE"==x.contents_kind){var w,A,b;6==x.extended_degree?(w=o.turbulence_color_mod,A=[[[0,0],[0,0]],[[0,2],[1,2],[2,1],[3,2],[4,2]]],b=2):7==x.extended_degree?(w=o.turbulence_color_sev,A=[[[1,1],[2,0],[3,1]],[[0,2],[1,2],[2,1],[3,2],[4,2]]],b=2):(w=o.turbulence_color_mod_to_sev,A=[[[0,2],[1,2],[2,1],[3,2],[4,2]],[[6,1],[7,0],[8,1]],[[5,2],[6,2],[7,1],[8,2],[9,2]]],b=4.5);var W=P.coordinates;W&&(g=new WRAP.Geo.Feature.GeoLine({path:W,lineWidth:o.turbulence_line_width,strokeStyle:w,lineDash:[12,12]}),s.push(g));var G=l(W);if(G&&G.length)for(var R=0;R<G.length;G++){var S=G[R],M=null,I=null;if(1==x.altitudes.length?M=x.altitudes[0]:2==x.altitudes.length&&(I=x.altitudes[0],M=x.altitudes[1]),g=new WRAP.Geo.Feature.Text({point:S,text:h(M),fontSize:11,fillStyle:o.turbulence_label_color,offsetX:0,offsetY:0,align:"center"}),s.push(g),g=new WRAP.Geo.Feature.Text({point:S,text:h(I),fontSize:11,fillStyle:o.turbulence_label_color,offsetX:0,offsetY:12,align:"center"}),s.push(g),A){for(var T=4,p=0;p<A.length;p++)for(var k=A[p],L=0;L<k.length;L++){var z=k[L];z[0]=z[0]*T-b*T,z[1]=z[1]*T-24}g=new WRAP.Geo.Feature.Line({point:S,line:A,lineWidth:1,strokeStyle:o.turbulence_label_color}),s.push(g)}}}}}for(var F="counterclockwise"==o.cloud_line_orientation?"counter_cloud":"cloud",d=0;d<_;d++){var y=c[d],P=y.geometry;if(P){var x=y.properties;if("CLOUD"==x.contents_kind){var W=P.coordinates;W&&(g=new WRAP.Geo.Feature.GeoLine({path:W,lineWidth:o.cloud_line_width,strokeStyle:o.cloud_line_color,option:F}),s.push(g));var G=l(W);if(G&&G.length)for(var R=0;R<G.length;G++){var S=G[R];if(x.cloud_distribution){for(var C=-36,D=x.cloud_distribution.split("/"),L=0;L<D.length;L++)g=new WRAP.Geo.Feature.Text({point:S,text:D[L],fontSize:11,fillStyle:o.turbulence_label_color,offsetX:0,offsetY:C+=12,align:"center"}),s.push(g);g=new WRAP.Geo.Feature.Text({point:S,text:x.cloud_type,fontSize:11,fillStyle:o.turbulence_label_color,offsetX:0,offsetY:C+=12,align:"center"}),s.push(g);var E="XXX",X="XXX";0<x.altitudes.length&&(E=h(x.altitudes[0])),1<x.altitudes.length&&(X=h(x.altitudes[1])),g=new WRAP.Geo.Feature.Text({point:S,text:E,fontSize:11,fillStyle:o.turbulence_label_color,offsetX:0,offsetY:C+=12,align:"center"}),s.push(g),g=new WRAP.Geo.Feature.Text({point:S,text:X,fontSize:11,fillStyle:o.turbulence_label_color,offsetX:0,offsetY:C+=12,align:"center"}),s.push(g)}else{if(x.extended_degree){var H="XXX",Y="XXX";x.airframe_icing?3<x.altitudes.length&&(x.altitudes[0]!=m&&(Y=h(x.altitudes[0])),x.altitudes[1]!=m&&(H=h(x.altitudes[1]))):1<x.altitudes.length&&(x.altitudes[0]!=m&&(Y=h(x.altitudes[0])),x.altitudes[1]!=m&&(H=h(x.altitudes[1])));var j;2==x.extended_degree?j=o.cloud_turb_mod_icon:3==x.extended_degree&&(j=o.cloud_turb_sev_icon);var C=-26;j&&(g=new WRAP.Geo.Feature.Image({point:S,image:j,width:o.cloud_icon_width,height:o.cloud_icon_height,offsetX:-o.cloud_icon_width/2-6,offsetY:C+6}),s.push(g)),g=new WRAP.Geo.Feature.Text({point:S,text:H,fontSize:11,fillStyle:o.turbulence_label_color,offsetX:14,offsetY:C+=12,align:"center"}),s.push(g),g=new WRAP.Geo.Feature.Text({point:S,text:Y,fontSize:11,fillStyle:o.turbulence_label_color,offsetX:14,offsetY:C+=12,align:"center"}),s.push(g)}if(x.airframe_icing){var O="MOD",j=o.cloud_ice_mod_icon;0===x.airframe_icing.lastIndexOf("MOD",0)?O="MOD":0===x.airframe_icing.lastIndexOf("SEV",0)&&(O="SEV",j=o.cloud_ice_sev_icon);var H="XXX",Y="XXX";x.extended_degree?3<x.altitudes.length&&(x.altitudes[2]!=m&&(Y=h(x.altitudes[2])),x.altitudes[3]!=m&&(H=h(x.altitudes[3]))):1<x.altitudes.length&&(x.altitudes[0]!=m&&(Y=h(x.altitudes[0])),x.altitudes[1]!=m&&(H=h(x.altitudes[1])));var C=-2;g=new WRAP.Geo.Feature.Image({point:S,image:j,width:o.cloud_icon_width,height:o.cloud_icon_height,offsetX:-o.cloud_icon_width/2-6,offsetY:C+6}),s.push(g),g=new WRAP.Geo.Feature.Text({point:S,text:H,fontSize:11,fillStyle:o.turbulence_label_color,offsetX:14,offsetY:C+=12,align:"center"}),s.push(g),g=new WRAP.Geo.Feature.Text({point:S,text:Y,fontSize:11,fillStyle:o.turbulence_label_color,offsetX:14,offsetY:C+=12,align:"center"}),s.push(g)}}}}}}for(var d=0;d<_;d++){var y=c[d],P=y.geometry;if(P){var x=y.properties;if("VOLCANO"==x.contents_kind)for(var L=0;L<P.coordinates.length;L++){var N=P.coordinates[L];g=new WRAP.Geo.Feature.Image({point:N,image:o.volcano_icon,width:o.volcano_icon_width,height:o.volcano_icon_height,offsetX:-o.volcano_icon_width/2,offsetY:-o.volcano_icon_height/2}),g.geo=y,s.push(g),g=new WRAP.Geo.Feature.Text({point:N,text:x.feature_name,fontSize:11,fillStyle:o.volcano_label_color,offsetX:2,offsetY:22,align:"left"}),s.push(g)}}}for(var B=12,Z=20,q=-3,V=-6,J=20,U=4,Q=12,d=0;d<_;d++){var y=c[d],P=y.geometry;if(P){var x=y.properties;if("JET STREAM"==x.contents_kind)for(var W=P.coordinates,K=x.points,p=0;p<W.length;p++)for(var $=WRAP.Geo.getScreenLine(W[p]),tt=W[p][0][1]<0,et=0;et<$.length;et++){for(var k=$[et],it=W[p].concat(),nt=K.concat(),ot=[],rt=0,L=0;L<k.length;L++){var N=it[L],at=k[L],st=nt[L],lt=st[0]||0;lt&&(lt=Number(lt)/.514,lt=Math.round(lt)+2);var ht={knots:lt,arrow:null,changeBar:null};if(ot.push(ht),L<k.length-1){var ft=k[L+1],ut=ft.x-at.x,ct=ft.y-at.y,dt=ut*ut+ct*ct;if(rt=180*Math.atan2(ft.y-at.y,ft.x-at.x)/Math.PI,lt>0){for(var vt="FL"+h(N[2]||0),pt=st[2]?h(st[2]):0,gt=st[4]?h(st[4]):0,_t=Math.floor(lt/50),mt=Math.floor(lt%50/10),yt=Math.floor(lt%10/5),Pt=mt+yt,xt=(_t+Pt)*B+(_t-1)*q+(Pt-1)*V+(_t>0?V:q),wt=0;dt<=xt*xt;){wt++;var At=L+1+wt;if(At>k.length-1)break;var bt=k[At],ut=bt.x-at.x,ct=bt.y-at.y;dt=ut*ut+ct*ct}if(dt>xt*xt){wt>0&&(k.splice(L+1,wt),it.splice(L+1,wt),nt.splice(L+1,wt),ft=k[L+1],ut=ft.x-at.x,ct=ft.y-at.y,dt=ut*ut+ct*ct,rt=180*Math.atan2(ft.y-at.y,ft.x-at.x)/Math.PI);for(var Wt=[],Gt=[],Rt=_t+mt+yt,St=tt?Z:-Z,Mt=0,et=0;et<Rt;et++){var It=V;et<_t?(0==et&&(It=q),et==_t-1&&(It=V),Wt.push([[Mt,0],[Mt+B,0],[Mt,St],[Mt,0]])):et<_t+mt?Gt.push([[Mt+B,0],[Mt,St]]):Gt.push([[Mt+B,0],[Mt+B/2,St/2]]),Mt+=B+It}for(var R=0;R<Wt.length;R++)g=new WRAP.Geo.Feature.Line({point:N,line:Wt[R],fillStyle:o.jetstream_line_color,rotation:rt}),s.push(g);Gt.length&&(g=new WRAP.Geo.Feature.Line({point:N,line:Gt,lineWidth:1,strokeStyle:o.jetstream_line_color,rotation:rt}),s.push(g));var Tt=2,kt=12,Lt=2,zt=24,wt=rt;tt?wt<-90||wt>90?(wt+=180,Tt-=30,Lt-=30):(kt=-4,zt=-16):(wt<-90||wt>90)&&(wt+=180,Tt-=30,Lt-=30,kt=-4,zt=-16),N[2]&&(g=new WRAP.Geo.Feature.Text({point:N,text:vt,fontSize:11,fillStyle:o.jetstream_label_color,offsetX:Tt,offsetY:kt,align:"left",rotation:wt}),s.push(g)),gt&&pt&&(g=new WRAP.Geo.Feature.Text({point:N,text:gt+"/"+pt,fontSize:11,fillStyle:o.jetstream_label_color,offsetX:Lt,offsetY:zt,align:"left",rotation:wt}),s.push(g)),ht.arrow=!0}else if(dt>U*U){var Ft=J/2,Ct=[];Ct.push([[0,Ft],[0,-Ft]]),Ct.push([[U,Ft],[U,-Ft]]),g=new WRAP.Geo.Feature.Line({point:N,line:Ct,lineWidth:1,strokeStyle:o.jetstream_line_color,rotation:rt}),ht.changeBar=g}}var Dt=ft.x-at.x,Et=ft.y-at.y;g=new WRAP.Geo.Feature.Line({point:N,line:[[0,0],[Dt,Et]],lineWidth:o.jetstream_line_width,strokeStyle:o.jetstream_line_color}),s.push(g)}else if(L>0){var Xt=[];Xt.push([[0,0],[Q,-Q/2],[Q,Q/2],[0,0]]),g=new WRAP.Geo.Feature.Line({point:N,line:Xt,fillStyle:o.jetstream_line_color,rotation:rt-180}),s.push(g)}}for(var L=0;L<ot.length;L++){var ht=ot[L];if(ht.changeBar){for(var Ht=0,Yt=0,et=L-1;et>=0;et--)if(ot[et].arrow){Ht=ot[et].knots;break}for(var et=L+1;et<ot.length;et++)if(ot[et].arrow){Yt=ot[et].knots;break}(Ht&&Math.abs(Ht-ht.knots)>=20||Yt&&Math.abs(Yt-ht.knots)>=20)&&s.push(ht.changeBar)}}}}}for(var d=0;d<_;d++){var y=c[d],P=y.geometry;if(P){var x=y.properties;if("TROPOPAUSE"==x.contents_kind)for(var p=0;p<P.coordinates.length;p++){var N=P.coordinates[p];if(N&&N[2]){var jt=h(N[2]);"MINIMUM"==x.significance?(g=new WRAP.Geo.Feature.Line({point:N,line:[[-13,-7],[13,-7],[13,12],[0,19],[-13,12],[-13,-7]],lineWidth:.5,strokeStyle:"#000000",fillStyle:"#ffffff"}),s.push(g),g=new WRAP.Geo.Feature.Text({point:N,text:"L",fontSize:11,fillStyle:"#000",offsetX:0,offsetY:15,align:"center"}),s.push(g)):"MAXIMUM"==x.significance?(g=new WRAP.Geo.Feature.Line({point:N,line:[[-13,-12],[0,-19],[13,-12],[13,7],[-13,7],[-13,-7]],lineWidth:.5,strokeStyle:"#000000",fillStyle:"#ffffff"}),s.push(g),g=new WRAP.Geo.Feature.Text({point:N,text:"H",fontSize:11,fillStyle:"#000",offsetX:0,offsetY:-7,align:"center"}),s.push(g)):(g=new WRAP.Geo.Feature.Line({point:N,line:[[-13,-7],[13,-7],[13,7],[-13,7],[-13,-7]],lineWidth:.5,strokeStyle:"#000000",fillStyle:"#ffffff"}),s.push(g)),g=new WRAP.Geo.Feature.Text({point:N,text:jt,fontSize:11,fillStyle:"#000",offsetX:0,offsetY:4,align:"center"}),s.push(g)}}}}this.content_revision=a.content,this.context_revision=a.context,this.conf_revision=a.conf,WRAP.Geo.invalidate()}}},WRAP.Geo.Renderer.ASCScale=function(){this.style_revision,this.context_revision,this.draw=function(t,e,i,n,o,r,a,s){function l(t,e,i,n,o,r){var a=[e+.17*n,i+.72*o],s=[e+.23*n,i+.46*o],l=[e+.4*n,i+.35*o],h=[e+.5*n,i+.333*o],f=[e+.6*n,i+.35*o],u=[e+.77*n,i+.46*o],c=[e+.83*n,i+.72*o],d=i+.5*o,v=i+.2*o;1==r?(t.push([a,s,l,h,f,u,c]),t.push([[e+.5*n,d],[e+.5*n,v]])):4==r&&(t.push([a,s,l,h,f,u,c]),t.push([[e+.4*n,d],[e+.4*n,v]]),t.push([[e+.6*n,d],[e+.6*n,v]]))}function h(t,e,i,n,o,r){var a=e+.2*n,s=e+.35*n,l=e+.5*n,h=e+.65*n,f=e+.8*n,u=i+.2*o,c=i+.5*o,d=i+.8*o;7==r?(t.push([[a,u],[s,u],[l,c],[h,u],[f,u]]),t.push([[s,c],[l,d],[h,c]])):t.push([[a,u],[s,u],[l,d],[h,u],[f,u]])}if(!this.revision||this.revision.context!=a.context){this.style_revision!=a.style&&(this.style_revision=a.style);var f=i.Attributes.style.default;if(o&&i.Attributes.style[o]&&(f=i.Attributes.style[o]),f){var u=r._handler().getGrid();if(u){var c=parseInt(u.Width),d=parseInt(u.Height),v="highest";if(f.min_blocksize&&(v+=" "+f.min_blocksize),e&&e.element&&e.level){var p=Array.isArray(e.element)?e.element:[e.element],g=Array.isArray(e.level)?e.level:[e.level],_={};for(var m in e)"element"!=m&&"level"!=m&&(_[m]=e[m]);for(var y=[],P=0;P<p.length;P++){y[P]=[];for(var x=0;x<g.length;x++)y[P][x]=[]}for(var w=0;w<n.tiles.length;w++)for(var A=n.tiles[w],P=0;P<p.length;P++){_.element=p[P];for(var x=0;x<g.length;x++){_.level=g[x];var b;if(!(b=r._handler().getTile(_,A.id,v)))return void r._handler().loadTile(_,A.id,v,A.z,A.y,A.x,A.cood,A.bounds,function(){WRAP.Geo.redraw(t)});y[P][x][w]=b}}s.length=0;for(var W,G=new Uint8Array(c*d),R=[],S=["rgba(0,0,0,0)",f.icing_lgt_color,f.conv_lgt_color,f.turb_mod_color,f.icing_mod_color,f.conv_mod_color,f.turb_mod_to_sev_color,f.turb_sev_color],M=[-1,0,1,2,0,1,2,2],I=10,T=12,P=0;P<p.length;P++)for(var k=p[P],x=0;x<g.length;x++)for(var L=y[P][x],w=0;w<L.length;w++)for(var r=L[w].data,z=0;z<r.length;z++){var F=r[z];if(F.value&&!isNaN(F.value)&&F.step){var C;if("ICING"==k?1==F.value?C=1:2==F.value&&(C=4):"CONV"==k?1==F.value?C=2:2==F.value&&(C=5):"TURB"==k&&(3==F.value?C=3:4==F.value?C=6:5==F.value&&(C=7)),C){var D=F.y*c+F.x;(!G[D]||G[D]<C)&&(G[D]=C,R[D]={lat:F.lat,lon:F.lon},W=F.step)}}}if(W)for(var E=parseFloat(u.LonInterval)*W,X=parseFloat(u.LatInterval)*W,H=E/2,Y=X/2,j=1;j<=7;j++)for(var O=M[j],w=0,N=0;N<d;N++)for(var f=w,B=0;B<c;B++){var F=G[w];if(F==j){var Z,q,V,J,U,Q=S[F],K=R[w],$=K.lon-H,tt=K.lon+H,et=K.lat+Y,it=K.lat-H;if(0==O||2==O){q=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*et,60*$)),V=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*it,60*tt)),J=Math.abs(q.x-V.x),U=Math.abs(q.y-V.y);var nt=Math.floor(J/T),ot=Math.floor(U/T);if(nt&&ot){for(var rt=(tt-$)/nt,at=(et-it)/ot,st=[],lt=0;lt<ot;lt++)for(var ht=et-at*(lt+.5),ft=ht-at/2,ut=0;ut<nt;ut++){var ct=$+rt*(ut+.5),dt=ct-rt/2;0==O?l(st,dt,ft,rt,at,j):h(st,dt,ft,rt,at,j)}s.push(new WRAP.Geo.Feature.GeoLine({path:st,strokeStyle:Q,lineWidth:1.5}))}}var vt=w-c*W;if(vt>0&&G[vt]<F)if(0==O){var nt=Math.floor(J/I),ot=Math.floor(U/I);if(nt&&ot)for(var rt=(tt-$)/nt,at=(et-it)/ot,pt=.3*rt,gt=.2*at,_t=0;_t<nt;_t++){var ct=$+rt*(_t+.5);s.push(new WRAP.Geo.Feature.GeoLine({path:[[ct-pt,et+gt],[ct,et-gt],[ct+pt,et+gt]],strokeStyle:Q,lineWidth:1.5}))}}else 1==O?s.push(new WRAP.Geo.Feature.GeoLine({path:[[tt,et],[$,et]],strokeStyle:Q,lineWidth:2,option:"cloud"})):2==O&&s.push(new WRAP.Geo.Feature.GeoLine({path:[[[tt,et],[tt+.33*($-tt),et]],[[tt+.66*($-tt),et],[$,et]]],strokeStyle:Q,lineWidth:2}));var mt=w+c*W;if(mt<G.length&&G[mt]<F)if(0==O){var nt=Math.floor(J/I),ot=Math.floor(U/I);if(nt&&ot)for(var rt=(tt-$)/nt,at=(et-it)/ot,pt=.3*rt,gt=.2*at,_t=0;_t<nt;_t++){var ct=$+rt*(_t+.5);s.push(new WRAP.Geo.Feature.GeoLine({path:[[ct-pt,it+gt],[ct,it-gt],[ct+pt,it+gt]],strokeStyle:Q,lineWidth:1.5}))}}else 1==O?s.push(new WRAP.Geo.Feature.GeoLine({path:[[$,it],[tt,it]],strokeStyle:Q,lineWidth:2,option:"cloud"})):2==O&&s.push(new WRAP.Geo.Feature.GeoLine({path:[[[tt,it],[tt+.33*($-tt),it]],[[tt+.66*($-tt),it],[$,it]]],strokeStyle:Q,lineWidth:2}));var x=f+(B-W)%c;if(G[x]<F)if(0==O){var nt=Math.floor(J/I),ot=Math.floor(U/I);if(nt&&ot)for(var rt=(tt-$)/nt,at=(et-it)/ot,pt=.3*rt,gt=.2*at,_t=0;_t<ot;_t++){var ht=et-at*(_t+.5);s.push(new WRAP.Geo.Feature.GeoLine({path:[[$-pt,ht+gt],[$,ht-gt],[$+pt,ht+gt]],strokeStyle:Q,lineWidth:1.5}))}}else 1==O?s.push(new WRAP.Geo.Feature.GeoLine({
path:[[$,et],[$,it]],strokeStyle:Q,lineWidth:2,option:"cloud"})):2==O&&s.push(new WRAP.Geo.Feature.GeoLine({path:[[[$,et],[$,et+.33*(it-et)]],[[$,et+.66*(it-et)],[$,it]]],strokeStyle:Q,lineWidth:2}));var yt=f+(B+W)%c;if(G[yt]<F)if(0==O){var nt=Math.floor(J/I),ot=Math.floor(U/I);if(nt&&ot)for(var rt=(tt-$)/nt,at=(et-it)/ot,pt=.3*rt,gt=.2*at,_t=0;_t<ot;_t++){var ht=et-at*(_t+.5);s.push(new WRAP.Geo.Feature.GeoLine({path:[[tt-pt,ht+gt],[tt,ht-gt],[tt+pt,ht+gt]],strokeStyle:Q,lineWidth:1.5}))}}else 1==O?s.push(new WRAP.Geo.Feature.GeoLine({path:[[tt,it],[tt,et]],strokeStyle:Q,lineWidth:2,option:"cloud"})):2==O&&s.push(new WRAP.Geo.Feature.GeoLine({path:[[[tt,et],[tt,et+.33*(it-et)]],[[tt,et+.66*(it-et)],[tt,it]]],strokeStyle:Q,lineWidth:2}))}w++}var Pt=!1;if(Pt)for(var w=0,N=0;N<d;N++)for(var B=0;B<c;B++){var F=G[w];if(F){var Z,K=R[w];Z=new WRAP.Geo.Feature.Text({point:[K.lon,K.lat],text:F,fontSize:12,fillStyle:"#000",offsetX:0,offsetY:6,align:"center"}),s.push(Z)}w++}this.context_revision=n.revision,WRAP.Geo.invalidate()}}}}}},WRAP.Geo.Renderer.Isotach=function(){var t=this;this.palette=null,this.palette_value_min=0,this.palette_value_max=0,this.palette_gradient=!0,this.palette_scale=10,this.palette_step=1,this.setPalette=function(e){if(!t.palette&&e.palette){t.palette=[],t.palette_gradient=e.palette_gradient,t.palette_step=e.palette_step||1,t.palette_scale=1/t.palette_step;for(var i=e.palette,n=[],o=0;o<i.length;o++){var r=[],a=i[o].value;0==o?(this.palette_value_min=a,this.palette_value_max=a):(this.palette_value_min>a&&(this.palette_value_min=a),this.palette_value_max<a&&(this.palette_value_max=a)),r.push(a);var s=WRAP.Geo.parseColor(i[o].color);r.push(s[0]),r.push(s[1]),r.push(s[2]),r.push(s[3]),n.push(r)}for(var l=0,h=t.palette_value_min;h<=t.palette_value_max;h+=t.palette_step){for(;l<n.length-1&&h>=n[l+1][0];)l++;if(l==n.length-1)t.palette.push([parseInt(n[l][1]),parseInt(n[l][2]),parseInt(n[l][3]),parseInt(n[l][4])]);else{var f=n[l][1],u=n[l][2],c=n[l][3],d=n[l][4];if(t.palette_gradient){var v=(h-n[l][0])/(n[l+1][0]-n[l][0]),p=n[l+1][1],g=n[l+1][2],_=n[l+1][3],m=n[l+1][4];t.palette.push([parseInt(f+(p-f)*v),parseInt(u+(g-u)*v),parseInt(c+(_-c)*v),parseInt(d+(m-d)*v)])}else t.palette.push([parseInt(f),parseInt(u),parseInt(c),parseInt(d)])}}}},this.getColor=function(e){var i=Math.floor((e-t.palette_value_min)*t.palette_scale);return i<0||i>=t.palette.length?[0,0,0,0]:t.palette[i]},this.draw=function(t,e,i,n,o,r,a,s){var l=!0;if(this.context_revision!=a.context&&(l=!1),this.content_revision!=a.content&&(l=!1),this.conf_revision!=a.conf&&(l=!1),this.style_revision!=a.style&&(l=!1,this.palette=null),!l){var h=i.Attributes.data_offset||0,f=i.Attributes.style.default;if(!o&&i.Attributes.style_selector){if(!i.Attributes.style_selector.key||!i.Attributes.style_selector.styles)return void console.log("style_selector formar error.");for(var u=i.Attributes.style_selector.key,c=0;c<i.Attributes.style_selector.styles.length;c++){var d=i.Attributes.style_selector.styles[c].values;if(d.indexOf(e[u])>=0){o=i.Attributes.style_selector.styles[c].style;break}}}if(o&&i.Attributes.style[o]&&(f=i.Attributes.style[o]),f){this.setPalette(f);for(var v="block"!=f.fill_type?"interpolate":"nearest",p=f.fill_type,g=f.contour,_=[],c=0;c<n.tiles.length;c++){var m=n.tiles[c];if(!(_[c]=r._handler().getTile(e,m.id,v)))return void r._handler().loadTile(e,m.id,v,m.z,m.y,m.x,m.cood,m.bounds,function(){WRAP.Geo.redraw(t)})}s.length=0;for(var c=0;c<_.length;c++){var y=_[c];if(y&&!y.empty){var m=n.tiles[c],P=m.ctx.createImageData(256,256),f=this.getData(e,y.data);if(f){var x=P.data;if(p)for(var w=0;w<65536;w++){var A=f[w];if(void 0!==A){A+=h;var b=this.getColor(A),W=4*w;x[W]=b[0],x[W+1]=b[1],x[W+2]=b[2],x[W+3]=b[3]}}var G=[];if(g){for(var R=0,S=0,W=0;W<65536;W++){var A=f[W];void 0!==A&&(0==W?R=S=A:(R>A&&(R=A),S<A&&(S=A)))}for(var M=0;M<g.length;M++)for(var I=g[M],b=WRAP.Geo.parseColor(I.strokeStyle),A=I.base-h,T=0;T<I.num;T++){if(R<=A&&A<=S){for(var k=-1,L=0,z=0,F=0,C=0;C<256;C++)for(var D=0==C?0:-256,E=255==C?0:256,X=0;X<256;X++){var H=0==X?0:-1,Y=255==X?0:1,j=f[F];if(j>=A){var O=f[F+D],N=f[F+H],B=f[F+Y],Z=f[F+E];if(O<A||N<A||B<A||Z<A){x[4*F]=b[0],x[4*F+1]=b[1],x[4*F+2]=b[2],x[4*F+3]=b[3],I.lineWidth>1&&(x[4*F+4]=b[0],x[4*F+5]=b[1],x[4*F+6]=b[2],x[4*F+7]=b[3],x[4*F+1024]=b[0],x[4*F+1024+1]=b[1],x[4*F+1024+2]=b[2],x[4*F+1024+3]=b[3]);var q=Math.abs(X-128)+Math.abs(C-128);(k<0||q<k)&&(k=q,L=X,z=C)}}F++}20<L&&L<=236&&20<z&&z<=236&&G.push({x:L,y:z,value:A+h,color:I.textColor})}A+=I.interval}}var V=new WRAP.Geo.Feature.Tile({tile:m,imageData:P});s.push(V);for(var q=0;q<G.length;q++){var V,J=65792,U=m.cood[J],Q=m.cood[J+1];V=new WRAP.Geo.Feature.Text({point:[Q,U],text:G[q].value,fontSize:12,fillStyle:G[q].color,offsetX:G[q].x-128,offsetY:G[q].y-128,align:"center"}),s.push(V)}}}}this.context_revision=a.context,this.content_revision=a.content,this.conf_revision=n.conf,this.style_revision=a.style,WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.Isotach.prototype.getData=function(t,e){if(t.element&&Array.isArray(t.element)){for(var i=e[0],n=e[1],o=[],r=0;r<65536;r++){var a=i[r],s=n[r];isNaN(a)||isNaN(s)||(o[r]=Math.sqrt(a*a+s*s)/.514)}return o}},WRAP.Geo.Renderer.IcingProbavility=function(){this.style_revision,this.context_revision,this.draw=function(t,e,i,n,o,r,a,s){if(!this.revision||this.revision.context!=a.context){this.style_revision!=a.style&&(this.style_revision=a.style);var l=i.Attributes.style.default;if(o&&i.Attributes.style[o]&&(l=i.Attributes.style[o]),l){var h="value";l.min_blocksize&&(h+=" "+l.min_blocksize);for(var f=[],u=0;u<n.tiles.length;u++){var c=n.tiles[u];if(!(f[u]=r._handler().getTile(e,c.id,h)))return void r._handler().loadTile(e,c.id,h,c.z,c.y,c.x,c.cood,c.bounds,function(){WRAP.Geo.redraw(t)})}s.length=0;for(var u=0;u<f.length;u++)for(var r=f[u].data,d=0;d<r.length;d++){var v=r[d];if(v.value&&2==v.value.length){var p=v.value[0];if(!isNaN(p)){var g=v.value[1];if(!isNaN(g)&&(p-=273.15,-15<=p&&p<=0&&g>=90)){var _,m="＊";_=new WRAP.Geo.Feature.Text({point:[v.lon,v.lat],text:m,fontSize:14,fillStyle:l.icon_color,offsetX:0,offsetY:-7,align:"center"}),s.push(_)}}}}this.context_revision=n.revision,WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.GridLine=function(){this.draw=function(t,e,i,n,o,r,a,s){t=null,r=null,a=null,e=null,n=null;var l=i.Attributes.style.default;if(o&&i.Attributes.style[o]&&(l=i.Attributes.style[o]),l){s.length=0;var h,f,u,c,d=l.grid_interval||10,v=l.line_width||1,p=l.line_color,g=l.font_size||14,_=l.text_color||"black",m=l.text_edge_color;l.position&&(h=l.position.indexOf("top")>=0,f=l.position.indexOf("bottom")>=0,u=l.position.indexOf("left")>=0,c=l.position.indexOf("right")>=0);for(var y=85,P=[],x=[],w=0;w<=180;)0==w||180==w?x.push({lon:w,text:w}):(x.push({lon:w,text:"E"+w}),x.push({lon:-w,text:"W"+w})),w+=d;for(var A=0;A<=y;)0==A?P.push({lat:A,text:A}):(P.push({lat:A,text:"N"+A}),P.push({lat:-A,text:"S"+A})),A+=d;for(w=0;w<x.length;w++){var b=x[w].lon;for(s.push(new WRAP.Geo.Feature.GeoLine({path:[[b,y],[b,-y]],lineWidth:v,strokeStyle:p,geodesic:!1})),A=0;A<P.length;A++){var W=P[A].lat;s.push(new WRAP.Geo.Feature.GeoLine({path:[[b,W],[b+d,W]],lineWidth:v,strokeStyle:p,geodesic:!1}))}}for(var G=WRAP.Geo.getSize(),b=10;b<G.width-10;b++){if(h){var R=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(b,0)),S=R.lonDegree();for(w=0;w<x.length;w++){var M=x[w],I=M.lon,T=Math.abs(I-S);(!M.top||M.top.d>T)&&(M.top={d:T,point:R})}}if(f){var R=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(b,G.height)),S=R.lonDegree();for(w=0;w<x.length;w++){var M=x[w],I=M.lon,T=Math.abs(I-S);(!M.bottom||M.bottom.d>T)&&(M.bottom={d:T,point:R})}}}for(var W=20;W<G.height-20;W++){if(u){var R=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(0,W)),S=R.latDegree();for(A=0;A<P.length;A++){var M=P[A],I=M.lat,T=Math.abs(I-S);(!M.left||M.left.d>T)&&(M.left={d:T,point:R})}}if(c){var R=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(G.width,W)),S=R.latDegree();for(A=0;A<P.length;A++){var M=P[A],I=M.lat,T=Math.abs(I-S);(!M.right||M.right.d>T)&&(M.right={d:T,point:R})}}}for(w=0;w<x.length;w++){var M;(M=x[w].top)&&M.d<4&&s.push(new WRAP.Geo.Feature.Text({point:[M.point.lonDegree(),M.point.latDegree()],text:x[w].text,fontSize:g,strokeStyle:m,fillStyle:_,offsetX:0,offsetY:g+2,align:"center"})),(M=x[w].bottom)&&M.d<4&&s.push(new WRAP.Geo.Feature.Text({point:[M.point.lonDegree(),M.point.latDegree()],text:x[w].text,fontSize:g,strokeStyle:m,fillStyle:_,offsetX:0,offsetY:-4,align:"center"}))}for(A=0;A<P.length;A++)(M=P[A].left)&&M.d<4&&s.push(new WRAP.Geo.Feature.Text({point:[M.point.lonDegree(),M.point.latDegree()],text:P[A].text,fontSize:g,strokeStyle:m,fillStyle:_,offsetX:2,offsetY:g/2,align:"left"})),(M=P[A].right)&&M.d<4&&s.push(new WRAP.Geo.Feature.Text({point:[M.point.lonDegree(),M.point.latDegree()],text:P[A].text,fontSize:g,strokeStyle:m,fillStyle:_,offsetX:-3,offsetY:g/2,align:"right"}));WRAP.Geo.invalidate()}}},WRAP.Geo.Renderer.LiveCamera=function(){function t(t,i,n){i.img=null;var o=new Image;o.onload=function(){i.img=[];for(var n=document.createElement("canvas"),r=n.getContext("2d"),a=0;a<e;a++){var s=a*(360/e)*Math.PI/180;n.width=32,n.height=32;var l=n.width/2,h=n.height/2;r.save(),r.translate(l,h),r.rotate(s),r.translate(-l,-h),r.drawImage(o,0,0,32,32),r.restore();var f=n.toDataURL("image/png");i.img.push(f)}WRAP.Geo.redraw(t)},o.onerror=function(){i.img=[];for(var t=0;t<e;t++)i.img.push(n)},o.src=i.url}var e=16,i={t:{},s:{},a:{}};this.draw=function(n,o,r,a,s,l,h,f){o=null,a=null;var u=l.query("data").value();if(u){var s=r.Attributes.style.default,c=s.icon_width,d=s.icon_height,v=s.icon_offset_x,p=s.icon_offset_y,g=s.icon_nondir,_=s.icon_t,m=s.icon_s,y=s.icon_a;if(g&&_&&m&&y){if(i.a.url!=y&&(i.a.url=y,t(n,i.a,g)),i.s.url!=m&&(i.s.url=m,t(n,i.s,m)),i.t.url!=_&&(i.t.url=_,t(n,i.t,g)),!i.a.img||!i.s.img||!i.t.img)return void setTimeout(function(){WRAP.Geo.redraw(n)},500);var P=!0;if(this.content_revision!=h.content&&(P=!1,this.content_revision=h.content),!P){console.log("draw:"+n.name()),f.length=0;for(var x in u){var w=u[x];if(w.lat&&w.lon){var A;if(w.dir){var b=Math.floor((w.dir+360/(2*e))/(360/e));b%=e,A=i.s.img[b]}else A=g;var W=new WRAP.Geo.Feature.Image({point:[w.lon/60,w.lat/60],image:A,width:c,height:d,offsetX:v,offsetY:p});W.set(n,l.query("data."+x)),f.push(W)}}WRAP.Geo.invalidate(),console.log("  display list -> "+f.length)}}}}};
//# sourceMappingURL=../build/js/WRAP.Geo-1.1.0.8-min.js.map