var WRAP;"undefined"==typeof WRAP&&(WRAP={}),WRAP.Geo={name:"Geographic",version:"0.9",setLayer:function(t){this.container={interactive_layers:t.interactive_layers,plot_layers:t.plot_layers,upper_layers:t.upper_layers,lower_layers:t.lower_layers},this.map.setOverLandLayer(!0),this.draw()},getScreenPoint:function(t){return this.map.getScreenPoint(t)},getPoint:function(t){return this.map.getPoint(t)},getCenterPoint:function(){return this.map.getCenterPoint()},setCenterPoint:function(t){this.map.setCenterPoint(t)},getZoom:function(){return this.map.getZoom()},setZoom:function(t){this.map.setZoom(t)},getPerspective:function(t,e){return this.map.getPerspective(t,e)},getDistance:function(t,e){return this.map.getDistance(t,e)},getTMSPoint:function(t,e,i){return this.map.getTMSPoint(t,e,i)},addEventHandler:function(t,e){var i=this.Interaction[t];i&&i.push(e)},removeEventHandler:function(t,e){var i=this.Interaction[t];if(i){var n=i.indexOf(e);n>=0&&i.splice(n,1)}},Point:function(t,e){this.set=function(t,e){this.lat=parseFloat(t),this.lon=parseFloat(e),this.lon<-10800?this.lon+=21600:this.lon>=10800&&(this.lon-=21600)},this.setDegree=function(t,e){set(parseFloat(t)*60..parseFloat(e)*60)},this.latDegree=function(){return this.lat/60},this.lonDegree=function(){return this.lon/60},this.set(t,e)},Bounds:function(t,e,i,n){this.north=t,this.south=e,this.east=i,this.west=n},ScreenPoint:function(t,e){this.x=t,this.y=e},ScreenBounds:function(t,e,i,n){this.x=t,this.y=e,this.width=i,this.height=n},Layer:function(t){var e=this;this._name=t,this._visible=!0,this._style=null,this._current=null,this._attr=null,this._data=null,this._conf=null,this._dl=[],this.configure=function(t,i){this._data=t,this._conf=i;var n=i.Renderer;n&&WRAP.Geo.Renderer[n]?this._renderer=new WRAP.Geo.Renderer[n]:e._error("Implementation WRAP.Geo.Renderer."+n+" not found."),this._data.inspect(function(){e._updateDisplayList()},!0)},this.show=function(){this.setVisible(!0)},this.hide=function(){this.setVisible(!1)},this.visible=function(){return this._visible},this.setVisible=function(t){if(this._visible!=t){this._visible=t;var e=WRAP.Geo.Interaction.visibilityChange;if(e)for(var i=0;i<e.length;i++)e[i](this);WRAP.Geo.invalidate(),WRAP.Geo.draw()}},this.addFeature=function(t){this._dl.push(t)},this.removeFeature=function(t){var e=this._dl.indexOf(t);e>=0&&this._dl.splice(e,1)},this.clear=function(){this._dl=[],WRAP.Geo.draw()},this.set=function(t){this._current&&t&&JSON.stringify(this._current)==JSON.stringify(t)||(this._current=t,WRAP.Geo.invalidate())},this.setAttributes=function(t){this._current&&t&&JSON.stringify(this._current)==JSON.stringify(t)||(this._attr=t,this._updateDisplayList())},this.setStyle=function(t){this._style=t,this._updateDisplayList()},this.name=function(){return this._name},this._currentConfiguration=function(){function t(e,i){for(var n in i)Array.isArray(i[n])?e[n]=i[n]:"object"==typeof i[n]?t(e[n]={},i[n]):e[n]=i[n]}function e(t,i){if(i)for(var n in i)"object"==typeof i[n]&&t[n]?e(t[n],i[n]):t[n]=i[n]}var i={};return t(i,this._conf),i.Attributes||(i.Attributes={}),e(i.Attributes,this._attr),i},this._updateDisplayList=function(){this._renderer&&this._renderer.render(this,this._dl,this._data,this._currentConfiguration()),WRAP.Geo.draw()},this._readyTile=function(t,e,i){return!(this._visible&&this._renderer&&this._renderer.readyTile)||this._renderer.readyTile(this._data,this._current,t,e,i)},this._updateTile=function(t,e,i,n){this._visible&&this._renderer&&this._renderer.renderTile&&this._renderer.renderTile(t,this._data,this._current,e,i,n,this._currentConfiguration())},this._preloadTile=function(t,e,i){this._visible&&this._renderer&&this._renderer.preload&&this._renderer.preload(this._data,this._current,t,e,i)},this._error=function(t){console.warn(this.name()+":"+t)}},Feature:function(t){this.type=t,this.set=function(t,e){this.layer=t,this.reference=e,this.mouseover=function(){for(var t=WRAP.Geo.Interaction.mouseover,e=WRAP.Geo.getScreenPoint(this.point),i=0;i<t.length;i++)t[i](this.layer,this.reference,e)},this.mouseout=function(){for(var t=WRAP.Geo.Interaction.mouseout,e=WRAP.Geo.getScreenPoint(this.point),i=0;i<t.length;i++)t[i](this.layer,this.reference,e)},this.touch=function(){for(var t=WRAP.Geo.Interaction.touch,e=WRAP.Geo.getScreenPoint(this.point),i=0;i<t.length;i++)t[i](this.layer,this.reference,e)}}},Animation:function(){this.setTimeRange=function(t,e){this._frame=t,this._interval=parseFloat(e),this._last_time=0,this._next_time=0,this._current=-1,this._time=0,this._setFrame(0),this._running=null,this._cb=null},this.setLayer=function(t){this._layer=t},this.setTime=function(t){this._running=!1;for(var e=0;e<this._frame.length&&(t.basetime&&t.basetime!=this._frame[e].basetime||!(t.validtime<=this._frame[e].validtime));)e++;this._setFrame(e)},this.start=function(t){this._cb=t,this._running||(this._running=!0,this._current_time=WRAP.Geo.addAnimation(this),this._next_time=this._current_time+this._interval)},this.stop=function(){this._running=!1,WRAP.Geo.removeAnimation(this)},this.time=function(){return this._time},this._setFrame=function(t){if(!this._frame||!this._frame.length)return this._time=void 0,this._current=-1,!1;if(t<0&&(t=0),t>=this._frame.length&&(t=this._frame.length-1),this._current!=t){if(this._current=t,this._time=this._frame[t],this._layer)for(var e=0;e<this._layer.length;e++)this._layer[e].set(this._frame[t]);return!0}return!1},this._go=function(t){if(this._running&&this._next_time<=t){if(WRAP.Geo.upper_layers_updating)return void WRAP.Geo.drawTiles();this._next_time=t+this._interval,this._setFrame(this._current+1)&&this._cb&&this._cb(this._time),this._current>=this._frame.length-1&&this.stop()}}},Bridge:{},Renderer:{},Interaction:{mouseover:[],mouseout:[],touch:[],boundsChange:[],visibilityChange:[]},draw:function(){if(this.map){if(this.map.clearStart(),this.container&&this.container.interactive_layers)for(var t=this.container.interactive_layers.length-1;t>=0;){var e=this.container.interactive_layers[t];e.visible()&&this.map.render(e._dl),t--}this.map.clearEnd()}},updateBounds:function(t,e,i,n,o){var r=WRAP.Geo.Interaction.boundsChange;if(r)for(var a=0;a<r.length;a++)r[a]();this.tiles=[];for(var s=Math.pow(2,t),l=n;l<=o;l++)if(e<=i)for(var h=e;h<=i;h++)this.tiles.push(""+t+"/"+l+"/"+h);else{for(var h=e;h<s;h++)this.tiles.push(""+t+"/"+l+"/"+h);for(var h=0;h<=i;h++)this.tiles.push(""+t+"/"+l+"/"+h)}this.drawTiles()},drawTiles:function(){var t=WRAP.Geo.container.upper_layers;if(t&&t.length){WRAP.Geo.upper_layers_updating=0;for(var e=[],i=0;i<this.tiles.length;i++){var n="upper_layers/"+this.tiles[i],o=n.split("/"),r=document.getElementById(n);if(r&&(e.push({canvas:r,z:o[1],y:o[2],x:o[3]}),r.offscreen!=this.revision)){for(var a=0,s=t.length-1;s>=0;s--){var l=t[s];if(!l._readyTile(o[1],o[2],o[3])){a++,WRAP.Geo.upper_layers_updating++;break}}if(!a){for(var h=262144,c=0;c<h;c++)r.pix.data[c]=0;for(var s=t.length-1;s>=0;s--){var l=t[s];l._updateTile(r.pix,o[1],o[2],o[3])}r.offscreen=this.revision}}}if(!WRAP.Geo.upper_layers_updating){for(var i=0;i<e.length;i++){var r=e[i].canvas;r.revision!=this.revision&&(r.ctx.putImageData(r.pix,0,0),r.revision=this.revision)}for(var i=0;i<e.length;i++)for(var s=0;s<t.length;s++){var l=t[s];l._preloadTile(e[i].z,e[i].y,e[i].x)}}}},invalidate:function(){this.revision++,this.drawTiles()},addAnimation:function(t){var e=this;this.animations.push(t);var i=new Date;return this.timer||(this.animation_start=i,this.timer=setInterval(function(){for(var t=new Date,i=(t-e.animation_start)/1e3,n=0;n<e.animations.length;n++)e.animations[n]._go(i)},15)),(i-this.animation_start)/1e3},removeAnimation:function(t){var e=this.animations.indexOf(t);e>=0&&this.animations.splice(e,1),!this.animations.length&&this.timer&&(clearInterval(this.timer),this.timer=null,this.animation_start=null)},timer:null,animation_start:null,animations:[],revision:1,tiles:[]},WRAP.Geo.setGoogleMaps=function(t){function e(t){this.tileSize=t}WRAP.Geo.map=new WRAP.Geo.Bridge.GoogleMaps(t);var i,n=WRAP.Geo.map.map;e.prototype.getTile=function(t,e,n){var o=this.name,r=Math.pow(2,e),a=t.x%r,s=r-t.y-1,l=o+"/"+e+"/"+s+"/"+a,h=document.getElementById(l);return h?h:(h=n.createElement("canvas"),h.id=l,h.width=256,h.height=256,h.ctx=h.getContext("2d"),h.pix=h.ctx.createImageData(256,256),i&&clearTimeout(i),i=setTimeout(function(){WRAP.Geo.drawTiles()},10),h)},WRAP.Geo.map.overland_layer=new e(new google.maps.Size(256,256)),WRAP.Geo.map.overland_layer.name="upper_layers",WRAP.Geo.map.overland_layer_index=n.overlayMapTypes.length,n.overlayMapTypes.push(null)},WRAP.Geo.Bridge.GoogleMaps=function(t){function e(){var t=n.bounds;if(n.bounds&&n.projection){var e=t.getNorthEast(),i=t.getSouthWest(),o=n.projection.fromLatLngToPoint(e),r=n.projection.fromLatLngToPoint(i),a=Math.pow(2,n.zoom),s=Math.floor(r.x*a/256),l=Math.floor(o.x*a/256),h=a-Math.floor(r.y*a/256)-1,c=a-Math.floor(o.y*a/256)-1;WRAP.Geo.updateBounds(n.zoom,s,l,h,c)}}function i(t,e){t.feature=e,e.mouseover&&google.maps.event.addListener(t,"mouseover",function(){n.touch=t,this.feature.mouseover()}),e.mouseout&&google.maps.event.addListener(t,"mouseout",function(){n.touch=t,this.feature.mouseout()}),e.touch&&google.maps.event.addListener(t,"click",function(){n.touch=t,this.feature.touch()})}var n=this;this.map=t,this.markers=[],this.lines=[],this.touch=null,this.zoom=t.getZoom(),this.center=t.getCenter(),this.projection=t.getProjection(),this.bounds=t.getBounds(),window.setTimeout(function(){e()},1e3),google.maps.event.addListener(t,"zoom_changed",function(){n.projection=t.getProjection(),n.zoom=t.getZoom(),e()}),google.maps.event.addListener(t,"bounds_changed",function(){n.projection=t.getProjection(),n.center=t.getCenter(),n.zoom=t.getZoom(),n.bounds=t.getBounds(),n.touch&&(n.touch.feature&&n.touch.feature.mouseout&&n.touch.feature.mouseout(),n.touch=null),e()}),google.maps.event.addListener(t,"mousemove",function(t){n.mouse_point=new WRAP.Geo.Point(60*t.latLng.lat(),60*t.latLng.lng()),n.mouse_screenpoint=new WRAP.Geo.ScreenPoint(t.pixel.x,t.pixel.y)}),google.maps.event.addListener(t,"click",function(t){n.mouse_point=new WRAP.Geo.Point(60*t.latLng.lat(),60*t.latLng.lng()),n.mouse_screenpoint=new WRAP.Geo.ScreenPoint(t.pixel.x,t.pixel.y)}),this.setOverLandLayer=function(t){this.map.overlayMapTypes.setAt(WRAP.Geo.map.overland_layer_index,t?WRAP.Geo.map.overland_layer:null)},this.clear=function(){for(;this.markers.length;)this.markers.pop().setMap(null);for(;this.lines.length;)this.lines.pop().setMap(null)},this.clearStart=function(){this.save_markers=this.markers,this.save_lines=this.lines,this.markers=[],this.lines=[]},this.clearEnd=function(){var t;if(this.save_markers&&(t=this.save_markers.length))for(var e=0;e<t;e++)this.save_markers[e].setMap(null);if(this.save_lines&&(t=this.save_lines.length))for(var e=0;e<t;e++)this.save_lines[e].setMap(null);this.save_markers=[],this.save_lines=[]},this.render=function(t){for(var e=0;e<t.length;e++){var n=t[e];if("image"==n.type){var o={url:n.image,scaledSize:new google.maps.Size(n.width,n.height),anchor:new google.maps.Point(n.offset_x,n.offset_y)},r=new google.maps.Marker({map:this.map,position:new google.maps.LatLng(n.point.latDegree(),n.point.lonDegree()),icon:o});this.markers.push(r),i(r,n)}else if("line"==n.type){for(var a=[],s=0;s<n.path.length;s++)a.push(new google.maps.LatLng(n.path[s].latDegree(),n.path[s].lonDegree()));var l=new google.maps.Polyline({map:this.map,path:a,strokeColor:n.strokeStyle,strokeOpacity:1,strokeWeight:n.strokeWidth});this.lines.push(l)}else if("point"==n.type){var h=document.createElement("canvas"),c=h.getContext("2d"),u=2*(n.pointSize/2+(n.strokeWidth?n.strokeWidth:0))+2,d=u;h.width=u,h.height=d;var m=u/2,f=d/2;n.fillStyle&&(c.fillStyle=n.fillStyle,c.beginPath(),c.arc(m,f,u/2-1,0,2*Math.PI,!0),c.fill()),n.strokeStyle&&(c.strokeStyle=n.strokeStyle,c.stroke.width=1,c.beginPath(),c.arc(m,f,u/2-1,0,2*Math.PI,!0),c.stroke()),c.closePath();var r=new google.maps.Marker({map:this.map,position:new google.maps.LatLng(n.point.latDegree(),n.point.lonDegree()),icon:{url:h.toDataURL("image/png"),anchor:new google.maps.Point(m,f)}});this.markers.push(r),i(r,n)}else if("text"==n.type){var h=document.createElement("canvas"),c=h.getContext("2d"),p=n.fontSize?n.fontSize:13;c.font=p+"px Arial";var u=Math.ceil(c.measureText(n.text).width)+1,d=p+2;h.width=u,h.height=d;var m=u/2-parseFloat(n.offsetX?n.offsetX:0),f=p/2-parseFloat(n.offsetY?n.offsetY:0);c.beginPath(),c.font=p+"px Arial",n.strokeStyle&&(c.strokeStyle=n.strokeStyle,c.strokeWidth=n.strokeWidth?eature.strokeWidth:2,c.strokeText(n.text,0,p-1)),n.fillStyle&&(c.fillStyle=n.fillStyle,c.fillText(n.text,1,p)),c.closePath();var r=new google.maps.Marker({map:this.map,position:new google.maps.LatLng(n.point.latDegree(),n.point.lonDegree()),icon:{url:h.toDataURL("image/png"),anchor:new google.maps.Point(m,f)}});this.markers.push(r)}}},this.getScreenPoint=function(e){if(this.projection){var i=this.projection.fromLatLngToPoint(new google.maps.LatLng(e.latDegree(),e.lonDegree())),n=this.projection.fromLatLngToPoint(this.center),o=i.x-n.x,r=i.y-n.y;o<-128&&(o+=256),r>=128&&(o-=256);var a=Math.pow(2,this.zoom),s=.5*t.getDiv().offsetWidth+o*a,l=.5*t.getDiv().offsetHeight+r*a;return new WRAP.Geo.ScreenPoint(parseInt(s),parseInt(l))}return new WRAP.Geo.ScreenPoint(0,0)},this.getPoint=function(e){if(this.projection){var i=e.x-.5*t.getDiv().offsetWidth,n=e.y-.5*t.getDiv().offsetHeight,o=this.projection.fromLatLngToPoint(this.center),r=Math.pow(2,this.zoom),a=o.x+i/r,s=o.y+n/r,l=this.projection.fromPointToLatLng(new google.maps.Point(a,s));return new WRAP.Geo.Point(60*l.lat(),60*l.lng())}return new WRAP.Geo.Point(0,0)},this.getCenterPoint=function(){return new WRAP.Geo.Point(60*n.center.lat(),60*n.center.lng())},this.setCenterPoint=function(e){t.setCenter(this.center=new google.maps.LatLng(e.latDegree(),e.lonDegree()))},this.getZoom=function(){return this.zoom},this.setZoom=function(e){t.setZoom(this.zoom=e)},this.getPerspective=function(e,i){if(!this.projection||!e||!e.length)return{center:this.getCenterPoint(),zoom:this.zoom};void 0===i&&(i=0);for(var n=e[0].lat,o=e[0].lon,r=n,a=n,s=o,h=o,c=1;c<e.length;c++){var n=e[c].lat,u=e[c].lon-o;o=u>=10800?e[c].lon-21600:l<-10800?e[c].lon+21600:e[c].lon,s>o&&(s=o),h<o&&(h=o),r>n&&(r=n),a<n&&(a=n)}o<-10800?o+=21600:o>=10800&&(o-=21600);var d=this.projection.fromLatLngToPoint(new google.maps.LatLng(r/60,s/60)),m=this.projection.fromLatLngToPoint(new google.maps.LatLng(a/60,h/60)),f=(d.y+m.y)/2,p=(m.x+d.x)/2,g=this.projection.fromPointToLatLng(new google.maps.Point(p,f));n=g.lat(),o=g.lng();var v=d.y-m.y,_=Math.abs(m.x-d.x),y=t.getDiv().offsetWidth-2*i,b=t.getDiv().offsetHeight-2*i,w=Math.log(2),P=v>0?Math.log(b/v)/w:this.zoom,x=_>0?Math.log(y/_)/w:this.zoom,A=Math.floor(P<x?P:x);return A>19&&(A=19),{center:new WRAP.Geo.Point(60*n,60*o),zoom:A}},this.getDistance=function(t,e){var i=new google.maps.LatLng(t.latDegree(),t.lonDegree()),n=new google.maps.LatLng(e.latDegree(),e.lonDegree());return google.maps.geometry.spherical.computeDistanceBetween(i,n)},this.getCurrentPoint=function(){return{point:this.mouse_point,screenpoint:this.mouse_screenpoint}},this.getTMSPoint=function(t,e,i){var n=Math.pow(2,parseInt(t)),o=256*parseFloat(e)/n,r=256*(n-parseFloat(i)-1)/n,a=this.projection.fromPointToLatLng(new google.maps.Point(o,r));return new WRAP.Geo.Point(60*a.lat(),60*a.lng())}},WRAP.Geo.Renderer.GASS_Scale=function(){this.render=function(){},this.readyTile=function(t,e,i,n,o){if(!e||!e.validtime)return!0;var r=e.basetime+"/"+e.validtime;return!!t._handler().getTile(r,i,n,o)||(t._handler().loadTile(r,i,n,o,function(){WRAP.Geo.drawTiles(i,n,o)}),!1)},this.renderTile=function(t,e,i,n,o,r,a){if(i&&i.validtime){var s=i.basetime+"/"+i.validtime,l=e._handler().getTile(s,n,o,r);if(l&&!l.empty){var h=a.Attributes,c=h.vis3,u=h.vis2,d=h.cig3,m=h.cig2,f=h.color1,p=h.color2,g=h.color3,v=document.createElement("canvas");v.width=3,v.height=1;var _=v.getContext("2d");_.fillStyle=f,_.fillRect(0,0,1,1),_.fillStyle=p,_.fillRect(1,0,1,1),_.fillStyle=g,_.fillRect(2,0,1,1),f=_.getImageData(0,0,1,1).data,p=_.getImageData(1,0,1,1).data,g=_.getImageData(2,0,1,1).data;var y=f[3]/255;f[0]*=y,f[1]*=y,f[2]*=y,y=1-y;var b=p[3]/255;p[0]*=b,p[1]*=b,p[2]*=b,b=1-b;var w=g[3]/255;g[0]*=w,g[1]*=w,g[2]*=w,w=1-w;for(var P=l.data,x=l.width,A=256/x,W=t.data,R=0,G=0;G<x;G++)for(var L=0;L<x;L++){var k=P[R++],T=P[R++],S=P[R++],M=P[R++],D=256*k+T,I=256*S+M;if(0!=D||0!=I){var z=y,C=f;D<=c||I<=d?(z=w,C=g):(D<=u||I<=m)&&(z=b,C=p);for(var E=(256*G+L)*(4*A),H=0;H<A;H++){for(var F=E,N=0;N<A;N++){var j=W[F],O=W[F+1],B=W[F+2],q=W[F+3];W[F]=j*z+C[0],W[F+1]=O*z+C[1],W[F+2]=B*z+C[2],W[F+3]=q*z+C[3],F+=4}E+=1024}}}}}},this.preload=function(t,e,i,n,o){if(e&&e.next_basetime&&e.next_validtime){var r=e.next_basetime+"/"+e.next_validtime;t._handler().loadTile(r,i,n,o,function(){})}}},WRAP.Geo.Renderer.Lightning=function(){this.render=function(t,e,i,n){if(t){e.length=0;var o=n.Attributes.style.default,r=o.icon,a=o.icon_width,s=o.icon_height,l=o.icon_offset_x,h=o.icon_offset_y,c=i.query("data.updatedtime").value(),u=i.query("data.array").value();if(r&&c&&u){c=WRAP.DH._time(c);for(var d=u.length,m=0;m<d;m++)for(var f=u[m],p=WRAP.DH._time(f.time),g=WRAP.DH._elapsed(p,c)/60,v=0;v<r.length;v++)if(parseInt(r[v].ge)<=g&&g<parseInt(r[v].lt)){var _=new WRAP.Geo.Feature("image");_.point=new WRAP.Geo.Point(f.lat,f.lon),_.image=r[v].image,_.width=a,_.height=s,_.offset_x=l,_.offset_y=h,e.push(_);break}}}}},WRAP.Geo.Renderer.LiveCamera=function(){function t(t,e){t.img=null;var n=new Image;n.onload=function(){t.img=[];for(var e=document.createElement("canvas"),o=e.getContext("2d"),r=0;r<i;r++){var a=r*(360/i)*Math.PI/180;e.width=32,e.height=32;var s=e.width/2,l=e.height/2;o.save(),o.translate(s,l),o.rotate(a),o.translate(-s,-l),o.drawImage(n,0,0,32,32),o.restore();var h=e.toDataURL("image/png");t.img.push(h)}},n.onerror=function(){t.img=[];for(var n=0;n<i;n++)t.img.push(e)},n.src=t.url}var e=this,i=16,n={t:{},s:{},a:{}};this.render=function(o,r,a,s){r.length=0;var l=s.Attributes.style.default,h=l.icon_width,c=l.icon_height,u=l.icon_offset_x,d=l.icon_offset_y,m=l.icon_nondir,f=l.icon_t,p=l.icon_s,g=l.icon_a;if(m&&f&&p&&g){if(n.a.url!=g&&(n.a.url=g,t(n.a,m)),n.s.url!=p&&(n.s.url=p,t(n.s,p)),n.t.url!=f&&(n.t.url=f,t(n.t,m)),!n.a.img||!n.s.img||!n.t.img)return void setTimeout(function(){e.render(o,r,a,s)},500);var v=a.query("data").value();if(v)for(var _ in v){var y=v[_];if(y.lat&&y.lon){var b=new WRAP.Geo.Feature("image");if(b.set(o,a.query("data."+_)),b.point=new WRAP.Geo.Point(y.lat,y.lon),b.width=h,b.height=c,b.offset_x=u,b.offset_y=d,y.dir){var w=Math.floor((y.dir+360/(2*i))/(360/i));w%=i,b.image=n.s.img[w]}else b.image=m;r.push(b)}}}}},WRAP.Geo.Renderer.RendezvousPoint=function(){this.render=function(t,e,i,n){e.length=0;var o=n.Attributes.type,r=n.Attributes.style.default,a=r.icon,s=r.icon_width,l=r.icon_height,h=r.icon_offset_x,c=r.icon_offset_y,u=r.line_color,d=r.line_width,m=i.query("data").value();if(a&&m)for(var f=m.length,p=0;p<f;p++){var g=m[p];if(g.type==o&&g.display){var v=g.circle_num?parseInt(g.circle_num):0,_=g.circle_dist?parseFloat(g.circle_dist):0;if(v&&_>0){for(var y=new WRAP.Geo.Point(g.lat,g.lon),b=new WRAP.Geo.Point(g.lat,g.lon+60),w=new WRAP.Geo.Point(g.lat-60,g.lon),P=WRAP.Geo.getDistance(y,b),x=WRAP.Geo.getDistance(y,w),A=P/x,W=_/(P/1852),R=W,G=0;G<v;G++){for(var L=96,k=[],T=0;T<=L;T++){var S=T*(2*Math.PI)/L,M=g.lat-R*A*Math.sin(S),D=g.lon+R*Math.cos(S);k.push(new WRAP.Geo.Point(M,D))}var I=new WRAP.Geo.Feature("line");I.path=k,I.strokeStyle=u,I.strokeWidth=d,e.push(I),R+=W}R-=.75*W;for(var L=12,T=0;T<=L;T++){var k=[],S=T*(2*Math.PI)/L,M=g.lat-R*A*Math.sin(S),D=g.lon+R*Math.cos(S);k.push(y),k.push(new WRAP.Geo.Point(M,D));var I=new WRAP.Geo.Feature("line");I.path=k,I.strokeStyle=u,I.strokeWidth=d,e.push(I)}R=W;for(var G=0;G<v;G++){for(var L=4,T=0;T<L;T++){var S=T*(2*Math.PI)/L,M=-R*A*Math.sin(S)+g.lat,D=R*Math.cos(S)+g.lon,z=new WRAP.Geo.Feature("text");0==T?(z.offsetX=-10,z.offsetY=-10):1==T?(z.offsetX=-10,z.offsetY=-10):2==T?(z.offsetX=10,z.offsetY=-10):3==T&&(z.offsetX=-10,z.offsetY=10),z.point=new WRAP.Geo.Point(M,D),z.text=_*(G+1),z.fillStyle=u,e.push(z)}R+=W}}var C=new WRAP.Geo.Feature("image");C.set(t,i.query("data["+p+"]")),C.point=new WRAP.Geo.Point(g.lat,g.lon),C.image=a,C.width=s,C.height=l,C.offset_x=h,C.offset_y=c,e.push(C)}}}},WRAP.Geo.Renderer.TMS=function(){this.render=function(){},this.readyTile=function(t,e,i,n,o){return!e||!e.validtime||(!!t._handler().getTile(e.validtime,i,n,o)||(t._handler().loadTile(e.validtime,i,n,o,function(){WRAP.Geo.drawTiles(i,n,o)}),!1))},this.renderTile=function(t,e,i,n,o,r){if(i&&i.validtime){var a=e._handler().getTile(i.validtime,n,o,r);if(a&&!a.empty)for(var s=a.width,l=a.data,h=256/s,c=t.data,u=0,d=0;d<s;d++)for(var m=0;m<s;m++){var f=l[u++],p=l[u++],g=l[u++],v=l[u++];if(0!=v)for(var _=v/255,y=1-_,b=(256*d+m)*(4*h),w=0;w<h;w++){for(var P=b,x=0;x<h;x++){var A=c[P],W=c[P+1],R=c[P+2],G=c[P+3];c[P]=A*y+f,c[P+1]=W*y+p,c[P+2]=R*y+g,c[P+3]=G*y+v,P+=4}b+=1024}}}},this.preload=function(t,e,i,n,o){e&&e.next_validtime&&t._handler().loadTile(e.next_validtime,i,n,o,function(){})}},WRAP.Geo.Renderer.CoPilot=function(){this.render=function(t,e,i,n){e.length=0;var o=n.Attributes.type,r=n.Attributes.route,a=n.Attributes.style.default,s=a.icon,l=a.icon_width,h=a.icon_height,c=a.icon_offset_x,u=a.icon_offset_y,d=a.point_size,m=a.point_color,f=a.line_color,p=a.line_width,g=i.query("data").value();if(s&&g)for(var v=g.length,_=0;_<v;_++){var y=g[_];if(y.type==o){if(r){var b=y.past_position&&y.past_position.length;if(b){var w=[];w.push(new WRAP.Geo.Point(y.lat,y.lon));for(var P=0;P<b;P++){var x=y.past_position[P];w.push(new WRAP.Geo.Point(x.lat,x.lon))}var A=new WRAP.Geo.Feature("line");A.path=w,A.strokeStyle=f,A.strokeWidth=p,e.push(A);for(var P=0;P<b;P++){var x=y.past_position[P],A=new WRAP.Geo.Feature("point");A.set(t,i.query("data["+_+"].past_position["+P+"]")),A.point=new WRAP.Geo.Point(x.lat,x.lon),A.strokeStyle=f,A.strokeWidth=p,A.fillStyle=m,A.pointSize=d,e.push(A)}}}var W=new WRAP.Geo.Feature("image");W.set(t,i.query("data["+_+"]")),W.point=new WRAP.Geo.Point(y.lat,y.lon),W.image=s,W.width=l,W.height=h,W.offset_x=c,W.offset_y=u,e.push(W)}}}};var MapInteraction;"undefined"==typeof MapInteraction&&(MapInteraction=function(){function t(t){return("number"==typeof t||"string"==typeof t)&&(t==parseFloat(t)&&isFinite(t))}function e(t,e){var i={lat:"",lon:""},n="N";t<0&&(t=-t,n="S");var o="E";e<0&&(e=-e,o="W");var r,a,s;return r=Math.floor(t/60),a=60*(t-60*r),s=Math.floor(a),i.lat+=r,i.lat+="°",i.lat+=s,i.lat+="'",i.lat+=n,r=Math.floor(e/60),a=60*(e-60*r),s=Math.floor(a),i.lon+=r,i.lon+="°",i.lon+=s,i.lon+="'",i.lon+=o,i}function i(e){if(!t(e))return"";for(e+=11.25;e<0;)e+=360;for(;e>=360;)e-=360;return e=Math.floor(e/22.5),j[e]}function n(t,n,o){var n=n.value();if(n){var r;if(0==t.name().indexOf("RendezvousPoint")){var a=e(n.lat,n.lon);r="地点名: "+n.name+"<br/>緯度経度: "+a.lat+" "+a.lon+"<br/>登録情報: "+(n.remarks?n.remarks:"")}else if(0==t.name().indexOf("CoPilot")){var a=e(n.lat,n.lon),s=WRAP.DH._setTime(WRAP.DH._time(n.obs_time),32400),l=WRAP.DH._timeString(s,"/"," ",":");r="表示機番名: "+n.name+"<br/>FOSTER-CoPilot番号: "+n.copilot_no+"<br/>入電時刻(JST): "+l.substr(0,16)+"<br/>高度: "+n.hgt+"FT<br/>対地速度: "+n.gps_spd+"KT<br/>向き: "+i(n.heading)+"<br/>緯度経度: "+a.lat+" "+a.lon+"<br/>バッテリー状況: "+(n.battery?n.battery:"")}else if(0==t.name().indexOf("LiveCamera")){var h;if((h=f(n.area_name))||(h=new g(n)),p(h),y!=h){var m=y;y&&y.tooltip&&y.hide(),y=h,m&&m.set(),y.visible||(y.tooltip=!0,h.show(n.lat,n.lon)),y.set()}}if(r&&r.length)return c(r),void d(o.x,o.y)}u()}function o(t){if(u(),0==t.name().indexOf("LiveCamera")){y&&y.tooltip&&y.hide();var e=y;y=null,e&&e.set()}}function r(t,e){u(),0==t.name().indexOf("LiveCamera")&&y&&y.tooltip&&(e.query("image").load(function(){}),y.tooltip=!1,y.set())}function a(){for(var t=0;t<W.length;t++){var e=W[t];if(e.pinned){var i=WRAP.Geo.getScreenPoint(e.window.point);i.x+=R,i.y+=R,e.window.style.left=i.x+"px",e.window.style.top=i.y+"px"}}}function s(t){if(0==t.name().indexOf("LiveCamera")){for(var e=0;e<W.length;e++){var i=W[e];t.visible()?i.window.style.display=i.visible?"block":"none":(i.window.style.display="none",i.setImage(0)),i.animating=!1}MapInteraction.live_camera._data.handler&&(MapInteraction.live_camera._data.handler.auto_update=t.visible())&&MapInteraction.live_camera.load()}}function l(t){var e=document.createElement("style"),i=document.createTextNode(t);e.media="screen",e.type="text/css",e.styleSheet?e.styleSheet.cssText=i.nodeValue:e.appendChild(i),document.getElementsByTagName("head")[0].appendChild(e)}function h(){if(!_){_=document.createElement("div"),v.appendChild(_),_.style.display="block",_.style.top="-1000px",_.style.left="-1000px";var t=".tooltip {position: absolute;background: "+w+";color: "+P+";border: 1px solid "+x+";padding: 10px;    border-radius: 6px;    z-index: "+b+";    pointer-events: none;}.lt-arrow:after, .lt-arrow:before {right: 100%;top: "+A+"px;border: solid transparent;content: ' ';height: 0;width: 0;position: absolute;}.lt-arrow:after {    border-right-color: "+w+";    border-width: 8px;    margin-top: -8px;}.lt-arrow:before {    border-right-color: "+x+";    border-width: 9px;    margin-top: -9px;}.lb-arrow:after, .lb-arrow:before {right: 100%;bottom: "+A+"px;border: solid transparent;content: ' ';height: 0;width: 0;position: absolute;}.lb-arrow:after {    border-right-color: "+w+";    border-width: 8px;    margin-top: -8px;}.lb-arrow:before {    border-right-color: "+x+";    border-width: 9px;    margin-top: -9px;}.rt-arrow:after, .rt-arrow:before {left: 100%;top: "+A+"px;border: solid transparent;content: ' ';height: 0;width: 0;position: absolute;}.rt-arrow:after {    border-left-color: "+w+";    border-width: 8px;    margin-top: -8px;}.rt-arrow:before {    border-left-color: "+x+";    border-width: 9px;    margin-top: -9px;}.rb-arrow:after, .rb-arrow:before {left: 100%;bottom: "+A+"px;border: solid transparent;content: ' ';height: 0;width: 0;position: absolute;}.rb-arrow:after {    border-left-color: "+w+";    border-width: 8px;    margin-top: -8px;}.rb-arrow:before {    border-left-color: "+x+";    border-width: 9px;    margin-top: -9px;}";l(t)}}function c(t){_&&(_.innerHTML=t)}function u(){_&&(_.style.display="none",_.innerHTML="")}function d(t,e){if(_&&_.innerHTML){var i=_.parentNode.clientWidth,n=_.parentNode.clientHeight;if(t<0||t>=i||e<0||e>=n)return void(_.style.display="none");_.style.display="block";var o=_.clientWidth,r=_.clientHeight;o>=i&&(o=0);var a,s,l=26,h=14,c=h+A;t+o+2*l>=i?(t-=o+l,a=" r"):(t+=l,a=" l"),e<c?e=h:e>=n-h-A?e=n-h-r:e+r-A>=n-c?(e-=r-A-2,s="b-arrow"):(e-=A,s="t-arrow");var u="tooltip";a&&s&&(u+=a+s),_.style.top=""+e+"px",_.style.left=""+t+"px",_.setAttribute("class",u)}}function m(t){MapInteraction.live_camera=t;var e=".smooth_tran {-webkit-transition-duration : 0.2s;-moz-transition-duration : 0.2s;-o-transition-duration : 0.2s;-ms-transition-duration : 0.2s;}.current_window {box-shadow : 0px 0px 50px #fff;border: 1px solid #fff;}.live_camera {position: absolute;background-color: "+z+";border: 1px solid "+C+";user-select: none;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;}.small_window {width: "+E+"px;height: "+(H+D)+"px;}.middle_window {width: "+F+"px;height: "+(N+D+I)+"px;}.image_s {position: absolute;width: 100%;height: "+H+"px;top: "+D+"px;background-color: #bbb;}.image_m {position: absolute;width: 100%;height: "+N+"px;top: "+D+"px;background-color: #bbb;}.camera_button {position: absolute;width:20px;height:20px;padding:0;border:solid 1px rgba(0,0,0,0);border-radius:4px;cursor:pointer;user-select: none;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;}.camera_button:hover {border:solid 1px rgba(150,150,150,0.8);}.camera_zoomin {top:3px; right:28px;background:url(img/bt_zoomIn.png) no-repeat left top;}.camera_zoomout {top:3px; right:28px;background:url(img/bt_zoomOut.png) no-repeat left top;}.camera_close {top:3px; right:4px;background:url(img/closebtn.png) no-repeat left top;}.camera_text {user-select: none;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;cursor:default;position: absolute;font-size:11px;color:black;width:100px;height:10px;}.camera_name {top:0px; left:4px;}.camera_time {top:11px; left:4px;}.camera_time_button {font-size:10px;color:black;position: absolute;bottom:1px;width:32px;height:18px;padding:0;vertical-align:middle;border:solid 1px rgba(120,120,120,1.0);border-radius:4px;background-color: "+z+";cursor:pointer;}.camera_time_button:hover {background: #fefeff;}.camera_time_button:disabled {color:#999;border:solid 1px rgba(170,170,170,0.8);pointer-events: none;cursor:default;}";l(e),t.inspect(function(){for(var t=0;t<W.length;t++){var e=W[t];e.visible&&!e.animating&&0==e.index&&e.setImage(e.index)}})}function f(t){for(var e=0;e<W.length;e++)if(W[e].camera.area_name==t)return W[e];return null}function p(t){for(var e=L,i=0;i<W.length;){var n=W[i];if(n==t){for(var o=i+1;o<W.length;)n=W[o-1]=W[o],n.window.style["z-index"]=e++,o++;W[o-1]=t;break}n.window.style["z-index"]=e++,i++}i==W.length&&W.push(t),t.window.style["z-index"]=e}function g(t){var e=this;this.camera=t,this.visible=!1,this.small=!0,this.pinned=!0,this.tooltip=!0,this.animating=!1,this.smooth=!1;var i=this.window=document.createElement("div");i.controller=this,i.style.display="none",i.setAttribute("class","live_camera small_window");var n=this.canvas=document.createElement("div");n.width=k,n.height=T,n.setAttribute("class","image_s"),i.appendChild(this.name=document.createElement("div")),this.name.setAttribute("class","camera_text camera_name"),i.appendChild(this.time=document.createElement("div")),this.time.setAttribute("class","camera_text camera_time"),i.appendChild(this.zoom=document.createElement("button")),this.zoom.setAttribute("class","camera_button camera_zoomin"),i.appendChild(this.close=document.createElement("button")),this.close.setAttribute("class","camera_button camera_close");var o;i.appendChild(o=this.time_frst=document.createElement("button")),o.setAttribute("class","camera_time_button"),o.innerHTML="|＜",o.style.left="100px",o.style.display="none",i.appendChild(o=this.time_prev=document.createElement("button")),o.setAttribute("class","camera_time_button"),o.innerHTML="＜",o.style.left="140px",o.style.display="none",i.appendChild(o=this.time_play=document.createElement("button")),o.setAttribute("class","camera_time_button"),o.innerHTML="▶",o.style.left="180px",o.style.display="none",i.appendChild(o=this.time_next=document.createElement("button")),o.setAttribute("class","camera_time_button"),o.innerHTML="＞",o.style.left="220px",o.style.display="none",i.appendChild(o=this.time_last=document.createElement("button")),o.setAttribute("class","camera_time_button"),o.innerHTML="＞|",o.style.left="260px",o.style.display="none",i.appendChild(n),this.setImage=function(i){if(n=this.canvas,n.innerHTML="",this.index=i,this.name.innerHTML=t.l_name,this.time.innerHTML="--",t.image&&t.image.length){i<0&&(i=0),i>=t.image.length&&(i=t.image.length-1);var o=t.image[i];o.image&&(n.width=o.image.width||600,n.height=o.image.height||480,o.image.style.width="100%",o.image.style.height="100%",o.image.style["pointer-events"]="none",n.appendChild(o.image));var r=WRAP.DH._timeString(WRAP.DH._setTime(WRAP.DH._time(o.time),32400)),a=Number(r.substr(6,2)),s=Number(r.substr(9,2)),l=Number(r.substr(11,2));this.time.innerHTML=""+a+"日 "+s+"時 "+l+"分",e.time_frst.disabled=i==t.image.length-1,e.time_prev.disabled=i==t.image.length-1,e.time_play.disabled=t.image.length<=1,e.time_next.disabled=0==i,e.time_last.disabled=0==i}else e.time_frst.disabled=!0,e.time_prev.disabled=!0,e.time_play.disabled=!0,e.time_next.disabled=!0,e.time_last.disabled=!0;this.index=i},this.close.onclick=function(){e.hide()},this.zoom.onclick=function(){e.smooth=!0,e.small?(e.small=!1,
e.set()):(e.small=!0,e.set())},this.animate=function(){if(!e.animating)return void(e.time_play.innerHTML="▶");e.time_play.innerHTML="■";var t=e.index-1;t<0&&(t=e.camera.image.length-1),e.setImage(t),setTimeout(function(){e.animate()},500)},this.time_frst.onclick=function(){e.setImage(e.camera.image.length-1)},this.time_prev.onclick=function(){e.setImage(e.index+1)},this.time_play.onclick=function(){(e.animating=!e.animating)&&e.animate()},this.time_next.onclick=function(){e.setImage(e.index-1)},this.time_last.onclick=function(){e.setImage(0)},i.onmousedown=function(t){B=this,q=i.style.left.replace(/px/,""),Z=i.style.top.replace(/px/,""),X=t.clientX-q,Y=t.clientY-Z,p(B.controller)},i.onmouseup=function(){B=!1},i.onmousemove=function(t){if(B){var e=t.clientX-X,i=t.clientY-Y;B.controller.pinned=!0,B.point=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(e-R,i-G)),B.style.left=e+"px",B.style.top=i+"px"}},this.set=function(){var t=e.smooth?"smooth_tran ":"";t+="live_camera",t+=e.small?" small_window":" middle_window",this.tooltip||this!=y||(t+=" current_window"),e.window.setAttribute("class",t),t=e.smooth?"smooth_tran ":"",t+=e.small?" image_s":" image_m",e.canvas.setAttribute("class",t),e.zoom.setAttribute("class",e.small?"camera_button camera_zoomin":"camera_button camera_zoomout"),e.time_frst.style.display=e.small?"none":"block",e.time_prev.style.display=e.small?"none":"block",e.time_play.style.display=e.small?"none":"block",e.time_next.style.display=e.small?"none":"block",e.time_last.style.display=e.small?"none":"block",e.zoom.style.display=e.tooltip?"none":"block",e.close.style.display=e.tooltip?"none":"block",!e.small&&e.visible||(e.animating=!1),e.small&&e.setImage(0),e.smooth&&setTimeout(function(){e.smooth=!1,e.set()},250)},this.show=function(t,i){e.set(),e.visible=!0,this.window.point=new WRAP.Geo.Point(t,i);var n=WRAP.Geo.getScreenPoint(this.window.point);n.x+=R,n.y+=R,this.window.style.top=""+n.y+"px",this.window.style.left=""+n.x+"px",this.window.style.display="block"},this.hide=function(){this.window.style.display="none",e.visible=!1,e.small=!0,e.animating=!1,e.setImage(0)},v.appendChild(i),this.setImage(0)}for(var v,_,y,b=1e4,w="#2e3a54",P="#ffffff",x="#ffffff",A=20,W=[],R=10,G=10,L=2e4,k=640,T=480,S=.3,M=.6,D=26,I=20,z="#f2f2f2",C="rgba(150,150,150,0.6)",E=Math.floor(k*S),H=Math.floor(T*S),F=Math.floor(k*M),N=Math.floor(T*M),j=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"],O=0;O<16;O++)j[O]=j[O].replace(/N/g,"北").replace(/S/g,"南").replace(/W/g,"西").replace(/E/g,"東");var B,q,Z,X,Y;return{init:function(t,e){v=e,h(),m(t),WRAP.Geo.addEventHandler("mouseover",n),WRAP.Geo.addEventHandler("mouseout",o),WRAP.Geo.addEventHandler("touch",r),WRAP.Geo.addEventHandler("boundsChange",a),WRAP.Geo.addEventHandler("visibilityChange",s)},alignLiveCamera:function(){for(var t=0;t<W.length;t++){var e=W[t];e.pinned=!0}for(var i=v.clientLeft,n=v.clientTop,o=i+v.clientWidth,r=n+v.clientHeight,a=10,s=E+a,l=H+D+a,h=a;h+s<o;h+=s)for(var c=a;c+l<r;c+=l){for(var u=99999999,d=null,t=0;t<W.length;t++){var e=W[t];if(e.pinned&&e.visible){var m=e.window.style.left.replace(/px/,""),f=e.window.style.top.replace(/px/,""),p=m-h,g=f-c,_=p*p+g*g;u>_&&(u=_,d=e)}}d&&(d.smooth=!0,d.small=!0,d.pinned=!1,d.window.point=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(h,c)),d.window.style.left=h+"px",d.window.style.top=c+"px",d.set())}}}}());
//# sourceMappingURL=../build/js/WRAP.Geo-1.0.0.1-min.js.map