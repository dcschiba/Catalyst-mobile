<!DOCTYPE html>
<html style="width:100%; height:100%; margin:0; padding:0; font-family: 'Helvetica Neue', Helvetica, sans-serif !important; font-size: 13px;">
    <head>
        <meta charset="utf-8">
        <title>WRAP Mercury Lightning Sample</title>
        <script src="https://maps.googleapis.com/maps/api/js?client=gme-weathernewsinc&libraries=geometry"></script>
        <script type="text/javascript" src="3rd/js/jquery-1.10.2.min.js"></script>
        <script type="text/javascript" src="js/WRAP.DH-1.1.0.0.js"></script>
        <script type="text/javascript" src="js/WRAP.Geo-1.1.0.0.js"></script>
        <script type="text/javascript" src="js/WRAP.Core-1.1.0.0.js"></script>
        <script type="text/javascript" src="js/WRAP.ASM.js"></script>
    </head>
    <body style="width:100%; height:100%; margin:0; padding:0; background-color:rgb(255,255,255);">
        <div style="color:black; position:absolute; left:20px; top:8px;">Lightning</div>
        <div id="opacity_label" style="color:#555; position:absolute; left:140px; top:8px;">kind</div>
        <label style="position:absolute; width:60px; height:18px; left:180px; top:6px;">
            <input type="checkbox" id="kind_c" checked><spawn style="position:absolute; top:2px; left:20px;">C</spawn>
        </label>
        <label style="position:absolute; width:60px; height:18px; left:220px; top:6px;">
            <input type="checkbox" id="kind_g" checked><spawn style="position:absolute; top:2px; left:20px;">G</spawn>
        </label>
        <div id="display_count" style="position:absolute; left:300px; top:8px;">inside the screen bounds : </div>
        <div id="tooltip_state" style="position:absolute; left:500px; top:8px;">tooltip : </div>
        <a href="../doc/reference/sample_code/lightning.html" target="_blank" style="position:absolute; right:40px; top:8px;" >Document</a>

        <div id="map_canvas" style="position:absolute; top:30px; bottom:10px; left:10px; right:10px;"></div>
        <div id="message"></div>

        <script type="text/javascript">
            // Mapの初期画角
            var initial_lat = 32.0;
            var initial_lon = 127.5;
            var initial_zoom = 8;

            var conf_path = "./pri/conf";     // ローカルの sample_data用コンフィグを用いる
            
            // Setup Google Maps
            var map_canvas = document.getElementById('map_canvas');
            var g_map = new google.maps.Map(map_canvas, {
                zoom: initial_zoom,
                minZoom: 3,
                maxZoom: 15,
                center: new google.maps.LatLng(initial_lat, initial_lon),
                zoomControl: true,
                mapTypeControl: false,
                scaleControl: false,
                streetViewControl: false,
                draggableCursor: "default",
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });
            WRAP.Geo.setGoogleMaps(g_map)
            
            // Data
            WRAP.DH.conf_path = conf_path+"/data";
            var lightning_data = WRAP.DH.addObject("LightningSample");
            
            // Layers
            var lightning_layer = new WRAP.Geo.Layer("LightningSample");
            
            WRAP.Geo.setLayer({
                upper_layers : [
                    lightning_layer
                ]
            });

            // Configure Layers
            var conf_dir = "./pri/conf";
            // Configure Layers
            $.when(
                $.getJSON(conf_dir + '/layer/LightningSample.json')
            ).done(function() {
                lightning_layer.configure(lightning_data, arguments[0]);
            });
            
            // Tooltip
            WRAP.Geo.setInteraction(map_canvas);
            lightning_layer.setTooltip(function(geo) {
                var p = geo && geo.properties;
                if ( p ) {
                    var lat = geo.geometry.coordinates[1];
                    var lon = geo.geometry.coordinates[0];
                    var ad = p.announced_date;
                    var ad_text = ad.substr(0,4)+"/"+ad.substr(4,2)+"/"+ad.substr(6,2)+" "
                                + ad.substr(9,2)+":"+ad.substr(11,2)+":"+ad.substr(13,2);
                    var ot = p.obs_time;
                    var ot_text = ot.substr(0,4)+"/"+ot.substr(4,2)+"/"+ot.substr(6,2)+" "
                                + ot.substr(9,2)+":"+ot.substr(11,2)+":"+ot.substr(13,2);
                    return "pos : "+lat+" ,"+lon+"<br>"
                         + "announced_date : "+ad_text+"<br>"
                         + "obs_time : "+ot_text+"<br>"
                         + "kind : "+p.kind+"<br>"
                         + "peak_current : "+p.peak_current;
                }
                tooltipStatus();
            });
            
            // 画角変化の監視
            var screen_bounds;
            WRAP.Geo.addEventHandler('boundsChange', function(bounds) {
                screen_bounds = bounds;
                updateDisplayCount();
            });

            // 画角内の表示要素をカウントしてヘッダに表示
            function updateDisplayCount() {
                if ( !screen_bounds )
                    return;
                var count = 0;
                var root = lightning_data.query("data").value();
                if ( root && root.features ) {
                    for ( var i = 0 ; i < root.features.length ; i++ ) {
                        var prop = root.features[i].properties;
                        if ( prop.display_flag === false )
                            continue;
                        var geometry = root.features[i].geometry;
                        if ( screen_bounds.contains(new WRAP.Geo.Point(geometry.coordinates[1]*60, geometry.coordinates[0]*60)) )
                        count++;
                    }
                }
                $('#display_count').html("inside the screen bounds : "+count);
            }
        
            // チェック内容に応じて要素の表示状態をOn/Offする
            function updateDisplayFlag() {
                var c = $('#kind_c').prop('checked');
                var g = $('#kind_g').prop('checked');
                var root = lightning_data.query("data").value();
                if ( root && root.features ) {
                    for ( var i = 0 ; i < root.features.length ; i++ ) {
                        var prop = root.features[i].properties;
                        // GeoJSONオブジェクトの properties.display_flagを true（表示）または false（非表示）に設定する
                        if ( c && prop.kind == "C" )
                            prop.display_flag = true;
                        else if ( g && prop.kind == "G" )
                            prop.display_flag = true;
                        else
                            prop.display_flag = false;
                    }
                }
                lightning_layer.invalidate();   // レイヤーの再描画
                updateDisplayCount();
            }

            // ツールチップの表示/非表示状態を調べヘッダに表示
            function tooltipStatus() {
                var status = WRAP.Geo.currentTooltip();
                $('#tooltip_state').html("tooltip : "+(status?"displayed":"-"));
            }

            // UIイベントに応じて各処理を呼び出す
            map_canvas.addEventListener("mousemove", tooltipStatus);
            $('#kind_c').click(updateDisplayFlag);
            $('#kind_g').click(updateDisplayFlag);
            updateDisplayFlag();
            
        </script>
    </body>
</html>
