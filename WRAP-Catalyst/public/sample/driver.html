
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no">
        <title>WRAP Test Driver</title>
        <script src="https://maps.googleapis.com/maps/api/js?client=gme-weathernewsinc&channel=sky_bestway&libraries=geometry"></script>
        <script type="text/javascript" src="3rd/js/jquery-1.10.2.min.js"></script>
        <script type="text/javascript" src="js/WRAP.DH-1.0.0.0-min.js"></script>
        <script type="text/javascript" src="js/WRAP.Geo-1.0.0.1-min.js"></script>
        
        <link rel="stylesheet" type="text/css" href="test.css" />
    </head>
    <body>
        <!-- 画面上部 -->
        <div class="nav">
            <ul class="navbar">
                <li class="navtab" id="menu"></li>
                <li class="navtxt" id="lt_test">→ Lightning</li>
                <li class="navtxt" id="rp_test">→ RendezvousPoint</li>
                <li class="navtxt" id="cp_test">→ CoPilot</li>
                <li class="navmsg" id="Message">Message</li>
            </ul>
        </div>
        
        <!-- 画面コンテンツ部 -->
        <div id="main">
            <!-- 画面左側メニュー・パート -->
            <div id="sidepane">
                <div id="sidebar">
                    <span class="info" id="center"></span><br/>
                    <span class="info" id="zoom"></span><br/>
                    <span class="info" id="xy"></span><br/>
                    <span class="info" id="ll"></span><br/>
                    <div class="subtitle" >
                        <input type="checkbox" id="chk_cp" value="CoPilot" checked>
                        <label for="chk_cp">CoPilot</label>
                    </div>
                    <div class="sidebar_contents">
                        <span>updated : </span><span id="cp_time">--/-- --:-- Z</span><br/>
                        <input type="checkbox" id="chk_cp00" value="0" checked><label for="chk_cp00">タイプなし</label><br/>
                        <input type="checkbox" id="chk_cp10" value="10" checked><label for="chk_cp10">ヘリ通常</label><br/>
                        <input type="checkbox" id="chk_cp11" value="11" checked><label for="chk_cp11">ヘリ医療</label><br/>
                        <input type="checkbox" id="chk_cp20" value="20" checked><label for="chk_cp20">車通常</label><br/>
                        <input type="checkbox" id="chk_cp21" value="21" checked><label for="chk_cp21">車医療</label><br/>
                        <input type="checkbox" id="chk_cp30" value="30" checked><label for="chk_cp30">ビジネスジェット</label><br/>
                        <hr/>
                        <input type="checkbox" id="chk_cprt" value="cprt"><label for="chk_cprt">軌跡</label><br/>
                    </div>
                    <div class="subtitle" >
                        <input type="checkbox" id="chk_rp" value="RendezvousPoint" checked>
                        <label for="chk_rp">ランデブーポイント</label>
                    </div>
                    <div class="sidebar_contents">
                        <span>updated : </span><span id="rp_time">--/-- --:-- Z</span><br/>
                        <input type="checkbox" id="chk_rp10" value="10" checked><label for="chk_rp10">ヘリポート</label><br/>
                        <input type="checkbox" id="chk_rp20" value="20" checked><label for="chk_rp20">病院</label><br/>
                        <input type="checkbox" id="chk_rp30" value="30" checked><label for="chk_rp30">ランデブーポイント</label><br/>
                    </div>
                    <div class="subtitle" >
                        <input type="checkbox" id="chk_rd" value="Radar" disabled>
                        <label for="chk_rd">レーダー</label>
                    </div>
                    <div class="sidebar_contents">
                        <span>validtime : </span><select id="rd_vt" disabled><option value="" >--/-- --:--</option></select>
                        <div class="buttonContainer">
                            <div class="btn frst nop" id="rd_frst"></div>
                            <div class="btn prev nop" id="rd_prev"></div>
                            <div class="btn play nop" id="rd_play"></div>
                            <div class="btn next nop" id="rd_next"></div>
                            <div class="btn last nop" id="rd_last"></div>
                        </div>
                    </div>
                    <div class="subtitle" >
                        <input type="checkbox" id="chk_lt" value="Lightning" checked>
                        <label for="chk_lt">雷</label>
                    </div>
                    <div class="sidebar_contents">
                        <span>updated : </span><span id="lt_time">--/-- --:-- Z</span>
                    </div>
                    <div class="subtitle" >
                        <input type="checkbox" id="chk_lc" value="LiveCamera" disabled>
                        <label for="chk_lc">ライブカメラ</label>
                    </div>
                    <div class="sidebar_contents">
                        <span>updated : </span><span id="lc_time">--/-- --:-- Z</span>
                        <div class="btn tx nop" id="lc_align">整列</div>
                    </div>
                    <div class="subtitle" >
                        <input type="checkbox" id="chk_gs" value="GASSScale" disabled>
                        <label for="chk_gs">GASS Scale</label>
                    </div>
                    <div class="sidebar_contents">
                        <span>basetime : </span><select id="gs_bt" disabled><option value="">--/-- --:--</option></select>
                        <span>validtime : </span><select id="gs_vt" disabled><option value="">--/-- --:--</option></select>
                        <div class="buttonContainer">
                            <div class="btn frst nop" id="gs_frst"></div>
                            <div class="btn prev nop" id="gs_prev"></div>
                            <div class="btn play nop" id="gs_play"></div>
                            <div class="btn next nop" id="gs_next"></div>
                            <div class="btn last nop" id="gs_last"></div>
                        </div>
                    </div>
                    <div style="height:100px;"></div>
                    
                </div>
            </div>
            
            <!-- Google Maps 表示パート -->
            <div id="map_canvas" style="width:100%; height:100%;"></div>
        </div>

        <script type="text/javascript">
            // Setup Google Maps
            var map_canvas = document.getElementById('map_canvas');
            // Setup Google Maps
            var map = new google.maps.Map(map_canvas, {
                zoom: 10,
                minZoom: 3,
                center: new google.maps.LatLng(35.792621, 139.806513),
                zoomControl: true,
                mapTypeControl: false,
                scaleControl: false,
                streetViewControl: false,
                draggableCursor: "default",
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });
            
            // User
            WRAP.DH.setUser("WNI", "wni_root1");
            
            // Data
            //WRAP.DH.conf_path = "./pri/conf/data";
            var lightning_data = WRAP.DH.addObject("WX_JP_Lightning");
            var rendezvous_point_data = WRAP.DH.addObject("SKY_CUS_RendezvousPoint");
            var copilot_data = WRAP.DH.addObject("SKY_CUS_CoPilot");
            var radar_data = WRAP.DH.addObject("WX_JP_Radar");
            var gass_scale_data = WRAP.DH.addObject("SKY_JP_GASS_Scale");
            var live_camera_data = WRAP.DH.addObject("WX_LiveCamera");
            
            // Map
            WRAP.Geo.setGoogleMaps(map);
            
            // Layers
            var lightning_layer = new WRAP.Geo.Layer("Lightning");
            var rp10_layer = new WRAP.Geo.Layer("RendezvousPoint_10");
            var rp11_layer = new WRAP.Geo.Layer("RendezvousPoint_11");
            var rp12_layer = new WRAP.Geo.Layer("RendezvousPoint_12");
            var rp20_layer = new WRAP.Geo.Layer("RendezvousPoint_20");
            var rp30_layer = new WRAP.Geo.Layer("RendezvousPoint_30");
            var cp00_layer = new WRAP.Geo.Layer("CoPilot_00");
            var cp10_layer = new WRAP.Geo.Layer("CoPilot_10");
            var cp11_layer = new WRAP.Geo.Layer("CoPilot_11");
            var cp20_layer = new WRAP.Geo.Layer("CoPilot_20");
            var cp21_layer = new WRAP.Geo.Layer("CoPilot_21");
            var cp30_layer = new WRAP.Geo.Layer("CoPilot_30");
            var radar_layer = new WRAP.Geo.Layer("Radar");
            var gass_scale_layer = new WRAP.Geo.Layer("GASSScale");
            var live_camera_layer = new WRAP.Geo.Layer("LiveCamera");
            
            WRAP.Geo.setLayer({
                interactive_layers : [
                    // copilot layers
                    cp00_layer,
                    cp10_layer,
                    cp11_layer,
                    cp20_layer,
                    cp21_layer,
                    cp30_layer,
                    // rendezvous point layers
                    rp30_layer,
                    rp20_layer,
                    rp12_layer,
                    rp11_layer,
                    rp10_layer,
                    live_camera_layer,
                    lightning_layer,
                ],
                upper_layers : [
                    radar_layer,
                    gass_scale_layer
                ]
            });

            var conf_dir = "./pri/conf";
            // Configure Layers
            $.when(
                $.getJSON(conf_dir + '/layer/Lightning.json'),
                $.getJSON(conf_dir + '/layer/RendezvousPoint_10.json'),
                $.getJSON(conf_dir + '/layer/RendezvousPoint_11.json'),
                $.getJSON(conf_dir + '/layer/RendezvousPoint_12.json'),
                $.getJSON(conf_dir + '/layer/RendezvousPoint_20.json'),
                $.getJSON(conf_dir + '/layer/RendezvousPoint_30.json'),
                $.getJSON(conf_dir + '/layer/CoPilot_00.json'),
                $.getJSON(conf_dir + '/layer/CoPilot_10.json'),
                $.getJSON(conf_dir + '/layer/CoPilot_11.json'),
                $.getJSON(conf_dir + '/layer/CoPilot_20.json'),
                $.getJSON(conf_dir + '/layer/CoPilot_21.json'),
                $.getJSON(conf_dir + '/layer/CoPilot_30.json'),
                $.getJSON(conf_dir + '/layer/Radar.json'),
                $.getJSON(conf_dir + '/layer/GASS_Scale.json'),
                $.getJSON(conf_dir + '/layer/LiveCamera.json')
            ).done(function() {
                var i = 0;
                lightning_layer.configure(lightning_data, arguments[i++][0]);
                rp10_layer.configure(rendezvous_point_data, arguments[i++][0]);
                rp11_layer.configure(rendezvous_point_data, arguments[i++][0]);
                rp12_layer.configure(rendezvous_point_data, arguments[i++][0]);
                rp20_layer.configure(rendezvous_point_data, arguments[i++][0]);
                rp30_layer.configure(rendezvous_point_data, arguments[i++][0]);
                cp00_layer.configure(copilot_data, arguments[i++][0]);
                cp10_layer.configure(copilot_data, arguments[i++][0]);
                cp11_layer.configure(copilot_data, arguments[i++][0]);
                cp20_layer.configure(copilot_data, arguments[i++][0]);
                cp21_layer.configure(copilot_data, arguments[i++][0]);
                cp30_layer.configure(copilot_data, arguments[i++][0]);
                radar_layer.configure(radar_data, arguments[i++][0]);
                gass_scale_layer.configure(gass_scale_data, arguments[i++][0]);
                live_camera_layer.configure(live_camera_data, arguments[i++][0]);
            });
            
            // Customize Layer Attributes
            gass_scale_layer.setAttributes({
                vis3:5000, vis2:9900, cig3:1000, cig2:2000
            });
            
            // Animation Controller
            var radar_animation = new WRAP.Geo.Animation();
            var gass_scale_animation = new WRAP.Geo.Animation();
            
            // Setup Map Interaction Module
            MapInteraction.init(live_camera_data, map_canvas);
            $('#lc_align').click(function() {
                $('#menu').click();
                MapInteraction.alignLiveCamera();
            });
            
            // update UI
            lightning_data.inspect(function(ref) {
                var tm = ref.query("data.updatedtime").value();
                if ( tm ) {
                    var ts = timeString(tm, true);
                    $('#lt_time').html(ts+"Z");
                                  
                    var num = ref.query("data.array").length();
                    message("Lightning Data Loaded.  updated time="+ts+" num="+num);
                }
            }, true);
            
            rendezvous_point_data.inspect(function(ref) {
                var ts = "--/-- --:--";
                var num = ref.query("data").length();
                if ( num ) {
                    var tm = ref.query("data[0].update_time").value();
                    ts = timeString(tm, true);
                }
                $('#rp_time').html(ts+"Z");
                message("RendezvousPoint Data Loaded.  updated time="+ts+" num="+num);
            }, true);
            
            copilot_data.inspect(function(ref) {
                var ts = "--/-- --:--";
                var num = ref.query("data").length();
                if ( num ) {
                    var tm = ref.query("data[0].update_time").value();
                    ts = timeString(tm, true);
                }
                $('#cp_time').html(ts+"Z");
                message("Copilot Data Loaded.  updated time="+ts+" num="+num);
            }, true);
            
            function updated(last, current) {
                return !last || JSON.stringify(last)!=JSON.stringify(current);
            }
        
            var time_range = { rd:[], gs:[] };
        
            var radar_timelist;
            radar_data.inspect(function(ref) {
                var timelist = ref.query("timelist").value();
                if ( timelist && timelist.length ) {
                    if ( updated(radar_timelist, timelist) ) {
                        $("#chk_rd").prop('disabled', false);
                        $("#rd_vt").html("");
                        radar_timelist = timelist;
                        time_range.rd = [];
                        var num = timelist.length;
                        var latest = "";
                        for ( var i = 0 ; i < num ; i++ ) {
                            var tm = timelist[i];
                            var ts = timeString(tm)+"Z";
                            if ( !i )
                               latest = ts;
                            var time_index = num-i-1;
                            $("#rd_vt").append("<option value='"+time_index+"'>"+ts+"</option>");
                            time_range.rd[time_index] = {validtime:tm};
                        }
                        message("Radar Timelist Loaded.  updated time="+latest+" vt="+num);
                    }
                }
                updateTimeControl("rd", radar_layer.visible()&&radar_timelist);
            }, true);
            
            var gass_scale_timelist;
            gass_scale_data.inspect(function(ref) {
                var timelist = ref.query("timelist").value();
                if ( timelist && timelist.length ) {
                    if ( updated(gass_scale_timelist, timelist) ) {
                        $("#chk_gs").prop('disabled', false);
                        $("#gs_bt").html("");
                        $("#gs_vt").html("");
                        gass_scale_timelist = timelist;
                        time_range.gs = [];
                        if ( timelist.length ) {
                            var bt = timelist[0].basetime;
                            var basetime = timeString(bt)+"Z";
                            $("#gs_bt").append("<option value='"+0+"'>"+basetime+"</option>");
                            var num = timelist[0].validtime.length;
                            for ( var i = 0 ; i < num ; i++ ) {
                                var tm = timelist[0].validtime[i];
                                var ts = timeString(tm)+"Z";
                                var time_index = num-i-1;
                                $("#gs_vt").append("<option value='"+time_index+"'>"+ts+"</option>");
                                time_range.gs[time_index] = {basetime:bt, validtime:tm};
                            }
                            $("#gs_vt").val(0);
                            message("GASS Scale Timelist Loaded.  basetime time="+basetime+" vt="+num);
                        }
                    }
                }
                updateTimeControl("gs", gass_scale_layer.visible()&&gass_scale_timelist);
            }, true);
            
            live_camera_data.inspect(function(ref) {
                var lc = ref.query("data").value();
                if ( lc ) {
                    $("#chk_lc").prop('disabled', false);
                    var count = 0;
                    var latest;
                    for ( var key in lc ) {
                        var c = lc[key];
                        if ( c.image && c.image.length ) {
                            if ( !latest || latest < c.image[0].time )
                                latest = c.image[0].time;
                            count++;
                        }
                    }
                    var ts = (latest?timeString(latest, true):"--/-- --:--")+"Z";
                    $('#lc_time').html(ts);
                    message("Camera Data Loaded.  latest time="+ts+" active camera="+count);
                }
            }, true);
            
            // Time Control UI
            function updateTimeControl(prefix, show) {
                var l = time_range[prefix].length;
                if ( !l )
                    show = false;
                $("#"+prefix+"_bt").prop('disabled', !show);
                $("#"+prefix+"_vt").prop('disabled', !show);
                $("#"+prefix+"_frst")[show?'removeClass':'addClass']('nop');
                $("#"+prefix+"_prev")[show?'removeClass':'addClass']('nop');
                $("#"+prefix+"_play")[show?'removeClass':'addClass']('nop');
                $("#"+prefix+"_next")[show?'removeClass':'addClass']('nop');
                $("#"+prefix+"_last")[show?'removeClass':'addClass']('nop');
                if ( show ) {
                    var index = $("#"+prefix+"_vt").val();
                    if ( index == 0 ) {
                        $("#"+prefix+"_frst").addClass('nop');
                        $("#"+prefix+"_prev").addClass('nop');
                    }
                    else if ( index == l-1 ) {
                        $("#"+prefix+"_last").addClass('nop');
                        $("#"+prefix+"_next").addClass('nop');
                        $("#"+prefix+"_play").addClass('nop');
                    }
                    if ( $("#"+prefix+"_play").hasClass('stop') ) {
                        $("#"+prefix+"_frst").addClass('nop');
                        $("#"+prefix+"_prev").addClass('nop');
                        $("#"+prefix+"_last").addClass('nop');
                        $("#"+prefix+"_next").addClass('nop');
                    }
                }
            }

            $("#rd_frst").click(function() {
                var index = 0;
                $("#rd_vt").val(index);
                radar_layer.set(time_range.rd[index]);
                updateTimeControl("rd", true);
            });
            $("#rd_prev").click(function() {
                var index = parseInt($("#rd_vt").val())-1;
                $("#rd_vt").val(index);
                radar_layer.set(time_range.rd[index]);
                updateTimeControl("rd", true);
            });
            $("#rd_play").click(function() {
                if ( $("#rd_play").hasClass('play') ) {
                    var index = parseInt($("#rd_vt").val());
                    // アニメーションの開始
                    radar_animation.setTimeRange(time_range.rd, 0.5);   // アニメーション時間範囲、0.5秒更新
                    radar_animation.setLayer([radar_layer]);            // アニメーション対象レイヤー登録
                    radar_animation.setTime(time_range.rd[index]);      // 最初のフレームを設定
                    radar_animation.start(function(time) {              // アニメーション開始
                        // フレーム（時間）変化毎にコールバックされるので UIの時間表示を更新
                        for ( var i = 0 ; i < time_range.rd.length ; i++ ) {
                            if ( time_range.rd[i].validtime == time.validtime ) {
                                $("#rd_vt").val(i);
                                if ( i == time_range.rd.length-1 )
                                    $("#rd_play").removeClass('stop').addClass('play');
                                updateTimeControl("rd", radar_layer.visible());
                                return;
                            }
                        }
                    });
                    // プレイボタンを停止ボタンに変更
                    $("#rd_play").removeClass('play').addClass('stop');
                }
                else {
                    // アニメーションの終了
                    radar_animation.stop();
                    // 停止ボタンをプレイボタンに変更
                    $("#rd_play").removeClass('stop').addClass('play');
                }
                updateTimeControl("rd", true);
            });
            $("#rd_next").click(function() {
                var index = parseInt($("#rd_vt").val())+1;
                $("#rd_vt").val(index);
                radar_layer.set(time_range.rd[index]);
                updateTimeControl("rd", true);
            });
            $("#rd_last").click(function() {
                var index = time_range.rd.length-1;
                $("#rd_vt").val(index);
                radar_layer.set(time_range.rd[index]);
                updateTimeControl("rd", true);
            });
            
            $("#gs_frst").click(function() {
                var index = 0;
                $("#gs_vt").val(index);
                gass_scale_layer.set(time_range.gs[index]);
                updateTimeControl("gs", true);
            });
            $("#gs_prev").click(function() {
                var index = parseInt($("#gs_vt").val())-1;
                $("#gs_vt").val(index);
                gass_scale_layer.set(time_range.gs[index]);
                updateTimeControl("gs", true);
            });
            $("#gs_play").click(function() {
                if ( $("#gs_play").hasClass('play') ) {
                    var index = parseInt($("#gs_vt").val());
                    // アニメーションの開始
                    gass_scale_animation.setTimeRange(time_range.gs, 0.5);  // アニメーション時間範囲、0.5秒更新
                    gass_scale_animation.setLayer([gass_scale_layer]);      // アニメーション対象レイヤー登録
                    gass_scale_animation.setTime(time_range.gs[index]);     // 最初のフレームを設定
                    gass_scale_animation.start(function(time) {             // アニメーション開始
                        // フレーム（時間）変化毎にコールバックされるので UIの時間表示を更新
                        for ( var i = 0 ; i < time_range.gs.length ; i++ ) {
                            if ( time_range.gs[i].basetime == time.basetime
                             &&  time_range.gs[i].validtime == time.validtime ) {
                                $("#gs_vt").val(i);
                                if ( i == time_range.gs.length-1 )
                                    $("#gs_play").removeClass('stop').addClass('play');
                                updateTimeControl("gs", gass_scale_layer.visible());
                                return;
                            }
                        }
                    });
                    // プレイボタンを停止ボタンに変更
                    $("#gs_play").removeClass('play').addClass('stop');
                }
                else {
                    // アニメーションの終了
                    gass_scale_animation.stop();
                    // 停止ボタンをプレイボタンに変更
                    $("#gs_play").removeClass('stop').addClass('play');
                }
                updateTimeControl("gs", true);
            });
            $("#gs_next").click(function() {
                var index = parseInt($("#gs_vt").val())+1;
                $("#gs_vt").val(index);
                gass_scale_layer.set(time_range.gs[index]);
                updateTimeControl("gs", true);
            });
            $("#gs_last").click(function() {
                var index = time_range.gs.length-1;
                $("#gs_vt").val(index);
                gass_scale_layer.set(time_range.gs[index]);
                updateTimeControl("gs", true);
            });

            function timeString(tm, year) {
                return (year?(tm.substr(0,4)+"/"):"")+tm.substr(4,2)+"/"+tm.substr(6,2)+" "+
                       tm.substr(9,2)+":"+tm.substr(11,2);
            }

            function message(str) {
                $('#Message').html(str);
                console.log(str);
            }
        
            function latlon(pt) {
                return ""+pt.latDegree().toFixed(4)+", "+pt.lonDegree().toFixed(4);
            }
        
            // Map状態監視
            var l, t;
            function infoMap(e) {
                var onmap = (l = e) && e.target && e.target.clientHeight > 200;
                if ( onmap ) {
                    var r = e.target.getBoundingClientRect();
                    var x = e.clientX-r.left, y = e.clientY-r.top;
                    var pt = WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(x,y));
                    $('#center').html("map_center : "+latlon(WRAP.Geo.getCenterPoint()));
                    $('#zoom').html("map_zoom : "+WRAP.Geo.getZoom());
                    $('#xy').html("x,y : "+x+", "+y);
                    $('#ll').html("lat,lon : "+latlon(pt));
                    //var s = WRAP.Geo.getScreenPoint(pt);
                    //$('#ll').html("x,y : "+s.x+", "+s.y);
                }
                if(t) clearTimeout(t);
                t = setTimeout(function(){
                    $('#xy')[onmap?'fadeIn':'fadeOut'](250);
                    $('#ll')[onmap?'fadeIn':'fadeOut'](250);
                },50);
            }
            map_canvas.addEventListener("mousemove", infoMap);
            map_canvas.addEventListener("mouseout", function() {infoMap()});
            google.maps.event.addListener(map, 'bounds_changed', function() {infoMap(l)});

            // テストメニュー制御
            var menu = false;
            $('#menu').click(function(){
                menu = !menu;
                $('#sidepane').animate({left: menu?'0px':'-210px'});
                $('#menu').html("<span class='arrow "+(menu?"l":"r")+"'/>　WRAP テストドライバ");
            }).click();
            
            var updateLayers = function () {
                var check_lt = $('#chk_lt').prop("checked");
                var check_rp = $('#chk_rp').prop("checked");
                var check_rp10 = $('#chk_rp10').prop("checked");
                var check_rp20 = $('#chk_rp20').prop("checked");
                var check_rp30 = $('#chk_rp30').prop("checked");
                var check_cp = $('#chk_cp').prop("checked");
                var check_cp00 = $('#chk_cp00').prop("checked");
                var check_cp10 = $('#chk_cp10').prop("checked");
                var check_cp11 = $('#chk_cp11').prop("checked");
                var check_cp20 = $('#chk_cp20').prop("checked");
                var check_cp21 = $('#chk_cp21').prop("checked");
                var check_cp30 = $('#chk_cp30').prop("checked");
                var check_cprt = $('#chk_cprt').prop("checked");
                var check_rd = $('#chk_rd').prop("checked");
                var check_gs = $('#chk_gs').prop("checked");
                var check_lc = $('#chk_lc').prop("checked");
                
                lightning_layer.setVisible(check_lt);
                rp10_layer.setVisible(check_rp&&check_rp10);
                rp11_layer.setVisible(check_rp&&check_rp10);
                rp12_layer.setVisible(check_rp&&check_rp10);
                rp20_layer.setVisible(check_rp&&check_rp20);
                rp30_layer.setVisible(check_rp&&check_rp30);
                cp00_layer.setVisible(check_cp&&check_cp00);
                cp10_layer.setVisible(check_cp&&check_cp10);
                cp11_layer.setVisible(check_cp&&check_cp11);
                cp20_layer.setVisible(check_cp&&check_cp20);
                cp21_layer.setVisible(check_cp&&check_cp21);
                cp30_layer.setVisible(check_cp&&check_cp30);
                radar_layer.setVisible(check_rd);
                gass_scale_layer.setVisible(check_gs);
                live_camera_layer.setVisible(check_lc);
                $('#lc_align')[check_lc?'removeClass':'addClass']('nop');

                var copilot_route_config = {route:check_cprt};
                cp00_layer.setAttributes(copilot_route_config);
                cp10_layer.setAttributes(copilot_route_config);
                cp11_layer.setAttributes(copilot_route_config);
                cp20_layer.setAttributes(copilot_route_config);
                cp21_layer.setAttributes(copilot_route_config);
                cp30_layer.setAttributes(copilot_route_config);

                if ( check_rd && time_range.rd.length ) {
                    var index = parseInt($("#rd_vt").val());
                    radar_layer.set(time_range.rd[index]);
                    updateTimeControl("rd", true);
                }
                else {
                    updateTimeControl("rd", false);
                }

                if ( check_gs && time_range.gs.length ) {
                    var index = parseInt($("#gs_vt").val());
                    gass_scale_layer.set(time_range.gs[index]);
                    updateTimeControl("gs", true);
                }
                else {
                    updateTimeControl("gs", false);
                }
            };

            $("input[type=checkbox]").change(updateLayers);
            $("#rd_vt").change(updateLayers);
            $("#gs_vt").change(updateLayers);
            updateLayers();


            // 単体試験
            map_canvas.addEventListener("mousemove", infoMap);
            
            function testDHInspect() {
                var ref = WRAP.DH.query("WX_JP_Lightning.data").query("array[0]");
                ref.inspect(function() {
                    alert("loaded");
                });
            }

            function adjustPerspective(data) {
                var points = data.filter(function(v) {
                    return new WRAP.Geo.Point(v.lat, v.lon);
                });
                if ( points && points.length ) {
                    var perspective = WRAP.Geo.getPerspective(points,10);
                    WRAP.Geo.setCenterPoint(perspective.center);
                    //if ( perspective.zoom < WRAP.Geo.getZoom() )
                    WRAP.Geo.setZoom(perspective.zoom);
                }
                else {
                    alert("No data found.");
                }
            }
        
            $('#cp_test').click(function(){
                adjustPerspective(WRAP.DH.query("SKY_CUS_CoPilot.data"));
            });
            $('#rp_test').click(function(){
                adjustPerspective(WRAP.DH.query("SKY_CUS_RendezvousPoint.data"));
            });
            $('#lt_test').click(function(){
                adjustPerspective(WRAP.DH.query("WX_JP_Lightning.data.array"));
            });
            
        </script>
    </body>
</html>
