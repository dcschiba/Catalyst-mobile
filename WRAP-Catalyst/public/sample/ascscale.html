<!DOCTYPE html>
<html style="width:100%; height:100%; margin:0; padding:0; font-family: 'Helvetica Neue', Helvetica, sans-serif !important; font-size: 13px;">
    <head>
        <meta charset="utf-8">
        <title>WRAP Mercury ASCScale Sample</title>
        <script src="https://maps.googleapis.com/maps/api/js?client=gme-weathernewsinc&libraries=geometry"></script>
        <script type="text/javascript" src="3rd/js/jquery-1.10.2.min.js"></script>
        <script type="text/javascript" src="js/WRAP.DH-1.1.0.0.js"></script>
        <script type="text/javascript" src="js/WRAP.Geo-1.1.0.0.js"></script>
        <script type="text/javascript" src="js/WRAP.ASM.js"></script>
    </head>
    <body style="width:100%; height:100%; margin:0; padding:0; background-color:rgb(255,255,255);">
        <label style="position:absolute; width:160px; height:18px; left:10px; top:8px;">ASCScale</label>
        <label style="position:absolute; width:160px; height:18px; left:100px; top:8px;">basetime</label>
        <select id="mdl_bt" style="position:absolute; width:100px; left:160px; top:6px; height:18px;"></select>
        <label style="position:absolute; width:160px; height:18px; left:280px; top:8px;">validtime</label>
        <select id="mdl_vt" style="position:absolute; width:100px; left:340px; top:6px; height:18px;"></select>
        <label style="position:absolute; width:160px; height:18px; left:460px; top:8px;">level range</label>
        <select id="mdl_lv_hi" style="position:absolute; width:50px; left:530px; top:6px; height:18px;"></select>
        <label style="position:absolute; width:160px; height:18px; left:585px; top:8px;">〜</label>
        <select id="mdl_lv_lo" style="position:absolute; width:50px; left:605px; top:6px; height:18px;"></select>
        <label style="position:absolute; width:160px; height:18px; left:700px; top:6px;">
            <input type="checkbox" id="chk_turb"><spawn style="position:absolute; top:2px; left:20px;">Turbulence</spawn>
        </label>
        <label style="position:absolute; width:160px; height:18px; left:800px; top:6px;">
            <input type="checkbox" id="chk_conv"><spawn style="position:absolute; top:2px; left:20px;">Convection</spawn>
        </label>
        <label style="position:absolute; width:160px; height:18px; left:900px; top:6px;">
            <input type="checkbox" id="chk_icing"><spawn style="position:absolute; top:2px; left:20px;">Icing</spawn>
        </label>
        
        <a href="../doc/reference/sample_code/ascscale.html" target="_blank" style="position:absolute; right:40px; top:8px;" >Document</a>
        <div id="map_canvas" style="position:absolute; top:30px; bottom:10px; left:10px; right:10px;"></div>
        
        <script type="text/javascript">
            // Mapの初期画角
            var initial_lat = 35.65;
            var initial_lon = 140.045;
            var initial_zoom = 5;
            
            var levels = [100,150,200,250,300,400,500,700,850];

            var conf_path = "./pri/conf";     // ローカルの sample_data用コンフィグを用いる
            WRAP.DH.conf_path = conf_path+"/data";
            
            // Setup Google Maps
            var map_canvas = document.getElementById('map_canvas');
            var g_map = new google.maps.Map(map_canvas, {
                zoom: initial_zoom,
                minZoom: 3,
                maxZoom: 8,
                center: new google.maps.LatLng(initial_lat, initial_lon),
                zoomControl: true,
                mapTypeControl: false,
                scaleControl: false,
                streetViewControl: false,
                draggableCursor: "default",
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });
            WRAP.Geo.setGoogleMaps(g_map)

            // Model
            var data = WRAP.DH.addObject("SKY_WNI_ASCScale");
            
            // レイヤー登録
            var layer = new WRAP.Geo.Layer("ASCScale");
            WRAP.Geo.setLayer({upper_layers:[layer]});

            // Configure Layers
            var conf_dir = "./pri/conf";
            $.getJSON(conf_dir + '/layer/ASCScale.json', function(conf) {
                layer.configure(data, conf);
            });
            
            function timeString(tm, year) {
                if ( !tm )
                    return (year?"----/":"")+"--/-- --:--";
                var ts = year?(tm.substr(0,4)+"/"):"";
                return ts+tm.substr(4,2)+"/"+tm.substr(6,2)+" "+tm.substr(9,2)+":"+tm.substr(11,2);
            }
        
            // モデルのタイムリスト取得＆UIセットアップ
            var time_range = [];
            var timelist;
            
            function updateModelContent() {
                var time_index = parseInt($("#mdl_vt").val());
                var e = [];
                if ( $('#chk_turb').prop('checked') )
                    e.push("TURB");
                if ( $('#chk_conv').prop('checked') )
                    e.push("CONV");
                if ( $('#chk_icing').prop('checked') )
                    e.push("ICING");
                if ( !e.length ) {
                    layer.hide();
                    return;
                }
                var l = [];
                for ( var i = parseInt($("#mdl_lv_hi").val()) ; i <= parseInt($("#mdl_lv_lo").val()) ; i++ )
                    l.push(levels[i]);
                var content = {
                    element:e,
                    level:l,
                    basetime:time_range[time_index].basetime,
                    validtime:time_range[time_index].validtime
                };
                layer.set(content);
                layer.show();
            }
            
            function updateModelTime() {
                $("#mdl_vt").html("");
                timelist = data.query("timelist").value();
                if ( !timelist )
                    return;
                var b = $("#mdl_bt").val();
                var bt = timelist[b].basetime;
                var num = timelist[b].validtime.length;
                for ( var i = 0 ; i < num ; i++ ) {
                    var tm = timelist[b].validtime[i];
                    var ts = timeString(tm)+"Z";
                    $("#mdl_vt").append("<option value='"+i+"'>"+ts+"</option>");
                    time_range[i] = {basetime:bt, validtime:tm};
                }
            }
            data.inspect(function(ref) {
                time_range = [];
                timelist = ref.query("timelist").value();
                if ( timelist && timelist.length ) {
                    $("#mdl_bt").html("");
                    $("#mdl_vt").html("");
                    for ( var i = 0 ; i < timelist.length ; i++ ) {
                        var bt = timelist[i].basetime;
                        var basetime = timeString(bt)+"Z";
                        $("#mdl_bt").append("<option value='"+i+"'>"+basetime+"</option>");
                    }
                    $("#mdl_bt").val(timelist.length-1);
                    updateModelTime();
                    var vl = timelist[timelist.length-1].validtime;
                    $("#mdl_vt").val(vl.length-1);
                    updateModelContent();
                }
            }, true);

            $('#mdl_lv_hi').change(function() {
                if ( $('#mdl_lv_lo').val() < $(this).val() )
                    $('#mdl_lv_lo').val($(this).val());
                updateModelContent();
            });
            
            $('#mdl_lv_lo').change(function() {
                if ( $('#mdl_lv_hi').val() > $(this).val() )
                    $('#mdl_lv_hi').val($(this).val());
                updateModelContent();
            });
                                
            $('#mdl_bt').change(function() {
                updateModelTime();
                var index = $('#mdl_bt').val();
                var vl = timelist[index].validtime;
                $("#mdl_vt").val(vl.length-1);
                updateModelContent();
            });
                                 
            $('#mdl_vt').change(updateModelContent);
            $('#chk_turb').click(updateModelContent);
            $('#chk_conv').click(updateModelContent);
            $('#chk_icing').click(updateModelContent);

            for ( var i = 0 ; i < levels.length ; i++ ) {
                $('#mdl_lv_hi').append("<option value="+i+">"+levels[i]+"</option>");
                $('#mdl_lv_lo').append("<option value="+i+">"+levels[i]+"</option>");
            }
        
            // 初期状態設定
            $('#mdl_lv_hi').val(levels.length-1);
            $('#mdl_lv_lo').val(levels.length-1);
            $('#chk_turb').prop('checked', true);

        </script>
    </body>
</html>
