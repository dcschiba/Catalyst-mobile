<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no">
        <title>WRAP Mercury Test Driver</title>
        <script src="https://maps.googleapis.com/maps/api/js?client=gme-weathernewsinc&channel=sky_bestway&libraries=geometry"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ol3/3.4.0/ol.css" type="text/css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ol3/3.4.0/ol.js"></script>
        <script type="text/javascript" src="3rd/js/jquery-1.10.2.min.js"></script>
 
        <script type="text/javascript" src="js/WRAP.DH-1.1.0.0.js"></script>
        <script type="text/javascript" src="js/WRAP.Geo-1.1.0.0.js"></script>
        <script type="text/javascript" src="js/WRAP.ASM.js"></script>
        <link rel="stylesheet" type="text/css" href="sample.css" />
        
    </head>
    <body>
        <!-- 画面上部 -->
        <div class="nav">
            <ul class="navbar">
                <li class="navtab" id="menu"></li>
                <li class="navtxt" id="w_map" style="color:#999;">WebGL Map</li>
                <li class="navtxt" id="o_map">OpenLayers+OpenStreamMap</li>
                <li class="navtxt" id="g_map">Google Maps</li>
                <li class="navmsg" id="Message">Multi-Map Support Test</li>
            </ul>
        </div>
        
        <!-- 画面コンテンツ部 -->
        <div id="main">
            <!-- 画面左側メニュー・パート -->
            <div id="sidepane">
                <div id="sidebar">
                    <span class="info" id="center"></span><br/>
                    <span class="info" id="zoom"></span><br/>
                    <span class="info" id="xy"></span><br/>
                    <span class="info" id="ll"></span><br/>
                    <div class="subtitle" >
                        <label for="chk_cp">地点情報データ（GeoJSON）</label>
                    </div>
                    <div class="sidebar_contents">
                        <input type="checkbox" id="chk_00" value="00" ><label for="chk_00">ランデブーポイント</label><br/>
                        <input type="checkbox" id="chk_01" value="01" ><label for="chk_01">Copilot</label><br/>
                        <input type="checkbox" id="chk_02" value="02" ><label for="chk_02">マイクロネット</label><br/>
                    </div>
                    <div class="subtitle" >
                        <label for="chk_rd">GPVデータ（GeoTiff）</label>
                    </div>
                    <div class="sidebar_contents" style="position:relative;">
                        <input type="checkbox" id="chk_20" value="20" disabled><label for="chk_20">ASC Scale (TURB)</label><br/>
                        <span>basetime : </span><select id="as_bt" style="position:absolute; right:20px;" disabled><option value="">--/-- --:--</option></select><br/>
                        <span>validtime : </span><select id="as_vt" style="position:absolute; right:20px;" disabled><option value="">--/-- --:--</option></select><br/>
                        <span>level : </span><select id="as_lv" style="position:absolute; right:20px;" disabled>
                            <option value="100">100</option>
                            <option value="150">150</option>
                            <option value="200">200</option>
                            <option value="250">250</option>
                            <option value="300">300</option>
                            <option value="400">400</option>
                            <option value="500">500</option>
                            <option value="700">700</option>
                            <option value="850">850</option>
                        </select>
                    </div>
                    <div class="sidebar_contents" style="position:relative;">
                        <input type="checkbox" id="chk_mdl" disabled><label for="chk_mdl">GSM</label><br/>
                        <span>basetime : </span><select id="mdl_bt" style="position:absolute; right:20px;" disabled><option value="">--/-- --:--</option></select><br/>
                        <span>validtime : </span><select id="mdl_vt" style="position:absolute; right:20px;" disabled><option value="">--/-- --:--</option></select><br/>
                        <span>level : </span><select id="mdl_lv" style="position:absolute; right:20px;" disabled>
                            <option value="100">100</option>
                            <option value="150">150</option>
                            <option value="200">200</option>
                            <option value="250">250</option>
                            <option value="300">300</option>
                            <option value="400">400</option>
                            <option value="500">500</option>
                            <option value="600">600</option>
                            <option value="700">700</option>
                            <option value="850">850</option>
                            <option value="925" selected>925</option>
                            <option value="1000">1000</option>
                        </select>
                        <div style="height:10px;"></div>
                        <input type="checkbox" id="chk_mdl1" style="margin-left:15px;"><label for="chk_mdl1">Wind</label><br/>
                        <input type="checkbox" id="chk_mdl2" style="margin-left:15px;" checked><label for="chk_mdl2">Temp</label><br/>
                        <input type="checkbox" id="chk_mdl3" style="margin-left:25px;"><label for="chk_mdl3">Contour</label><br/>
<!--                        <input type="checkbox" id="chk_mdl4" style="margin-left:25px;"><label for="chk_mdl4">Block</label><br/> -->
                        <input type="checkbox" id="chk_mdl5" style="margin-left:25px;"><label for="chk_mdl5">Flat</label><br/>
                        <input type="checkbox" id="chk_mdl6" style="margin-left:25px;" checked><label for="chk_mdl6">Gradation</label><br/>
                        <input type="checkbox" id="chk_mdl7" style="margin-left:25px;"><label for="chk_mdl7">Grid Value</label><br/>
                    </div>
                    <div style="height:100px;"></div>
                    
                </div>
            </div>
            
            <!-- Maps 表示パート -->
            <div id="map_canvas" style="width:100%; height:100%; margin:0; padding:0">
            <div id="g_map_canvas" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%;"></div>
            <div id="o_map_canvas" style="position:absolute; top:0; left:0; width:100%; height:100%;"></div>
            </div>
        </div>

        <script type="text/javascript">
            // テスト用セットアップ
            var center_lat = 35.792621;
            var center_lon = 139.806513;
            
            WRAP.DH.conf_path = "./pri/conf/data";  // ローカルの sample_data用コンフィグを用いる
        
            var map_canvas = document.getElementById('map_canvas');
            var g_map_canvas = document.getElementById('g_map_canvas');
            var o_map_canvas = document.getElementById('o_map_canvas');
            
            // Setup Google Maps
            var g_map = new google.maps.Map(g_map_canvas, {
                zoom: 3,
                minZoom: 3,
                center: new google.maps.LatLng(center_lat, center_lon),
                zoomControl: true,
                mapTypeControl: false,
                scaleControl: false,
                streetViewControl: false,
                draggableCursor: "default",
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });

            // Setup OpenLyers OSM
            var o_map = new ol.Map({
                layers:[ new ol.layer.Tile({
                                source: new ol.source.OSM()
                            })
                ],
                target: 'o_map_canvas',
                view: new ol.View({
                    center: ol.proj.transform([center_lon, center_lat], 'EPSG:4326', 'EPSG:3857'),
                    zoom: 3
                })
            });
            
            // User
            WRAP.DH.setUser("WNI", "wni_root1");
            
            // Data
            var copilot_data = WRAP.DH.addObject("SKY_CUS_CoPilot");
            var rendezvous_point_data = WRAP.DH.addObject("SKY_CUS_RendezvousPoint");
            var micronet_data = WRAP.DH.addObject("Micronet");
            var asc_scale_data = WRAP.DH.addObject("ASCScale");
            var gsm_data = WRAP.DH.addObject("Model_GSM");
            
            // Map
            var g_map_ins = WRAP.Geo.setGoogleMaps(g_map);
            var o_map_ins = WRAP.Geo.setOpenLayers(o_map);
            
            var current_map;
            function selectMap(map) {
                if ( current_map != map ) {
                    current_map = map;
                    WRAP.Geo.switchMap(map);
                    if ( current_map == g_map_ins ) {
                        g_map_canvas.style.display = '';
                        o_map_canvas.style.display = 'none';
                        $('#g_map').css('color', '#4F6');
                        $('#o_map').css('color', '');
                    }
                    if ( current_map == o_map_ins ) {
                        o_map_canvas.style.display = '';
                        g_map_canvas.style.display = 'none';
                        $('#o_map').css('color', '#4F6');
                        $('#g_map').css('color', '');
                    }
                }
            }
        
        
            // Layers
            var cp00_layer = new WRAP.Geo.Layer("CoPilot_00");
            var rp_layer = new WRAP.Geo.Layer("RendezvousPoint");
            var gpv_fill_layer = new WRAP.Geo.Layer("GPVFillStyleSamples");
            var gpv_contour_layer = new WRAP.Geo.Layer("GPVContour");
            var grid_value_layer = new WRAP.Geo.Layer("GridValue");
            var wind_layer = new WRAP.Geo.Layer("Wind");
            var asc_scale_layer = new WRAP.Geo.Layer("ASCScale");
            var micronet_layer = new WRAP.Geo.Layer("Micronet");
            
            WRAP.Geo.setLayer({
                upper_layers : [
                    cp00_layer,
                    rp_layer,
                    micronet_layer,
                    asc_scale_layer,
                    wind_layer,
                    grid_value_layer,
                    gpv_contour_layer,
                    gpv_fill_layer,
                ]
            });

            var conf_dir = "./pri/conf";
            // Configure Layers
            $.when(
                $.getJSON(conf_dir + '/layer/RendezvousPoint.json'),
                $.getJSON(conf_dir + '/layer/CoPilot_00.json'),
                $.getJSON(conf_dir + '/layer/ASCScaleTurbulence.json'),
                $.getJSON(conf_dir + '/layer/GPVFillSample.json'),
                $.getJSON(conf_dir + '/layer/GPVContourSample.json'),
                $.getJSON(conf_dir + '/layer/GridValueSample.json'),
                $.getJSON(conf_dir + '/layer/WindArrowSample.json'),
                $.getJSON(conf_dir + '/layer/Micronet.json')
            ).done(function() {
                var i = 0;
                rp_layer.configure(rendezvous_point_data, arguments[i++][0]);
                cp00_layer.configure(copilot_data, arguments[i++][0]);
                asc_scale_layer.configure(asc_scale_data, arguments[i++][0]);
                gpv_fill_layer.configure(gsm_data, arguments[i++][0]);
                gpv_contour_layer.configure(gsm_data, arguments[i++][0]);
                grid_value_layer.configure(gsm_data, arguments[i++][0]);
                wind_layer.configure(gsm_data, arguments[i++][0]);
                micronet_layer.configure(micronet_data, arguments[i++][0]);
            });

            function timeString(tm, year) {
                return (year?(tm.substr(0,4)+"/"):"")+tm.substr(4,2)+"/"+tm.substr(6,2)+" "+
                       tm.substr(9,2)+":"+tm.substr(11,2);
            }

            function message(str) {
                $('#Message').html(str);
                console.log(str);
            }
        
            function latlon(pt) {
                return ""+pt.latDegree().toFixed(4)+", "+pt.lonDegree().toFixed(4);
            }
        
            var time_range = { as:[], gsm:[] };
            var asc_scale_timelist;
            asc_scale_data.inspect(function(ref) {
                time_range.as = [];
                var timelist = ref.query("timelist").value();
                if ( timelist && timelist.length ) {
                    $("#chk_20").prop('disabled', false);
                    $("#as_bt").html("");
                    $("#as_vt").html("");
                    asc_scale_timelist = timelist;
                    var bt = timelist[0].basetime;
                    var basetime = timeString(bt)+"Z";
                    $("#as_bt").append("<option value='"+0+"'>"+basetime+"</option>");
                    var num = timelist[0].validtime.length;
                    for ( var i = 0 ; i < num ; i++ ) {
                        var tm = timelist[0].validtime[i];
                        var ts = timeString(tm)+"Z";
                        var time_index = num-i-1;
                        $("#as_vt").append("<option value='"+time_index+"'>"+ts+"</option>");
                        time_range.as[time_index] = {basetime:bt, validtime:tm};
                    }
                    var show = asc_scale_layer.visible();
                    $("#as_bt").prop('disabled', !show);
                    $("#as_vt").prop('disabled', !show);
                    $("#as_lv").prop('disabled', !show);
                }
                $("#as_vt").val(0);
            }, true);
            
            var gsm_timelist;
            function updateModel() {
                $("#mdl_vt").html("");
                var timelist = gsm_data.query("timelist").value();
                if ( !timelist && !timelist )
                    return;
                var b = $("#mdl_bt").val();
                var bt = timelist[b].basetime;
                var num = timelist[b].validtime.length;
                for ( var i = 0 ; i < num ; i++ ) {
                    var tm = timelist[b].validtime[i];
                    var ts = timeString(tm)+"Z";
                    var time_index = num-i-1;
                    $("#mdl_vt").append("<option value='"+time_index+"'>"+ts+"</option>");
                    time_range.gsm[time_index] = {basetime:bt, validtime:tm};
                }
            }
            gsm_data.inspect(function(ref) {
                time_range.gsm = [];
                var timelist = ref.query("timelist").value();
                if ( timelist && timelist.length ) {
                    $("#chk_mdl").prop('disabled', false);
                    $("#mdl_bt").html("");
                    $("#mdl_vt").html("");
                    gsm_timelist = timelist;
                    for ( var i = 0 ; i < timelist.length ; i++ ) {
                        var bt = timelist[i].basetime;
                        var basetime = timeString(bt)+"Z";
                        $("#mdl_bt").append("<option value='"+i+"'>"+basetime+"</option>");
                    }
                    $("#mdl_bt").val(timelist.length-1);
                    updateModel();
                    var show = gpv_fill_layer.visible();
                    $("#mdl_bt").prop('disabled', !show);
                    $("#mdl_vt").prop('disabled', !show);
                    $("#mdl_lv").prop('disabled', !show);
                }
                $("#mdl_vt").val(0);
            }, true);

        
            // Map状態監視
            var l, t;
            function infoMap(e) {
                var onmap = (l = e) && e.target && e.target.clientHeight > 200;
                if ( onmap ) {
                    var r = e.target.getBoundingClientRect();
                    var x = e.clientX-r.left, y = e.clientY-r.top;
                    var pt = WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(x,y));
                    $('#center').html("map_center : "+latlon(WRAP.Geo.getCenterPoint()));
                    $('#zoom').html("map_zoom : "+WRAP.Geo.getZoom());
                    $('#xy').html("x,y : "+x+", "+y);
                    $('#ll').html("lat,lon : "+latlon(pt));
                }
                if(t) clearTimeout(t);
                t = setTimeout(function(){
                    $('#xy')[onmap?'fadeIn':'fadeOut'](250);
                    $('#ll')[onmap?'fadeIn':'fadeOut'](250);
                },50);
            }
            map_canvas.addEventListener("mousemove", infoMap);
            map_canvas.addEventListener("mouseout", function() {infoMap()});
            google.maps.event.addListener(g_map, 'bounds_changed', function() {infoMap(l)});

            // テストメニュー制御
            var menu = false;
            $('#menu').click(function(){
                menu = !menu;
                $('#sidepane').animate({left: menu?'0px':'-210px'});
                $('#menu').html("<span class='arrow "+(menu?"l":"r")+"'/>　WRAP Mercury テストドライバ");
            }).click();
            
            $('#g_map').click(function() {
                selectMap(g_map_ins);
            });
            $('#o_map').click(function() {
                selectMap(o_map_ins);
            });
            selectMap(g_map_ins);
            
            var last_cl = null;
            
            var updateLayers = function () {
                var check_rp = $('#chk_00').prop("checked");
                var check_cp = $('#chk_01').prop("checked");
                var check_mn = $('#chk_02').prop("checked");
                var check_as = $('#chk_20').prop("checked");
                var check_mdl = $('#chk_mdl').prop("checked");
                var check_mdl1 = check_mdl && $('#chk_mdl1').prop("checked");
                var check_mdl2 = check_mdl && $('#chk_mdl2').prop("checked");
                var check_mdl3 = check_mdl && $('#chk_mdl3').prop("checked");
                var check_mdl4 = check_mdl && $('#chk_mdl4').prop("checked");
                var check_mdl5 = check_mdl && $('#chk_mdl5').prop("checked");
                var check_mdl6 = check_mdl && $('#chk_mdl6').prop("checked");
                var check_mdl7 = check_mdl && $('#chk_mdl7').prop("checked");
                
                $("#as_bt").prop('disabled', !check_as);
                $("#as_vt").prop('disabled', !check_as);
                $("#as_lv").prop('disabled', !check_as);
                if ( check_as ) {
                    var time_index = parseInt($("#as_vt").val());
                    asc_scale_layer.set({
                        element:"TURB",
                        level:$("#as_lv").val(),
                        basetime:time_range.as[time_index].basetime,
                        validtime:time_range.as[time_index].validtime
                    });
                }
                
                $("#mdl_bt").prop('disabled', !check_mdl);
                $("#mdl_vt").prop('disabled', !check_mdl);
                $("#mdl_lv").prop('disabled', !check_mdl);
                $("#chk_mdl1").prop('disabled', !check_mdl);
                $("#chk_mdl2").prop('disabled', !check_mdl);
                if ( check_mdl ) {
                    var time_index = parseInt($("#mdl_vt").val());
                    var tmp_content = {
                        element:"TMP",
                        level:$("#mdl_lv").val(),
                        basetime:time_range.gsm[time_index].basetime,
                        validtime:time_range.gsm[time_index].validtime
                    };
                    var wind_content = {
                        element:["UGRD","VGRD"],
                        level:$("#mdl_lv").val(),
                        basetime:time_range.gsm[time_index].basetime,
                        validtime:time_range.gsm[time_index].validtime
                    };
                    
                    gpv_fill_layer.set(tmp_content);
                    gpv_contour_layer.set(tmp_content);
                    grid_value_layer.set(tmp_content);
                    wind_layer.set(wind_content);
                }
                $("#chk_mdl3").prop('disabled', !check_mdl2);
                $("#chk_mdl4").prop('disabled', !check_mdl2);
                $("#chk_mdl5").prop('disabled', !check_mdl2);
                $("#chk_mdl6").prop('disabled', !check_mdl2);
                $("#chk_mdl7").prop('disabled', !check_mdl2);
                
                rp_layer.setVisible(check_rp);
                cp00_layer.setVisible(check_cp);
                micronet_layer.setVisible(check_mn);
                asc_scale_layer.setVisible(check_as);
                gpv_contour_layer.setVisible(check_mdl&&check_mdl2&&check_mdl3);
                gpv_fill_layer.setVisible(check_mdl&&check_mdl2&&(check_mdl4||check_mdl5||check_mdl6));
                grid_value_layer.setVisible(check_mdl&&check_mdl2&&check_mdl7);
                wind_layer.setVisible(check_mdl&&check_mdl1);
                if ( check_mdl4 )
                    gpv_fill_layer.setStyle("block");
                else if ( check_mdl5 )
                    gpv_fill_layer.setStyle("flat");
                else if ( check_mdl6 )
                    gpv_fill_layer.setStyle("gradation");
            };
        
            // Tooltip
            WRAP.Geo.setInteraction(map_canvas);
            wind_layer.setTooltip(function(geo) {
                var p = geo && geo.properties;
                if ( p )
                    return (p.direction_text?(p.direction_text+"/"):"")+p.speed_text;
            });

            $("input[type=checkbox]").change(updateLayers);
            $("#as_bt").change(updateLayers);
            $("#as_vt").change(updateLayers);
            $("#as_lv").change(updateLayers);
            $("#mdl_bt").change( function() {
                updateModel();
                $("#mdl_vt").val(0);
                updateLayers();
            });
            $("#mdl_vt").change(updateLayers);
            $("#mdl_lv").change(updateLayers);

            $("#chk_mdl4").click(function() {
                $("#chk_mdl5").prop('checked', false);
                $("#chk_mdl6").prop('checked', false);
                $("#chk_mdl7").prop('checked', false);
                updateLayers();
            });
            $("#chk_mdl5").click(function() {
                $("#chk_mdl4").prop('checked', false);
                $("#chk_mdl6").prop('checked', false);
                $("#chk_mdl7").prop('checked', false);
                updateLayers();
            });
            $("#chk_mdl6").click(function() {
                $("#chk_mdl4").prop('checked', false);
                $("#chk_mdl5").prop('checked', false);
                $("#chk_mdl7").prop('checked', false);
                updateLayers();
            });

            updateLayers();

            $("#open_doc").click(function() {
                window.open('../doc/reference/index.html');
            });

            map_canvas.addEventListener("mousemove", infoMap);
            
        </script>
    </body>
</html>
